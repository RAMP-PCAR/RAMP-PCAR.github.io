/*! ramp-pcar 24-04-2015 14:06:59 : v. 5.3.0-4 
 * 
 * RAMP GIS viewer - Elk; Sample of an implementation of RAMP 
 **/
define(["ramp/eventManager","esri/request","dojo/promise/all","dojo/topic"],function(a,b,c,d){"use strict";var e,f=[];return{init:function(g){var h='<header class="modal-header"><h2 class="modal-title">{0}</h2></header>'.format(i18n.t("mapClickHandler.getFiPanelTitle"));e=g,d.subscribe(a.Map.CLICK,function(g){var i=[],j=[];RAMP.state.ui.wmsQuery&&(i=f.filter(function(a){return a.wmsLayer.visible&&a.wmsLayer.id in RAMP.layerRegistry&&RAMP.layerRegistry[a.wmsLayer.id]}),0!==i.length&&(d.publish(a.GUI.SUBPANEL_OPEN,{panelName:i18n.t("mapClickHandler.getFiPanelName"),title:i18n.t("mapClickHandler.getFiPanelTitle"),content:null,origin:"wmsFeatureInfo",target:$("#map-div"),guid:"wms-guid"}),j=i.map(function(a){try{var c,d,f,h={};return d=a.wmsLayer.getMap().spatialReference,f=a.wmsLayer.spatialReferences,f&&f.length>1?c=f[0]:d.wkid&&(c=d.wkid),h="1.3"===a.wmsLayer.version||"1.3.0"===a.wmsLayer.version?{CRS:"EPSG:"+c,I:g.layerX,J:g.layerY}:{SRS:"EPSG:"+c,X:g.layerX,Y:g.layerY},$.extend(h,{SERVICE:"WMS",REQUEST:"GetFeatureInfo",VERSION:a.wmsLayer.version,BBOX:e.extent.xmin+","+e.extent.ymin+","+e.extent.xmax+","+e.extent.ymax,WIDTH:e.width,HEIGHT:e.height,QUERY_LAYERS:a.layerConfig.layerName,LAYERS:a.layerConfig.layerName,INFO_FORMAT:a.layerConfig.featureInfo.mimeType}),new b({url:a.wmsLayer.url.split("?")[0],content:h,handleAs:"text"})}catch(i){}}),d.publish(a.GUI.SUBPANEL_OPEN,{content:"",origin:"wmsFeatureInfo",update:!0,guid:"wms-guid"}),c(j).then(function(b){var c=b.map(function(a,b){var c="<h5 class='margin-top-none'>"+i[b].layerConfig.displayName+"</h5>"+RAMP.plugins.featureInfoParser[i[b].layerConfig.featureInfo.parser](a,i[b].wmsLayer.id);return c}).join(""),e='<section id="wms-results-large" class="mfp-hide modal-dialog modal-content overlay-def">{0}<div class="modal-body">{1}</div></section>'.format(h,c);$(".sub-panel").on("click","#wms-expand",function(){$(document).trigger("open.wb-lbx",[{src:"#wms-results-large",type:"inline"}]),$("#wms-results-large").css("width",Math.round(.9*window.innerWidth)+"px"),$("#wms-results-large .modal-body").css("height",Math.round(.75*window.innerHeight)+"px")}),d.publish(a.GUI.SUBPANEL_OPEN,{content:'{0}{1}<a id="wms-expand" href="#wms-results-large" role="button" aria-controls="wms-results-large">{2}</a>'.format(e,c,i18n.t("gui.actions.expand")),origin:"wmsFeatureInfo",update:!0,guid:"wms-guid"})},function(b){d.publish(a.GUI.SUBPANEL_OPEN,{content:String.format("<em>{0}</em>",i18n.t("mapClickHandler.getFiFailed")),origin:"wmsFeatureInfo",update:!0,guid:"wms-guid"})})))})},registerWMSClick:function(a){f.push(a)}}});