/*! ramp-theme-intranet 21-11-2014 12:49:12 : v. 4.0.0 
 * 
 * RAMP GIS viewer - Dragonfly; Sample of an implementation of RAMP with Intranet Theme 
 **/
define(["dojo/_base/declare","dojo/_base/lang","dojo/query","dojo/_base/array","dojo/on","dojo/dom","dojo/dom-class","dojo/dom-style","dojo/dom-construct","dojo/_base/connect","dojo/Deferred","dojo/topic","dojo/aspect","dojo/promise/all","dojo/text!./templates/filter_manager_template.json","dojo/text!./templates/filter_wms_meta_Template.json","esri/tasks/query","esri/layers/FeatureLayer","esri/layers/WMSLayer","ramp/ramp","ramp/globalStorage","ramp/map","ramp/eventManager","ramp/theme","utils/tmplHelper","utils/util","utils/array","utils/dictionary","utils/popupManager","utils/checkbox","utils/checkboxGroup"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E){"use strict";function F(){l.subscribe(w.GUI.TAB_DESELECTED,function(a){"filterManager"===a.tabName&&l.publish(w.GUI.SUBPANEL_CLOSE,{origin:"filterManager"})})}var G,H="layer-id",I=function(){function a(){var a,b;a=new E(h.find(".checkbox-custom .box + input"),{nodeIdAttr:H,cssClass:{active:"active",focus:"focused",check:"checked"},label:{check:i18n.t("filterManager.hideBounds"),uncheck:i18n.t("filterManager.showBounds")},onChange:function(){x.tooltipster(this.labelNode.parent(),null,"update")},master:{node:i.find(".checkbox-custom .box + input"),nodeIdAttr:"id",label:{check:i18n.t("filterManager.hideAllBounds"),uncheck:i18n.t("filterManager.showAllBounds")}}}),a.setEachState(function(a){var b=t.getLayerConfigWithId(a.node.data(H));return b.settings.boundingBoxVisible}),a.on(a.event.MEMBER_TOGGLE,function(a){l.publish(w.FilterManager.BOX_VISIBILITY_TOGGLED,{id:a.checkbox.id,state:a.checkbox.state})}),a.on(a.event.MASTER_TOGGLE,function(a){}),l.subscribe(w.FilterManager.TOGGLE_BOX_VISIBILITY,function(b){a.setState(b.state,b.layerId)}),b=new E(h.find(".checkbox-custom .eye + input"),{nodeIdAttr:H,cssClass:{active:"active",focus:"focused",check:"checked"},label:{check:i18n.t("filterManager.hideFeatures"),uncheck:i18n.t("filterManager.showFeatures")},onChange:function(){x.tooltipster(this.labelNode.parent(),null,"update")},master:{node:i.find(".checkbox-custom .eye + input"),nodeIdAttr:"id",label:{check:i18n.t("filterManager.hideAllFeatures"),uncheck:i18n.t("filterManager.showAllFeatures")}}}),b.setEachState(function(a){var b=t.getLayerConfigWithId(a.node.data(H));return b.settings.visible}),b.on(b.event.MEMBER_TOGGLE,function(a){l.publish(w.FilterManager.LAYER_VISIBILITY_TOGGLED,{id:a.checkbox.id,state:a.checkbox.state})}),b.on(b.event.MASTER_TOGGLE,function(a){}),l.subscribe(w.FilterManager.TOGGLE_LAYER_VISIBILITY,function(a){b.setState(a.state,a.layerId)})}function b(){x.tooltipster(i),x.tooltipster(h),C.registerPopup(h,"hoverIntent",function(){this.target.attr("title")&&(this.target.isOverflowed()?this.target.tooltipster({theme:".tooltipster-dark"}).tooltipster("show"):this.target.removeAttr("title"))},{handleSelector:".layer-name span, .layer-details span",useAria:!1,timeout:500})}function c(){function a(){z.adjustWidthForSrollbar(h.parent(),[i])}function b(){var a=e.length,b=e.filter(":hidden").length;0===b?c.open():b===a&&c.close()}var c,d=i.find(".global-button"),e=h.find(".layerList-container:hidden"),f=h.find("button.legend-button");f.map(function(){var c=$(this),d=c.parents("fieldset").find("> .layerList-container");C.registerPopup(c,"state-expanded",d,"click",function(c){d.slideToggle(400,function(){a(),b(),c.resolve()})},"same")}),c=C.registerPopup(d,"state-expanded",e,"click",function(b){e.slideDown(400,function(){f.addClass("state-expanded"),a(),b.resolve()})},function(b){e.slideUp(400,function(){f.removeClass("state-expanded"),$("#tabs1_1-parent").scrollTop(0),a(),b.resolve()})}),C.registerPopup(h,"hover, focus",function(a){a.resolve()},{handleSelector:"li.layerList1:not(.list-item-grabbed):not(.ui-sortable-helper)",targetSelector:":tabbable",activeClass:"bg-very-light",useAria:!1}),C.registerPopup(h,"click",function(b){this.target.slideToggle("fast",function(){a(),b.resolve()}),this.target.find(".nstSlider").nstSlider("refresh")},{handleSelector:".settings-button",targetContainerSelector:"li.layerList1",targetSelector:".filter-row-settings",activeClass:"button-pressed"}),C.registerPopup(h,"click",function(b){this.target.slideToggle("fast",function(){a(),b.resolve()})},{handleSelector:".renderer-button",targetContainerSelector:"li.layerList1",targetSelector:".renderer-list",activeClass:"button-pressed"}),h.find("legend button.metadata-button").on("click",function(){var a=$(this),b=a.parents("legend");if(b.hasClass("selected-row"))l.publish(w.GUI.SUBPANEL_CLOSE,{origin:"filterManager"});else{var c,d=a.data("layer-id"),e=t.getLayerConfigWithId(d);if(l.publish(w.GUI.SUBPANEL_OPEN,{panelName:i18n.t("filterManager.metadata"),title:b.find(".layer-name span").text(),content:null,target:b.find(".layer-details"),origin:"filterManager",guid:d,doOnOpen:function(){b.addClass("selected-row")},doOnHide:function(){h.find(".selected-row").removeClass("selected-row")}}),e.layerInfo)if(e.legend){var f;tmpl.cache={},tmpl.templates=JSON.parse(y.stringifyTemplate(p)),f=tmpl("wms_meta_main",{legendUrl:e.legend.imageUrl,getCapabilitiesUrl:e.url+"&request=GetCapabilities"}),l.publish(w.GUI.SUBPANEL_OPEN,{content:$(f),origin:"filterManager",update:!0,guid:d})}else l.publish(w.GUI.SUBPANEL_OPEN,{content:"<p>"+i18n.t("filterManager.metadataNotFound")+"</p>",origin:"filterManager",update:!0,guid:d});else c="assets/metadata/"+d+".xml",z.transformXML(c,"assets/metadata/xstyle_default_"+G.lang+".xsl",function(a,b){a?l.publish(w.GUI.SUBPANEL_OPEN,{content:"<p>"+i18n.t("filterManager.metadataNotFound")+"</p>",origin:"filterManager",update:!0,guid:d}):l.publish(w.GUI.SUBPANEL_OPEN,{content:$(b),origin:"filterManager",update:!0,guid:d})})}}),a()}function e(){h.scroll(function(){var a=h.scrollTop();0===a?i.removeClass("scroll"):i.addClass("scroll")})}function f(){h=$("#layerList > ul");var a=h.parent().find(".layer-group-separator"),b=h.filter(function(a,b){return $(b).find("> li").length>1}),c=function(a,b){var c=b.item[0].id,e=h.map(function(a,b){return $(b).find("> li").toArray().reverse()}).map(function(a,b){return b.id}),f=d.indexOf(e,c);l.publish(w.GUI.SUBPANEL_CLOSE,{origin:"rampPopup,datagrid"}),l.publish(w.FilterManager.SELECTION_CHANGED,{id:c,index:f})},e=function(){h.removeClass("sort-active").removeClass("sort-disabled"),a.removeClass("active")},f=function(b,c){h.has(c.item).addClass("sort-active").end().filter(":not(.sort-active)").addClass("sort-disabled"),c.item.removeClass("bg-very-light"),a.addClass("active")};b.sortable({axis:"y",handle:".sort-handle",placeholder:"sortable-placeholder",update:c,stop:e,start:f}),z.keyboardSortable(b,{linkLists:!0,onUpdate:c,onStart:f,onStop:e})}var g,h,i,j;return j=function(){function a(){var a;a=h.find(".nstSlider").nstSlider({left_grip_selector:".leftGrip",rounding:.01,highlight:{grip_class:"gripHighlighted",panel_selector:".highlightPanel"},value_changed_callback:function(a,b){var c,d=$(this),e=d.data(H),f=Math.round(100*b)+"%";d.parent().find(".leftLabel").text(f).end().end().nstSlider("highlight_range",0,b),l.publish(w.FilterManager.LAYER_TRANSPARENCY_CHANGED,{layerId:e,value:b}),c=0===b?!1:d.hasClass("disabled")?!0:c,z.isUndefined(c)||l.publish(w.FilterManager.TOGGLE_LAYER_VISIBILITY,{state:c,layerId:e})}}),l.subscribe(w.FilterManager.LAYER_VISIBILITY_TOGGLED,function(b){var c,d=a.filter("[data-layer-id='"+b.id+"']");d.length>0&&(d.toggleClass("disabled",!b.state),c=d.nstSlider("get_current_min_value"),0===c&&b.state&&d.nstSlider("set_position",1))})}return{init:function(){a()}}}(),{init:function(){tmpl.cache={},tmpl.templates=JSON.parse(y.stringifyTemplate(o));var h,k,m=v.getMap().getLayersVisibleAtScale().reverse(),n={feature:[],wms:[]};d.forEach(m,function(a){var b=null;a.ramp.type===u.layerType.WMS?(a.layerConfig=t.getLayerConfigWithId(a.id),a.layerConfig.legendMimeType&&(a.layerConfig.legend={type:"wms",imageUrl:String.format("{0}?SERVICE=WMS&REQUEST=GetLegendGraphic&TRANSPARENT=true&VERSION=1.1.1&FORMAT={2}&LAYER={3}",a.layerConfig.url,a.version,a.layerConfig.legendMimeType,a.layerConfig.layerName)}),n.wms.push(a)):(a.ramp.type===u.layerType.Feature||a.ramp.type===u.layerType.Static)&&(a.layerConfig=t.getLayerConfig(a.url,b),n.feature.push(a))}),h={config:RAMP.config,layerGroups:{feature:y.dataBuilder(n.feature),wms:y.dataBuilder(n.wms)}},g=$("#"+RAMP.config.divNames.filter),k=tmpl("filter_manager_template",h),g.addClass("animated fadeOut"),window.setTimeout(function(){g.empty().append(k).removeClass("fadeOut").addClass("animated fadeIn"),window.setTimeout(function(){g.removeClass("animated fadeIn")},300),i=$("#filterGlobalToggles"),f(),a(),b(),c(),e(),j.init(),l.publish(w.FilterManager.UI_COMPLETE)},300)}}}();return{init:function(){G=RAMP.config,F(),I.init()},_getFeatures:function(a){var b=new q;return b.returnGeometry=!1,b.maxAllowableOffset=1e3,b.where=a.objectIdField+">0",a.queryFeatures(b)},_getField:function(a,b){var c=new k;return this._getFeatures(a).then(function(a){c.resolve(d.map(a.features,function(a){return a.attributes[b]}))}),c.promise}}});