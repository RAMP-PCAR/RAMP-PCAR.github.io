/*! ramp-gis-viewer 03-07-2014 : v. 1.0.42-7 

 * RAMP GIS viewer - ArcticFox; Sample of an implementation of RAMP 
 **/
define(["dojo/_base/array","dojo/topic","dojo/_base/lang","dojo/Deferred","ramp/globalStorage","ramp/eventManager","themes/theme","dojo/text!./templates/sub_panel_Template.html","dojo/text!./templates/sub_panel_template.json","dojo/text!./templates/sub_panel_content_Template.html","utils/util","utils/dictionary","utils/popupManager","utils/tmplHelper","dojo/domReady!"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){"use strict";function o(a){var b=Object.create(C);return b._attr=Object.create(B),b.create(a),b}function p(a){var b,e=new d;e.then(function(){a=b.getAttributes(),b=A[a.origin],b.open(),b.getPanel().find(".sub-panel-toggle").on("click",c.hitch(this,function(){q(a)})),z.animate({right:b.getPanel().width()+6},"easeOutCirc")}),a.consumeOrigin&&A[a.consumeOrigin]&&(b=A[a.consumeOrigin],b.changeOrigin(a.origin),b.shiftTarget(a.target),delete A[a.consumeOrigin],A[a.origin]=b),A[a.origin]?A[a.origin].update(a):a.update||(b=o(a),A[a.origin]=b,k.executeOnDone(A,function(b,c){b&&b.getOrigin()!==a.origin?q({origin:b.getOrigin()},200,c):c.resolve(!0)},e))}function q(a,b,c){var e=new d(function(){c&&c.cancel()});e.then(function(){delete A[a.origin],c&&c.resolve(!0)}),A[a.origin]&&(A[a.origin].destroy(b,e),z.animate({right:3},"easeOutCirc"))}function r(a){var b=a.target||v.getPanelContainer(),c=A[a.origin];c&&c.shiftTarget(b)}function s(a){var b;a.consumeOrigin===a.origin&&A[a.consumeOrigin]?(b=A[a.origin],b.shiftTarget(a.target)):a.consumeOrigin&&A[a.consumeOrigin]&&(b=A[a.consumeOrigin],b.changeOrigin(a.origin),b.shiftTarget(a.target),delete A[a.consumeOrigin],A[a.origin]=b)}var t,u,v,w=$(window),x=$("ul#tabs"),y=$("#mapContent"),z=y.find("#map-load-indicator"),A={},B={panelName:"",title:"",content:null,templateKey:"summary_sub_panel_container",target:null,origin:"",guid:"",update:!1,doOnOpen:null,doAfterOpen:null,doOnHide:null,doAfterHide:null,doOnDestroy:null,doAfterUpdate:null,showChars:170},C={_closing:!1,_destroyDeferred:null,_attr:null,_visible:!1,container:null,panel:null,_subPanelContentDiv:null,_panelTitle:null,_panelContentDiv:null,_animatePanelDuration:500,timeLine:null,parseContent:function(a){return("object"===jQuery.type(a)?a:$(a)).find(".shorten-candidate").shorten({showChars:this._attr.showChars}).removeClass("shorten-candidate").end()},getAttributes:function(){return this._attr},getContainer:function(){return this.container},getPanel:function(){return this.panel},getOrigin:function(){return this._attr.origin},getGuid:function(){return this._attr.guid},destroy:function(a,b){this._attr.doOnHide&&this._attr.doOnHide(),this._closing=!0,this._destroyDeferred=b,this._subPanelContentDiv.find(".fadeInDown").removeClass("fadeInDown"),v.getPanelContainer().before(this.container),v.subPanelChange(!1,this._attr.origin,this.container,!1),this.timeLine.eventCallback("onReverseComplete",function(){this._attr.doAfterHide&&this._attr.doAfterHide(),this._attr.doOnDestroy&&this._attr.doOnDestroy(),this._visible=!1,v.subPanelChange(!1,this._attr.origin,null,!0),this.container.remove(),b&&b.resolve(!0)},[],this),this.timeLine.reverse()},reopen:function(){this.timeLine.pause(),this._closing=!1,this._destroyDeferred&&(this._destroyDeferred.cancel(),this._destroyDeferred=null),this.open()},open:function(){this._attr.doOnOpen&&this._attr.doOnOpen(),this._visible=!0,v.subPanelChange(!0,this._attr.origin,this.container,!1),this.timeLine.play()},changeOrigin:function(a){this._attr.origin=a},shiftTarget:function(a){this._attr.target!==a&&(this._subPanelContentDiv.find(".fadeInDown").removeClass("fadeInDown"),a.after(this.container),this._attr.target=a)},create:function(a){var b,d;a.guid=a.guid||k.guid(),c.mixin(this._attr,a),tmpl.cache={},tmpl.templates=i,b=tmpl(this._attr.templateKey,c.mixin(this._attr,{closeTitle:e.config.stringResources.txtClose})),this.container=this._attr.target.after(b).parent().find(".sub-panel-container"),this.panel=this.container.find(".sub-panel"),this._subPanelContentDiv=this.panel.find(".sub-panel-content"),this._panelTitle=this.panel.find(".panel-title"),this._panelContentDiv=this.panel.find(".panel-content-div"),d=this.parseContent(this._attr.content),this._panelContentDiv.empty().append(d),this.timeLine=new TimelineLite({paused:!0,onComplete:function(){this._attr.doAfterOpen&&this._attr.doAfterOpen(),v.subPanelChange(!0,this._attr.origin,this.container,!0)},onCompleteScope:this}).to(this.panel,this._animatePanelDuration/1e3,{left:0,ease:"easeOutCirc"}),g.tooltipster(this.container),this.update(this._attr)},update:function(a){var b=300,e='<ul class="loadingAnimation"><li></li><li></li><li></li><li></li><li></li><li></li></ul>',f=[new d,new d],g=function(a,d,e){d&&(a.addClass("animated fadeOutDown"),window.setTimeout(c.hitch(this,function(){a.empty().append(d).removeClass("fadeOutDown").addClass("animated fadeInDown"),e.resolve()}),b))},h=function(a,b,c,d,f,h){c=null===c?d=e:c,c&&c!==b?f?g(a,d,h):(a.empty().append(d),h.resolve()):h.resolve()},i=c.hitch(this,function(a){this._subPanelContentDiv.animate({scrollTop:0},b,"easeOutCirc"),h(this._panelTitle,this._attr.title,a.title,a.title,this._visible,f[0]),h(this._panelContentDiv,this._attr.content,a.content,this.parseContent(a.content),this._visible,f[1]),c.mixin(this._attr,a)});k.afterAll(f,function(){a.doAfterUpdate&&a.doAfterUpdate()}),this._closing&&!a.update?(this._attr.guid!==a.guid&&(this._attr.doOnHide&&this._attr.doOnHide(),this._attr.doAfterHide&&this._attr.doAfterHide(),a.target.after(this.container),i(a)),this.reopen()):this._closing||(a.update||this._attr.guid===a.guid||(this._attr.doOnHide&&this._attr.doOnHide(),this._attr.doAfterHide&&this._attr.doAfterHide(),a.target.after(this.container),i(a),a.doOnOpen&&a.doOnOpen(),a.doAfterOpen&&a.doAfterOpen()),this._attr.guid===a.guid&&i(a))}},D=$("#helpToggle"),E=$("#help-section-container"),F=$("#help-section"),G=$("#addLayer-toggle"),H=$("#addLayer-section-container"),I="button-pressed",J="state-expanded",K=.5;return v=function(){function a(){F.css({"max-height":w.height()-(G?.2*w.height():y.offset().top)-90})}function c(){a(),r()}function d(){return p||(p=B.width()),p}function h(a){b.publish(f.GUI.PANEL_CHANGE,{visible:a})}function i(a){I.eventCallback("onReverseComplete",function(){r(),h(!0),C.tooltipster("content",e.config.stringResources.txtClose).find("span.wb-invisible").text(e.config.stringResources.txtClose),a.resolve()},[],this),I.reverse()}function j(a){I.eventCallback("onComplete",function(){k.subscribeOnce("map/update-end",function(){h(!1)}),r(),C.tooltipster("content",e.config.stringResources.txtOpen).find("span.wb-invisible").text(e.config.stringResources.txtOpen),a.resolve()},[],this),I.play()}function n(a){G=k.isUndefined(a)?!G:G,G?(TweenLite.fromTo(B,K,{width:430,right:0,left:"auto"},{left:35,right:0,width:"auto",ease:"easeOutCirc"}),H.play()):(TweenLite.fromTo(B,K,{left:35,width:"auto",right:B.css("right")},{right:0,width:430,ease:"easeInCirc"}),H.reverse()),l.forEachEntry(A,function(a){q({origin:a})})}var o,p,r,s=$(".viewport"),t=$("#map-div"),u=$("#mapContent"),x=$("#fullScreenToggle"),y=$("#map-toolbar"),z=$("#basemapControls"),B=$("#panel-div"),C=$("#panel-toggle"),D=.5,E=!1,G=!1,H=new TimelineLite({paused:!0,onComplete:function(){a(),r()},onReverseComplete:function(){a(),r()}}),I=new TimelineLite({paused:!0}),L=new TimelineLite({paused:!0});return r=function(){G||b.publish(f.GUI.LAYOUT_CHANGE)},H.set(s,{className:"+=full-data-mode"}).fromTo(t,K,{width:"auto"},{right:"auto",width:35,ease:"easeOutCirc"},0).fromTo(u,K,{opacity:1},{opacity:0,ease:"easeOutCirc"},0).set(u,{top:"500px"}).to(C,K,{right:-13,ease:"easeOutCirc"},0).set(C,{display:"none"}).to(z,K/2,{opacity:0,ease:"easeOutCirc"},0).to(z,0,{display:"none"},K/2).fromTo(y,K/2,{width:"100%",height:"31px"},{width:31,height:$("#map-div").height(),ease:"easeOutCirc"},D/2).to(y.find(".map-toolbar-item-button span"),K/2,{width:0,ease:"easeOutCirc"},0).set(y.find(".map-toolbar-item-button span"),{display:"none"},K/2).fromTo(B.find(".tabs li:first"),K,{width:"50%"},{width:"0%",ease:"easeOutCirc"},0).fromTo(B.find(".tabs li:last"),K,{width:"50%"},{width:"100%",className:"+=font-large",ease:"easeOutCirc"},0),I.fromTo(B,K,{right:0},{right:-d(),ease:"easeOutCirc"},0).set(B,{display:"none"},K).fromTo(t,K,{right:d()},{right:0,ease:"easeOutCirc"},0),L.fromTo(B,K,{right:"0px",left:"35px"},{left:"35px",right:"430px",ease:"easeOutCirc"}),{init:function(){o=m.registerPopup(C,"click",i,{activeClass:J,closeHandler:j}),b.subscribe(f.GUI.PANEL_TOGGLE,function(){o.toggle()}),g.fullScreenCallback("onComplete",c).fullScreenCallback("onReverseComplete",c),u.height()<.6*w.height()&&g.toggleFullScreenMode(!0),x.click(function(){g.toggleFullScreenMode()}),a()},isFullScreen:function(){return E},toggleFullScreenMode:function(a){g.toggleFullScreenMode(a)},isFullData:function(){return G},toggleFullDataMode:function(a){n(a)},subPanelChange:function(a,c,d,e){H.isActive()||!G||e||(a?L.play(0):a||L.reverse()),e||(a?C.hide():C.show()),b.publish(f.GUI.SUBPANEL_CHANGE,{visible:a,origin:c,container:d,offsetLeft:d?d.width()+25+v.getPanelWidth():v.getPanelWidth(),isComplete:e})},getPanelContainer:function(){return B},getPanelWidth:function(){return B.filter(":visible").width()}}}(),{load:function(d,e,g){i=JSON.parse(n.stringifyTemplate(i)),v.init(),t=m.registerPopup(D,"click",function(a){b.publish(f.GUI.HELP_PANEL_CHANGE,{visible:!0}),b.publish(f.GUI.TOOLBAR_SECTION_OPEN,{id:"help-section"}),k.subscribeOnce(f.GUI.TOOLBAR_SECTION_OPEN,c.hitch(this,function(){this.isOpen()&&this.close()})),E.slideToggle("fast",function(){a.resolve()})},{activeClass:I,target:E,closeHandler:function(a){b.publish(f.GUI.HELP_PANEL_CHANGE,{visible:!1}),b.publish(f.GUI.TOOLBAR_SECTION_CLOSE,{id:"help-section"}),E.slideToggle("fast",function(){a.resolve()})}}),u=m.registerPopup(G,"click",function(a){b.publish(f.GUI.ADD_LAYER_PANEL_CHANGE,{visible:!0}),b.publish(f.GUI.TOOLBAR_SECTION_OPEN,{id:"add-layer-section"}),k.subscribeOnce(f.GUI.TOOLBAR_SECTION_OPEN,c.hitch(this,function(){this.isOpen()&&this.close()})),H.slideToggle("fast",function(){a.resolve()})},{activeClass:I,target:H,closeHandler:function(a){b.publish(f.GUI.ADD_LAYER_PANEL_CHANGE,{visible:!1}),b.publish(f.GUI.TOOLBAR_SECTION_CLOSE,{id:"add-layer-section"}),H.slideToggle("fast",function(){a.resolve()})}}),$("#addLayer-add").on("click",function(){b.publish(f.Map.ADD_LAYER,null),H.slideToggle("fast")}),b.subscribe("gui/grid/expand",function(){v.toggleFullDataMode()}),b.subscribe(f.GUI.TOGGLE_FULLSCREEN,function(a){v.toggleFullScreenMode(a.expand)}),b.subscribe(f.GUI.SUBPANEL_OPEN,function(a){p(a)}),b.subscribe(f.GUI.SUBPANEL_CLOSE,function(b){"all"===b.origin?l.forEachEntry(A,function(a){q({origin:a})}):a.forEach(b.origin.split(","),function(a){q({origin:a})})}),b.subscribe(f.GUI.SUBPANEL_DOCK,function(b){var c;"all"===b.origin?l.forEachEntry(A,function(a){c=Object.create(b),c.origin=a,r(c)}):a.forEach(b.origin.split(","),function(a){c=Object.create(b),c.origin=a,r(c)})}),b.subscribe(f.GUI.SUBPANEL_CAPTURE,function(b){var c;"all"===b.consumeOrigin?l.forEachEntry(A,function(a){c=Object.create(b),c.consumeOrigin=a,s(c)}):a.forEach(b.consumeOrigin.split(","),function(a){c=Object.create(b),c.consumeOrigin=a,s(c)})}),x.find("li a").click(function(){b.publish(f.GUI.TAB_SELECTED,{id:this.id,tabName:this.attributes["data-panel-name"].value}),x.find("li:not(.active) a").each(function(){b.publish(f.GUI.TAB_DESELECTED,{id:this.id,tabName:this.attributes["data-panel-name"].value})})}),g()}}});