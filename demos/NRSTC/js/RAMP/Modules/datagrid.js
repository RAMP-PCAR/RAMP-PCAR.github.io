/*! ramp-gis-viewer 03-07-2014 : v. 1.0.42-7 

 * RAMP GIS viewer - ArcticFox; Sample of an implementation of RAMP 
 **/
define(["dojo/_base/declare","dojo/_base/lang","dojo/query","dojo/_base/array","dojo/dom-class","dojo/dom-attr","dojo/dom-construct","dojo/topic","dojo/on","dojo/Deferred","dojo/text!./templates/datagrid_template.json","dojo/text!./templates/extended_datagrid_template.json","esri/layers/FeatureLayer","esri/tasks/query","ramp/ramp","ramp/graphicExtension","ramp/globalStorage","ramp/datagridClickHandler","ramp/map","ramp/eventManager","themes/theme","utils/util","utils/array","utils/dictionary","utils/popupManager","utils/tmplHelper"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z){"use strict";function A(){var a=L.rows().data();T={},$.each(a,function(a,b){var c=b.last().featureUrl,d=p.getOid(b.last().feature);c in T||(T[c]={}),T[c][d]=a})}function B(a){return o.getLayerConfig(a).datagrid}function C(a,b){("keypress"===a.type&&13===a.keyCode||"click"===a.type)&&b()}function D(a){var b={},c=s.getVisibleFeatureLayers(),e=Y.getDatagridMode(),f=new n;e===Q&&(c=d.filter(c,function(a){return a.url===Y.getSelectedDatasetUrl()})),f.geometry=s.getMap().extent,f.outFields=["*"];var g=d.map(c,function(a){return a.queryFeatures(f).then(function(a){if(a.features.length>0){var c=a.features[0].getLayer(),d=c.url;c.visible||e!==P?b[d]=a.features:delete b[d]}})});v.afterAll(g,function(){F(b),a&&a.resolve()})}function E(a){var b,c=a.getLayer().url;if(Y.getDatagridMode()===P)b=[a.attributes[o.getLayerConfig(c).nameField]];else{b=[];var e=B(c).gridColumns;d.forEach(e,function(c){b.push(a.attributes[c.fieldName]||"")})}return b.push({featureUrl:c,layerName:o.getLayerConfig(c).displayName,feature:a}),b}function F(a){if(M.DataTable().clear(),Object.keys(a).isEmpty())return void M.DataTable().draw();var b=[];x.forEachEntry(a,function(a,c){b=b.concat(d.map(c,function(a){return a[Y.getDatagridMode()]?a[Y.getDatagridMode()]:a[Y.getDatagridMode()]=E(a)}))}),L.one("draw.dt",function(){h.publish(t.Datagrid.EXTENT_FILTER_END)}),M.dataTable().fnAddData(b)}function G(a){var b=a.data(X),c=parseInt(a.data(W)),d=s.getFeatureLayer(b),e=w.binaryFind(d.graphics,function(a){return p.getOid(a)-c});return e}function H(){h.subscribe(t.FilterManager.LAYER_VISIBILITY_TOGGLED,function(){V=!0}),h.subscribe(t.FilterManager.GLOBAL_LAYER_VISIBILITY_TOGGLED,function(){V=!0}),h.subscribe(t.GUI.TAB_SELECTED,function(a){"datagrid"===a.tabName&&(V?(V=!1,D()):Y.capturePanel(),Y.adjustPanelWidth())}),h.subscribe(t.GUI.TAB_DESELECTED,function(a){"datagrid"===a.tabName&&h.publish(t.GUI.SUBPANEL_DOCK,{origin:"datagrid"})}),h.subscribe(t.Datagrid.APPLY_EXTENT_FILTER,function(){Y.isReady()?Y.getDatagridMode()!==Q&&D():Y.init()}),h.subscribe(t.GUI.SUBPANEL_CHANGE,function(a){"ex-datagrid"===a.origin&&a.isComplete&&Y.adjustPanelWidth()})}var I,J,K,L,M,N,O,P="summary",Q="full",R=JSON.parse(z.stringifyTemplate(k)),S=JSON.parse(z.stringifyTemplate(l)),T={},U="asc",V=!0,W="feature-oid",X="feature-url",Y=function(){function a(a){var b=-1,c=null;return{focusedButton:null,isActive:function(){return null!==c},isEqual:function(a,b){var d=c.getLayer().url,e=p.getOid(c);return d===a&&e===b},navigateToRow:function(){if(-1!==b){var a=Math.floor(b/K.rowsPerPage);return L.page()!==a&&M.DataTable().page(a).draw(!1),eb.scrollTo(this.getNode(),300,{axis:"y",offset:{left:0,top:1.5*-this.getNode().height()}}),!0}return!1},setGraphic:function(a){c=a,this.refresh()},refresh:function(){if(c){var a=c.getLayer().url,d=p.getOid(c);b=a in T&&d in T[a]?T[a][d]:-1}else b=-1},getNode:function(){return $(String.format("#jqgrid tbody tr:nth-child({0})",b%K.rowsPerPage+1))},activate:function(){c&&(this.getNode().addClass(a),this.focusedButton&&(this.getNode().find(this.focusedButton).focus(),this.focusedButton=null))},deactivate:function(){c&&(this.getNode().removeClass(a),c=null)}}}function c(){var a={buttonLabel:I.stringResources.txtSort,classAddition:"font-medium global-button",someAttribute:""};return a}function e(a,b,c,e){var f,g=c.last(),h=Y.getDatagridMode();if(h===P){if(v.isUndefined(g[h])){var i=B(g.featureUrl).summaryRowTemplate;tmpl.cache={},tmpl.templates=R,f=z.dataBuilder(g.feature,g.featureUrl),g[h]=tmpl(i,f)}return g[h]}if(v.isUndefined(g[h])){g[h]=[];var j=B(g.featureUrl).gridColumns;tmpl.cache={},tmpl.templates=S,f=z.dataBuilder(g.feature,g.featureUrl),d.forEach(j,function(a,b){f.columnIdx=b;var c=tmpl(a.columnTemplate,f);"numeric"===a.sortType&&(c=Number(c)),g[h].push(c)})}return g[h][e.col]}function f(){var a,c={info:!1,columnDefs:[],autoWidth:!1,deferRender:!0,paging:!0,pagingType:"ramp",scrollX:!0,destroy:!0,searching:!1,pageLength:K.rowsPerPage,language:I.gridstrings};c=mb===P?b.mixin(c,{columns:[{title:"Name",width:"300px",type:"string",className:"",render:e,orderable:!0}],dom:'<"jqgrid_table_wrapper summary-table"t><"status-line"p>'}):b.mixin(c,{columns:d.map(B(Y.getSelectedDatasetUrl()).gridColumns,function(a){return{title:a.title,width:a.width?a.width:"100px",type:a.sortType,className:a.alignment?"":"center",render:e}}),dom:'<"jqgrid_table_wrapper full-table"t><"status-line"p>',scrollY:"500px"}),M=_.find("table");var f=!1;L=M.DataTable(c).on("page.dt",function(){h.publish(t.GUI.SUBPANEL_DOCK,{origin:"datagrid,ex-datagrid"}),f=!0}).on("order.dt",function(){h.publish(t.GUI.SUBPANEL_DOCK,{origin:"datagrid,ex-datagrid"})}).on("draw.dt",function(){A(),f?f=!1:Y.activateRows(),Y.adjustPanelWidth(),h.publish(t.Datagrid.DRAW_COMPLETE)}),db=_.find("#jqgrid_wrapper"),eb=_.find(".jqgrid_table_wrapper"),fb=_.find(".dataTables_scroll"),gb=fb.find(".dataTables_scrollBody"),hb=fb.find(".dataTables_scrollHead"),u.tooltipster(db),mb!==P&&(gb.height(eb.height()-hb.height()),a=M.outerWidth(),Y.adjustPanelWidth(),M.forceStyle({width:a+"px"}))}function g(){y.registerPopup(_,"hoverIntent",function(){this.target.attr("title")&&(this.target.isOverflowed()?this.target.tooltipster({theme:".tooltipster-dark"}).tooltipster("show"):this.target.removeAttr("title"))},{handleSelector:".point-name, .category-name, .title-span",useAria:!1,timeout:500})}function i(){_.on("click","button.details",function(){var a=$(this),b=a.data(X),c=a.data(W);if(kb.focusedButton="button.details",kb.isActive()&&kb.isEqual(b,c))r.onDetailDeselect(mb);else{var d=G(a);r.onDetailSelect(a,d,mb)}}),_.on("click","button.zoomto",function(a){var b=$(this);lb.focusedButton="button.zoomto",b.text()===I.stringResources.txtGrid_zoomTo?C(a,function(){N=G(b),O=s.getMap().extent.clone(),r.onZoomTo(s.getMap().extent.clone(),N),v.subscribeOnce(t.Datagrid.EXTENT_FILTER_END,function(){var a=$(String.format("button.zoomto[data-{0}='{1}'][data-{2}='{3}']:eq(0)",W,p.getOid(N),X,N.getLayer().url));a.text(I.stringResources.txtGrid_zoomBack)})}):(r.onZoomBack(N),b.text(I.stringResources.txtGrid_zoomTo))}),_.on("click","button.global-button",function(){var a=$(this);"asc"===U?(a.addClass("state-expanded"),U="desc"):(a.removeClass("state-expanded"),U="asc"),M.DataTable().order([0,U]).draw()}),_.on("click","button.expand",function(){var a=new j;mb=mb===P?Q:P,a.then(function(){k()}),F(a),h.publish("gui/grid/expand")}),_.on("change","#datasetSelector",function(){var a=$(this),b=a.find("option:selected"),c=b[0].value===ab;x(c)}),_.on("click","#datasetSelectorSubmitButton",function(){var a=ib.find("option:selected");ab=a.length>0?a[0].value:"",E()}),y.registerPopup(_,"hover, focus",function(a){this.target.removeClass("wb-invisible"),a.resolve()},{handleSelector:"tr",targetSelector:".record-controls",closeHandler:function(a){this.target.addClass("wb-invisible"),a.resolve()},activeClass:"background-light",useAria:!1}),y.registerPopup(_,"hover, focus",function(a){a.resolve()},{handleSelector:".full-table tr",activeClass:"background-light",useAria:!1}),y.registerPopup(_,"dblclick",function(a){var b=(this.handle.outerHeight()-this.target.height())/2;TweenLite.set(".expand-cell",{clearProps:"padding",className:"-=expand-cell"}),TweenLite.set(this.handle,{padding:b}),window.getSelection().removeAllRanges(),a.resolve()},{handleSelector:"td",targetSelector:".title-span",closeHandler:function(a){TweenLite.set(this.handle,{clearProps:"padding"}),TweenLite.set(this.handle,{className:"-=expand-cell"}),a.resolve()},activeClass:"expand-cell",useAria:!1})}function k(){var a,b;mb===P?eb.scroll(function(){a=eb.scrollTop(),b=fb.height()-eb.scrollTop()-eb.height(),0===a?cb.removeClass("scroll"):cb.addClass("scroll"),0===b?bb.removeClass("scroll"):bb.addClass("scroll")}):gb.scroll(function(){a=gb.scrollTop(),0===a?hb.removeClass("scroll"):hb.addClass("scroll")})}function l(a){m(),kb.setGraphic(a.graphic),a.scroll&&Y.activateRows()}function m(){kb.deactivate(),r.onZoomCancel()}function n(a){lb.setGraphic(a.graphic)}function o(){lb.deactivate()}function w(){h.subscribe(t.Datagrid.HIGHLIGHTROW_SHOW,l),h.subscribe(t.Datagrid.HIGHLIGHTROW_HIDE,m),h.subscribe(t.Datagrid.ZOOMLIGHTROW_SHOW,n),h.subscribe(t.Datagrid.ZOOMLIGHTROW_HIDE,o)}function x(a){var b;jb.attr("disabled",a).text(a?q.config.stringResources.txtDatasetSelectorButtonLoaded:q.config.stringResources.txtDatasetSelectorButtonLoad),b=d.filter(q.config.featureLayers,function(a){return a.url===ab}),Z&&b.length>0&&Z.text(": "+b[0].displayName)}function E(){var a,b=.2,c=new TimelineLite({paused:!0}),d=new j;tmpl.cache={},tmpl.templates=R,a=tmpl("datagrid_manager_table_Template",{tableId:"jqgrid",tableCss:"display table-condensed table-simplify animated fadeIn"}),kb.isActive()&&(b=.6,r.onDetailDeselect(mb)),c.set(db,{className:"+=animated fadeOut"}),c.call(function(){c.pause(),db.replaceWith(a),f(),x(!0),d.then(function(){c.set(M,{className:"-=animated fadeIn"},"+="+b),c.resume()}),D(d)},null,this,b+.05),c.set(db,{className:"-=fadeOut"}),c.set(db,{className:"+=fadeIn"}),c.set(db,{className:"-=animated fadeIn"},"+="+b),c.play()}function F(a){var d,e,g=c(),h={buttons:g,tableId:"jqgrid",tableCss:"display table-condensed table-simplify"},i=.5,k=new TimelineLite({paused:!0}),l=new j;tmpl.cache={},tmpl.templates=R,mb===P?(e="datagrid_manager_Template",h.buttons.toggleTitle=q.config.stringResources.txtFullData,Z&&Z.remove()):(e="datagrid_full_manager_Template",h.buttons=b.mixin(h.buttons,{datasets:q.config.featureLayers,toggleTitle:q.config.stringResources.txtDataSummary,txtDataset:q.config.stringResources.txtDataset}),Z=$("#tabs1_2-link").append("<span>").find("span")),d=tmpl(e,h),r.onDetailDeselect(mb),k.set(_,{className:"+=animated fadeOut"}),M&&k.set(M,{clearProps:"width"}),k.call(function(){k.pause(),_.empty().append(d),f(),cb=_.find("#datagridGlobalToggles"),bb=_.find(".status-line"),ib=$("#datasetSelector"),jb=$("#datasetSelectorSubmitButton"),x(!0),a.resolve(),l.then(function(){k.resume()}),D(l)},null,this,i+.1),k.set(_,{className:"-=fadeOut"}),k.set(_,{className:"+=fadeIn"}),k.set(_,{className:"-=animated fadeIn"},"+="+i),k.play()}function H(){kb.refresh(),lb.refresh(),kb.navigateToRow()||lb.navigateToRow(),lb.activate(),kb.activate(),J()}function J(){var a="datagrid",b=kb.getNode().find(".record-controls");mb===Q&&(a="ex-datagrid",b=kb.getNode().find(".button.details")),kb.isActive()&&h.publish(t.GUI.SUBPANEL_CAPTURE,{target:b,consumeOrigin:a,origin:a})}function V(){mb===P?v.adjustWidthForSrollbar(eb,[cb,bb]):M.outerWidth()===db.outerWidth()?gb.addClass("overflow-x-hidden"):gb.removeClass("overflow-x-hidden")}var Z,_,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb=a("selected-row"),lb=a("highlighted-row"),mb=P,nb=!1;return{init:v.once(function(){var a=new j;a.then(function(){nb=!0,g(),i(),k(),w()}),_=$("#"+q.config.divNames.datagrid),F(a)}),getDatagridMode:function(){return mb},getSelectedDatasetUrl:function(){return ab?ib.find("option[value='"+ab+"']").prop("selected",!0):ab=ib.find("option:selected").length>0?ib.find("option:selected")[0].value:q.config.featureLayers[0].url,ab},isReady:function(){return nb},adjustPanelWidth:V,activateRows:H,capturePanel:J}}();return{init:function(){I=q.config,J=I.featureLayers,K=J[0].datagrid,H()}}});