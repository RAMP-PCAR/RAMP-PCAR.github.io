/*! ramp-gis-viewer 24-06-2014 */
define(["dojo/_base/declare","require","dojo/dom-construct","dojo/io-query","dojo/_base/lang","dojo/dom","dojo/_base/array","dojo/topic","dijit/form/TextBox","dijit/TitlePane","esri/geometry/Extent","ramp/globalStorage","ramp/map","ramp/eventManager","utils/url","utils/util","utils/dictionary","utils/popupManager"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){"use strict";function s(){}function t(){}function u(a,b){W[a]=null===b?null:d.objectToQuery(b)}function v(a,b){X[a]=b}function w(a){var b=String.format(T,l.config.stringResources.txtEmailUrlSubject,l.config.stringResources.txtEmailUrlBody,encodeURIComponent(a));A.val(a),G.attr("href",b)}function x(){var a=I;q.forEachEntry(W,function(b,c){c&&(a+="&"+c)}),q.isEmpty(X)||(a+="&"),q.forEachEntry(X,function(b,c){a+="#"+c}),V?A.is(":visible")&&(H.show(),jQuery.urlShortener({longUrl:a,success:function(a){w(a),H.hide()},error:function(a){H.hide()}})):w(a)}function y(a){var b;V=a===!0?!0:a===!1?!1:!V,b=V?"long link":"short link",F.text(b),x()}var z,A,B,C,D,E,F,G,H,I,J="bookmarkLink/",K="extentChange",L="fullscreen",M="panelChange",N="selectedTab",O="basemapChange",P="globalLayer",Q="globalBox",R="activeLayers",S="activeBoxes",T="mailto:?subject={0}&body={1}%0D%0A%0D%0A{2}",U="button-pressed",V=!1,W={},X={},Y={},Z={},_={init:function(){H=$("#getlink-section .loadingAnimation"),G=$(".getlink-email-button"),C=$("#getlink-toggle"),D=$("#getlink-section-container"),E=$("#getlink-section"),A=$("#getlink-input").on("focus",function(){var a=$(this).one("mouseup.mouseupSelect",function(){return a.select(),!1}).one("mousedown",function(){a.off("mouseup.mouseupSelect")}).select()}),F=$(".getlink-shorten-button").on("click",y),B=r.registerPopup(C,"click",function(a){h.publish(n.BookmarkLink.GETLINK_PANEL_CHANGED,{visible:!0}),D.slideDown("fast",function(){a.resolve()})},{activeClass:U,target:D,closeHandler:function(a){h.publish(n.BookmarkLink.GETLINK_PANEL_CHANGED,{visible:!1}),D.slideUp("fast",function(){y(!1),a.resolve()})}}),h.subscribe(n.GUI.HELP_PANEL_CHANGE,function(a){B.isOpen()&&a.visible&&B.close()})}};return{init:function(a){var c=new o(b.toUrl(document.location));I=c.uri,-1===I.indexOf(a)&&(I+=a),I+="?lang="+l.config.lang,z=d.queryToObject(c.query),jQuery.urlShortener.settings.apiKey="AIzaSyB52ByjsXrOYlXxc2Q9GVpClLDwt0Lw6pc",s(),t(),_.init(),this.updateMap(),this.subscribeAndUpdate()},subscribeAndUpdate:function(){h.subscribe(n.Map.EXTENT_CHANGE,function(a){u(K,{xmin:a.extent.xmin,ymin:a.extent.ymin,xmax:a.extent.xmax,ymax:a.extent.ymax,sr:a.extent.spatialReference.wkid}),x()}),h.subscribe(n.GUI.FULLSCREEN_CHANGE,function(a){u(L,a),x()}),h.subscribe(n.GUI.TAB_SELECTED,function(a){v(N,a.id.replace("-link","")),x()}),h.subscribe(n.GUI.PANEL_CHANGE,function(a){u(M,{panelVisible:a.visible}),x()}),h.subscribe(n.BasemapSelector.BASEMAP_CHANGED,function(a){u(O,{baseMap:a.id}),x()}),h.subscribe(n.FilterManager.GLOBAL_LAYER_VISIBILITY_TOGGLED,function(a){u(P,{globalLayer:a.checked}),u(R,null),x()}),h.subscribe(n.FilterManager.GLOBAL_BOX_VISIBILITY_TOGGLED,function(a){u(Q,{globalBox:a.checked}),u(S,null),x()}),h.subscribe(n.FilterManager.LAYER_VISIBILITY_TOGGLED,function(a){var b=$(a.node).findInputLabel().data("layer-id");a.checked?delete Y[b]:Y[b]=!0,q.isEmpty(Y)?(u(R,null),u(P,null)):(u(R,{hiddenLayers:Object.keys(Y).join("+")}),u(P,null)),x()}),h.subscribe(n.FilterManager.BOX_VISIBILITY_TOGGLED,function(a){var b=$(a.node).findInputLabel().data("layer-id");a.checked?Z[b]=!0:delete Z[b],q.isEmpty(Z)?(u(S,null),u(Q,{globalBox:!1})):(u(S,{visibleBoxes:Object.keys(Z).join("+")}),u(Q,null)),x()}),x()},updateMap:function(){if(z){var a,b,c=[];if(z.selectedTab&&(a={index:z.selectedTab},u(N,a),h.publish(J+N,a)),z.panelVisible&&(a={panelVisible:p.parseBool(z.panelVisible)},u(M,a),a.panelVisible||c.push({publishName:n.GUI.PANEL_TOGGLE,eventArg:{origin:"bootstrapper"},subscribeName:n.GUI.PANEL_CHANGE})),z.fullscreen&&(a={fullscreen:p.parseBool(z.fullscreen)},u(L,a),a.fullscreen&&c.push({publishName:n.GUI.TOGGLE_FULLSCREEN,eventArg:{expand:!0},subscribeName:n.GUI.FULLSCREEN_CHANGE})),z.baseMap&&(a={id:z.baseMap},u(O,a),h.publish(n.BasemapSelector.TOGGLE,a)),z.xmin)if(a={xmin:parseFloat(z.xmin.replace(/,/g,"")),ymin:parseFloat(z.ymin.replace(/,/g,"")),xmax:parseFloat(z.xmax.replace(/,/g,"")),ymax:parseFloat(z.ymax.replace(/,/g,""))},u(K,a),c.isEmpty())h.publish(n.Map.SET_EXTENT,{extent:new k(a)});else{var d=g.map(c,function(a){return a.subscribeName});p.subscribeAll(d,function(){h.publish(n.Map.SET_EXTENT,{extent:new k(a)})}),g.forEach(c,function(a){h.publish(a.publishName,a.eventArg)})}z.globalLayer?(h.publish(n.FilterManager.TOGGLE_GLOBAL_LAYER_VISIBILITY,{visible:p.parseBool(z.globalLayer)}),u(P,{globalLayer:z.globalLayer})):z.hiddenLayers&&(b=z.hiddenLayers.split("+"),h.publish(n.FilterManager.TOGGLE_LAYER_VISIBILITY,{layerIds:b,checked:!1}),u(R,{hiddenLayers:z.hiddenLayers})),z.globalBox?(h.publish(n.FilterManager.TOGGLE_GLOBAL_BOX_VISIBILITY,{visible:p.parseBool(z.globalBox)}),u(Q,{globalBox:z.globalBox})):z.visibleBoxes&&(b=z.visibleBoxes.split("+"),h.publish(n.FilterManager.TOGGLE_BOX_VISIBILITY,{layerIds:b,checked:!0}),u(S,{visibleBoxes:z.visibleBoxes})),z.keys&&u("smallkeys",{keys:z.keys})}}}});