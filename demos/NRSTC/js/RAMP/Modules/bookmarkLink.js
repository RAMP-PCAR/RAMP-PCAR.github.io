/*! ramp-gis-viewer 09-09-2014 13:44:31 : v. 2.0.0 
 * 
 * RAMP GIS viewer - Bobcat; Sample of an implementation of RAMP 
 **/
define(["dojo/_base/declare","require","dojo/dom-construct","dojo/io-query","dojo/_base/lang","dojo/dom","dojo/_base/array","dojo/topic","dijit/form/TextBox","dijit/TitlePane","esri/geometry/Extent","ramp/globalStorage","ramp/map","ramp/eventManager","ramp/ramp","utils/url","utils/util","utils/dictionary","utils/array","utils/popupManager"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){"use strict";function u(a,b){U[a]=null===b?null:d.objectToQuery(b)}function v(a,b){V[a]=b}function w(a){var b=String.format(R,i18n.t("bookmarkLink.emailUrlSubject"),i18n.t("bookmarkLink.emailUrlBody"),encodeURIComponent(a));C.val(a),I.attr("href",b)}function x(){var a=K;r.forEachEntry(U,function(b,c){c&&(a+="&"+c)}),r.isEmpty(V)||(a+="&"),r.forEachEntry(V,function(b,c){a+="#"+c}),T?C.is(":visible")&&(J.show(),jQuery.urlShortener({longUrl:a,success:function(a){w(a),J.hide()},error:function(a){J.hide()}})):w(a)}function y(a){var b;T=a===!0?!0:a===!1?!1:!T,b=i18n.t(T?"bookmarkLink.longLink":"bookmarkLink.shortLink"),H.text(b),x()}function z(a){var c,e=new p(b.toUrl(document.location));A=l.config,K=e.uri,B=d.queryToObject(e.query),-1===K.indexOf(a)&&(K+=a),K+="?lang="+A.lang,jQuery.urlShortener.settings.apiKey="AIzaSyB52ByjsXrOYlXxc2Q9GVpClLDwt0Lw6pc",B.panelVisible&&(c={visible:q.parseBool(B.panelVisible)},u(N,c),A.ui.sidePanelOpened=c.visible),B.fullscreen&&(c={fullscreen:q.parseBool(B.fullscreen)},u(M,c),A.ui.fullscreen=c.fullscreen),B.xmin&&(c={xmin:parseFloat(B.xmin.replace(/,/g,"")),ymin:parseFloat(B.ymin.replace(/,/g,"")),xmax:parseFloat(B.xmax.replace(/,/g,"")),ymax:parseFloat(B.ymax.replace(/,/g,"")),sr:B.sr},u(L,c),A.extents.defaultExtent=c,A.spatialReference=JSON.parse(B.sr)),B.baseMap&&(c={baseMap:B.baseMap},u(P,c),g.forEach(A.basemaps,function(a){a.showOnInit=a.id===c.baseMap})),B.layerTransparency&&(u(n.FilterManager.LAYER_TRANSPARENCY_CHANGED,{layerTransparency:B.layerTransparency}),r.forEachEntry(JSON.parse(B.layerTransparency),function(a,b){var c=s.find(A.featureLayers.concat(A.wmsLayers),function(b){return b.id===a});c.settings.opacity.default=b})),B.selectedTab&&u(O,{index:B.selectedTab});var f;B.visibleLayers&&(f=B.visibleLayers.split("+"),f.forEach(function(a){var b=o.getLayerConfigWithId(a);b.layerVisible=!0,W[a]=!0}),u(Q.FILTER.VISIBLE_LAYERS,{visibleLayers:B.visibleLayers})),B.hiddenLayers&&(f=B.hiddenLayers.split("+"),f.forEach(function(a){var b=o.getLayerConfigWithId(a);b.layerVisible=!1,W[a]=!1}),u(Q.FILTER.HIDDEN_LAYERS,{hiddenLayers:B.hiddenLayers})),B.visibleBoxes&&(f=B.visibleBoxes.split("+"),f.forEach(function(a){var b=o.getLayerConfigWithId(a);b.boundingBoxVisible=!0,X[a]=!0}),u(Q.FILTER.VISIBLE_BOXES,{visibleBoxes:B.visibleBoxes})),B.hiddenBoxes&&(f=B.hiddenBoxes.split("+"),f.forEach(function(a){var b=o.getLayerConfigWithId(a);b.boundingBoxVisible=!1,X[a]=!1}),u(Q.FILTER.HIDDEN_BOXES,{hiddenBoxes:B.hiddenBoxes}))}var A,B,C,D,E,F,G,H,I,J,K,L="extentChange",M="fullscreen",N="panelChange",O="selectedTab",P="basemapChange",Q={FILTER:{VISIBLE_LAYERS:"visibleLayers",HIDDEN_LAYERS:"hiddenLayers",VISIBLE_BOXES:"visibleBoxes",HIDDEN_BOXES:"hiddenBoxes"}},R="mailto:?subject={0}&body={1}%0D%0A%0D%0A{2}",S="button-pressed",T=!1,U={},V={},W={},X={},Y={},Z={init:function(){J=$("#getlink-section .loadingAnimation"),I=$(".getlink-email-button"),E=$("#getlink-toggle"),F=$("#getlink-section-container"),G=$("#getlink-section"),C=$("#getlink-input").on("focus",function(){var a=$(this).one("mouseup.mouseupSelect",function(){return a.select(),!1}).one("mousedown",function(){a.off("mouseup.mouseupSelect")}).select()}),H=$(".getlink-shorten-button").on("click",y),D=t.registerPopup(E,"click",function(a){h.publish(n.BookmarkLink.GETLINK_PANEL_CHANGED,{visible:!0}),h.publish(n.GUI.TOOLBAR_SECTION_OPEN,{id:"get-link-section"}),q.subscribeOnce(n.GUI.TOOLBAR_SECTION_OPEN,e.hitch(this,function(){this.isOpen()&&this.close()})),F.slideDown("fast",function(){a.resolve()})},{activeClass:S,target:F,closeHandler:function(a){h.publish(n.BookmarkLink.GETLINK_PANEL_CHANGED,{visible:!1}),h.publish(n.GUI.TOOLBAR_SECTION_CLOSE,{id:"get-link-section"}),F.slideUp("fast",function(){y(!1),a.resolve()})},resetFocusOnClose:!0})}};return{createUI:function(){Z.init()},updateConfig:z,subscribeAndUpdate:function(){h.subscribe(n.Map.EXTENT_CHANGE,function(a){u(L,{xmin:a.extent.xmin,ymin:a.extent.ymin,xmax:a.extent.xmax,ymax:a.extent.ymax,sr:JSON.stringify(a.extent.spatialReference)}),x()}),h.subscribe(n.GUI.FULLSCREEN_CHANGE,function(a){u(M,{fullscreen:a.visible}),x()}),h.subscribe(n.GUI.TAB_SELECTED,function(a){v(O,a.id.replace("-link","")),x()}),h.subscribe(n.GUI.PANEL_CHANGE,function(a){u(N,{panelVisible:a.visible}),x()}),h.subscribe(n.BasemapSelector.BASEMAP_CHANGED,function(a){u(P,{baseMap:a.id}),x()}),h.subscribe(n.FilterManager.LAYER_VISIBILITY_TOGGLED,function(a){var b=a.id;W[b]=a.state;var c=r.filter(W,function(a,b){return b&&!o.getLayerConfigWithId(a).layerVisible}),d=r.filter(W,function(a,b){return!b&&o.getLayerConfigWithId(a).layerVisible});u(Q.FILTER.HIDDEN_LAYERS,r.isEmpty(d)?null:{hiddenLayers:Object.keys(d).join("+")}),u(Q.FILTER.VISIBLE_LAYERS,r.isEmpty(c)?null:{visibleLayers:Object.keys(c).join("+")}),x()}),h.subscribe(n.FilterManager.BOX_VISIBILITY_TOGGLED,function(a){var b=a.id;X[b]=a.state;var c=r.filter(X,function(a,b){return b&&!o.getLayerConfigWithId(a).boundingBoxVisible}),d=r.filter(X,function(a,b){return!b&&o.getLayerConfigWithId(a).boundingBoxVisible});u(Q.FILTER.HIDDEN_BOXES,r.isEmpty(d)?null:{hiddenBoxes:Object.keys(d).join("+")}),u(Q.FILTER.VISIBLE_BOXES,r.isEmpty(c)?null:{visibleBoxes:Object.keys(c).join("+")}),x()}),h.subscribe(n.FilterManager.LAYER_TRANSPARENCY_CHANGED,function(a){u(n.FilterManager.LAYER_TRANSPARENCY_CHANGED,a),Y[a.layerId]=a.value,u(n.FilterManager.LAYER_TRANSPARENCY_CHANGED,{layerTransparency:JSON.stringify(Y)}),x()}),x()}}});