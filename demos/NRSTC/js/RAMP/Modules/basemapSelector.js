/*! ramp-gis-viewer 03-07-2014 : v. 1.0.42-7 

 * RAMP GIS viewer - ArcticFox; Sample of an implementation of RAMP 
 **/
define(["dojo/_base/array","dojo/_base/lang","dojo/dom-attr","dojo/query","dojo/topic","dojo/text!./templates/basemap_selector_template.json","ramp/globalStorage","ramp/map","ramp/eventManager","esri/dijit/BasemapGallery","utils/popupManager","utils/tmplHelper"],function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";function m(){o.on("selection-change",function(){var a=o.getSelected();w.updateToggleLabel(),e.publish(i.BasemapSelector.BASEMAP_CHANGED,{id:a.id,title:a.title,cssStyle:a.scaleCssClass})})}function n(){e.subscribe(i.BasemapSelector.TOGGLE,function(a){o.select(a.id)})}var o,p,q,r,s,t=[],u="basemapGallery",v="button-pressed",w={init:function(){return q=$("#basemapControls"),r=$("#baseMapToggle"),s=$("#basemapGallery"),a.forEach(p.basemaps,function(a){c.set(d(String.format("#galleryNode_{0} img",a.id))[0],"alt",a.altText)}),tmpl.templates=JSON.parse(l.stringifyTemplate(f)),a.forEach($(".esriBasemapGalleryNode"),function(a,b){$(a).html(tmpl(p.siteTemplate.basemapTemplate,l.dataBuilder(p.basemaps[b])))}),k.registerPopup(q,"hoverIntent",function(a){s.slideDown("fast",function(){a.resolve()})},{activeClass:v,target:s,closeHandler:function(a){s.slideUp("fast",function(){a.resolve()})},timeout:500}),e.publish(i.BasemapSelector.UI_COMPLETE,{title:t[0].title}),this},updateToggleLabel:function(){r.find("span:first").text(o.getSelected().title)}};return{init:function(){p=g.config,a.forEach(p.basemaps,function(a){var b,c;b=new esri.dijit.BasemapLayer({url:a.url}),c=new esri.dijit.Basemap({id:a.id,layers:[b],title:String.format("{0} ({1})",a.name,a.type),thumbnailUrl:a.thumbnail}),c.scaleCssClass=a.scaleCssClass,t.push(c)}),o=new j({showArcGISBasemaps:!1,basemaps:t,map:h.getMap()},u),o.startup(),o.select(t[0].id),$(".esriBasemapGalleryNode").on("mousedown",function(a){var b=o.getSelected().id,c=a.currentTarget.id,d=c.slice(c.indexOf("_")+1);return b===d?!1:void o.select(d)}),m(),n(),w.init().updateToggleLabel()}}});