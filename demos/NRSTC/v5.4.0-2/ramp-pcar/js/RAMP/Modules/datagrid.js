/*! ramp-pcar 01-05-2015 14:07:43 : v. 5.4.0-2 
 * 
 * RAMP GIS viewer - Elk; Sample of an implementation of RAMP 
 **/
define(["dojo/_base/declare","dojo/_base/lang","dojo/query","dojo/_base/array","dojo/dom-class","dojo/dom-attr","dojo/dom-construct","dojo/topic","dojo/on","dojo/Deferred","dojo/text!./templates/datagrid_template.json","dojo/text!./templates/extended_datagrid_template.json","esri/layers/FeatureLayer","esri/tasks/query","ramp/ramp","ramp/graphicExtension","ramp/globalStorage","ramp/datagridClickHandler","ramp/map","ramp/eventManager","ramp/theme","ramp/attributeLoader","utils/util","utils/array","utils/dictionary","utils/popupManager","utils/tmplHelper"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A){"use strict";function B(){var a=K.rows().data();V={},$.each(a,function(a,b){if(b.last()){var c=b.last().layerId,d=p.getFDataOid(b.last().fData);c in V||(V[c]={}),V[c][d]=a}})}function C(a,b){("keypress"===a.type&&13===a.keyCode||"click"===a.type)&&b()}function D(a){var b={},c=s.getVisibleFeatureLayers(),e=_.getDatagridMode(),f=new n,g=!1;c=d.filter(c,function(a){return a.ramp.type!==q.layerType.Static}),e===P?RAMP.config.extendedDatagridExtentFilterEnabled?(f.geometry=s.getMap().extent,c=d.filter(c,function(a){return a.id===_.getSelectedDatasetId()})):(g=!0,c=[RAMP.layerRegistry[_.getSelectedDatasetId()]]):f.geometry=s.getMap().extent,f.outFields=["*"],Z=0,d.forEach(c,function(a){RAMP.data[a.id]&&(Z+=RAMP.data[a.id].features.length)});var h;g?(h=[],b[c[0].id]={type:"raw",layerId:c[0].id}):h=d.map(c,function(a){return a.queryFeatures(f).then(function(a){if(a.features.length>0){var c=a.features[0].getLayer();b[c.id]={type:"features",features:a.features}}})}),w.afterAll(h,function(){G(b),_.initInvisibleLayerToggleCount(),_.updateNotice(),a&&a.resolve()})}function E(a){var b,c=p.getConfigForFData(a);if(_.getDatagridMode()===O)b=[p.getFDataTitle(a)];else{b=[];var e=c.datagrid.gridColumns;d.forEach(e,function(c){b.push(a.attributes[c.fieldName]||"")})}return b.push({layerId:c.id,layerName:c.displayName,fData:a}),b}function F(a){$(".pagination-record-number").text(String.format("{0} / {1}",a,Z))}function G(a){if(void 0!==L){if(L.DataTable().clear(),Object.keys(a).isEmpty())return F(0),void L.DataTable().draw();var b,c=[],e=_.getDatagridMode();y.forEachEntry(a,function(a,f){if(RAMP.data[a])switch(f.type){case"features":b=d.map(f.features,function(a){var b=p.getFDataForGraphic(a);return b[e]?b[e]:b[e]=E(b)}),c=c.concat(b);break;case"raw":b=d.map(RAMP.data[f.layerId].features,function(a){return a[e]?a[e]:a[e]=E(a)}),c=c.concat(b)}}),F(c.length),K.one("draw.dt",function(){h.publish(t.Datagrid.EXTENT_FILTER_END)}),L.dataTable().fnAddData(c)}}function H(a){var b,c=p.getFDataOid(a);return b=p.findGraphic(c,a.parent.layerId)}function I(a){var b=a.data(R),c=a.data(Q),d=RAMP.data[b];return d.features[d.index[c]]}function J(){h.subscribe(t.FilterManager.LAYER_VISIBILITY_TOGGLED,function(a){if(X=!0,null!==a.id){var b=d.indexOf(Y,a.id);-1===b&&a.state?Y.push(a.id):-1===b||a.state||Y.splice(b,1)}}),h.subscribe(t.GUI.TAB_SELECTED,function(a){"datagrid"===a.tabName&&(X?(X=!1,D()):_.capturePanel(!0),_.adjustPanelWidth())}),h.subscribe(t.GUI.TAB_DESELECTED,function(a){"datagrid"===a.tabName&&h.publish(t.GUI.SUBPANEL_DOCK,{origin:"datagrid"})}),h.subscribe(t.Datagrid.APPLY_EXTENT_FILTER,function(){_.getDatagridMode()!==P&&D()}),h.subscribe(t.LayerLoader.LAYER_UPDATED,function(a){a.layer.ramp.type===q.layerType.feature&&_.getDatagridMode()!==P&&D()}),h.subscribe(t.Map.ZOOM_END,function(){_.updateNotice()}),h.subscribe(t.GUI.SUBPANEL_CHANGE,function(a){"ex-datagrid"===a.origin&&a.isComplete&&_.adjustPanelWidth()})}var K,L,M,N,O="summary",P="full",Q="feature-oid",R="layer-id",S=JSON.parse(A.stringifyTemplate(k)),T=JSON.parse(A.stringifyTemplate(l)),U=1,V={},W="asc",X=!0,Y=[],Z=0,_=function(){function a(a){var b=-1,c=null;return{focusedButton:null,isActive:function(){return null!==c},isEqual:function(a,b){var d=c.parent.layerId,e=p.getFDataOid(c);return d===a&&e===b},navigateToRow:function(){if(-1!==b){var a=Math.floor(b/U);return K.page()!==a&&L.DataTable().page(a).draw(!1),ka.scrollTo(this.getNode(),300,{axis:"y",offset:{left:0,top:1.5*-this.getNode().height()}}),!0}return!1},setFeatureData:function(a){c=a,this.refresh()},refresh:function(){if(c){var a=c.parent.layerId,d=p.getFDataOid(c);b=a in V&&d in V[a]?V[a][d]:-1}else b=-1},getNode:function(){return $(String.format("#jqgrid tbody tr:nth-child({0})",b%U+1))},activate:function(){c&&(this.getNode().addClass(a),this.focusedButton&&(this.getNode().find(this.focusedButton).focus(),this.focusedButton=null))},deactivate:function(){c&&(this.getNode().removeClass(a),c=null)}}}function c(){var a={buttonLabel:i18n.t("datagrid.sort"),classAddition:"font-medium global-button",someAttribute:""};return a}function e(a,b,c,e){var f,g,h=c.last(),i=_.getDatagridMode();if(!h||!h.fData)return"";if(g=p.getConfigForFData(h.fData),i===O){if(!(i in h)){f=A.dataBuilder(h.fData,g);var j=g.templates.summary;tmpl.cache={},tmpl.templates=S,h[i]=tmpl(j,f)}return h[i]}if(!(i in h)){h[i]=[];var k=g.datagrid.gridColumns;tmpl.cache={},tmpl.templates=T,f=A.dataBuilder(h.fData,g),d.forEach(k,function(a,b){f.columnIdx=b;var c=tmpl(a.columnTemplate,f);"numeric"===a.sortType&&(c=Number(c)),h[i].push(c)})}return h[i][e.col]}function f(){var a,c={info:!1,columnDefs:[],autoWidth:!1,deferRender:!0,order:[],paging:!0,pagingType:"ramp",scrollX:!0,destroy:!0,language:i18n.t("datagrid.gridstrings",{returnObjectTrees:!0}),getTotalRecords:function(){return Z}};if(ta===O)U=RAMP.config.rowsPerPage,c=b.mixin(c,{columns:[{title:"Name",width:"300px",type:"string",className:"",render:e,orderable:!0}],dom:'<"jqgrid_table_wrapper summary-table"t><"status-line"p>',searching:!0,pageLength:U});else{var f=o.getLayerConfigWithId(_.getSelectedDatasetId());U=f.datagrid.rowsPerPage,c=b.mixin(c,{columns:null===_.getSelectedDatasetId()?[{title:""}]:d.map(f.datagrid.gridColumns,function(a){return{title:a.title,width:a.width?a.width:"100px",type:a.sortType,className:a.alignment?"":"center",render:e,orderable:a.orderable}}),dom:'<"jqgrid_table_wrapper full-table"t><"datagrid-info-notice simple"><"status-line"p>',scrollY:"500px",searching:RAMP.config.extendedDatagridExtentFilterEnabled,pageLength:U})}L=ea.find("table");var g=!1;K=L.DataTable(c).on("page.dt",function(){h.publish(t.GUI.SUBPANEL_DOCK,{origin:"datagrid,ex-datagrid"}),g=!0}).on("order.dt",function(){h.publish(t.GUI.SUBPANEL_DOCK,{origin:"datagrid,ex-datagrid"})}).on("draw.dt",function(){B(),g?g=!1:_.activateRows(),_.adjustPanelWidth(),h.publish(t.Datagrid.DRAW_COMPLETE)}),ja=ea.find("#jqgrid_wrapper"),ka=ea.find(".jqgrid_table_wrapper"),la=ea.find(".dataTables_scroll"),ma=la.find(".dataTables_scrollBody"),na=la.find(".dataTables_scrollHead"),ia=ea.find(".datagrid-info-notice"),u.tooltipster(ja),ta!==O&&(ja.addClass("fadedOut"),ma.height(ka.height()-na.height()),a=L.outerWidth(),_.adjustPanelWidth(),L.forceStyle({width:a+"px"}))}function g(){z.registerPopup(ea,"hoverIntent",function(){this.target.attr("title")&&(this.target.isOverflowed()?this.target.tooltipster({theme:".tooltipster-dark"}).tooltipster("show"):this.target.removeAttr("title"))},{handleSelector:".point-name, .category-name, .title-span",useAria:!1,timeout:500})}function i(){ea.on("click","button.details",function(){var a=$(this),b=a.data(R),c=a.data(Q);if(qa.focusedButton="button.details",qa.isActive()&&qa.isEqual(b,c))r.onDetailDeselect(ta);else{var d=I(a),e=H(d);r.onDetailSelect(a,d,e,ta)}}),ea.on("click","button.zoomto",function(a){var b=$(this),c=I(b);ra.focusedButton="button.zoomto",b.text()===i18n.t("datagrid.zoomTo")?C(a,function(){M=H(c),N=s.getMap().extent.clone(),r.onZoomTo(s.getMap().extent.clone(),c,M),w.subscribeOnce(t.Datagrid.EXTENT_FILTER_END,function(){var a=$(String.format("button.zoomto[data-{0}='{1}'][data-{2}='{3}']:eq(0)",Q,p.getFDataOid(c),R,c.parent.layerId));a.text(i18n.t("datagrid.zoomBack"))})}):(r.onZoomBack(),b.text(i18n.t("datagrid.zoomTo")),w.subscribeOnce(t.Datagrid.EXTENT_FILTER_END,function(){var a=$(String.format("button.zoomto[data-{0}='{1}'][data-{2}='{3}']:eq(0)",Q,p.getFDataOid(c),R,c.parent.layerId));a.focus()}))}),ea.on("click","button.global-button",function(){var a=$(this);"asc"===W?(a.addClass("state-expanded"),W="desc"):(a.removeClass("state-expanded"),W="asc"),L.DataTable().order([0,W]).draw()}),ea.on("click","button.expand",function(){var a=new j;ta=ta===O?P:O,a.then(function(){k()}),J(a),h.publish(t.GUI.DATAGRID_EXPAND)}),ea.on("change","#datasetSelector",function(){var a=$(this),b=a.find("option:selected"),c=b[0].value===fa;E(c,!0)}),ea.on("click","#datasetSelectorSubmitButton",function(){var a=oa.find("option:selected");fa=a.length>0?a[0].value:"",G()}),z.registerPopup(ea,"hover, focus",function(a){this.target.removeClass("wb-invisible"),a.resolve()},{handleSelector:"tr",targetSelector:".record-controls",closeHandler:function(a){this.target.addClass("wb-invisible"),a.resolve()},activeClass:"bg-very-light",useAria:!1}),z.registerPopup(ea,"hover, focus",function(a){a.resolve()},{handleSelector:".full-table #jqgrid tbody tr",activeClass:"bg-very-light",useAria:!1}),z.registerPopup(ea,"dblclick",function(a){var b=(this.handle.outerHeight()-this.target.height())/2;TweenLite.set(".expand-cell",{clearProps:"padding",className:"-=expand-cell"}),TweenLite.set(this.handle,{padding:b}),window.getSelection().removeAllRanges(),a.resolve()},{handleSelector:"td",targetSelector:".title-span",closeHandler:function(a){TweenLite.set(this.handle,{clearProps:"padding"}),TweenLite.set(this.handle,{className:"-=expand-cell"}),a.resolve()},activeClass:"expand-cell",useAria:!1}),z.registerPopup(ea,"click",function(a){this.target.toggle(),this.handle.find(".separator i").removeClass("fa-angle-down").addClass("fa-angle-up"),a.resolve()},{closeHandler:function(a){this.target.toggle(),this.handle.find(".separator i").removeClass("fa-angle-up").addClass("fa-angle-down"),a.resolve()},handleSelector:".info-notice-button",containerSelector:".datagrid-info-notice",targetSelector:".notice-details"})}function k(){var a,b;ta===O?ka.scroll(function(){a=ka.scrollTop(),b=la.height()-ka.scrollTop()-ka.height(),0===a?(ha.removeClass("scroll"),ia.removeClass("scroll")):(ha.addClass("scroll"),ia.addClass("scroll")),0===b?ga.removeClass("scroll"):ga.addClass("scroll")}):ma.scroll(function(){a=ma.scrollTop(),0===a?na.removeClass("scroll"):na.addClass("scroll")})}function l(a){m(),qa.setFeatureData(a.fData),a.scroll&&_.activateRows()}function m(){qa.deactivate(),r.onZoomCancel()}function n(a){ra.setFeatureData(a.fData)}function v(){ra.deactivate()}function y(){h.subscribe(t.Datagrid.HIGHLIGHTROW_SHOW,l),h.subscribe(t.Datagrid.HIGHLIGHTROW_HIDE,m),h.subscribe(t.Datagrid.ZOOMLIGHTROW_SHOW,n),h.subscribe(t.Datagrid.ZOOMLIGHTROW_HIDE,v),h.subscribe(t.Datagrid.DRAW_COMPLETE,F)}function E(a,b){var c;b=b||!1,pa.attr("disabled",a).text(i18n.t(a?b?"datagrid.ex.datasetSelectorButtonLoaded":"datagrid.ex.datasetSelectorButtonLoading":"datagrid.ex.datasetSelectorButtonLoad")),c=d.filter(RAMP.config.layers.feature,function(a){return a.id===fa}),da&&c.length>0&&da.text(": "+c[0].displayName)}function F(){pa.text(i18n.t("datagrid.ex.datasetSelectorButtonLoaded"))}function G(){var a,b=.2,c=new TimelineLite({paused:!0}),d=new TimelineLite({paused:!0}),e=new j;tmpl.cache={},tmpl.templates=S,a=tmpl("datagrid_manager_table_Template",{tableId:"jqgrid",tableCss:"display table-condensed table-simplify"}),qa.isActive()&&(b=.6,r.onDetailDeselect(ta)),c.set(ja,{className:"+=animated fadeOut"}),c.call(function(){c.pause(),ja.replaceWith(a),f(),E(!0),e.then(function(){d.set(ja,{className:"-=fadedOut"}),d.set(ja,{className:"+=animated fadeIn"}),d.set(ja,{className:"-=animated fadeIn"},"+=1"),d.play()}),D(e)},null,this,b+.05),c.play()}function J(a){var e,g,h=c(),i={buttons:h,tableId:"jqgrid",tableCss:"display table-condensed table-simplify"},k=.5,l=new TimelineLite({paused:!0}),m=new TimelineLite({paused:!0}),n=new j;if(tmpl.cache={},tmpl.templates=S,ta===O)g="datagrid_manager_Template",i.buttons.toggleTitle=i18n.t("datagrid.fullData"),da&&da.remove();else{g="datagrid_full_manager_Template",fa="";var o=d.filter(RAMP.config.layers.feature,function(a){var b=RAMP.map.getLayer(a.id);return b&&b.loaded?b.ramp.type!==q.layerType.Static&&b.visible:void 0});i.buttons=b.mixin(i.buttons,{datasets:o,toggleTitle:i18n.t("datagrid.ex.dataSummary"),txtDataset:i18n.t("datagrid.ex.dataset")}),da=$("#tabs1_2-lnk").append("<span>").find("span")}e=tmpl(g,i),r.onDetailDeselect(ta),l.set(ea,{className:"+=animated fadeOut"}),L&&l.set(L,{clearProps:"width"}),l.call(function(){l.pause(),ea.empty().append(e),f(),ha=ea.find("#datagridGlobalToggles"),ga=ea.find(".status-line"),oa=$("#datasetSelector"),pa=$("#datasetSelectorSubmitButton"),E(!0),a.resolve(),l.resume(),n.then(function(){m.set(ja,{className:"-=fadedOut"}),m.set(ja,{className:"+=animated fadeIn"}),m.set(ja,{className:"-=animated fadeIn"},"+=1"),m.play()}),D(n)},null,this,k+.1),l.set(ea,{className:"-=fadeOut"}),l.set(ea,{className:"+=fadeIn"}),l.set(ea,{className:"-=animated fadeIn"},"+="+k),l.play()}function X(){qa.refresh(),ra.refresh(),qa.navigateToRow()||ra.navigateToRow(),ra.activate(),qa.activate(),ba()}function aa(){return"true"===sa.attr("aria-expanded")}function ba(a){var b="datagrid",c=qa.getNode().find(".record-controls");ta===P&&(b="ex-datagrid",c=qa.getNode().find(".button.details")),qa.isActive()&&(aa()||a)&&h.publish(t.GUI.SUBPANEL_CAPTURE,{target:c,consumeOrigin:b,origin:b})}function ca(){ta===O?w.adjustWidthForSrollbar(ka,[ha,ga,ia]):L.outerWidth()===ja.outerWidth()?ma.addClass("overflow-x-hidden"):ma.removeClass("overflow-x-hidden")}var da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa,qa=a("selected-row"),ra=a("highlighted-row"),sa=$("details[data-panel-name=datagrid]"),ta=O,ua=!1;return{init:w.once(function(){var a=new j;a.then(function(){ua=!0,g(),i(),k(),y()}),ea=$("#"+RAMP.config.divNames.datagrid),J(a)}),getDatagridMode:function(){return ta},getSelectedDatasetId:function(){if(fa)oa.find("option[value='"+fa+"']").prop("selected",!0);else if(oa.find("option:selected").length>0)fa=oa.find("option:selected")[0].value;else{var a=x.find(RAMP.config.layers.feature,function(a){var b=RAMP.map.getLayer(a.id);return b?b.visible&&b.ramp.type!==q.layerType.Static:!1});fa=null===a?null:a.id}return fa},isReady:function(){return ua},adjustPanelWidth:ca,activateRows:X,capturePanel:ba,updateNotice:function(){var a,b={layers:null},c=s.getInvisibleLayers().filter(function(a){return a.ramp&&a.ramp.type===q.layerType.feature});this.isReady()&&(tmpl.cache={},tmpl.templates=S,ta!==P&&c.length>0&&(b.layers=c.map(function(a){return a.ramp.config}),Y.length>0&&(a=tmpl("datagrid_info_notice",b))),a?(ia.empty().append(a),ea.addClass("notice")):(ia.empty(),ea.removeClass("notice")))},initInvisibleLayerToggleCount:w.once(function(){Y=s.getInvisibleLayers().filter(function(a){return a.ramp&&a.ramp.type===q.layerType.feature&&a.ramp.config.settings.visible}).map(function(a){return a.ramp.config.id})})}}();return{init:function(){J(),_.init()}}});