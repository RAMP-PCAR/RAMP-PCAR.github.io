<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/js/RAMP/Modules/attributeLoader.js - ramp-pcar</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../../../assets/images/bobcat_logo_sharp_smaller_s.png" title="ramp-pcar">undefined</h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 5.4.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AdvancedToolbar.html">AdvancedToolbar</a></li>
            
                <li><a href="../classes/AreaTool.html">AreaTool</a></li>
            
                <li><a href="../classes/Array.html">Array</a></li>
            
                <li><a href="../classes/AttributeLoader.html">AttributeLoader</a></li>
            
                <li><a href="../classes/BaseMapSelector.html">BaseMapSelector</a></li>
            
                <li><a href="../classes/BaseTool.html">BaseTool</a></li>
            
                <li><a href="../classes/BookmarkLink.html">BookmarkLink</a></li>
            
                <li><a href="../classes/Bootstrapper.html">Bootstrapper</a></li>
            
                <li><a href="../classes/Brick.html">Brick</a></li>
            
                <li><a href="../classes/Bricks.html">Bricks</a></li>
            
                <li><a href="../classes/BricksChoiceBrick.html">BricksChoiceBrick</a></li>
            
                <li><a href="../classes/BufferTool.html">BufferTool</a></li>
            
                <li><a href="../classes/ButtonBrick.html">ButtonBrick</a></li>
            
                <li><a href="../classes/Checkbox.html">Checkbox</a></li>
            
                <li><a href="../classes/CheckboxBrick.html">CheckboxBrick</a></li>
            
                <li><a href="../classes/CheckboxfsBrick.html">CheckboxfsBrick</a></li>
            
                <li><a href="../classes/CheckboxGroup.html">CheckboxGroup</a></li>
            
                <li><a href="../classes/ChoiceBrick.html">ChoiceBrick</a></li>
            
                <li><a href="../classes/ColorPickerBrick.html">ColorPickerBrick</a></li>
            
                <li><a href="../classes/Datagrid.html">Datagrid</a></li>
            
                <li><a href="../classes/DatagridClickHandler.html">DatagridClickHandler</a></li>
            
                <li><a href="../classes/DataLoader.html">DataLoader</a></li>
            
                <li><a href="../classes/DataLoaderGui.html">DataLoaderGui</a></li>
            
                <li><a href="../classes/Decorator.html">Decorator</a></li>
            
                <li><a href="../classes/Dictionary.html">Dictionary</a></li>
            
                <li><a href="../classes/DistanceTool.html">DistanceTool</a></li>
            
                <li><a href="../classes/DropDownBrick.html">DropDownBrick</a></li>
            
                <li><a href="../classes/EventManager.html">EventManager</a></li>
            
                <li><a href="../classes/FeatureClickHandler.html">FeatureClickHandler</a></li>
            
                <li><a href="../classes/FeatureHighlighter.html">FeatureHighlighter</a></li>
            
                <li><a href="../classes/FileInputBrick.html">FileInputBrick</a></li>
            
                <li><a href="../classes/FilterManager.html">FilterManager</a></li>
            
                <li><a href="../classes/FunctionMangler.html">FunctionMangler</a></li>
            
                <li><a href="../classes/GlobalStorage.html">GlobalStorage</a></li>
            
                <li><a href="../classes/GraphicExtension.html">GraphicExtension</a></li>
            
                <li><a href="../classes/GUI.html">GUI</a></li>
            
                <li><a href="../classes/ImageExport.html">ImageExport</a></li>
            
                <li><a href="../classes/LayerGroup.html">LayerGroup</a></li>
            
                <li><a href="../classes/LayerItem.html">LayerItem</a></li>
            
                <li><a href="../classes/LayerLoader.html">LayerLoader</a></li>
            
                <li><a href="../classes/LayoutController.html">LayoutController</a></li>
            
                <li><a href="../classes/Map.html">Map</a></li>
            
                <li><a href="../classes/MapClickHandler.html">MapClickHandler</a></li>
            
                <li><a href="../classes/Maptips.html">Maptips</a></li>
            
                <li><a href="../classes/MetadataHandler.html">MetadataHandler</a></li>
            
                <li><a href="../classes/MultiBrick.html">MultiBrick</a></li>
            
                <li><a href="../classes/Navigation.html">Navigation</a></li>
            
                <li><a href="../classes/OkCancelButtonBrick.html">OkCancelButtonBrick</a></li>
            
                <li><a href="../classes/PopulationTool.html">PopulationTool</a></li>
            
                <li><a href="../classes/Popup.html">Popup</a></li>
            
                <li><a href="../classes/PopupBase.html">PopupBase</a></li>
            
                <li><a href="../classes/PopupBaseSettings.html">PopupBaseSettings</a></li>
            
                <li><a href="../classes/PopupManager.html">PopupManager</a></li>
            
                <li><a href="../classes/Prototype.html">Prototype</a></li>
            
                <li><a href="../classes/QuickZoom.html">QuickZoom</a></li>
            
                <li><a href="../classes/RAMP.html">RAMP</a></li>
            
                <li><a href="../classes/RampMap.html">RampMap</a></li>
            
                <li><a href="../classes/RAMPStarter.html">RAMPStarter</a></li>
            
                <li><a href="../classes/SimpleInputBrick.html">SimpleInputBrick</a></li>
            
                <li><a href="../classes/StepItem.html">StepItem</a></li>
            
                <li><a href="../classes/SubPanel.html">SubPanel</a></li>
            
                <li><a href="../classes/SubPanelSettings.html">SubPanelSettings</a></li>
            
                <li><a href="../classes/Theme.html">Theme</a></li>
            
                <li><a href="../classes/TmplHelper.html">TmplHelper</a></li>
            
                <li><a href="../classes/TmplUtil.html">TmplUtil</a></li>
            
                <li><a href="../classes/ToggleBrick.html">ToggleBrick</a></li>
            
                <li><a href="../classes/Url.html">Url</a></li>
            
                <li><a href="../classes/Util.html">Util</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/AttributeLoader.html">AttributeLoader</a></li>
            
                <li><a href="../modules/BookmarkLink.html">BookmarkLink</a></li>
            
                <li><a href="../modules/Bricks.html">Bricks</a></li>
            
                <li><a href="../modules/Datagrid.html">Datagrid</a></li>
            
                <li><a href="../modules/DataLoader.html">DataLoader</a></li>
            
                <li><a href="../modules/FilterManager.html">FilterManager</a></li>
            
                <li><a href="../modules/GeoSearch.html">GeoSearch</a></li>
            
                <li><a href="../modules/GlobalStorage.html">GlobalStorage</a></li>
            
                <li><a href="../modules/Map.html">Map</a></li>
            
                <li><a href="../modules/Maptips.html">Maptips</a></li>
            
                <li><a href="../modules/Navigation.html">Navigation</a></li>
            
                <li><a href="../modules/QuickZoom.html">QuickZoom</a></li>
            
                <li><a href="../modules/RAMP.html">RAMP</a></li>
            
                <li><a href="../modules/Theme.html">Theme</a></li>
            
                <li><a href="../modules/Tools.html">Tools</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
                <li><a href="../modules/Utils.html">Utils</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/js/RAMP/Modules/attributeLoader.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
﻿/* global define, console, RAMP */

/**
*
*
* @module RAMP
* @submodule AttributeLoader
*/

//TODO should this be under DataLoader submodule??

/**
* Attribute Loader class.
*
* Handles the extraction of attribute data from map services, and transforms it to standard format
*
* ####Imports RAMP Modules:
* {{#crossLink &quot;EventManager&quot;}}{{/crossLink}}
* {{#crossLink &quot;GlobalStorage&quot;}}{{/crossLink}}
*
* @class AttributeLoader
* @static
* @uses dojo/topic
* @uses dojo/Deferred
* @uses dojo/request/script
*/

define([
/* Dojo */
&#x27;dojo/topic&#x27;, &#x27;dojo/request/script&#x27;, &#x27;dojo/Deferred&#x27;,

/* Esri */
&#x27;esri/request&#x27;,

/* RAMP */
&#x27;ramp/eventManager&#x27;, &#x27;ramp/globalStorage&#x27;, &#x27;ramp/map&#x27;],

    function (
    /* Dojo */
    topic, script, Deferred,

    /* Esri */
    esriRequest,

    /* RAMP */
    EventManager, GlobalStorage, RampMap) {
        &#x27;use strict&#x27;;

        /**
        * Will generate object id indexes and parent pointers on a layer data object.
        * Assumes data object already has features and object id field defined
        *
        * @method addLayerData
        * @private
        * @param  {Object} layerData layer data object
        * @param  {Array} featureData feature objects to enhance and add to layer data
        */
        function addLayerData(layerData, featureData) {
            var offset = layerData.features.length;

            //add new data to layer data&#x27;s array
            layerData.features = layerData.features.concat(featureData);

            //make parent pointers and a fun index on object id
            featureData.forEach(function (elem, idx) {
                //map object id to index of object in feature array
                //use toString, as objectid is integer and will act funny using array notation.
                layerData.index[elem.attributes[layerData.idField].toString()] = idx + offset;

                //pointer back to parent
                elem.parent = layerData;
            });
        }

        /**
        * Will generate an empty layer data object
        *
        * @method newLayerData
        * @private
        * @return {Object} empty layer data object
        */
        function newLayerData() {
            return {
                layerId: &#x27;&#x27;,
                idField: &#x27;&#x27;,
                features: [],
                index: {}
                //maxRecord: 0,
                //loadRangeSet: []
            };
        }

        /**
        * Recursive function to load a full set of attributes, regardless of the maximum output size of the service
        * Passes result back on the provided Deferred object
        *
        * @method loadDataBatch
        * @private
        * @param  {Integer} maxId largest object id that has already been downloaded
        * @param  {Integer} maxBatch maximum number of results the service will return. if -1, means currently unknown
        * @param  {String} layerUrl URL to feature layer endpoint
        * @param  {String} idField name of attribute containing the object id for the layer
        * @param  {String} layerId id of the layer
        * @param  {dojo/Deferred} callerDef deferred object that resolves when current data has been downloaded
        */
        function loadDataBatch(maxId, maxBatch, layerUrl, idField, layerId, callerDef) {
            //fetch attributes from feature layer. where specifies records with id&#x27;s higher than stuff already downloaded. outFields * (all attributes). no geometry.
            var defData = script.get(layerUrl + &#x27;/query&#x27;, {
                query: &#x27;where=&#x27; + idField + &#x27;&gt;&#x27; + maxId + &#x27;&amp;outFields=&#x27; + RAMP.layerRegistry[layerId].ramp.config.layerAttributes + &#x27;&amp;returnGeometry=false&amp;f=json&#x27;,
                jsonp: &#x27;callback&#x27;
            });

            defData.then(function (dataResult) {
                if (dataResult.features) {
                    var len = dataResult.features.length;
                    if (len &gt; 0) {
                        if (maxBatch === -1) {
                            //this is our first batch and our server is 10.0.  set the max batch size to this batch size
                            maxBatch = len;
                        }
                        if (len &lt; maxBatch) {
                            //this batch is less than the max.  this is last batch.  no need to query again.
                            callerDef.resolve(dataResult.features);
                        } else {
                            //stash the result and call the service again for the next batch of data.
                            //max id becomes last object id in the current batch
                            var thisDef = new Deferred();
                            loadDataBatch(dataResult.features[len - 1].attributes[idField], maxBatch, layerUrl, idField, layerId, thisDef);

                            thisDef.then(function (dataArray) {
                                callerDef.resolve(dataResult.features.concat(dataArray));
                            }, function (error) {
                                callerDef.reject(error);
                            });
                        }
                    } else {
                        //no more data.  we are done
                        callerDef.resolve([]);
                    }
                } else {
                    //it is possible to have an error, but it comes back on the &quot;success&quot; channel.
                    callerDef.reject(dataResult.error);
                }
            },
            function (error) {
                callerDef.reject(error);
            });
        }

        /**
        * Will download the attribute data for a layer.
        *
        * @method loadAttributeData
        * @private
        * @param  {String} layerId id of the layer
        * @param  {String} layerUrl the URL of the layer
        * @param  {String} layerType type of the layer. should be a value from GlobalStorage.layerType
        */
        function loadAttributeData(layerId, layerUrl, layerType) {
            switch (layerType) {
                case GlobalStorage.layerType.feature:

                    console.log(&#x27;BEGIN ATTRIB LOAD: &#x27; + layerId);

                    //extract info for this service
                    var defService = esriRequest({
                        url: layerUrl,
                        content: { f: &#x27;json&#x27; },
                        callbackParamName: &#x27;callback&#x27;,
                        handleAs: &#x27;json&#x27;
                    });

                    defService.then(function (serviceResult) {
                        if (serviceResult &amp;&amp; (typeof serviceResult.error === &#x27;undefined&#x27;)) {
                            RampMap.updateDatagridUpdatingState(RAMP.layerRegistry[layerId], true);

                            //set up layer data object based on layer data
                            var maxBatchSize = serviceResult.maxRecordCount || -1, //10.0 server will not supply a max record value
                                defFinished = new Deferred(),
                                layerData = newLayerData();
                            layerData.layerId = layerId;

                            //find object id field
                            serviceResult.fields.every(function (elem) {
                                if (elem.type === &#x27;esriFieldTypeOID&#x27;) {
                                    layerData.idField = elem.name;
                                    return false; //break the loop
                                }
                                return true; //keep looping
                            });

                            //begin the loading process
                            loadDataBatch(-1, maxBatchSize, layerUrl, layerData.idField, layerId, defFinished);

                            //after all data has been loaded
                            defFinished.promise.then(function (features) {
                                addLayerData(layerData, features);

                                //store attribData
                                // (Set layer data in global object only once all data has been downloaded
                                //  Used as both a flag and a data store)
                                RAMP.data[layerId] = layerData;
                                //new data. tell grid to reload
                                topic.publish(EventManager.Datagrid.APPLY_EXTENT_FILTER);

                                RampMap.updateDatagridUpdatingState(RAMP.layerRegistry[layerId], false);
                                console.log(&#x27;END ATTRIB LOAD: &#x27; + layerId);
                            },
                            function (error) {
                                console.log(&#x27;error getting attribute data for id &#x27; + layerId);
                                //set layer to error state
                                RampMap.updateDatagridUpdatingState(RAMP.layerRegistry[layerId], false);
                                topic.publish(EventManager.LayerLoader.LAYER_ERROR, { layer: RAMP.layerRegistry[layerId], error: error });
                            });
                        } else {
                            console.log(&#x27;Service metadata load error&#x27;);
                            if (serviceResult &amp;&amp; serviceResult.error) {
                                console.log(serviceResult.error);
                            }
                        }
                    },
                     function (error) {
                         console.log(&#x27;Service metadata load error : &#x27; + error);
                     });

                    break;

                default:
                    console.log(&#x27;Layer type not supported by attribute loader: &#x27; + layerType);
            }

            //TODO do we need to return any sort of promise to indicate when the loading has finished?
        }

        /**
        * Will extract the attribute data from a file based layer.
        *
        * @method extractAttributeData
        * @private
        * @param  {Object} layer the layer object
        */
        function extractAttributeData(layer) {
            switch (layer.ramp.type) {
                case GlobalStorage.layerType.feature:

                    //change to standard format and store.
                    var layerData = newLayerData();
                    layerData.layerId = layer.id;
                    layerData.idField = layer.objectIdField;

                    addLayerData(layerData, layer.graphics.map(function (elem) {
                        return { attributes: elem.attributes };
                    }));

                    //we dont care about setting range values, as all the data is already loaded

                    //store attribData
                    RAMP.data[layer.id] = layerData;
                    //new data. tell grid to reload
                    topic.publish(EventManager.Datagrid.APPLY_EXTENT_FILTER);
                    console.log(&#x27;END ATTRIB LOAD: &#x27; + layer.id);

                    break;

                default:
                    console.log(&#x27;Layer type not supported by attribute extractor: &#x27; + layer.ramp.type);
            }

            //TODO do we need to return any sort of promise to indicate when the loading has finished?
        }

        return {
            loadAttributeData: loadAttributeData,
            extractAttributeData: extractAttributeData
        };
    });
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
