<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/js/RAMP/Modules/layerItem.js - ramp-pcar</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../../../assets/images/bobcat_logo_sharp_smaller_s.png" title="ramp-pcar">undefined</h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 5.4.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AdvancedToolbar.html">AdvancedToolbar</a></li>
            
                <li><a href="../classes/AreaTool.html">AreaTool</a></li>
            
                <li><a href="../classes/Array.html">Array</a></li>
            
                <li><a href="../classes/AttributeLoader.html">AttributeLoader</a></li>
            
                <li><a href="../classes/BaseMapSelector.html">BaseMapSelector</a></li>
            
                <li><a href="../classes/BaseTool.html">BaseTool</a></li>
            
                <li><a href="../classes/BookmarkLink.html">BookmarkLink</a></li>
            
                <li><a href="../classes/Bootstrapper.html">Bootstrapper</a></li>
            
                <li><a href="../classes/Brick.html">Brick</a></li>
            
                <li><a href="../classes/Bricks.html">Bricks</a></li>
            
                <li><a href="../classes/BricksChoiceBrick.html">BricksChoiceBrick</a></li>
            
                <li><a href="../classes/BufferTool.html">BufferTool</a></li>
            
                <li><a href="../classes/ButtonBrick.html">ButtonBrick</a></li>
            
                <li><a href="../classes/Checkbox.html">Checkbox</a></li>
            
                <li><a href="../classes/CheckboxBrick.html">CheckboxBrick</a></li>
            
                <li><a href="../classes/CheckboxfsBrick.html">CheckboxfsBrick</a></li>
            
                <li><a href="../classes/CheckboxGroup.html">CheckboxGroup</a></li>
            
                <li><a href="../classes/ChoiceBrick.html">ChoiceBrick</a></li>
            
                <li><a href="../classes/ColorPickerBrick.html">ColorPickerBrick</a></li>
            
                <li><a href="../classes/Datagrid.html">Datagrid</a></li>
            
                <li><a href="../classes/DatagridClickHandler.html">DatagridClickHandler</a></li>
            
                <li><a href="../classes/DataLoader.html">DataLoader</a></li>
            
                <li><a href="../classes/DataLoaderGui.html">DataLoaderGui</a></li>
            
                <li><a href="../classes/Decorator.html">Decorator</a></li>
            
                <li><a href="../classes/Dictionary.html">Dictionary</a></li>
            
                <li><a href="../classes/DistanceTool.html">DistanceTool</a></li>
            
                <li><a href="../classes/DropDownBrick.html">DropDownBrick</a></li>
            
                <li><a href="../classes/EventManager.html">EventManager</a></li>
            
                <li><a href="../classes/FeatureClickHandler.html">FeatureClickHandler</a></li>
            
                <li><a href="../classes/FeatureHighlighter.html">FeatureHighlighter</a></li>
            
                <li><a href="../classes/FileInputBrick.html">FileInputBrick</a></li>
            
                <li><a href="../classes/FilterManager.html">FilterManager</a></li>
            
                <li><a href="../classes/FunctionMangler.html">FunctionMangler</a></li>
            
                <li><a href="../classes/GlobalStorage.html">GlobalStorage</a></li>
            
                <li><a href="../classes/GraphicExtension.html">GraphicExtension</a></li>
            
                <li><a href="../classes/GUI.html">GUI</a></li>
            
                <li><a href="../classes/ImageExport.html">ImageExport</a></li>
            
                <li><a href="../classes/LayerGroup.html">LayerGroup</a></li>
            
                <li><a href="../classes/LayerItem.html">LayerItem</a></li>
            
                <li><a href="../classes/LayerLoader.html">LayerLoader</a></li>
            
                <li><a href="../classes/LayoutController.html">LayoutController</a></li>
            
                <li><a href="../classes/Map.html">Map</a></li>
            
                <li><a href="../classes/MapClickHandler.html">MapClickHandler</a></li>
            
                <li><a href="../classes/Maptips.html">Maptips</a></li>
            
                <li><a href="../classes/MetadataHandler.html">MetadataHandler</a></li>
            
                <li><a href="../classes/MultiBrick.html">MultiBrick</a></li>
            
                <li><a href="../classes/Navigation.html">Navigation</a></li>
            
                <li><a href="../classes/OkCancelButtonBrick.html">OkCancelButtonBrick</a></li>
            
                <li><a href="../classes/PopulationTool.html">PopulationTool</a></li>
            
                <li><a href="../classes/Popup.html">Popup</a></li>
            
                <li><a href="../classes/PopupBase.html">PopupBase</a></li>
            
                <li><a href="../classes/PopupBaseSettings.html">PopupBaseSettings</a></li>
            
                <li><a href="../classes/PopupManager.html">PopupManager</a></li>
            
                <li><a href="../classes/Prototype.html">Prototype</a></li>
            
                <li><a href="../classes/QuickZoom.html">QuickZoom</a></li>
            
                <li><a href="../classes/RAMP.html">RAMP</a></li>
            
                <li><a href="../classes/RampMap.html">RampMap</a></li>
            
                <li><a href="../classes/RAMPStarter.html">RAMPStarter</a></li>
            
                <li><a href="../classes/SimpleInputBrick.html">SimpleInputBrick</a></li>
            
                <li><a href="../classes/StepItem.html">StepItem</a></li>
            
                <li><a href="../classes/SubPanel.html">SubPanel</a></li>
            
                <li><a href="../classes/SubPanelSettings.html">SubPanelSettings</a></li>
            
                <li><a href="../classes/Theme.html">Theme</a></li>
            
                <li><a href="../classes/TmplHelper.html">TmplHelper</a></li>
            
                <li><a href="../classes/TmplUtil.html">TmplUtil</a></li>
            
                <li><a href="../classes/ToggleBrick.html">ToggleBrick</a></li>
            
                <li><a href="../classes/Url.html">Url</a></li>
            
                <li><a href="../classes/Util.html">Util</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/AttributeLoader.html">AttributeLoader</a></li>
            
                <li><a href="../modules/BookmarkLink.html">BookmarkLink</a></li>
            
                <li><a href="../modules/Bricks.html">Bricks</a></li>
            
                <li><a href="../modules/Datagrid.html">Datagrid</a></li>
            
                <li><a href="../modules/DataLoader.html">DataLoader</a></li>
            
                <li><a href="../modules/FilterManager.html">FilterManager</a></li>
            
                <li><a href="../modules/GeoSearch.html">GeoSearch</a></li>
            
                <li><a href="../modules/GlobalStorage.html">GlobalStorage</a></li>
            
                <li><a href="../modules/Map.html">Map</a></li>
            
                <li><a href="../modules/Maptips.html">Maptips</a></li>
            
                <li><a href="../modules/Navigation.html">Navigation</a></li>
            
                <li><a href="../modules/QuickZoom.html">QuickZoom</a></li>
            
                <li><a href="../modules/RAMP.html">RAMP</a></li>
            
                <li><a href="../modules/Theme.html">Theme</a></li>
            
                <li><a href="../modules/Tools.html">Tools</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
                <li><a href="../modules/Utils.html">Utils</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/js/RAMP/Modules/layerItem.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
ï»¿/* global define, tmpl, $, console, i18n */

/**
* @module RAMP
* @submodule FilterManager
* @main FilterManager
*/

/**
* Create a layer item for each map layer to be displayed in the layer selector. Allows for dynamic changing of the layer item state. 
* 
* ####Imports RAMP Modules:
* {{#crossLink &quot;Util&quot;}}{{/crossLink}}  
* {{#crossLink &quot;TmplHelper&quot;}}{{/crossLink}}  
* {{#crossLink &quot;TmplUtil&quot;}}{{/crossLink}}  
* {{#crossLink &quot;Array&quot;}}{{/crossLink}}  
* {{#crossLink &quot;Dictionary&quot;}}{{/crossLink}}  
*  
* 
* ####Uses RAMP Templates:
* {{#crossLink &quot;templates/layer_selector_template.json&quot;}}{{/crossLink}}
* 
* @class LayerItem
* @constructor
* @uses dojo/Evented
* @uses dojo/_base/declare
* @uses dojo/lang
* 
* @param {Object} config a config definition of the layer
* @param {Object} [options] Additional options
* 
* @param {String} [options.state] Specifies the initial state of the LyerItem; must be one of the &#x60;LayerItem.state&#x60; defaults
* @param {String} [options.type] Specifies type of this LayerItem and the name of the layer item template to use
* 
* @param {Object} [options.stateMatrix] additional state matrix records to be mixed into the default
* @param {Object} [options.transitionMatrix] additional state transition matrix records to be mixed into the default
* 
* @return {LayerItem} A control object representing a layer allowing to dynamically change its state.
*/

define([
    &#x27;dojo/Evented&#x27;, &#x27;dojo/_base/declare&#x27;, &#x27;dojo/_base/lang&#x27;,

    /* Text */
    &#x27;dojo/text!./templates/layer_selector_template.json&#x27;,

    /* Util */
    &#x27;utils/util&#x27;, &#x27;utils/tmplHelper&#x27;, &#x27;utils/tmplUtil&#x27;, &#x27;utils/array&#x27;, &#x27;utils/dictionary&#x27;, &#x27;utils/bricks&#x27;
],
    function (
        Evented, declare, lang,
        layer_selector_template,
        Util, TmplHelper, TmplUtil, UtilArray, UtilDict, Bricks
    ) {
        &#x27;use strict&#x27;;

        var LayerItem,
            ALL_STATES_CLASS;

        LayerItem = declare([Evented], {
            constructor: function (config, options) {
                // declare individual properties inside the constructor: http://dojotoolkit.org/reference-guide/1.9/dojo/_base/declare.html#id6
                lang.mixin(this,
                    {
                        /**
                         * Layer id. Upon initialization, &#x60;id&#x60; can be overwritten by &#x60;config.id&#x60; value. 
                         *
                         * @property id
                         * @type String
                         * @default null
                         */
                        id: null,

                        /**
                         * A node of the LayerItem.
                         *
                         * @property node
                         * @type JObject
                         * @default null
                         */
                        node: null,

                        /**
                         * A copy of the layer config supplied during LayerItem creation; is set to &#x60;config&#x60; value.
                         *
                         * @property _config
                         * @private
                         * @type Object
                         * @default null
                         */
                        _config: null,

                        /**
                         * A node of the image container.
                         *
                         * @property _imageContainerNode
                         * @private
                         * @type JObject
                         * @default null
                         */
                        _imageContainerNode: null,

                        /**
                         * A node of the layer display name.
                         *
                         * @property _displayNameNode
                         * @private
                         * @type JObject
                         * @default null
                         */
                        _displayNameNode: null,

                        /**
                         * A node of the layer controls.
                         *
                         * @property _controlsNode
                         * @private
                         * @type JObject
                         * @default null
                         */
                        _controlsNode: null,

                        /**
                         * A node of the layer toggles.
                         *
                         * @property _togglesNode
                         * @private
                         * @type JObject
                         * @default null
                         */
                        _togglesNode: null,

                        /**
                         * A node of the layer toggles.
                         *
                         * @property _togglesNode
                         * @private
                         * @type JObject
                         * @default null
                         */
                        _noticesNode: null,

                        /**
                         * A node of the layer toggles.
                         *
                         * @property _togglesNode
                         * @private
                         * @type JObject
                         * @default null
                         */
                        _settingsNode: null,

                        /**
                         * A dictionary of control nodes available for this layer.
                         *
                         * @property _controlStore
                         * @private
                         * @type Object
                         * @default {}
                         */
                        _controlStore: {},

                        /**
                         * A dictionary of toggle nodes available for this layer.
                         *
                         * @property _toggleStore
                         * @private
                         * @type Object
                         * @default {}
                         */
                        _toggleStore: {},

                        /**
                         * A dictionary of notice nodes available for this layer.
                         *
                         * @property _noticeStore
                         * @private
                         * @type Object
                         * @default {}
                         */
                        _noticeStore: {},

                        /**
                         * A dictionary of setting nodes available for this layer.
                         *
                         * @property _settingStore
                         * @private
                         * @type Object
                         * @default {}
                         */
                        _settingsStore: {},

                        /**
                         * Templates to be used in construction of the layer nodes.
                         *
                         * @property templates
                         * @type Object
                         * @default layer_selector_template.json
                         */
                        templates: JSON.parse(TmplHelper.stringifyTemplate(layer_selector_template)),

                        /**
                         * State of this LayerItem; can be overwritten by &#x60;options.state&#x60;.
                         *
                         * @property state
                         * @type String
                         * @default LayerItem.state.DEFAULT
                         */
                        state: LayerItem.state.DEFAULT,

                        /**
                         * Specifies type of this LayerItem and the name of the layer item template to use; can be overwritten by &#x60;options.type&#x60;.
                         *
                         * @property type
                         * @type String
                         * @default null
                         */
                        type: null
                    },
                    options,
                    {
                        id: config.id,

                        _config: config,

                        /**
                         * Specifies a state matrix for this particular LayerItem. The default is mixed with &#x60;options.stateMatrix&#x60; upon initialization.
                         * The state matrix prescribes what controls, toggles, and notices are present in specific states. 
                         * 
                         * @property stateMatrix
                         * @type Object
                         * @default LayerItem.stateMatrix
                         */
                        stateMatrix: lang.mixin(
                            lang.clone(LayerItem.stateMatrix),
                            options.stateMatrix
                        ),

                        /**
                         * Specifies a state transition matrix for this particular LayerItem. The default is mixed with &#x60;options.transitionMatrix&#x60; upon initialization.
                         * The state transition matrix prescribes the direction of state changes for specific states.
                         *
                         * @property transitionMatrix
                         * @type Object
                         * @default LayerItem.transitionMatrix
                         */
                        transitionMatrix: lang.mixin(
                            lang.clone(LayerItem.transitionMatrix),
                            options.transitionMatrix
                        )
                    }
                );

                // can&#x27;t use i18n before locale files are loaded, so have to set brick templates after 
                if (!LayerItem.brickTemplates) {
                    LayerItem.brickTemplates = {
                        bounding_box_brick: {
                            type: Bricks.CheckboxfsBrick,
                            config: {
                                label: i18n.t(&#x27;filterManager.boundingBox&#x27;),
                                customContainerClass: &#x27;bbox&#x27;,
                                checked: false//,
                                //instructions: i18n.t(&#x27;addDataset.help.dataSource&#x27;)
                            }
                        },

                        all_data_brick: {
                            type: Bricks.ChoiceBrick,
                            config: {
                                header: i18n.t(&#x27;filterManager.layerData&#x27;),
                                template: &#x27;default_choice_brick_inline_template&#x27;,
                                containerClass: &#x27;choice-brick-inline-container&#x27;,
                                customContainerClass: &#x27;all-data&#x27;,
                                choices: [
                                    {
                                        key: &#x27;layerDataPrefetch&#x27;,
                                        value: i18n.t(&#x27;filterManager.layerDataPrefetch&#x27;)
                                    }
                                ]
                                //instructions: i18n.t(&#x27;addDataset.help.dataSource&#x27;)
                            }

                        },

                        all_data_checked_brick: {
                            type: Bricks.ChoiceBrick,
                            config: {
                                header: i18n.t(&#x27;filterManager.layerData&#x27;),
                                template: &#x27;default_choice_brick_inline_template&#x27;,
                                containerClass: &#x27;choice-brick-inline-container&#x27;,
                                customContainerClass: &#x27;all-data&#x27;,
                                isEnabled: false,
                                preselect: &#x27;layerDataPrefetch&#x27;,
                                choices: [
                                    {
                                        key: &#x27;layerDataPrefetch&#x27;,
                                        value: i18n.t(&#x27;filterManager.layerDataPrefetch&#x27;)
                                    }
                                ]
                                //instructions: i18n.t(&#x27;addDataset.help.dataSource&#x27;)
                            }

                        }
                    };
                }

                tmpl.cache = {};
                tmpl.templates = this.templates;

                var info = this._config;
                info.fn = TmplUtil;

                this.node = $(tmpl(this.type, info));
                this._imageBoxNode = this.node.find(&#x27;.layer-details &gt; div:first&#x27;);
                this._displayNameNode = this.node.find(&#x27;.layer-name &gt; span&#x27;);
                this._controlsNode = this.node.find(&#x27;.layer-controls-group&#x27;);
                this._togglesNode = this.node.find(&#x27;.layer-checkboxes&#x27;);
                this._noticesNode = this.node.find(&#x27;.layer-notices&#x27;);
                this._settingsNode = this.node.find(&#x27;.layer-settings&#x27;);

                this._generateParts(&#x27;controls&#x27;, &#x27;layer_control_&#x27;, this._controlStore);
                this._generateParts(&#x27;toggles&#x27;, &#x27;layer_toggle_&#x27;, this._toggleStore);
                this._generateParts(&#x27;notices&#x27;, &#x27;layer_notice_&#x27;, this._noticeStore);
                this._generateParts(&#x27;settings&#x27;, &#x27;layer_setting_&#x27;, this._settingsStore);

                this.setState(this.state, options, true);

                console.debug(&#x27;--&gt;&#x27;, this.state, options);
            },

            /**
             * Generates control, toggle, and notice nodes for the LayerItem object to be used in different states.
             *
             * @param {String} partType name of the part type - &#x27;controls&#x27;, &#x27;toggles&#x27;, or &#x27;notices&#x27;
             * @param {String} templateKey a template name prefix for the template parts
             * @param {Object} partStore a dictionary to store generated nodes
             * @method _generateParts
             * @private
             */
            _generateParts: function (partType, templateKey, partStore) {
                var that = this,

                    stateKey,
                    partKeys = [],
                    part,

                    brickTemplate,
                    brickPart;

                Object
                    .getOwnPropertyNames(LayerItem.state)
                    .forEach(function (s) {
                        stateKey = LayerItem.state[s];
                        partKeys = partKeys.concat(that.stateMatrix[stateKey][partType]);
                    });

                partKeys = UtilArray.unique(partKeys);

                partKeys.forEach(function (pKey) {
                    if (LayerItem.brickTemplates[pKey]) {
                        brickTemplate = LayerItem.brickTemplates[pKey];

                        brickPart = brickTemplate.type.new(pKey, brickTemplate.config);
                        // TODO: fix
                        // hack to get the data-layer-id attribute onto checkboxBrick input node
                        // used in conjunction with ChekcboxGroup in FilterManager; will be removed when layerItem is switched full to Bricks and 
                        // LayerCollection controller is added in between filterManager and LayerGroup.

                        if (Bricks.CheckboxBrick.isPrototypeOf(brickPart)) {
                            brickPart.inputNode.attr(&#x27;data-layer-id&#x27;, that._config.id);
                        } else {
                            brickPart.choiceButtons.attr(&#x27;data-layer-id&#x27;, that._config.id);
                        }

                        part = brickPart.node;

                    } else {
                        part = that._generatePart(templateKey, pKey);
                    }
                    partStore[pKey] = (part);
                });
            },

            /**
             * Generates a control given the template name and additional data object to pass to the template engine.
             *
             * @param {String} templateKey a template name prefix for the template parts
             * @param {String} pKey name of the template to build
             * @param {Object} [data] optional data to pass to template engine; used to update strings on notice objects
             * @method _generatePart
             * @private
             * @return Created part node
             */
            _generatePart: function (templateKey, pKey, data) {
                tmpl.cache = {};
                tmpl.templates = this.templates;

                var info = {
                    id: this.id,
                    config: this._config,
                    nameKey: pKey,
                    data: data
                };
                info.fn = TmplUtil;
                var part = $(tmpl(templateKey + pKey, info));

                return part;
            },

            /**
             * Changes the state of the LayerItem and update its UI representation.
             *
             * @param {String} state name of the state to be set
             * @param {Object} [options] additional options
             * @param {Object} [options.notices] custom information to be displayed in a notice for the current state if needed; object structure is not set; look at the appropriate template; 
             * @example
             *      {
             *          notices: {
             *              error: {
             *                  message: &quot;I am error&quot;
             *              },
             *              scale: {
             *                  message: &quot;All your base are belong to us&quot;
             *              }
             *          }
             *      }
             * @param {Boolean} force if &#x60;true&#x60;, forces the state change even if it&#x27;s no allowed by the &#x60;transitionMatrix&#x60;
             * @method setState
             */
            setState: function (state, options, force) {
                var allowedStates = this.transitionMatrix[this.state],
                    notice,
                    focusedNode,

                    that = this;

                if (allowedStates.indexOf(state) !== -1 || force) {

                    this.state = state;
                    //lang.mixin(this, options);

                    // set state class on the layerItem root node
                    this.node
                        .removeClass(ALL_STATES_CLASS)
                        .addClass(this.state);

                    // regenerate notice controls if extra data is provided
                    if (options) {
                        if (options.notices) {

                            UtilDict.forEachEntry(options.notices, function (pKey, data) {
                                notice = that._generatePart(&#x27;layer_notice_&#x27;, pKey, data);

                                that._noticeStore[pKey] = (notice);
                            });
                        }
                    }

                    // store reference to a focused node inside this layer item if any
                    focusedNode = this.node.find(&#x27;:focus&#x27;);

                    this._setParts(&#x27;controls&#x27;, this._controlStore, this._controlsNode);
                    this._setParts(&#x27;toggles&#x27;, this._toggleStore, this._togglesNode);
                    this._setParts(&#x27;notices&#x27;, this._noticeStore, this._noticesNode);
                    this._setParts(&#x27;settings&#x27;, this._settingsStore, this._settingsNode);

                    switch (this.state) {
                        case LayerItem.state.DEFAULT:
                            console.log(LayerItem.state.DEFAULT);
                            break;

                        case LayerItem.state.LOADING:
                            this.node.attr(&#x27;aria-busy&#x27;, true); // indicates that the region is loading

                            console.log(LayerItem.state.LOADING);
                            break;

                        case LayerItem.state.LOADED:
                            this.node.attr(&#x27;aria-busy&#x27;, false); // indicates that the loading is complete
                            this.setState(LayerItem.state.DEFAULT);

                            console.log(LayerItem.state.LOADED);
                            break;

                        case LayerItem.state.ERROR:
                            console.log(LayerItem.state.ERROR);
                            break;

                        case LayerItem.state.OFF_SCALE:
                            console.log(LayerItem.state.OFF_SCALE);
                            break;

                        default:
                            break;
                    }

                    // reset focus after changing layer item&#x27;s state
                    if (focusedNode.length &gt; 0) {
                        // if the previously focused node still in DOM, set focus to it
                        if (Util.containsInDom(focusedNode[0])) {
                            focusedNode.focus();
                        } else { // if this node is no longer in DOM, set focus to the first focusable element in layer item
                            this.node.find(&#x27;:focusable:first&#x27;).focus();
                        }
                    }

                    return true;
                } else {
                    return false;
                }
            },

            refresh: function () {
                this.setState(this.state, null, true);
            },

            /**
             * Sets controls, toggles, and notices of the LayerItem according to its state.
             *
             * @param {String} partType name of the part type - &#x27;controls&#x27;, &#x27;toggles&#x27;, or &#x27;notices&#x27;
             * @param {Object} partStore a dictionary to store generated nodes
             * @param {JObject} target a jQuery node where the nodes should be appended
             * @method _setParts
             * @private
             */
            _setParts: function (partType, partStore, target) {
                var controls = [];

                this.stateMatrix[this.state][partType].forEach(function (pKey) {
                    controls.push(partStore[pKey]);
                });

                // use detach instead of empty to preserve handlers that jQuery deletes on empty
                // http://stackoverflow.com/questions/2027706/why-do-registered-events-disappear-when-an-element-is-removed-from-dom/14900035#14900035
                // http://api.jquery.com/detach/
                target
                    .children()
                    .detach()
                    .end()
                    .append(controls)
                ;
            }
        });

        /**
         * Helper function to check if &#x60;states&#x60; parameter is false or []. If empty array is supplied, all available states are returned
         * 
         * @param {Array} [states] state names
         * @method getStateNames
         * @private
         */
        function getStateNames(states) {
            if (typeof states === &#x27;undefined&#x27; || !states || states.length === 0) {
                states = Object
                    .getOwnPropertyNames(LayerItem.state)
                    .map(function (key) { return LayerItem.state[key]; });
            }

            return states;
        }

        /**
         * Helper function to check if &#x60;partKeys&#x60; parameter is false or []. If empty array is supplied, all available partKeys for the specified partType are returned.
         * 
         * @param {String} partType a part type
         * @param {Array} [partKeys] part keys
         * @method getPartKeys
         * @return {Array} an array of partKeys
         * @private
         */
        function getPartKeys(partType, partKeys) {
            if (typeof partKeys === &#x27;undefined&#x27; || !partKeys || partKeys.length === 0) {
                partKeys = Object
                    .getOwnPropertyNames(LayerItem[partType])
                    .map(function (key) { return LayerItem[partType][key]; });
            }

            return partKeys;
        }

        lang.mixin(LayerItem,
            {
                /**
                * A default collection of possible LayerItem states.
                *
                * @property LayerItem.state
                * @static
                * @type Object
                * @example 
                *     state: {
                *       DEFAULT: &#x27;layer-state-default&#x27;,
                *       LOADING: &#x27;layer-state-loading&#x27;,
                *       LOADED: &#x27;layer-state-loaded&#x27;,
                *       UPDATING: &#x27;layer-state-updating&#x27;,
                *       ERROR: &#x27;layer-state-error&#x27;,
                *       OFF_SCALE: &#x27;layer-state-off-scale&#x27;
                *       }
                */
                state: {
                    DEFAULT: &#x27;layer-state-default&#x27;,
                    LOADING: &#x27;layer-state-loading&#x27;,
                    LOADED: &#x27;layer-state-loaded&#x27;,
                    UPDATING: &#x27;layer-state-updating&#x27;,
                    ERROR: &#x27;layer-state-error&#x27;,
                    OFF_SCALE: &#x27;layer-state-off-scale&#x27;
                },

                /**
                * A default collection of possible LayerItem part types.
                *
                * @property LayerItem.partTypes
                * @static
                * @type Object
                * @example 
                *     partTypes: {
                *       TOGGLES: &#x27;toggles&#x27;,
                *       CONTROLS: &#x27;controls&#x27;,
                *       NOTICES: &#x27;notices&#x27;,
                *       SETTINGS: &#x27;settings&#x27;
                *       }
                */
                partTypes: {
                    TOGGLES: &#x27;toggles&#x27;,
                    CONTROLS: &#x27;controls&#x27;,
                    NOTICES: &#x27;notices&#x27;,
                    SETTINGS: &#x27;settings&#x27;
                },

                /**
                * A default collection of possible LayerItem controls.
                *
                * @property LayerItem.controls
                * @static
                * @type Object
                * @example 
                *     controls: {
                *            METADATA: &#x27;metadata&#x27;,
                *            SETTINGS: &#x27;settings&#x27;,
                *            LOADING: &#x27;loading&#x27;,
                *            REMOVE: &#x27;remove&#x27;,
                *            RELOAD: &#x27;reload&#x27;,
                *            ERROR: &#x27;error&#x27;
                *           }
                */
                controls: {
                    METADATA: &#x27;metadata&#x27;,
                    SETTINGS: &#x27;settings&#x27;,
                    LOADING: &#x27;loading&#x27;,
                    REMOVE: &#x27;remove&#x27;,
                    RELOAD: &#x27;reload&#x27;,
                    ERROR: &#x27;error&#x27;
                },

                /**
                * A default collection of possible LayerItem toggles.
                *
                * @property LayerItem.toggles
                * @static
                * @type Object
                * @example 
                *     toggles: {
                *           EYE: &#x27;eye&#x27;,
                *           BOX: &#x27;box&#x27;,
                *            RELOAD: &#x27;reload&#x27;,
                *            HIDE: &#x27;hide&#x27;,
                *            ZOOM: &#x27;zoom&#x27;,
                *            PLACEHOLDER: &#x27;placeholder&#x27;
                *        }
                */
                toggles: {
                    EYE: &#x27;eye&#x27;,
                    BOX: &#x27;box&#x27;,
                    RELOAD: &#x27;reload&#x27;,
                    HIDE: &#x27;hide&#x27;,
                    ZOOM: &#x27;zoom&#x27;,
                    PLACEHOLDER: &#x27;placeholder&#x27;,
                    QUERY: &#x27;query&#x27;
                },

                /**
                * A default collection of possible LayerItem notices.
                *
                * @property LayerItem.notices
                * @static
                * @type Object
                * @example 
                *     notices: {
                *            SCALE: &#x27;scale&#x27;
                *            ERROR: &#x27;error&#x27;,
                *            UPDATE: &#x27;update&#x27;,
                *            USER: &#x27;user&#x27;
                *           }
                */
                notices: {
                    SCALE: &#x27;scale&#x27;,
                    ERROR: &#x27;error&#x27;,
                    UPDATE: &#x27;update&#x27;,
                    USER: &#x27;user&#x27;
                },

                /**
                * A default collection of possible LayerItem settings.
                *
                * @property LayerItem.settings
                * @static
                * @type Object
                * @example 
                *     settings: {
                *           OPACITY: &#x27;opacity&#x27;,
                *           BOUNDING_BOX: &#x27;bounding_box&#x27;,
                *           SNAPSHOT: &#x27;snapshot&#x27;
                *           }
                */
                settings: {
                    OPACITY: &#x27;opacity&#x27;,
                    BOUNDING_BOX: &#x27;bounding_box_brick&#x27;,
                    SNAPSHOT: &#x27;snapshot&#x27;,
                    ALL_DATA: &#x27;all_data_brick&#x27;,
                    ALL_DATA_CHECKED: &#x27;all_data_checked_brick&#x27; // a Choice brick which is alreayd preselected
                },

                /**
                * A default state matrix specifying what controls are active in which state.
                *
                * @property LayerItem.stateMatrix
                * @static
                * @type Object
                * @example 
                *        DEFAULT: {
                *            controls: [
                *                LayerItem.controls.METADATA,
                *                LayerItem.controls.SETTINGS
                *            ],
                *            toggles: [
                *                LayerItem.toggles.EYE,
                *                LayerItem.toggles.BOX
                *            ],
                *            notices: []
                *        },
                *
                *        LOADING: {
                *            controls: [
                *                LayerItem.controls.LOADING
                *            ],
                *            toggles: [],
                *            notices: []
                *        },
                * 
                *        LOADED: {
                *            controls: [],
                *            toggles: [],
                *            notices: []
                *        },
                *        DEFAULT: {
                *            controls: [
                *                LayerItem.controls.METADATA,
                *                LayerItem.controls.SETTINGS
                *            ],
                *            toggles: [
                *                LayerItem.toggles.EYE,
                *                LayerItem.toggles.BOX
                *            ],
                *            notices: [
                *                LayerItem.notices.UPDATE
                *            ]
                *        },
                *
                *        ERROR: {
                *            controls: [
                *                LayerItem.controls.RELOAD,
                *                LayerItem.controls.REMOVE
                *            ],
                *            toggles: [],
                *            notices: [
                *                LayerItem.notices.ERROR
                *            ]
                *        },
                *
                *        OFF_SCALE: {
                *            controls: [
                *                LayerItem.controls.METADATA,
                *                LayerItem.controls.SETTINGS
                *            ],
                *            toggles: [
                *                LayerItem.toggles.ZOOM,
                *                LayerItem.toggles.EYE,
                *                LayerItem.toggles.BOX
                *            ],
                *            notices: [
                *                LayerItem.notices.SCALE
                *            ]
                *        }
                */
                stateMatrix: {},

                /**
                * A default state transition matrix specifying to what state the LayerItem can transition.
                *
                * @property LayerItem.transitionMatrix
                * @static
                * @type Object
                * @example 
                *        DEFAULT: [
                *            LayerItem.state.ERROR,
                *            LayerItem.state.OFF_SCALE,
                *            LayerItem.state.UPDATING
                *        ],
                *        LOADED: [
                *            LayerItem.state.DEFAULT
                *        ],
                *        LOADING: [
                *            LayerItem.state.LOADED
                *        ],
                *        UPDATING: [
                *            LayerItem.state.ERROR,
                *            LayerItem.state.OFF_SCALE,
                *            LayerItem.state.DEFAULT
                *        ],
                *        ERROR: [
                *            LayerItem.state.LOADING
                *        ],
                *        OFF_SCALE: [
                *            LayerItem.state.ERROR,
                *            LayerItem.state.DEFAULT,
                *            LayerItem.state.UPDATING
                *        ]
                * 
                */
                transitionMatrix: {},

                /**
                 * A temporary store for brick templates.
                 * TODO: re-think how to best use brick/templates inside the layer item
                 * 
                 * @property LayerItem.brickTemplates
                 * @static
                 * @type Object
                 * @default null
                 */
                brickTemplates: null
            }
        );

        // setting defaults for state matrix
        LayerItem.stateMatrix[LayerItem.state.DEFAULT] = {
            controls: [
                LayerItem.controls.METADATA,
                LayerItem.controls.SETTINGS,
                LayerItem.controls.REMOVE
            ],
            toggles: [],
            notices: [],
            settings: [
                LayerItem.settings.OPACITY
            ]
        };

        LayerItem.stateMatrix[LayerItem.state.LOADING] = {
            controls: [
                LayerItem.controls.LOADING
            ],
            toggles: [],
            notices: [],
            settings: [
                LayerItem.settings.OPACITY
            ]
        };

        LayerItem.stateMatrix[LayerItem.state.LOADED] = {
            controls: [],
            toggles: [],
            notices: [],
            settings: []
        };

        LayerItem.stateMatrix[LayerItem.state.UPDATING] = {
            controls: [
                LayerItem.controls.METADATA,
                LayerItem.controls.SETTINGS,
                LayerItem.controls.REMOVE
            ],
            toggles: [],
            notices: [
                LayerItem.notices.UPDATE
            ],
            settings: [
                LayerItem.settings.OPACITY
            ]
        };

        LayerItem.stateMatrix[LayerItem.state.ERROR] = {
            controls: [
                LayerItem.controls.RELOAD,
                LayerItem.controls.REMOVE
            ],
            toggles: [],
            notices: [
                LayerItem.notices.ERROR
            ],
            settings: [
                LayerItem.settings.OPACITY
            ]
        };

        LayerItem.stateMatrix[LayerItem.state.OFF_SCALE] = {
            controls: [
                LayerItem.controls.METADATA,
                LayerItem.controls.SETTINGS,
                LayerItem.controls.REMOVE
            ],
            toggles: [
                LayerItem.toggles.ZOOM
            ],
            notices: [
                LayerItem.notices.SCALE
            ],
            settings: [
                LayerItem.settings.OPACITY
            ]
        };

        // setting defaults for transition matrix
        LayerItem.transitionMatrix[LayerItem.state.DEFAULT] = [
            LayerItem.state.ERROR,
            LayerItem.state.OFF_SCALE,
            LayerItem.state.UPDATING
        ];

        LayerItem.transitionMatrix[LayerItem.state.LOADING] = [
            LayerItem.state.LOADED,
            LayerItem.state.ERROR,
            LayerItem.state.UPDATING
        ];

        LayerItem.transitionMatrix[LayerItem.state.LOADED] = [
            LayerItem.state.DEFAULT
        ];

        LayerItem.transitionMatrix[LayerItem.state.UPDATING] = [
            LayerItem.state.LOADED,
            LayerItem.state.ERROR
        ];

        LayerItem.transitionMatrix[LayerItem.state.ERROR] = [
            LayerItem.state.LOADING
        ];

        LayerItem.transitionMatrix[LayerItem.state.OFF_SCALE] = [
            LayerItem.state.ERROR,
            LayerItem.state.DEFAULT,
            LayerItem.state.UPDATING
        ];

        /**
        * Modifies a given state matrix by adding specified partKey to the specified partType collection.
        *
        * @param {Object} stateMatrix matrix to modify
        * @param {String} partType type of the parts to modify: &#x60;controls&#x60;, &#x60;toggles&#x60;, &#x60;notices&#x60;
        * @param {String} partKey part key to be inserted into the collection
        * @param {Array} [states] array of state names to insert the part into; if false or [], all states are assumed
        * @param {Boolean} [prepend] indicates if the part key should be prepended or appended
        * @method addStateMatrixPart
        * @static
        */
        LayerItem.addStateMatrixPart = function (stateMatrix, partType, partKey, states, prepend) {
            var parts;

            states = getStateNames(states);
            states.forEach(function (state) {
                parts = stateMatrix[state][partType];
                if (prepend) {
                    parts.unshift(partKey);
                } else {
                    parts.push(partKey);
                }
            });

            /*UtilDict.forEachEntry(stateMatrix, function (state, data) {
                if (states.indexOf(state) !== -1) {
                    if (prepend) {
                        data[partType].unshift(partKey);
                    } else {
                        data[partType].push(partKey);
                    }
                }
            });*/
        };

        /**
        * Sets given matrix states by adding specified partKeys to the specified partType collection.
        *
        * @param {Object} stateMatrix matrix to modify
        * @param {String} partType type of the parts to modify: &#x60;controls&#x60;, &#x60;toggles&#x60;, &#x60;notices&#x60;
        * @param {Array} [partKeys] an array of part key names to be inserted into the collection; if false or [], all part keys are assumed
        * @param {Array} [states] array of state names to insert the part into; if false or [], all states are assumed
        * @param {Boolean} [prepend] indicates if the part key should be prepended or appended
        * @param {Boolean} [clear] a flag to clear existing partKey collections
        * @method addStateMatrixParts
        * @static
        */
        LayerItem.addStateMatrixParts = function (stateMatrix, partType, partKeys, states, prepend, clear) {
            var that = this;
            partKeys = getPartKeys(partType, partKeys);
            states = getStateNames(states);

            // remove partkeys
            if (clear) {
                states.forEach(function (state) {
                    stateMatrix[state][partType] = [];
                });
            }

            // add new ones
            partKeys.forEach(function (partKey) {
                that.addStateMatrixPart(stateMatrix, partType, partKey, states, prepend);
            });
        };

        /**
         * Modifies a given state matrix by removing specified partKey to the specified partType collection.
         *
         * @param {Object} stateMatrix matrix to modify
         * @param {String} partType type of the parts to modify: &#x60;controls&#x60;, &#x60;toggles&#x60;, &#x60;notices&#x60;
         * @param {String} partKey part key to be removed from the collection
         * @param {Array} [states] array of state names to remove the part from; if false or [], all states are assumed
         * @method addStateMatrixPart
         * @static
         */
        LayerItem.removeStateMatrixPart = function (stateMatrix, partType, partKey, states) {
            states = getStateNames(states);
            states.forEach(function (state) {
                UtilArray.remove(stateMatrix[state][partType], partKey);
            });
        };

        /**
         * Modifies a given state matrix by removing specified partKeys to the specified partType collection.
         *
         * @param {Object} stateMatrix matrix to modify
         * @param {String} partType type of the parts to modify: &#x60;controls&#x60;, &#x60;toggles&#x60;, &#x60;notices&#x60;
         * @param {String} [partKeys] array of part key names to be removed from the collection; if false or [], all part keys are assumed
         * @param {Array} [states] array of state names to remove the part from; if false or [], all states are assumed
         * @method removeStateMatrixParts
         * @static
         */
        LayerItem.removeStateMatrixParts = function (stateMatrix, partType, partKeys, states) {
            var that = this;
            partKeys = getPartKeys(partType, partKeys);
            states = getStateNames(states);

            // remove partkey from states
            partKeys.forEach(function (partKey) {
                that.removeStateMatrixPart(stateMatrix, partType, partKey, states);
            });
        };

        /**
         * Get a deep copy of the default stateMatrix.
         * 
         * @method getStateMatrixTemplate
         * @static
         * @return {Object} a deep copy of the default stateMatrix
         */
        LayerItem.getStateMatrixTemplate = function () {
            return lang.clone(LayerItem.stateMatrix);
        };

        // a string with all possible layerItem state CSS classes joined by &#x27; &#x27;; used to clear any CSS state class from the node
        ALL_STATES_CLASS =
            Object
                .getOwnPropertyNames(LayerItem.state)
                .map(function (key) { return LayerItem.state[key]; })
                .join(&#x27; &#x27;);

        return LayerItem;
    });
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
