<!DOCTYPE html>

<html>
<head>
  <title>bookmarkLink.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="advancedToolbar.html">
                advancedToolbar.js
              </a>
            
              
              <a class="source" href="basemapSelector.html">
                basemapSelector.js
              </a>
            
              
              <a class="source" href="bookmarkLink.html">
                bookmarkLink.js
              </a>
            
              
              <a class="source" href="datagrid.html">
                datagrid.js
              </a>
            
              
              <a class="source" href="datagridClickHandler.html">
                datagridClickHandler.js
              </a>
            
              
              <a class="source" href="eventManager.html">
                eventManager.js
              </a>
            
              
              <a class="source" href="featureClickHandler.html">
                featureClickHandler.js
              </a>
            
              
              <a class="source" href="featureHighlighter.html">
                featureHighlighter.js
              </a>
            
              
              <a class="source" href="filterManager.html">
                filterManager.js
              </a>
            
              
              <a class="source" href="globalStorage.html">
                globalStorage.js
              </a>
            
              
              <a class="source" href="graphicExtension.html">
                graphicExtension.js
              </a>
            
              
              <a class="source" href="gui.html">
                gui.js
              </a>
            
              
              <a class="source" href="map.html">
                map.js
              </a>
            
              
              <a class="source" href="mapClickHandler.html">
                mapClickHandler.js
              </a>
            
              
              <a class="source" href="maptips.html">
                maptips.js
              </a>
            
              
              <a class="source" href="navigation.html">
                navigation.js
              </a>
            
              
              <a class="source" href="quickzoom.html">
                quickzoom.js
              </a>
            
              
              <a class="source" href="ramp.html">
                ramp.js
              </a>
            
              
              <a class="source" href="RAMP-starter.html">
                RAMP-starter.js
              </a>
            
              
              <a class="source" href="theme.html">
                theme.js
              </a>
            
              
              <a class="source" href="theme.html">
                theme.js
              </a>
            
              
              <a class="source" href="theme.html">
                theme.js
              </a>
            
              
              <a class="source" href="areaTool.html">
                areaTool.js
              </a>
            
              
              <a class="source" href="baseTool.html">
                baseTool.js
              </a>
            
              
              <a class="source" href="bufferTool.html">
                bufferTool.js
              </a>
            
              
              <a class="source" href="distanceTool.html">
                distanceTool.js
              </a>
            
              
              <a class="source" href="populationTool.html">
                populationTool.js
              </a>
            
              
              <a class="source" href="array.html">
                array.js
              </a>
            
              
              <a class="source" href="checkbox.html">
                checkbox.js
              </a>
            
              
              <a class="source" href="checkboxGroup.html">
                checkboxGroup.js
              </a>
            
              
              <a class="source" href="decorator.html">
                decorator.js
              </a>
            
              
              <a class="source" href="dictionary.html">
                dictionary.js
              </a>
            
              
              <a class="source" href="functionMangler.html">
                functionMangler.js
              </a>
            
              
              <a class="source" href="popupManager.html">
                popupManager.js
              </a>
            
              
              <a class="source" href="prototype.html">
                prototype.js
              </a>
            
              
              <a class="source" href="tmplHelper.html">
                tmplHelper.js
              </a>
            
              
              <a class="source" href="tmplUtil.html">
                tmplUtil.js
              </a>
            
              
              <a class="source" href="url.html">
                url.js
              </a>
            
              
              <a class="source" href="util.html">
                util.js
              </a>
            
              
              <a class="source" href="bootstrapper.html">
                bootstrapper.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>bookmarkLink.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* global define, i18n */</span>

<span class="hljs-comment">/**
* BookmarkLink submodule
*
* Keeps track of the current state of the map and updates the GetLinkPanel's textbook accordingly. On page load, if any
* parameters are detected in the URL, this module will attempt to recreate the map according to the parameters. Internally,
* this module subscribes to all events that change the state of the map (e.g. extent-change, layers toggled on/off). It contains
* a dictionary that map event names to an object that contains the minimum information needed to reconstruct the map for that particular
* event. For example, if an extent change occurred, this module will add a key "map/extent-change" (or update if the entry already exists)
* and put an object that contains the minimum information needed to reconstruct the map to that extent (in this case it would be
* xmin, ymin, xmax, ymax. Spatial reference is not needed since the map always has the same spatial reference).
*
* @module RAMP
* @submodule BookmarkLink
* @main BookmarkLink
*/</span>

<span class="hljs-comment">/**
* BookmarkLink class.
*
*
* ### Steps for making the bookmark link update with an event
*
* 1. Subscribe to the event of interest (e.g. map extent-change)
* 2. Create an object containing fields that will contain the necessary
*    information for reconstructing the map to the same state. (e.g. for
*    map extent-change, a useful object might be one that represents the
*    current extent of the map: `{ xmin : 123, xmax : 456, ymin : 789, ymax : 000}).`
*
*   __IMPORTANT__: the object must be serializable since it will be added to the URL and
*   should serialize to a reasonable length String. If the fields contain
*   non-primitives, e.g. array, object, one must manually serialize the field first.
*   Also only use anonymous objects with custom fields, do not use class objects
*   (e.g. use an anonymous { } object to store map extent instead of ESRI's map
*   {{#crossLink "Esri/geometry/Extent"}}{{/crossLink}} object, since it will contain other fields and methods that will also
*   be serialized).
*
* 3. Call updateURL, passing it a name (e.g. "newExtent") and the object
*    (a name is required for efficiency, this way the URL will only need to
*    serialize and update the given object instead of all objects).
*
* @class BookmarkLink
* @static
* @uses dojo/_base/declare
* @uses require
* @uses dojo/dom-construct
* @uses dojo/io-query
* @uses dojo/_base/lang
* @uses dojo/dom
* @uses dojo/_base/array
* @uses dojo/topic
* @uses dijit/form/TextBox
* @uses dijit/TitlePane
* @uses esri/geometry/Extent
* @uses GlobalStorage
* @uses Map
* @uses EventManager
* @uses Url
* @uses Util
* @uses Dictionary
* @uses PopupManager
*/</span>

define([</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Dojo</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-string">"dojo/_base/declare"</span>, <span class="hljs-string">"require"</span>, <span class="hljs-string">"dojo/dom-construct"</span>, <span class="hljs-string">"dojo/io-query"</span>, <span class="hljs-string">"dojo/_base/lang"</span>,
        <span class="hljs-string">"dojo/dom"</span>, <span class="hljs-string">"dojo/_base/array"</span>, <span class="hljs-string">"dojo/topic"</span>, <span class="hljs-string">"dijit/form/TextBox"</span>, <span class="hljs-string">"dijit/TitlePane"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Esri</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-string">"esri/geometry/Extent"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Ramp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-string">"ramp/globalStorage"</span>, <span class="hljs-string">"ramp/map"</span>, <span class="hljs-string">"ramp/eventManager"</span>, <span class="hljs-string">"ramp/ramp"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Util</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-string">"utils/url"</span>, <span class="hljs-string">"utils/util"</span>, <span class="hljs-string">"utils/dictionary"</span>, <span class="hljs-string">"utils/array"</span>, <span class="hljs-string">"utils/popupManager"</span>
],

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(
</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Dojo</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        declare, dojoRequire, dojoDomConstruct, dojoQuery, dojoLang,
        dojoDom, dojoArray, topic, TextBox, TitlePane,</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Esri</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Extent,</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Ramp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        GlobalStorage, RampMap, EventManager, Ramp,</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Util</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Url, UtilMisc, UtilDict, UtilArray, PopupManager) {
        <span class="hljs-string">"use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Using constants so we can have intellisense and not make silly typos</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> EVENT_EXTENT_CHANGE = <span class="hljs-string">"extentChange"</span>,
            EVENT_FULLSCREEN = <span class="hljs-string">"fullscreen"</span>,
            EVENT_PANEL_CHANGE = <span class="hljs-string">"panelChange"</span>,
            EVENT_TAB_CHANGE = <span class="hljs-string">"selectedTab"</span>,
            EVENT_BASEMAP_CHANGED = <span class="hljs-string">"basemapChange"</span>,
            PARAM = {
                FILTER: {
                    VISIBLE_LAYERS: <span class="hljs-string">"visibleLayers"</span>,
                    HIDDEN_LAYERS: <span class="hljs-string">"hiddenLayers"</span>,
                    VISIBLE_BOXES: <span class="hljs-string">"visibleBoxes"</span>,
                    HIDDEN_BOXES: <span class="hljs-string">"hiddenBoxes"</span>
                }
            },
            HREF_MAILTO_TEMPLATE = <span class="hljs-string">"mailto:?subject={0}&amp;body={1}%0D%0A%0D%0A{2}"</span>,

            config,

            queryObject,

            linkPaneTextbox,

            getlinkPopup,

            getlinkToggle,
            getlinkSectionContainer,
            getlinkSection,

            getlinkShortenButton,
            getlinkEmailButton,

            getlinkloadinganimation,

            cssButtonPressedClass = <span class="hljs-string">"button-pressed"</span>,

            isShortLinkMode = <span class="hljs-literal">false</span>,

            baseUrl,

        <span class="hljs-comment">/**
        * A dictionary mapping names (String) to query parameter (String) of the URL. The query parameter is
        * what ends up in the url. The key can be any arbitrary name (best to name them to describe the query
        * parameter).
        *
        * @private
        * @property parameters
        * @type {Object}
        */</span>
            parameters = {},

        <span class="hljs-comment">/**
        * A dictionary mapping names (String) to anchors (String) used at the end of the URL.
        *
        * @private
        * @property anchors
        * @type {Object}
        */</span>
            anchors = {},

            <span class="hljs-comment">/**
             * A dictionary containing layer id (String) as key and layer visiblility (boolean) as value
             *
             * @private
             * @property layerVisibility
             * @type {Object}
             */</span>
            layerVisibility = {},

            <span class="hljs-comment">/**
             * A dictionary containing layer id (String) as key and bounding box visibility (boolean) as value
             *
             * @private
             * @property boundingBoxVisibility
             * @type {Object}
             */</span>
            boundingBoxVisibility = {},

            <span class="hljs-comment">/**
             * A dictionary with the layer id as key, and the transparency as value.
             *
             * @private
             * @property layerTransparency
             * @type {Object}
             */</span>
            layerTransparency = {},

            ui = {
                <span class="hljs-comment">/**
                * Initiates additional UI components of the widget, setting listeners and other stuff.
                *
                * @method init
                * @private
                * @constructor
                */</span>
                init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    getlinkloadinganimation = $(<span class="hljs-string">"#getlink-section .loadingAnimation"</span>);

                    getlinkEmailButton = $(<span class="hljs-string">".getlink-email-button"</span>);

                    getlinkToggle = $(<span class="hljs-string">"#getlink-toggle"</span>);
                    getlinkSectionContainer = $(<span class="hljs-string">"#getlink-section-container"</span>);
                    getlinkSection = $(<span class="hljs-string">"#getlink-section"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>select link when user focuses on the textbox <a href="http://stackoverflow.com/a/22102081">http://stackoverflow.com/a/22102081</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    linkPaneTextbox =
                        $(<span class="hljs-string">"#getlink-input"</span>)
                        .on(<span class="hljs-string">'focus'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            <span class="hljs-keyword">var</span> $<span class="hljs-keyword">this</span> = $(<span class="hljs-keyword">this</span>)
                                .one(<span class="hljs-string">'mouseup.mouseupSelect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                    $<span class="hljs-keyword">this</span>.select();
                                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                                })
                                .one(<span class="hljs-string">'mousedown'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>compensate for untriggered ‘mouseup’ caused by focus via tab</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    $<span class="hljs-keyword">this</span>.off(<span class="hljs-string">'mouseup.mouseupSelect'</span>);
                                })
                                .select();
                        });</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>toggle short/long link mode on click</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    getlinkShortenButton =
                        $(<span class="hljs-string">".getlink-shorten-button"</span>)
                        .on(<span class="hljs-string">"click"</span>, toggleShortLinkMode);

                    getlinkPopup = PopupManager.registerPopup(getlinkToggle, <span class="hljs-string">"click"</span>,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                            topic.publish(EventManager.BookmarkLink.GETLINK_PANEL_CHANGED, { visible: <span class="hljs-literal">true</span> });
                            topic.publish(EventManager.GUI.TOOLBAR_SECTION_OPEN, { id: <span class="hljs-string">"get-link-section"</span> });
                            <span class="hljs-built_in">console</span>.log(EventManager.BookmarkLink.GETLINK_PANEL_CHANGED + <span class="hljs-string">" visible:"</span>, <span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>close this panel if any other panel is opened</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            UtilMisc.subscribeOnce(EventManager.GUI.TOOLBAR_SECTION_OPEN, dojoLang.hitch(<span class="hljs-keyword">this</span>,
                                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isOpen()) {
                                        <span class="hljs-keyword">this</span>.close();
                                    }
                                })
                            );

                            getlinkSectionContainer.slideDown(<span class="hljs-string">"fast"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                d.resolve();
                            });
                        },
                        {
                            activeClass: cssButtonPressedClass,
                            target: getlinkSectionContainer,
                            closeHandler: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                                topic.publish(EventManager.BookmarkLink.GETLINK_PANEL_CHANGED, { visible: <span class="hljs-literal">false</span> });
                                topic.publish(EventManager.GUI.TOOLBAR_SECTION_CLOSE, { id: <span class="hljs-string">"get-link-section"</span> });
                                <span class="hljs-built_in">console</span>.log(EventManager.BookmarkLink.GETLINK_PANEL_CHANGED + <span class="hljs-string">" visible:"</span>, <span class="hljs-literal">false</span>);

                                getlinkSectionContainer.slideUp(<span class="hljs-string">"fast"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                    toggleShortLinkMode(<span class="hljs-literal">false</span>);
                                    d.resolve();
                                });
                            },
                            resetFocusOnClose: <span class="hljs-literal">true</span>
                        }
                    );

                    <span class="hljs-comment">/*topic.subscribe(EventManager.GUI.HELP_PANEL_CHANGE, function (attr) {
                        if (getlinkPopup.isOpen() &amp;&amp; attr.visible) {
                            getlinkPopup.close();
                        }
                    });*/</span>
                }
            };

        <span class="hljs-comment">/**
        * Update the parameter dictionary with the new values for the parameter. If paramObj is set to null,
        * essentially removes the given paramKey from the URL.
        *
        * @method addParameter
        * @private
        * @param {String} paramKey  the parameter (e.g. extent) that was changed
        * @param {Object} paramObj an object representing data that can be serialized into the query parameter
        * of the URL (can be null, in which case the parameter will NOT be included in the URL)
        *
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addParameter</span><span class="hljs-params">(paramKey, paramObj)</span> </span>{
            <span class="hljs-keyword">if</span> (paramObj === <span class="hljs-literal">null</span>) {
                parameters[paramKey] = <span class="hljs-literal">null</span>;
            } <span class="hljs-keyword">else</span> {
                parameters[paramKey] = dojoQuery.objectToQuery(paramObj);
            }
        }

        <span class="hljs-comment">/*
        * Adds an anchor object to a tracking array
        * @method addAnchor
        * @param {String} anchorName a key value for the anchor
        * @param {Object} anchorObj an anchor object
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addAnchor</span><span class="hljs-params">(anchorName, anchorObj)</span> </span>{
            anchors[anchorName] = anchorObj;
        }

        <span class="hljs-comment">/*
        * Appends information to the current map's URL to create a mail-to link. Set the email buttons target URL.
        * @method setNewUrl
        * @param {String} url the base URL that defines the current state of the map
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setNewUrl</span><span class="hljs-params">(url)</span> </span>{
            <span class="hljs-keyword">var</span> mailToHref = <span class="hljs-built_in">String</span>.format(HREF_MAILTO_TEMPLATE,
                i18n.t(<span class="hljs-string">"bookmarkLink.emailUrlSubject"</span>),
                i18n.t(<span class="hljs-string">"bookmarkLink.emailUrlBody"</span>),
                <span class="hljs-built_in">encodeURIComponent</span>(url));
            
            linkPaneTextbox.val(url);
            getlinkEmailButton.attr(<span class="hljs-string">"href"</span>, mailToHref);
        }

        <span class="hljs-comment">/**
        * Updates the link displayed in the textbox. This function should be called whenever
        * one of the objects that are in the URL query is modified.
        *
        * @method updateURL
        * @private
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateURL</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> link = baseUrl;

            <span class="hljs-comment">/* Appends all the query parameters to the link (a query parameter can be
            * excluded by setting it to null) */</span>
            UtilDict.forEachEntry(parameters, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, value)</span> </span>{
                <span class="hljs-keyword">if</span> (value) { <span class="hljs-comment">// Value cannot be null or the empty String</span>
                    link += <span class="hljs-string">"&amp;"</span> + value;
                }
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Need to add an extra “&amp;” to the query if we have an anchor, otherwise
the last query will contain the anchors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (!UtilDict.isEmpty(anchors)) {
                link += <span class="hljs-string">"&amp;"</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Anchors have to be at the end</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            UtilDict.forEachEntry(anchors, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, value)</span> </span>{
                link += <span class="hljs-string">"#"</span> + value;
            });

            <span class="hljs-keyword">if</span> (isShortLinkMode) {
                <span class="hljs-keyword">if</span> (linkPaneTextbox.is(<span class="hljs-string">":visible"</span>)) {
                    getlinkloadinganimation.show();

                    jQuery.urlShortener({
                        longUrl: link,
                        success: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(shortUrl)</span> </span>{
                            setNewUrl(shortUrl);
                            getlinkloadinganimation.hide();
                        },
                        error: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
                            <span class="hljs-built_in">console</span>.error(<span class="hljs-built_in">JSON</span>.stringify(err));
                            getlinkloadinganimation.hide();
                        }
                    });
                }
            } <span class="hljs-keyword">else</span> {
                setNewUrl(link);
            }
        }

        <span class="hljs-comment">/**
        * Toggle the short/long link mode and change the label accordingly
        *
        * @method toggleShortLinkMode
        * @param {Object} value true - shortLinkMode; false - !shortlinkMore; undefined - toggle;
        * @private
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toggleShortLinkMode</span><span class="hljs-params">(value)</span> </span>{
            <span class="hljs-keyword">var</span> label;

            isShortLinkMode = value === <span class="hljs-literal">true</span> ? <span class="hljs-literal">true</span> : (value === <span class="hljs-literal">false</span> ? <span class="hljs-literal">false</span> : !isShortLinkMode);
            label = isShortLinkMode ? i18n.t(<span class="hljs-string">"bookmarkLink.longLink"</span>) : i18n.t(<span class="hljs-string">"bookmarkLink.shortLink"</span>);
            getlinkShortenButton.text(label);
            updateURL();
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateConfig</span><span class="hljs-params">(homePage)</span> </span>{
            <span class="hljs-keyword">var</span> event,
                urlObj = <span class="hljs-keyword">new</span> Url(dojoRequire.toUrl(<span class="hljs-built_in">document</span>.location));

            config = GlobalStorage.config;
            baseUrl = urlObj.uri;
            queryObject = dojoQuery.queryToObject(urlObj.query);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>adds homePage (e.g. default.aspx or rampmap.aspx) if not present;
used in getlink or else the link would be invalid.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (baseUrl.indexOf(homePage) === -<span class="hljs-number">1</span>) {
                baseUrl += homePage;
            }
            baseUrl += <span class="hljs-string">"?lang="</span> + config.lang;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Move the API key to config.json??</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            jQuery.urlShortener.settings.apiKey = <span class="hljs-string">'AIzaSyB52ByjsXrOYlXxc2Q9GVpClLDwt0Lw6pc'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Toggle the main panel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (queryObject.panelVisible) {
                event = {
                    visible: UtilMisc.parseBool(queryObject.panelVisible)
                };

                addParameter(EVENT_PANEL_CHANGE, event);
                config.ui.sidePanelOpened = event.visible;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Toggle fullscreen mode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (queryObject.fullscreen) {
                event = {
                    fullscreen: UtilMisc.parseBool(queryObject.fullscreen)
                };
                addParameter(EVENT_FULLSCREEN, event);
                config.ui.fullscreen = event.fullscreen;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Check for map extent queries</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (queryObject.xmin) {
                event = {
                    xmin: <span class="hljs-built_in">parseFloat</span>(queryObject.xmin.replace(<span class="hljs-regexp">/,/g</span>, <span class="hljs-string">""</span>)),
                    ymin: <span class="hljs-built_in">parseFloat</span>(queryObject.ymin.replace(<span class="hljs-regexp">/,/g</span>, <span class="hljs-string">""</span>)),
                    xmax: <span class="hljs-built_in">parseFloat</span>(queryObject.xmax.replace(<span class="hljs-regexp">/,/g</span>, <span class="hljs-string">""</span>)),
                    ymax: <span class="hljs-built_in">parseFloat</span>(queryObject.ymax.replace(<span class="hljs-regexp">/,/g</span>, <span class="hljs-string">""</span>)),
                    sr: queryObject.sr
                };

                addParameter(EVENT_EXTENT_CHANGE, event);

                config.extents.defaultExtent = event;
                config.spatialReference = <span class="hljs-built_in">JSON</span>.parse(queryObject.sr);</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Wait for things such as fullscreen or panel collapse
to finish before doing an extent change.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Select the correct basemap</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (queryObject.baseMap) {
                event = {
                    baseMap: queryObject.baseMap
                };
                addParameter(EVENT_BASEMAP_CHANGED, event);

                dojoArray.forEach(config.basemaps, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(basemap)</span> </span>{
                    basemap.showOnInit = (basemap.id === event.baseMap);
                });
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Modify the layer transparency</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (queryObject.layerTransparency) {
                addParameter(EventManager.FilterManager.LAYER_TRANSPARENCY_CHANGED, {
                    layerTransparency: queryObject.layerTransparency
                });

                UtilDict.forEachEntry(<span class="hljs-built_in">JSON</span>.parse(queryObject.layerTransparency), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, value)</span> </span>{
                    <span class="hljs-keyword">var</span> layerConfig = UtilArray.find(config.featureLayers.concat(config.wmsLayers), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layer)</span> </span>{
                        <span class="hljs-keyword">return</span> layer.id === key;
                    });
                    layerConfig.settings.opacity.default = value;
                });
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>check for selected tab queries</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (queryObject.selectedTab) {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Just add the parameter, no need to do anything else
since we’re using anchor tags</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                addParameter(EVENT_TAB_CHANGE, {
                    index: queryObject.selectedTab
                });
            }

            <span class="hljs-keyword">var</span> layerIds;

            <span class="hljs-keyword">if</span> (queryObject.visibleLayers) {
                layerIds = queryObject.visibleLayers.split(<span class="hljs-string">"+"</span>);

                layerIds.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layerId)</span> </span>{
                    <span class="hljs-keyword">var</span> layerConfig = Ramp.getLayerConfigWithId(layerId);
                    layerConfig.layerVisible = <span class="hljs-literal">true</span>;

                    layerVisibility[layerId] = <span class="hljs-literal">true</span>;
                });

                addParameter(PARAM.FILTER.VISIBLE_LAYERS, {
                    visibleLayers: queryObject.visibleLayers
                });
            }

            <span class="hljs-keyword">if</span> (queryObject.hiddenLayers) {
                layerIds = queryObject.hiddenLayers.split(<span class="hljs-string">"+"</span>);

                layerIds.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layerId)</span> </span>{
                    <span class="hljs-keyword">var</span> layerConfig = Ramp.getLayerConfigWithId(layerId);
                    layerConfig.layerVisible = <span class="hljs-literal">false</span>;

                    layerVisibility[layerId] = <span class="hljs-literal">false</span>;
                });

                addParameter(PARAM.FILTER.HIDDEN_LAYERS, {
                    hiddenLayers: queryObject.hiddenLayers
                });
            }

            <span class="hljs-keyword">if</span> (queryObject.visibleBoxes) {
                layerIds = queryObject.visibleBoxes.split(<span class="hljs-string">"+"</span>);

                layerIds.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layerId)</span> </span>{
                    <span class="hljs-keyword">var</span> layerConfig = Ramp.getLayerConfigWithId(layerId);
                    layerConfig.boundingBoxVisible = <span class="hljs-literal">true</span>;

                    boundingBoxVisibility[layerId] = <span class="hljs-literal">true</span>;
                });

                addParameter(PARAM.FILTER.VISIBLE_BOXES, {
                    visibleBoxes: queryObject.visibleBoxes
                });
            }

            <span class="hljs-keyword">if</span> (queryObject.hiddenBoxes) {
                layerIds = queryObject.hiddenBoxes.split(<span class="hljs-string">"+"</span>);

                layerIds.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layerId)</span> </span>{
                    <span class="hljs-keyword">var</span> layerConfig = Ramp.getLayerConfigWithId(layerId);
                    layerConfig.boundingBoxVisible = <span class="hljs-literal">false</span>;

                    boundingBoxVisibility[layerId] = <span class="hljs-literal">false</span>;
                });

                addParameter(PARAM.FILTER.HIDDEN_BOXES, {
                    hiddenBoxes: queryObject.hiddenBoxes
                });
            }
        }

        <span class="hljs-keyword">return</span> {
            <span class="hljs-comment">/**
            * Instantiates a BookmarkLink. Subscribes to all the events that causes
            * the bookmark link to update (e.g. map extent change or feature layer visibility
            * change).
            *
            * @method init
            * {String} homePage a string denoting the name of the homePage (e.g. usually "Default.aspx" or "index.html")
            */</span>
            createUI: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                ui.init();
            },

            updateConfig: updateConfig,

            <span class="hljs-comment">/**
            * Subscribe to map state changes so the URL displayed can be changed accordingly.
            *  SUBSCRIBES TO:
            * map "extent-change"
            *   Updates URL when map extent changes
            *
            * EventManager.GUI.FULLSCREEN_CHANGE
            *   Updates URL when map goes into fullscreen mode
            *
            * EventManager.GUI.TAB_SELECTED
            *   Updates URL when tabs are selected
            *
            * EventManager.GUI.PANEL_CHANGE
            *   Updates URL when panel opens/closes
            *
            * EventManager.BasemapSelector.BASEMAP_CHANGED
            *   Updates URL when basemap changed
            *
            * * ================================================================
            * Subscribe to updates
            * ================================================================
            * To include more information into the query string, do not get the information
            * directly from the object/module of interest, but rather make it publish an
            * event with data to include and subscribe to this event here.
            * @method subscribeAndUpdate
            * @private
            */</span>
            subscribeAndUpdate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                topic.subscribe(EventManager.Map.EXTENT_CHANGE, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Event fields: extent, delta, levelChange, lod;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    addParameter(EVENT_EXTENT_CHANGE, {
                        xmin: event.extent.xmin,
                        ymin: event.extent.ymin,
                        xmax: event.extent.xmax,
                        ymax: event.extent.ymax,
                        sr: <span class="hljs-built_in">JSON</span>.stringify(event.extent.spatialReference)
                    });
                    updateURL();
                });

                topic.subscribe(EventManager.GUI.FULLSCREEN_CHANGE, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
                    addParameter(EVENT_FULLSCREEN, {
                        fullscreen: event.visible
                    });
                    updateURL();
                });

                topic.subscribe(EventManager.GUI.TAB_SELECTED, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Need to remove the “-link” part for the id to work
since when the page first loads, if the tab is deselected,
it’s id will be missing the “-link” at the end.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    addAnchor(EVENT_TAB_CHANGE, event.id.replace(<span class="hljs-string">"-link"</span>, <span class="hljs-string">""</span>));
                    updateURL();
                });

                topic.subscribe(EventManager.GUI.PANEL_CHANGE, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
                    addParameter(EVENT_PANEL_CHANGE, {
                        panelVisible: event.visible
                    });
                    updateURL();
                });

                topic.subscribe(EventManager.BasemapSelector.BASEMAP_CHANGED, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
                    addParameter(EVENT_BASEMAP_CHANGED, {
                        baseMap: event.id
                    });
                    updateURL();
                });

                topic.subscribe(EventManager.FilterManager.LAYER_VISIBILITY_TOGGLED, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
                    <span class="hljs-keyword">var</span> layerName = event.id;
                    layerVisibility[layerName] = event.state;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Only keep attributes that are different from the default config</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> visibleLayers = UtilDict.filter(layerVisibility, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, layerVisible)</span> </span>{
                        <span class="hljs-keyword">return</span> layerVisible &amp;&amp; !Ramp.getLayerConfigWithId(key).layerVisible;
                    }),
                        hiddenLayers = UtilDict.filter(layerVisibility, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, boxVisible)</span> </span>{
                            <span class="hljs-keyword">return</span> !boxVisible &amp;&amp; Ramp.getLayerConfigWithId(key).layerVisible;
                        });

                    addParameter(PARAM.FILTER.HIDDEN_LAYERS, UtilDict.isEmpty(hiddenLayers) ? <span class="hljs-literal">null</span> : {</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Convert an array of string into a “+” delimited string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        hiddenLayers: <span class="hljs-built_in">Object</span>.keys(hiddenLayers).join(<span class="hljs-string">"+"</span>)
                    });

                    addParameter(PARAM.FILTER.VISIBLE_LAYERS, UtilDict.isEmpty(visibleLayers) ? <span class="hljs-literal">null</span> : {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Convert an array of string into a “+” delimited string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        visibleLayers: <span class="hljs-built_in">Object</span>.keys(visibleLayers).join(<span class="hljs-string">"+"</span>)
                    });

                    updateURL();
                });

                topic.subscribe(EventManager.FilterManager.BOX_VISIBILITY_TOGGLED, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
                    <span class="hljs-keyword">var</span> layerName = event.id;
                    boundingBoxVisibility[layerName] = event.state;</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Only keep attributes that are different from the default config</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> visibleBoxes = UtilDict.filter(boundingBoxVisibility, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, boxVisible)</span> </span>{
                        <span class="hljs-keyword">return</span> boxVisible &amp;&amp; !Ramp.getLayerConfigWithId(key).boundingBoxVisible;
                    }),
                        hiddenBoxes = UtilDict.filter(boundingBoxVisibility, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, boxVisible)</span> </span>{
                            <span class="hljs-keyword">return</span> !boxVisible &amp;&amp; Ramp.getLayerConfigWithId(key).boundingBoxVisible;
                        });

                    addParameter(PARAM.FILTER.HIDDEN_BOXES, UtilDict.isEmpty(hiddenBoxes) ? <span class="hljs-literal">null</span> : {</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Convert an array of string into a “+” delimited string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        hiddenBoxes: <span class="hljs-built_in">Object</span>.keys(hiddenBoxes).join(<span class="hljs-string">"+"</span>)
                    });

                    addParameter(PARAM.FILTER.VISIBLE_BOXES, UtilDict.isEmpty(visibleBoxes) ? <span class="hljs-literal">null</span> : {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Convert an array of string into a “+” delimited string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        visibleBoxes: <span class="hljs-built_in">Object</span>.keys(visibleBoxes).join(<span class="hljs-string">"+"</span>)
                    });

                    updateURL();
                });

                topic.subscribe(EventManager.FilterManager.LAYER_TRANSPARENCY_CHANGED, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
                    addParameter(EventManager.FilterManager.LAYER_TRANSPARENCY_CHANGED, event);
                    layerTransparency[event.layerId] = event.value;

                    addParameter(EventManager.FilterManager.LAYER_TRANSPARENCY_CHANGED, {
                        layerTransparency: <span class="hljs-built_in">JSON</span>.stringify(layerTransparency)
                    });

                    updateURL();
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>This call is necessary to fill in the URL in the bookmark link
if this call is removed, there will be no URL in the bookmark link
until one of the above events fires</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                updateURL();
            }
        };
    });</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
