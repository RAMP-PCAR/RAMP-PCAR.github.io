<!DOCTYPE html>

<html>
<head>
  <title>dataLoaderGui.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="advancedToolbar.html">
                advancedToolbar.js
              </a>
            
              
              <a class="source" href="basemapSelector.html">
                basemapSelector.js
              </a>
            
              
              <a class="source" href="bookmarkLink.html">
                bookmarkLink.js
              </a>
            
              
              <a class="source" href="dataLoader.html">
                dataLoader.js
              </a>
            
              
              <a class="source" href="dataLoaderGui.html">
                dataLoaderGui.js
              </a>
            
              
              <a class="source" href="datagrid.html">
                datagrid.js
              </a>
            
              
              <a class="source" href="datagridClickHandler.html">
                datagridClickHandler.js
              </a>
            
              
              <a class="source" href="eventManager.html">
                eventManager.js
              </a>
            
              
              <a class="source" href="featureClickHandler.html">
                featureClickHandler.js
              </a>
            
              
              <a class="source" href="featureHighlighter.html">
                featureHighlighter.js
              </a>
            
              
              <a class="source" href="filterManager.html">
                filterManager.js
              </a>
            
              
              <a class="source" href="geoSearch.html">
                geoSearch.js
              </a>
            
              
              <a class="source" href="globalStorage.html">
                globalStorage.js
              </a>
            
              
              <a class="source" href="graphicExtension.html">
                graphicExtension.js
              </a>
            
              
              <a class="source" href="gui.html">
                gui.js
              </a>
            
              
              <a class="source" href="imageExport.html">
                imageExport.js
              </a>
            
              
              <a class="source" href="layerGroup.html">
                layerGroup.js
              </a>
            
              
              <a class="source" href="layerItem.html">
                layerItem.js
              </a>
            
              
              <a class="source" href="layerLoader.html">
                layerLoader.js
              </a>
            
              
              <a class="source" href="map.html">
                map.js
              </a>
            
              
              <a class="source" href="mapClickHandler.html">
                mapClickHandler.js
              </a>
            
              
              <a class="source" href="maptips.html">
                maptips.js
              </a>
            
              
              <a class="source" href="navigation.html">
                navigation.js
              </a>
            
              
              <a class="source" href="quickzoom.html">
                quickzoom.js
              </a>
            
              
              <a class="source" href="ramp.html">
                ramp.js
              </a>
            
              
              <a class="source" href="stepItem.html">
                stepItem.js
              </a>
            
              
              <a class="source" href="theme.html">
                theme.js
              </a>
            
              
              <a class="source" href="RAMP-starter.html">
                RAMP-starter.js
              </a>
            
              
              <a class="source" href="areaTool.html">
                areaTool.js
              </a>
            
              
              <a class="source" href="baseTool.html">
                baseTool.js
              </a>
            
              
              <a class="source" href="bufferTool.html">
                bufferTool.js
              </a>
            
              
              <a class="source" href="distanceTool.html">
                distanceTool.js
              </a>
            
              
              <a class="source" href="populationTool.html">
                populationTool.js
              </a>
            
              
              <a class="source" href="array.html">
                array.js
              </a>
            
              
              <a class="source" href="bricks.html">
                bricks.js
              </a>
            
              
              <a class="source" href="checkbox.html">
                checkbox.js
              </a>
            
              
              <a class="source" href="checkboxGroup.html">
                checkboxGroup.js
              </a>
            
              
              <a class="source" href="decorator.html">
                decorator.js
              </a>
            
              
              <a class="source" href="dictionary.html">
                dictionary.js
              </a>
            
              
              <a class="source" href="functionMangler.html">
                functionMangler.js
              </a>
            
              
              <a class="source" href="popupManager.html">
                popupManager.js
              </a>
            
              
              <a class="source" href="prototype.html">
                prototype.js
              </a>
            
              
              <a class="source" href="tmplHelper.html">
                tmplHelper.js
              </a>
            
              
              <a class="source" href="tmplUtil.html">
                tmplUtil.js
              </a>
            
              
              <a class="source" href="url.html">
                url.js
              </a>
            
              
              <a class="source" href="util.html">
                util.js
              </a>
            
              
              <a class="source" href="bootstrapper.html">
                bootstrapper.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>dataLoaderGui.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>﻿<span class="hljs-comment">/* global define, console, window, $, i18n, RAMP, t, TimelineLite */</span>

<span class="hljs-comment">/**
* @module RAMP
* @submodule FilterManager
* @main FilterManager
*/</span>

<span class="hljs-comment">/**
* Creates a choice tree for adding datasets.
* 
* ####Imports RAMP Modules:
* {{#crossLink "PopupManager"}}{{/crossLink}}  
* {{#crossLink "DataLoader"}}{{/crossLink}}  
* {{#crossLink "Theme"}}{{/crossLink}}  
* {{#crossLink "Map"}}{{/crossLink}}  
* {{#crossLink "LayerLoader"}}{{/crossLink}}  
* {{#crossLink "GlobalStorage"}}{{/crossLink}}  
* {{#crossLink "StepItem"}}{{/crossLink}}  
* {{#crossLink "Util"}}{{/crossLink}}  
* {{#crossLink "TmplHelper"}}{{/crossLink}}  
* {{#crossLink "TmplUtil"}}{{/crossLink}}  
* {{#crossLink "Array"}}{{/crossLink}}  
* {{#crossLink "Dictionary"}}{{/crossLink}}  
* {{#crossLink "Bricks"}}{{/crossLink}}    
* 
* ####Uses RAMP Templates:
* {{#crossLink "templates/filter_manager_template.json"}}{{/crossLink}}
* 
* @class DataLoaderGui
* @static
* @uses dojo/lang
*/</span>

define([
    <span class="hljs-comment">/* Dojo */</span>
    <span class="hljs-string">"dojo/_base/lang"</span>,

    <span class="hljs-comment">/* Text */</span>
    <span class="hljs-string">"dojo/text!./templates/filter_manager_template.json"</span>,

    <span class="hljs-comment">/* Ramp */</span>

    <span class="hljs-string">"utils/popupManager"</span>, <span class="hljs-string">"ramp/dataLoader"</span>, <span class="hljs-string">"ramp/theme"</span>, <span class="hljs-string">"ramp/map"</span>, <span class="hljs-string">"ramp/layerLoader"</span>, <span class="hljs-string">"ramp/globalStorage"</span>, <span class="hljs-string">"ramp/stepItem"</span>,

    <span class="hljs-comment">/* Util */</span>
    <span class="hljs-string">"utils/util"</span>, <span class="hljs-string">"utils/tmplHelper"</span>, <span class="hljs-string">"utils/tmplUtil"</span>, <span class="hljs-string">"utils/array"</span>, <span class="hljs-string">"utils/dictionary"</span>, <span class="hljs-string">"utils/bricks"</span>
],
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(
        lang,
        filter_manager_template,
        PopupManager, DataLoader, Theme, RampMap, LayerLoader, GlobalStorage, StepItem,
        UtilMisc, TmplHelper, TmplUtil, UtilArray, UtilDict, Bricks
    )</span> </span>{
<span class="hljs-pi">        "use strict"</span>;

        <span class="hljs-keyword">var</span> rootNode,

            addDatasetToggle,
            addDatasetContainer,

            layerList,
            layerToggles,
            filterToggles,

            symbologyPreset = {},

            choiceTree,
            choiceTreeCallbacks,
            choiceTreeErrors,
            stepLookup = {},

            addDatasetPopup,

            transitionDuration = <span class="hljs-number">0.5</span>,

            templates = <span class="hljs-built_in">JSON</span>.parse(TmplHelper.stringifyTemplate(filter_manager_template));

        <span class="hljs-comment">/**
         * A collection of callbacks used by the choice tree.
         * 
         * @property choiceTreeCallbacks
         * @private
         * @type {Object}
         */</span>
        choiceTreeCallbacks = {
            <span class="hljs-comment">/**
             * A callback that advances the choice tree to the specified child step of the supplied step item.
             * 
             * @method choiceTreeCallbacks.simpleAdvance
             * @private
             * @param  {StepItem} step            step item to advance from
             * @param  {Object} data            data from the choice brick in step item
             * @param  {Object} targetChildData data to be passed to the step being advanced to
             */</span>
            simpleAdvance: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(step, data, targetChildData)</span> </span>{
                step.advance(data.selectedChoice, targetChildData);
            },

            <span class="hljs-comment">/**
             * A callback that retreats part of the choice tree to the step item specified.
             * 
             * @method choiceTreeCallbacks.simpleCancel
             * @private
             * @param  {StepItem} step step item to retreat to
             * @param  {Object} data data from the callback function
             */</span>
            simpleCancel: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(step, data)</span> </span>{
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Step cancel click:"</span>, <span class="hljs-keyword">this</span>, step, data);

                <span class="hljs-keyword">if</span> (step.isCompleted()) {
                    step.retreat();
                } <span class="hljs-keyword">else</span> {
                    step.clearStep();
                }
            },

            <span class="hljs-comment">/**
             * A callback to guess the service type from the service url provided in step data.
             * 
             * @method choiceTreeCallbacks.serviceTypeStepGuess
             * @private
             * @param  {StepItem} step step item to guess service type on
             * @param  {[type]} data data from the callback function
             */</span>
            serviceTypeStepGuess: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(step, data)</span> </span>{
                <span class="hljs-keyword">var</span> value = data.inputValue,
                    serviceTypeBrick = step.contentBricks.serviceType,
                    guess = <span class="hljs-string">""</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>make a guess if it’s a feature or wms server only if the user hasn’t already selected the type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (!serviceTypeBrick.isUserSelected()) {
                    <span class="hljs-keyword">if</span> (value.match(<span class="hljs-regexp">/ArcGIS\/rest\/services/ig</span>)) {
                        guess = <span class="hljs-string">"featureServiceAttrStep"</span>;
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value.match(<span class="hljs-regexp">/wms/ig</span>)) {
                        guess = <span class="hljs-string">"wmsServiceAttrStep"</span>;
                    }

                    serviceTypeBrick.setChoice(guess);
                }
            },

            <span class="hljs-comment">/**
             * A callback to guess the file type from the file url or file object provided in step data.
             * 
             * @method choiceTreeCallbacks.fileTypeStepGuess
             * @private
             * @param  {StepItem} step step item to guess file type on
             * @param  {[type]} data data from the callback function
             */</span>
            fileTypeStepGuess: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(step, data)</span> </span>{
                <span class="hljs-keyword">var</span> fileName = data.inputValue,
                    serviceFileBrick = step.contentBricks.fileType,
                    guess = <span class="hljs-string">""</span>;

                <span class="hljs-keyword">if</span> (!serviceFileBrick.isUserSelected() &amp;&amp; !serviceFileBrick.isUserEntered) {
                    <span class="hljs-keyword">if</span> (fileName.endsWith(<span class="hljs-string">".csv"</span>)) {
                        guess = <span class="hljs-string">"csvFileAttrStep"</span>;
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fileName.endsWith(<span class="hljs-string">".json"</span>)) {
                        guess = <span class="hljs-string">"geojsonFileAttrStep"</span>;
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fileName.endsWith(<span class="hljs-string">".zip"</span>)) {
                        guess = <span class="hljs-string">"shapefileFileAttrStep"</span>;
                    }

                    serviceFileBrick.setChoice(guess);
                }
            }
        };

        <span class="hljs-comment">/**
         * Create choice tree structure. This function is executed as part of the module initialization so that i18n strings can be properly loaded
         * 
         * @method prepareChoiceTreeStructure
         * @private
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">prepareChoiceTreeStructure</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-comment">/**
             * A collection of precanned error messages that are used by the choice tree.
             * 
             * @property choiceTreeErrors
             * @private
             * @type {Object}
             */</span>
            choiceTreeErrors = {
                base: {
                    type: <span class="hljs-string">"error"</span>,
                    header: <span class="hljs-string">"Cannot load"</span>,
                    message: <span class="hljs-string">"You have IE9?"</span>
                }
            };

            choiceTreeErrors.featureError = lang.mixin({}, choiceTreeErrors.base, {
                header: i18n.t(<span class="hljs-string">"addDataset.error.headerFeature"</span>)
            });

            choiceTreeErrors.wmsError = lang.mixin({}, choiceTreeErrors.base, {
                header: i18n.t(<span class="hljs-string">"addDataset.error.headerWMS"</span>)
            });

            choiceTreeErrors.fileError = lang.mixin({}, choiceTreeErrors.base, {
                header: i18n.t(<span class="hljs-string">"addDataset.error.headerFile"</span>)
            });

            choiceTreeErrors.geojsonError = lang.mixin({}, choiceTreeErrors.base, {
                header: i18n.t(<span class="hljs-string">"addDataset.error.headerGeojson"</span>)
            });

            choiceTreeErrors.csvError = lang.mixin({}, choiceTreeErrors.base, {
                header: i18n.t(<span class="hljs-string">"addDataset.error.headerCSV"</span>)
            });

            choiceTreeErrors.shapefileError = lang.mixin({}, choiceTreeErrors.base, {
                header: i18n.t(<span class="hljs-string">"addDataset.error.headerShapefile"</span>)
            });

            <span class="hljs-comment">/**
             * A choice tree config object
             *
             * Config has a simple tree structure, with content being an array of Brick object to be placed inside a StepItem.
             * 
             * @property choiceTree
             * @private
             * @type {Object}
             */</span>
            choiceTree = {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>step for choosing between adding a service or a file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                id: <span class="hljs-string">"sourceTypeStep"</span>,
                content: [
                    {
                        id: <span class="hljs-string">"sourceType"</span>,
                        type: Bricks.ChoiceBrick,
                        config: {
                            header: i18n.t(<span class="hljs-string">"addDataset.dataSource"</span>),
                            instructions: i18n.t(<span class="hljs-string">"addDataset.help.dataSource"</span>),
                            choices: [
                                {
                                    key: <span class="hljs-string">"serviceTypeStep"</span>,
                                    value: i18n.t(<span class="hljs-string">"addDataset.dataSourceService"</span>)
                                },
                                {
                                    key: <span class="hljs-string">"fileTypeStep"</span>,
                                    value: i18n.t(<span class="hljs-string">"addDataset.dataSourceFile"</span>)
                                }
                            ]
                        },
                        on: [
                            {
                                eventName: Bricks.ChoiceBrick.event.CHANGE,</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>expose: { as: “advance” },</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                callback: choiceTreeCallbacks.simpleAdvance
                            }
                        ]
                    }
                ],
                children: [
                    {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>step for choosing between feature and wms service and providing a service url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        id: <span class="hljs-string">"serviceTypeStep"</span>,
                        content: [
                            {
                                id: <span class="hljs-string">"serviceURL"</span>,
                                type: Bricks.SimpleInputBrick,
                                config: {
                                    header: i18n.t(<span class="hljs-string">"addDataset.serviceLayerURL"</span>),
                                    instructions: i18n.t(<span class="hljs-string">"addDataset.help.serviceURL"</span>),
                                    placeholder: i18n.t(<span class="hljs-string">"addDataset.serviceLayerURLPlaceholder"</span>),
                                    freezeStates: [Bricks.Brick.state.SUCCESS]
                                },
                                on: [
                                    {
                                        eventName: Bricks.SimpleInputBrick.event.CHANGE,
                                        callback: choiceTreeCallbacks.serviceTypeStepGuess
                                    }
                                ]
                            },
                            {
                                id: <span class="hljs-string">"serviceType"</span>,
                                type: Bricks.ChoiceBrick,
                                config: {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>template: “template_name”, //optional, has a default</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    header: i18n.t(<span class="hljs-string">"addDataset.serviceType"</span>),
                                    instructions: i18n.t(<span class="hljs-string">"addDataset.help.serviceType"</span>),
                                    choices: [
                                        {
                                            key: <span class="hljs-string">"featureServiceAttrStep"</span>,
                                            value: i18n.t(<span class="hljs-string">"addDataset.serviceTypeFeature"</span>)
                                        },
                                        {
                                            key: <span class="hljs-string">"wmsServiceAttrStep"</span>,
                                            value: i18n.t(<span class="hljs-string">"addDataset.serviceTypeWMS"</span>)
                                        }
                                    ],
                                    freezeStates: [Bricks.Brick.state.SUCCESS]
                                }
                            },
                            {
                                id: <span class="hljs-string">"serviceTypeOkCancel"</span>,
                                type: Bricks.OkCancelButtonBrick,
                                config: {
                                    okLabel: i18n.t(<span class="hljs-string">"addDataset.connect"</span>),
                                    okFreezeStates: [
                                        Bricks.Brick.state.SUCCESS,
                                        Bricks.Brick.state.ERROR
                                    ],
                                    cancelLabel: i18n.t(<span class="hljs-string">"addDataset.cancel"</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>cancelFreezeStates: false,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    reverseOrder: <span class="hljs-literal">true</span>,

                                    required: [
                                        {
                                            id: Bricks.OkCancelButtonBrick.okButtonId,
                                            type: <span class="hljs-string">"all"</span>,
                                            check: [<span class="hljs-string">"serviceType"</span>, <span class="hljs-string">"serviceURL"</span>]
                                        },
                                        {
                                            id: Bricks.OkCancelButtonBrick.cancelButtonId,
                                            type: <span class="hljs-string">"any"</span>,
                                            check: [<span class="hljs-string">"serviceType"</span>, <span class="hljs-string">"serviceURL"</span>]
                                        }
                                    ]
                                },
                                on: [
                                    <span class="hljs-comment">/*{
                                        eventName: Bricks.OkCancelButtonBrick.event.CLICK,
                                        callback: function (step, data) {
                                            console.log("Just Click:", this, step, data);
                                        }
                                    },*/</span>
                                    {
                                        eventName: Bricks.OkCancelButtonBrick.event.OK_CLICK,</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>connect to feature service</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                        callback: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(step<span class="hljs-comment">/*, data*/</span>)</span> </span>{
                                            <span class="hljs-keyword">var</span> promise,
                                                handle = delayLoadingState(step, <span class="hljs-number">100</span>),
                                                bricksData = step.getData().bricksData,
                                                serviceTypeValue = bricksData.serviceType.selectedChoice,
                                                serviceUrlValue = bricksData.serviceURL.inputValue;

                                            <span class="hljs-keyword">switch</span> (serviceTypeValue) {
                                                <span class="hljs-keyword">case</span> <span class="hljs-string">"featureServiceAttrStep"</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>get data from feature layer endpoint</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                    promise = DataLoader.getFeatureLayer(serviceUrlValue);

                                                    promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>get data from feature layer’s legend endpoint</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                                                        <span class="hljs-keyword">var</span> layerInRampLODRange = RampMap.layerInLODRange(data.maxScale, data.minScale);

                                                        <span class="hljs-keyword">if</span> (!layerInRampLODRange) {
                                                            handleFailure(step, handle, {
                                                                serviceType:
                                                                    lang.mixin(choiceTreeErrors.featureError, {
                                                                        message: i18n.t(<span class="hljs-string">"addDataset.error.messageFeatureOutsideZoomRange"</span>)
                                                                    })
                                                            });
                                                        } <span class="hljs-keyword">else</span> {
                                                            <span class="hljs-keyword">var</span> legendPromise = DataLoader.getFeatureLayerLegend(serviceUrlValue);
                                                            legendPromise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(legendLookup)</span> </span>{
                                                                <span class="hljs-keyword">var</span> fieldOptions;
                                                                <span class="hljs-built_in">window</span>.clearTimeout(handle);

                                                                data.legendLookup = legendLookup;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>TODO: when field name aliases are available, change how the dropdown values are generated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                                fieldOptions = data.fields.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(field)</span> </span>{ <span class="hljs-keyword">return</span> { value: field, text: field }; });</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>no fields available; likely this is not a Feature service</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                                <span class="hljs-keyword">if</span> (!fieldOptions || fieldOptions.length === <span class="hljs-number">0</span>) {
                                                                    handleFailure(step, handle, {
                                                                        serviceType:
                                                                            lang.mixin(choiceTreeErrors.featureError, {
                                                                                message: i18n.t(<span class="hljs-string">"addDataset.error.messageFeatureInvalid"</span>)
                                                                            })
                                                                    });
                                                                } <span class="hljs-keyword">else</span> {
                                                                    choiceTreeCallbacks.simpleAdvance(step, bricksData.serviceType, {
                                                                        stepData: data,
                                                                        bricksData: {
                                                                            primaryAttribute: {
                                                                                options: fieldOptions
                                                                            }
                                                                        }
                                                                    });
                                                                }
                                                            }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
                                                                <span class="hljs-built_in">console</span>.error(event);
                                                                handleFailure(step, handle, {
                                                                    serviceType:
                                                                        lang.mixin(choiceTreeErrors.featureError, {
                                                                            message: i18n.t(<span class="hljs-string">"addDataset.error.messageFeatureLegend"</span>)
                                                                        })
                                                                });
                                                            });
                                                        }

                                                    }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>error connection to service</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                        <span class="hljs-built_in">console</span>.error(event);
                                                        handleFailure(step, handle, {
                                                            serviceURL:
                                                                lang.mixin(choiceTreeErrors.featureError, {
                                                                    message: i18n.t(<span class="hljs-string">"addDataset.error.messageFeatureConnect"</span>)
                                                                })
                                                        });
                                                    });

                                                    <span class="hljs-keyword">break</span>;

                                                <span class="hljs-keyword">case</span> <span class="hljs-string">"wmsServiceAttrStep"</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>get data from wms endpoint</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                    promise = DataLoader.getWmsLayerList(serviceUrlValue);

                                                    promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
                                                        <span class="hljs-keyword">var</span> layerOptions;
                                                        <span class="hljs-built_in">window</span>.clearTimeout(handle);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>TODO: when field name aliases are available, change how the dropdown values are generated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                        layerOptions = data.layers.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layer)</span> </span>{ <span class="hljs-keyword">return</span> { value: layer.name, text: layer.desc }; });</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>no layer names available; likely this is not a WMS service</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                        <span class="hljs-keyword">if</span> (!layerOptions || layerOptions.length === <span class="hljs-number">0</span>) {
                                                            handleFailure(step, handle, {
                                                                serviceType:
                                                                    lang.mixin(choiceTreeErrors.wmsError, {
                                                                        message: i18n.t(<span class="hljs-string">"addDataset.error.messageWMSInvalid"</span>)
                                                                    })
                                                            });
                                                        } <span class="hljs-keyword">else</span> {
                                                            choiceTreeCallbacks.simpleAdvance(step, bricksData.serviceType, {
                                                                stepData: {
                                                                    wmsData: data,
                                                                    wmsUrl: serviceUrlValue
                                                                },
                                                                bricksData: {
                                                                    layerName: {
                                                                        options: layerOptions
                                                                    }
                                                                }
                                                            });
                                                        }
                                                    }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
                                                        <span class="hljs-built_in">console</span>.error(event);
                                                        handleFailure(step, handle, {
                                                            serviceURL:
                                                                lang.mixin(choiceTreeErrors.wmsError, {
                                                                    message: i18n.t(<span class="hljs-string">"addDataset.error.messageWMSConnect"</span>)
                                                                })
                                                        });
                                                    });

                                                    <span class="hljs-keyword">break</span>;
                                            }
                                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>expose: { as: “advance” }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    },
                                    {
                                        eventName: Bricks.OkCancelButtonBrick.event.CANCEL_CLICK,</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>expose: { as: “retreat” },</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                        callback: choiceTreeCallbacks.simpleCancel
                                    }

                                ]
                            }
                        ],
                        children: [
                            {
                                id: <span class="hljs-string">"featureServiceAttrStep"</span>,
                                content: [
                                    {
                                        id: <span class="hljs-string">"primaryAttribute"</span>,
                                        type: Bricks.DropDownBrick,
                                        config: {
                                            instructions: i18n.t(<span class="hljs-string">"addDataset.help.featurePrimaryAttribute"</span>),
                                            header: i18n.t(<span class="hljs-string">"addDataset.primaryAttribute"</span>)
                                        }
                                    },
                                    {
                                        id: <span class="hljs-string">"addDataset"</span>,
                                        type: Bricks.ButtonBrick,
                                        config: {
                                            label: i18n.t(<span class="hljs-string">"addDataset.addDatasetButton"</span>),
                                            containerClass: <span class="hljs-string">"button-brick-container-main"</span>,
                                            buttonClass: <span class="hljs-string">"btn-primary"</span>
                                        },
                                        on: [
                                            {
                                                eventName: Bricks.ButtonBrick.event.CLICK,</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>add feature service layer to the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                callback: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(step <span class="hljs-comment">/*,data*/</span>)</span> </span>{
                                                    <span class="hljs-keyword">var</span> data = step.getData(),
                                                        bricksData = data.bricksData,
                                                        layerData = data.stepData,

                                                        newConfig = { <span class="hljs-comment">//make feature layer config.</span>
                                                            id: LayerLoader.nextId(),
                                                            displayName: layerData.layerName,
                                                            nameField: bricksData.primaryAttribute.dropDownValue,
                                                            datagrid: DataLoader.createDatagridConfig(layerData.fields, layerData.aliasMap),
                                                            symbology: DataLoader.createSymbologyConfig(layerData.renderer, layerData.legendLookup),
                                                            url: layerData.layerUrl,
                                                            aliasMap: layerData.aliasMap
                                                        },
                                                        featureLayer;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>TODO: set symbology and colour on feature layer (obj.data)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                    newConfig = GlobalStorage.applyFeatureDefaults(newConfig);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>make layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                    featureLayer = RampMap.makeFeatureLayer(newConfig, <span class="hljs-literal">true</span>);
                                                    RAMP.config.layers.feature.push(newConfig);

                                                    LayerLoader.loadLayer(featureLayer);
                                                    addDatasetPopup.close();</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>mainPopup.close();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>expose: { as: “ADD_DATASET” }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                id: <span class="hljs-string">"wmsServiceAttrStep"</span>,
                                content: [
                                    {
                                        id: <span class="hljs-string">"layerName"</span>,
                                        type: Bricks.DropDownBrick,
                                        config: {
                                            instructions: i18n.t(<span class="hljs-string">"addDataset.help.wmsLayerName"</span>),
                                            header: i18n.t(<span class="hljs-string">"addDataset.layerName"</span>)
                                        }
                                    },
                                    {
                                        id: <span class="hljs-string">"addDataset"</span>,
                                        type: Bricks.ButtonBrick,
                                        config: {
                                            label: i18n.t(<span class="hljs-string">"addDataset.addDatasetButton"</span>),
                                            containerClass: <span class="hljs-string">"button-brick-container-main"</span>,
                                            buttonClass: <span class="hljs-string">"btn-primary"</span>
                                        },
                                        on: [
                                            {
                                                eventName: Bricks.ButtonBrick.event.CLICK,</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>add wms service layer to the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                callback: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(step <span class="hljs-comment">/*,data*/</span>)</span> </span>{
                                                    <span class="hljs-keyword">var</span> data = step.getData(),
                                                        bricksData = data.bricksData,
                                                        stepData = data.stepData,

                                                        wmsLayerName = bricksData.layerName.dropDownValue,

                                                        wmsConfig,
                                                        layer,
                                                        wmsLayer;

                                                    layer = UtilArray.find(stepData.wmsData.layers,
                                                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(l)</span> </span>{
                                                            <span class="hljs-keyword">return</span> l.name === wmsLayerName;
                                                        }
                                                    );

                                                    wmsConfig = {
                                                        id: LayerLoader.nextId(),
                                                        displayName: layer.desc,
                                                        format: <span class="hljs-string">"png"</span>,
                                                        layerName: wmsLayerName,
                                                        imageUrl: <span class="hljs-string">"assets/images/wms.png"</span>,
                                                        url: stepData.wmsUrl,
                                                        legendMimeType: <span class="hljs-string">"image/jpeg"</span>
                                                    };

                                                    <span class="hljs-keyword">if</span> (layer.queryable) {
                                                        wmsConfig.featureInfo = {
                                                            parser: <span class="hljs-string">"stringParse"</span>,
                                                            mimeType: <span class="hljs-string">"text/plain"</span>
                                                        };
                                                    }

                                                    wmsConfig = GlobalStorage.applyWMSDefaults(wmsConfig);

                                                    wmsLayer = RampMap.makeWmsLayer(wmsConfig, <span class="hljs-literal">true</span>);
                                                    RAMP.config.layers.wms.push(wmsConfig);

                                                    LayerLoader.loadLayer(wmsLayer);
                                                    addDatasetPopup.close();
                                                }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>expose: { as: “ADD_DATASET” }</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        id: <span class="hljs-string">"fileTypeStep"</span>,
                        content: [
                            {
                                id: <span class="hljs-string">"fileOrFileURL"</span>,
                                type: Bricks.FileInputBrick,
                                config: {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>template: “template_name”, //optional, has a default</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    header: i18n.t(<span class="hljs-string">"addDataset.fileOrURL"</span>),
                                    instructions: i18n.t(<span class="hljs-string">"addDataset.help.fileOrURL"</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>label: “Service URL”, // optional, equals to header by default</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    placeholder: i18n.t(<span class="hljs-string">"addDataset.fileOrURLPlaceholder"</span>),
                                    freezeStates: [Bricks.Brick.state.SUCCESS]
                                },
                                on: [
                                    {
                                        eventName: Bricks.FileInputBrick.event.CHANGE,
                                        callback: choiceTreeCallbacks.fileTypeStepGuess
                                    }
                                ]
                            },
                            {
                                id: <span class="hljs-string">"fileType"</span>,
                                type: Bricks.ChoiceBrick,
                                config: {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>template: “template_name”, //optional, has a default</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    instructions: i18n.t(<span class="hljs-string">"addDataset.help.fileOrURLType"</span>),
                                    header: i18n.t(<span class="hljs-string">"addDataset.fileType"</span>),
                                    choices: [
                                        {
                                            key: <span class="hljs-string">"geojsonFileAttrStep"</span>,
                                            value: i18n.t(<span class="hljs-string">"addDataset.geojson"</span>)
                                        },
                                        {
                                            key: <span class="hljs-string">"csvFileAttrStep"</span>,
                                            value: i18n.t(<span class="hljs-string">"addDataset.csv"</span>)
                                        },
                                        {
                                            key: <span class="hljs-string">"shapefileFileAttrStep"</span>,
                                            value: i18n.t(<span class="hljs-string">"addDataset.shapefile"</span>)
                                        }
                                    ],
                                    freezeStates: [Bricks.Brick.state.SUCCESS]
                                }
                            },
                            {
                                id: <span class="hljs-string">"fileTypeOkCancel"</span>,
                                type: Bricks.OkCancelButtonBrick,
                                config: {
                                    okLabel: i18n.t(<span class="hljs-string">"addDataset.load"</span>),
                                    okFreezeStates: [
                                        Bricks.Brick.state.SUCCESS,
                                        Bricks.Brick.state.ERROR
                                    ],
                                    cancelLabel: i18n.t(<span class="hljs-string">"addDataset.cancel"</span>),
                                    reverseOrder: <span class="hljs-literal">true</span>,

                                    required: [
                                        {
                                            id: Bricks.OkCancelButtonBrick.okButtonId,
                                            type: <span class="hljs-string">"all"</span>,
                                            check: [<span class="hljs-string">"fileType"</span>, <span class="hljs-string">"fileOrFileURL"</span>]
                                        },
                                        {
                                            id: Bricks.OkCancelButtonBrick.cancelButtonId,
                                            type: <span class="hljs-string">"any"</span>,
                                            check: [<span class="hljs-string">"fileType"</span>, <span class="hljs-string">"fileOrFileURL"</span>]
                                        }
                                    ]
                                },
                                on: [
                                    <span class="hljs-comment">/*{
                                        eventName: Bricks.OkCancelButtonBrick.event.CLICK,
                                        callback: function (step, data) {
                                            console.log("Just Click:", this, step, data);
                                        }
                                    },*/</span>
                                    {
                                        eventName: Bricks.OkCancelButtonBrick.event.OK_CLICK,</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>load and process files</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                        callback: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(step<span class="hljs-comment">/*, data*/</span>)</span> </span>{
                                            <span class="hljs-keyword">var</span> promise,
                                                handle = delayLoadingState(step, <span class="hljs-number">100</span>),
                                                bricksData = step.getData().bricksData,
                                                fileTypeValue = bricksData.fileType.selectedChoice,
                                                fileValue = bricksData.fileOrFileURL.fileValue,
                                                fileUrlValue = bricksData.fileOrFileURL.inputValue,
                                                fileName = bricksData.fileOrFileURL.fileName;

                                            promise = DataLoader.loadDataSet({
                                                url: fileValue ? <span class="hljs-literal">null</span> : fileUrlValue,
                                                file: fileValue,
                                                type: fileTypeValue === <span class="hljs-string">"shapefileFileAttrStep"</span> ? <span class="hljs-string">"binary"</span> : <span class="hljs-string">"text"</span>
                                            });

                                            promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
                                                <span class="hljs-keyword">switch</span> (fileTypeValue) {
                                                    <span class="hljs-keyword">case</span> <span class="hljs-string">"geojsonFileAttrStep"</span>:
                                                        <span class="hljs-keyword">var</span> geojsonPromise = DataLoader.buildGeoJson(data);

                                                        geojsonPromise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(featureLayer)</span> </span>{
                                                            <span class="hljs-keyword">var</span> fieldOptions;
                                                            <span class="hljs-built_in">window</span>.clearTimeout(handle);</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>TODO: when field name aliases are available, change how the dropdown values are generated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                            fieldOptions = featureLayer.fields.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(field)</span> </span>{ <span class="hljs-keyword">return</span> { value: field.name, text: field.name }; });</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>no layer names available; likely this is not a geojson file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                            <span class="hljs-keyword">if</span> (!fieldOptions || fieldOptions.length === <span class="hljs-number">0</span>) {
                                                                handleFailure(step, handle, {
                                                                    fileType:
                                                                        lang.mixin(choiceTreeErrors.geojsonError, {
                                                                            message: i18n.t(<span class="hljs-string">"addDataset.error.messageGeojsonInvalid"</span>)
                                                                        })
                                                                });
                                                            } <span class="hljs-keyword">else</span> {
                                                                choiceTreeCallbacks.simpleAdvance(step, bricksData.fileType, {
                                                                    stepData: featureLayer,
                                                                    bricksData: {
                                                                        datasetName: {
                                                                            inputValue: fileName
                                                                        },
                                                                        primaryAttribute: {
                                                                            options: fieldOptions
                                                                        }
                                                                    }
                                                                });
                                                            }
                                                        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>error building geojson</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                            <span class="hljs-built_in">console</span>.error(event);
                                                            handleFailure(step, handle, {
                                                                fileType:
                                                                    lang.mixin(choiceTreeErrors.geojsonError, {
                                                                        message: i18n.t(<span class="hljs-string">"addDataset.error.messageGeojsonBroken"</span>)
                                                                    })
                                                            });
                                                        });

                                                        <span class="hljs-keyword">break</span>;

                                                    <span class="hljs-keyword">case</span> <span class="hljs-string">"csvFileAttrStep"</span>:
                                                        <span class="hljs-keyword">var</span> rows,
                                                            delimiter = UtilMisc.detectDelimiter(data),

                                                            guess,
                                                            primaryAttribute,
                                                            headers;

                                                        <span class="hljs-built_in">window</span>.clearTimeout(handle);

                                                        rows = DataLoader.csvPeek(data, delimiter);
                                                        headers = rows[<span class="hljs-number">0</span>].map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(header)</span> </span>{ <span class="hljs-keyword">return</span> { value: header, text: header }; });</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>no properties names available; likely this is not a csv file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                        <span class="hljs-keyword">if</span> (!headers || headers.length === <span class="hljs-number">0</span>) {
                                                            handleFailure(step, handle, {
                                                                fileType:
                                                                    lang.mixin(choiceTreeErrors.csvError, {
                                                                        message: i18n.t(<span class="hljs-string">"addDataset.error.messageCSVInvalid"</span>)
                                                                    })
                                                            });
                                                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!rows || rows.length &lt; <span class="hljs-number">2</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>no rows, no layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                            handleFailure(step, handle, {
                                                                fileType:
                                                                    lang.mixin(choiceTreeErrors.csvError, {
                                                                        message: i18n.t(<span class="hljs-string">"addDataset.error.messageCSVShort"</span>)
                                                                    })
                                                            });
                                                        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (headers.length &lt; <span class="hljs-number">2</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>only one column? are you kidding me?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                            handleFailure(step, handle, {
                                                                fileType:
                                                                    lang.mixin(choiceTreeErrors.csvError, {
                                                                        message: i18n.t(<span class="hljs-string">"addDataset.error.messageCSVThin"</span>)
                                                                    })
                                                            });
                                                        } <span class="hljs-keyword">else</span> {
                                                            guess = guessLatLong(rows);</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>preselect primary attribute so it’s not one of the lat or long guesses;
if csv has only two fields (lat, long), select the first as primary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                            primaryAttribute = rows[<span class="hljs-number">0</span>].filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(header)</span> </span>{
                                                                <span class="hljs-keyword">return</span> header !== guess.lat &amp;&amp; header !== guess.long;
                                                            })[<span class="hljs-number">0</span>] || rows[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>TODO: if you can’t detect lat or long make the user choose them, don’t just select the first header from the list, maybe.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                            choiceTreeCallbacks.simpleAdvance(step, bricksData.fileType, {
                                                                stepData: {
                                                                    csvData: data,
                                                                    csvHeaders: rows[<span class="hljs-number">0</span>],
                                                                    csvDelimeter: delimiter
                                                                },
                                                                bricksData: {
                                                                    datasetName: {
                                                                        inputValue: fileName
                                                                    },
                                                                    primaryAttribute: {
                                                                        options: headers,
                                                                        selectedOption: primaryAttribute
                                                                    },
                                                                    latitude: {
                                                                        options: headers,
                                                                        selectedOption: guess.lat
                                                                    },
                                                                    longitude: {
                                                                        options: headers,
                                                                        selectedOption: guess.long
                                                                    }
                                                                }
                                                            });
                                                        }

                                                        <span class="hljs-keyword">break</span>;

                                                    <span class="hljs-keyword">case</span> <span class="hljs-string">"shapefileFileAttrStep"</span>:
                                                        <span class="hljs-keyword">var</span> shapefilePromise = DataLoader.buildShapefile(data);

                                                        shapefilePromise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(featureLayer)</span> </span>{
                                                            <span class="hljs-keyword">var</span> fieldOptions;

                                                            <span class="hljs-built_in">window</span>.clearTimeout(handle);</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>TODO: when field name aliases are available, change how the dropdown values are generated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                            fieldOptions = featureLayer.fields.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(field)</span> </span>{ <span class="hljs-keyword">return</span> { value: field.name, text: field.name }; });</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>no layer names available; likely this is not a geojson file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                            <span class="hljs-keyword">if</span> (!fieldOptions || fieldOptions.length === <span class="hljs-number">0</span>) {
                                                                handleFailure(step, handle, {
                                                                    fileType:
                                                                        lang.mixin(choiceTreeErrors.shapefileError, {
                                                                            message: i18n.t(<span class="hljs-string">"addDataset.error.messageShapefileInvalid"</span>)
                                                                        })
                                                                });
                                                            } <span class="hljs-keyword">else</span> {
                                                                choiceTreeCallbacks.simpleAdvance(step, bricksData.fileType, {
                                                                    stepData: featureLayer,
                                                                    bricksData: {
                                                                        datasetName: {
                                                                            inputValue: fileName
                                                                        },
                                                                        primaryAttribute: {
                                                                            options: fieldOptions
                                                                        }
                                                                    }
                                                                });
                                                            }
                                                        }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>error to build shapefiles</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                            <span class="hljs-built_in">console</span>.error(event);
                                                            handleFailure(step, handle, {
                                                                fileType:
                                                                    lang.mixin(choiceTreeErrors.shapefileError, {
                                                                        message: i18n.t(<span class="hljs-string">"addDataset.error.messageShapefileBroken"</span>)
                                                                    })
                                                            });
                                                        });

                                                        <span class="hljs-keyword">break</span>;
                                                }
                                            }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>error loading file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                <span class="hljs-built_in">console</span>.error(event);
                                                handleFailure(step, handle, {
                                                    fileOrFileURL:
                                                        lang.mixin(choiceTreeErrors.fileError, {
                                                            message: i18n.t(<span class="hljs-string">"addDataset.error.messageFileConnect"</span>)
                                                        })
                                                });
                                            });
                                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>expose: { as: “advance” },</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    },
                                    {
                                        eventName: Bricks.OkCancelButtonBrick.event.CANCEL_CLICK,
                                        expose: { <span class="hljs-keyword">as</span>: <span class="hljs-string">"retreat"</span> },
                                        callback: choiceTreeCallbacks.simpleCancel
                                    }

                                ]
                            }
                        ],
                        children: [
                            {
                                id: <span class="hljs-string">"geojsonFileAttrStep"</span>,
                                content: [
                                    {
                                        id: <span class="hljs-string">"datasetName"</span>,
                                        type: Bricks.SimpleInputBrick,
                                        config: {
                                            instructions: i18n.t(<span class="hljs-string">"addDataset.help.geojsonDatasetName"</span>),
                                            header: i18n.t(<span class="hljs-string">"addDataset.datasetName"</span>)
                                        }
                                    },
                                    {
                                        id: <span class="hljs-string">"primaryAttribute"</span>,
                                        type: Bricks.DropDownBrick,
                                        config: {
                                            instructions: i18n.t(<span class="hljs-string">"addDataset.help.geojsonPrimaryAttribute"</span>),
                                            header: i18n.t(<span class="hljs-string">"addDataset.primaryAttribute"</span>)
                                        }
                                    },
                                    {
                                        id: <span class="hljs-string">"color"</span>,
                                        type: Bricks.ColorPickerBrick,
                                        config: {
                                            instructions: i18n.t(<span class="hljs-string">"addDataset.help.geojsonColour"</span>),
                                            header: i18n.t(<span class="hljs-string">"addDataset.colour"</span>)
                                        }
                                    },
                                    {
                                        id: <span class="hljs-string">"addDataset"</span>,
                                        type: Bricks.ButtonBrick,
                                        config: {
                                            label: i18n.t(<span class="hljs-string">"addDataset.addDatasetButton"</span>),
                                            containerClass: <span class="hljs-string">"button-brick-container-main"</span>,
                                            buttonClass: <span class="hljs-string">"btn-primary"</span>
                                        },
                                        on: [
                                            {
                                                eventName: Bricks.ButtonBrick.event.CLICK,</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>add geojson layer to the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                callback: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(step <span class="hljs-comment">/*,data*/</span>)</span> </span>{
                                                    <span class="hljs-keyword">var</span> data = step.getData(),
                                                        bricksData = data.bricksData,
                                                        featureLayer = data.stepData,

                                                        iconTemplate = makeIconTemplate(<span class="hljs-string">"a_d_icon_"</span> + featureLayer.renderer._RAMP_rendererType, bricksData.color.hex);

                                                    DataLoader.enhanceFileFeatureLayer(featureLayer, {</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>renderer: obj.style,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                        colour: [
                                                            bricksData.color.rgb_[<span class="hljs-number">0</span>],
                                                            bricksData.color.rgb_[<span class="hljs-number">1</span>],
                                                            bricksData.color.rgb_[<span class="hljs-number">2</span>],
                                                            <span class="hljs-number">255</span>
                                                        ],
                                                        nameField: bricksData.primaryAttribute.dropDownValue,
                                                        icon: iconTemplate,
                                                        datasetName: bricksData.datasetName.inputValue,
                                                        fields: featureLayer.fields.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(field)</span> </span>{ <span class="hljs-keyword">return</span> field.name; })
                                                    });

                                                    LayerLoader.loadLayer(featureLayer);
                                                    addDatasetPopup.close();
                                                }
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                id: <span class="hljs-string">"csvFileAttrStep"</span>,
                                content: [
                                    {
                                        id: <span class="hljs-string">"datasetName"</span>,
                                        type: Bricks.SimpleInputBrick,
                                        config: {
                                            instructions: i18n.t(<span class="hljs-string">"addDataset.help.csvDatasetName"</span>),
                                            header: i18n.t(<span class="hljs-string">"addDataset.datasetName"</span>)
                                        }
                                    },
                                    {
                                        id: <span class="hljs-string">"primaryAttribute"</span>,
                                        type: Bricks.DropDownBrick,
                                        config: {
                                            instructions: i18n.t(<span class="hljs-string">"addDataset.help.csvPrimaryAttribute"</span>),
                                            header: i18n.t(<span class="hljs-string">"addDataset.primaryAttribute"</span>)
                                        }
                                    },
                                    {
                                        id: <span class="hljs-string">"latLongAttribute"</span>,
                                        type: Bricks.MultiBrick,
                                        config: {</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>header: “Service URL”, //optional, omitted if not specified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                            content: [
                                                {
                                                    id: <span class="hljs-string">"latitude"</span>,
                                                    type: Bricks.DropDownBrick,
                                                    config: {
                                                        instructions: i18n.t(<span class="hljs-string">"addDataset.help.csvLatitude"</span>),
                                                        header: i18n.t(<span class="hljs-string">"addDataset.latitude"</span>)
                                                    }
                                                },
                                                {
                                                    id: <span class="hljs-string">"longitude"</span>,
                                                    type: Bricks.DropDownBrick,
                                                    config: {
                                                        instructions: i18n.t(<span class="hljs-string">"addDataset.help.csvLongitude"</span>),
                                                        header: i18n.t(<span class="hljs-string">"addDataset.longitude"</span>)
                                                    }
                                                }
                                            ]
                                        }
                                    },
                                    {
                                        id: <span class="hljs-string">"color"</span>,
                                        type: Bricks.ColorPickerBrick,
                                        config: {
                                            instructions: i18n.t(<span class="hljs-string">"addDataset.help.csvColour"</span>),
                                            header: i18n.t(<span class="hljs-string">"addDataset.colour"</span>)
                                        }
                                    },
                                    {
                                        id: <span class="hljs-string">"addDataset"</span>,
                                        type: Bricks.ButtonBrick,
                                        config: {
                                            label: i18n.t(<span class="hljs-string">"addDataset.addDatasetButton"</span>),
                                            containerClass: <span class="hljs-string">"button-brick-container-main"</span>,
                                            buttonClass: <span class="hljs-string">"btn-primary"</span>
                                        },
                                        on: [
                                            {
                                                eventName: Bricks.ButtonBrick.event.CLICK,</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>add wms service layer to the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                callback: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(step <span class="hljs-comment">/*,data*/</span>)</span> </span>{
                                                    <span class="hljs-keyword">var</span> data = step.getData(),
                                                        bricksData = data.bricksData,
                                                        stepData = data.stepData,

                                                        csvData = stepData.csvData,
                                                        csvHeaders = stepData.csvHeaders,
                                                        csvDelimeter = stepData.csvDelimeter,

                                                        featureLayer,
                                                        iconTemplate = makeIconTemplate(<span class="hljs-string">'a_d_icon_circlePoint'</span>, bricksData.color.hex),

                                                        promise;

                                                    promise = DataLoader.buildCsv(csvData, {
                                                        latfield: bricksData.latitude.dropDownValue,
                                                        lonfield: bricksData.longitude.dropDownValue,
                                                        delimiter: csvDelimeter,

                                                        fields: csvHeaders
                                                    });

                                                    promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
                                                        featureLayer = event;

                                                        DataLoader.enhanceFileFeatureLayer(featureLayer, {
                                                            renderer: <span class="hljs-string">"circlePoint"</span>,
                                                            colour: [
                                                                bricksData.color.rgb_[<span class="hljs-number">0</span>],
                                                                bricksData.color.rgb_[<span class="hljs-number">1</span>],
                                                                bricksData.color.rgb_[<span class="hljs-number">2</span>],
                                                                <span class="hljs-number">255</span>
                                                            ],
                                                            nameField: bricksData.primaryAttribute.dropDownValue,
                                                            icon: iconTemplate,
                                                            datasetName: bricksData.datasetName.inputValue,
                                                            fields: csvHeaders
                                                        });</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>TODO: set symbology and colour on feature layer (obj.data)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                        LayerLoader.loadLayer(featureLayer);
                                                        addDatasetPopup.close();
                                                    }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>can’t construct csv</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                        handleFailure(step, <span class="hljs-literal">null</span>, {
                                                            datasetName:
                                                                lang.mixin(choiceTreeErrors.csvError, {
                                                                    message: i18n.t(<span class="hljs-string">"addDataset.error.messageCSVBroken"</span>)
                                                                })
                                                        });
                                                    });
                                                }
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                id: <span class="hljs-string">"shapefileFileAttrStep"</span>,
                                content: [
                                    {
                                        id: <span class="hljs-string">"datasetName"</span>,
                                        type: Bricks.SimpleInputBrick,
                                        config: {
                                            instructions: i18n.t(<span class="hljs-string">"addDataset.help.shapefileDatasetName"</span>),
                                            header: i18n.t(<span class="hljs-string">"addDataset.datasetName"</span>)
                                        }
                                    },
                                    {
                                        id: <span class="hljs-string">"primaryAttribute"</span>,
                                        type: Bricks.DropDownBrick,
                                        config: {
                                            instructions: i18n.t(<span class="hljs-string">"addDataset.help.shapefilePrimaryAttribute"</span>),
                                            header: i18n.t(<span class="hljs-string">"addDataset.primaryAttribute"</span>)
                                        }
                                    },
                                    {
                                        id: <span class="hljs-string">"color"</span>,
                                        type: Bricks.ColorPickerBrick,
                                        config: {
                                            instructions: i18n.t(<span class="hljs-string">"addDataset.help.shapefileColour"</span>),
                                            header: i18n.t(<span class="hljs-string">"addDataset.colour"</span>)
                                        }
                                    },
                                    {
                                        id: <span class="hljs-string">"addDataset"</span>,
                                        type: Bricks.ButtonBrick,
                                        config: {
                                            label: i18n.t(<span class="hljs-string">"addDataset.addDatasetButton"</span>),
                                            containerClass: <span class="hljs-string">"button-brick-container-main"</span>,
                                            buttonClass: <span class="hljs-string">"btn-primary"</span>
                                        },
                                        on: [
                                            {
                                                eventName: Bricks.ButtonBrick.event.CLICK,</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>add wms service layer to the map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                callback: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(step <span class="hljs-comment">/*,data*/</span>)</span> </span>{
                                                    <span class="hljs-keyword">var</span> data = step.getData(),
                                                        bricksData = data.bricksData,
                                                        featureLayer = data.stepData,

                                                        iconTemplate = makeIconTemplate(<span class="hljs-string">'a_d_icon_'</span> + featureLayer.renderer._RAMP_rendererType, bricksData.color.hex);

                                                    DataLoader.enhanceFileFeatureLayer(featureLayer, {</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>renderer: obj.style,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                                        colour: [
                                                            bricksData.color.rgb_[<span class="hljs-number">0</span>],
                                                            bricksData.color.rgb_[<span class="hljs-number">1</span>],
                                                            bricksData.color.rgb_[<span class="hljs-number">2</span>],
                                                            <span class="hljs-number">255</span>
                                                        ],
                                                        nameField: bricksData.primaryAttribute.dropDownValue,
                                                        icon: iconTemplate,
                                                        datasetName: bricksData.datasetName.inputValue,
                                                        fields: featureLayer.fields.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(field)</span> </span>{ <span class="hljs-keyword">return</span> field.name; })
                                                    });

                                                    LayerLoader.loadLayer(featureLayer);
                                                    addDatasetPopup.close();
                                                }
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                ]
            };
        }

        <span class="hljs-comment">/**
         * Creates a new choice tree html representation and appends it to the page.
         * 
         * @method createChoiceTree
         * @private
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createChoiceTree</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>clear steps</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            t.dfs(choiceTree, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(node)</span> </span>{
                node.stepItem = <span class="hljs-literal">null</span>;
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>create the choice tree</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            t.dfs(choiceTree, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(node, par<span class="hljs-comment">/*, ctrl*/</span>)</span> </span>{
                <span class="hljs-keyword">var</span> stepItem,
                    level = par ? par.level + <span class="hljs-number">1</span> : <span class="hljs-number">1</span>;

                node.level = level;

                stepItem = <span class="hljs-keyword">new</span> StepItem(node);
                stepItem.on(StepItem.event.CURRENT_STEP_CHANGE, setCurrentStep);
                stepItem.on(StepItem.event.STATE_CHANGE, setStepState);

                node.stepItem = stepItem;
                stepLookup[node.id] = stepItem;

                <span class="hljs-keyword">if</span> (par) {
                    par.stepItem.addChild(stepItem);
                }

                <span class="hljs-built_in">console</span>.log(node);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>append tree to the page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            rootNode
                .find(<span class="hljs-string">".add-dataset-content"</span>)
                .empty()
                .append(stepLookup.sourceTypeStep.node)
            ;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>set the first step as active</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            stepLookup.sourceTypeStep.currentStep(<span class="hljs-number">1</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>It’s IE9. Run Away!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">window</span>.FileReader) {
                <span class="hljs-keyword">var</span> fileOrFileURL = stepLookup.fileTypeStep.contentBricks.fileOrFileURL;

                <span class="hljs-built_in">console</span>.warn(<span class="hljs-string">"You have IE9"</span>);

                fileOrFileURL.fileNode.remove();
                fileOrFileURL.filePseudoNode.attr(<span class="hljs-string">"disabled"</span>, <span class="hljs-literal">true</span>);
                fileOrFileURL.browseFilesContainer
                    .attr({
                        title: i18n.t(<span class="hljs-string">"addDataset.error.ie9FileAPI"</span>)
                    })
                    .addClass(<span class="hljs-string">"_tooltip"</span>)
                ;
            }

            Theme.tooltipster(addDatasetContainer);
        }

        <span class="hljs-comment">/**
         * From provided CSV data, guesses which columns are long and lat.
         * 
         * @method guessLatLong
         * @private
         * @param  {Array} rows csv data
         * @return {Object}      an object with lat and long string properties indicating corresponding field names
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">guessLatLong</span><span class="hljs-params">(rows)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>try guessing lat and long columns</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> latRegex = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-regexp">/^[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)$/i</span>),
                longRegex = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-regexp">/^[-+]?(180(\.0+)?|((1[0-7]\d)|([1-9]?\d))(\.\d+)?)$/i</span>),

                guessesLat,
                guessesLong,

                guessedLatHeader,
                guessedLongHeader;</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>first filter out all columns that are not lat fro sure</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            guessesLat = rows[<span class="hljs-number">0</span>].filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(header, i)</span> </span>{
                <span class="hljs-keyword">return</span> rows.every(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(row, rowi)</span> </span>{
                    <span class="hljs-keyword">return</span> rowi === <span class="hljs-number">0</span> || latRegex.test(row[i]);
                });
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>filter out all columns that are not long for sure</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            guessesLong = rows[<span class="hljs-number">0</span>].filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(header, i)</span> </span>{
                <span class="hljs-keyword">return</span> rows.every(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(row, rowi)</span> </span>{
                    <span class="hljs-keyword">return</span> rowi === <span class="hljs-number">0</span> || longRegex.test(row[i]);
                });
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>console.log(guessesLat);
console.log(guessesLong);</p>

            </div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>if there more than one lat guesses</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (guessesLat.length &gt; <span class="hljs-number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>filter out ones that don’t have “la” or “y” in header name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                guessesLat = guessesLat.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(header)</span> </span>{
                    <span class="hljs-keyword">var</span> h = header.toLowerCase();

                    <span class="hljs-keyword">return</span> h.indexOf(<span class="hljs-string">'la'</span>) !== -<span class="hljs-number">1</span> || h.indexOf(<span class="hljs-string">'y'</span>) !== -<span class="hljs-number">1</span>;
                });
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>console.log(guessesLat);
pick the first lat guess or null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            guessedLatHeader = guessesLat[<span class="hljs-number">0</span>] || <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>if there more than one long guesses</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (guessesLong.length &gt; <span class="hljs-number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>first, remove lat guess from long options in case they overlap</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                UtilArray.remove(guessesLong, guessedLatHeader);</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>filter out ones that don’t have “lo” or “x” in header name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                guessesLong = guessesLong.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(header)</span> </span>{
                    <span class="hljs-keyword">var</span> h = header.toLowerCase();

                    <span class="hljs-keyword">return</span> h.indexOf(<span class="hljs-string">'lo'</span>) !== -<span class="hljs-number">1</span> || h.indexOf(<span class="hljs-string">'x'</span>) !== -<span class="hljs-number">1</span>;
                });
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>console.log(guessesLong);
pick the first long guess or null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            guessedLongHeader = guessesLong[<span class="hljs-number">0</span>] || <span class="hljs-literal">null</span>;

            <span class="hljs-keyword">return</span> {
                lat: guessedLatHeader,
                long: guessedLongHeader
            };
        }

        <span class="hljs-comment">/**
         * Creates a icon base64 template to be displayed in the layer selector.
         * 
         * @method makeIconTemplate
         * @private 
         * @param {String} templateName a name of the template to use for an icon
         * @param {String} hex color value in hex
         * @return {String} a base64 encoded icon template
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeIconTemplate</span><span class="hljs-params">(templateName, hex)</span> </span>{
            <span class="hljs-comment">/*jshint validthis: true */</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">"data:image/svg+xml;base64,"</span> +
                UtilMisc.b64EncodeUnicode(
                    TmplHelper.template.call(<span class="hljs-keyword">this</span>, templateName, {
                        colour: hex
                    }, templates)
                );
        }

        <span class="hljs-comment">/**
         * Delay setting loading state to the step for a specified time in case it happens really fast and it will flicker.
         * 
         * @method delayLoadingState
         * @param {StepItem} step step to delay setting loading state on
         * @param {Number} time a delay in ms
         * @private
         * @return {Number} setTimeout handle
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delayLoadingState</span><span class="hljs-params">(step, time)</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                step._notifyStateChange(StepItem.state.LOADING);
            }, time);
        }

        <span class="hljs-comment">/**
         * Handles any failure happening in the choice tree by setting the responsible step to error and displaying appropriate notices.
         * 
         * @method handleFailure
         * @private
         * @param  {StepItem} step         a step item that should handle failure
         * @param  {Number} handle       a timeout handle to be canceled
         * @param  {Object} brickNotices brick notices to be displayed 
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleFailure</span><span class="hljs-params">(step, handle, brickNotices)</span> </span>{
            <span class="hljs-keyword">if</span> (handle) {
                <span class="hljs-built_in">window</span>.clearTimeout(handle);
            }

            step
                ._notifyStateChange(StepItem.state.ERROR)
                .displayBrickNotices(brickNotices)
            ;
        }

        <span class="hljs-comment">/**
         * Notifies all step items in the tree which step is current at the moment.
         * 
         * @method setCurrentStep
         * @private
         * @param {String} event a StepItem.CURRENT_STEP_CHANGE event
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setCurrentStep</span><span class="hljs-params">(event)</span> </span>{
            t.dfs(choiceTree, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(node)</span> </span>{
                node.stepItem.currentStep(event.level, event.id);
            });
        }

        <span class="hljs-comment">/**
         * Notifies all step items in the tree that a certain step has changed its state.
         * 
         * @method setStepState
         * @private
         * @param {Object} event a StepItem.STATE_CHANGE event
         * @param {StepItem} step  a step item; this doesn't seem to be used
         * @param {String} state a state; this doesn't seem to be used
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setStepState</span><span class="hljs-params">(event, step, state)</span> </span>{
            <span class="hljs-keyword">if</span> (step &amp;&amp; state) {
                event = {
                    id: step.id,
                    level: step.level,
                    state: state
                };
            }

            t.dfs(choiceTree, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(node)</span> </span>{
                node.stepItem.setState(event.level, event.id, event.state);
            });
        }

        <span class="hljs-comment">/**
         * Closes the add dataset choice tree.
         * 
         * @method closeChoiceTree
         * @private
         */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">closeChoiceTree</span><span class="hljs-params">()</span> </span>{
            stepLookup.sourceTypeStep.retreat();
        }

        <span class="hljs-keyword">return</span> {
            <span class="hljs-comment">/**
             * Initialize add-dataset functionality and creates a add-dataset choice tree.
             * 
             * @method init
             * @static
             */</span>
            init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">var</span> tl = <span class="hljs-keyword">new</span> TimelineLite({ paused: <span class="hljs-literal">true</span> });

                rootNode = $(<span class="hljs-string">"#searchMapSectionBody"</span>);

                addDatasetToggle = rootNode.find(<span class="hljs-string">"#addDatasetToggle"</span>);
                addDatasetContainer = rootNode.find(<span class="hljs-string">"#add-dataset-section-container"</span>);

                layerList = rootNode.find(<span class="hljs-string">"#layerList"</span>);
                layerToggles = rootNode.find(<span class="hljs-string">".layer-checkboxes:first"</span>);
                filterToggles = rootNode.find(<span class="hljs-string">"#filterGlobalToggles"</span>);

                prepareChoiceTreeStructure();
                createChoiceTree();

                tl
                    .set(addDatasetContainer, { display: <span class="hljs-string">"block"</span> })

                    .set(layerList, { className: <span class="hljs-string">"+=scroll"</span> }, <span class="hljs-number">0.01</span>)
                    .set(filterToggles, { className: <span class="hljs-string">"+=scroll"</span> }, <span class="hljs-number">0.01</span>)

                    .to(filterToggles, transitionDuration, { top: -<span class="hljs-number">60</span>, ease: <span class="hljs-string">"easeOutCirc"</span> })
                    .to(layerList, transitionDuration, { top: layerList.height() / <span class="hljs-number">3</span>, ease: <span class="hljs-string">"easeOutCirc"</span> }, <span class="hljs-number">0</span>)
                    .to(layerList, transitionDuration / <span class="hljs-number">2</span>, { autoAlpha: <span class="hljs-number">0</span>, ease: <span class="hljs-string">"easeOutCirc"</span> }, transitionDuration / <span class="hljs-number">2</span>)

                    .set(layerToggles, { display: <span class="hljs-string">"none"</span> })
                ;

                addDatasetPopup = PopupManager.registerPopup(addDatasetToggle, <span class="hljs-string">"click"</span>,
                    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                        createChoiceTree();

                        tl
                            .eventCallback(<span class="hljs-string">"onComplete"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                addDatasetContainer.find(<span class="hljs-string">":focusable:first"</span>).focus();
                            })
                           .play()
                        ;

                        d.resolve();
                    },
                    {
                        closeHandler: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                            closeChoiceTree();

                            tl
                                .eventCallback(<span class="hljs-string">"onReverseComplete"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                })
                               .reverse()
                            ;

                            d.resolve();
                        },
                        target: addDatasetContainer,
                        activeClass: <span class="hljs-string">"button-pressed"</span>,
                        resetFocusOnClose: <span class="hljs-literal">true</span>
                    }
                );

                UtilDict.forEachEntry(GlobalStorage.DefaultRenderers,
                    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
                        symbologyPreset[key] = i18n.t(<span class="hljs-string">"presets.defaultRenderers."</span> + key);</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>symbologyPreset[key] = value.title;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    }
                );
            }
        };
    });</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
