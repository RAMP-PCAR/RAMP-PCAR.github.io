<!DOCTYPE html>

<html>
<head>
  <title>datagrid.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="advancedToolbar.html">
                advancedToolbar.js
              </a>
            
              
              <a class="source" href="basemapSelector.html">
                basemapSelector.js
              </a>
            
              
              <a class="source" href="bookmarkLink.html">
                bookmarkLink.js
              </a>
            
              
              <a class="source" href="dataLoader.html">
                dataLoader.js
              </a>
            
              
              <a class="source" href="dataLoaderGui.html">
                dataLoaderGui.js
              </a>
            
              
              <a class="source" href="datagrid.html">
                datagrid.js
              </a>
            
              
              <a class="source" href="datagridClickHandler.html">
                datagridClickHandler.js
              </a>
            
              
              <a class="source" href="eventManager.html">
                eventManager.js
              </a>
            
              
              <a class="source" href="featureClickHandler.html">
                featureClickHandler.js
              </a>
            
              
              <a class="source" href="featureHighlighter.html">
                featureHighlighter.js
              </a>
            
              
              <a class="source" href="filterManager.html">
                filterManager.js
              </a>
            
              
              <a class="source" href="geoSearch.html">
                geoSearch.js
              </a>
            
              
              <a class="source" href="globalStorage.html">
                globalStorage.js
              </a>
            
              
              <a class="source" href="graphicExtension.html">
                graphicExtension.js
              </a>
            
              
              <a class="source" href="gui.html">
                gui.js
              </a>
            
              
              <a class="source" href="imageExport.html">
                imageExport.js
              </a>
            
              
              <a class="source" href="layerGroup.html">
                layerGroup.js
              </a>
            
              
              <a class="source" href="layerItem.html">
                layerItem.js
              </a>
            
              
              <a class="source" href="layerLoader.html">
                layerLoader.js
              </a>
            
              
              <a class="source" href="map.html">
                map.js
              </a>
            
              
              <a class="source" href="mapClickHandler.html">
                mapClickHandler.js
              </a>
            
              
              <a class="source" href="maptips.html">
                maptips.js
              </a>
            
              
              <a class="source" href="navigation.html">
                navigation.js
              </a>
            
              
              <a class="source" href="quickzoom.html">
                quickzoom.js
              </a>
            
              
              <a class="source" href="ramp.html">
                ramp.js
              </a>
            
              
              <a class="source" href="stepItem.html">
                stepItem.js
              </a>
            
              
              <a class="source" href="theme.html">
                theme.js
              </a>
            
              
              <a class="source" href="RAMP-starter.html">
                RAMP-starter.js
              </a>
            
              
              <a class="source" href="areaTool.html">
                areaTool.js
              </a>
            
              
              <a class="source" href="baseTool.html">
                baseTool.js
              </a>
            
              
              <a class="source" href="bufferTool.html">
                bufferTool.js
              </a>
            
              
              <a class="source" href="distanceTool.html">
                distanceTool.js
              </a>
            
              
              <a class="source" href="populationTool.html">
                populationTool.js
              </a>
            
              
              <a class="source" href="array.html">
                array.js
              </a>
            
              
              <a class="source" href="bricks.html">
                bricks.js
              </a>
            
              
              <a class="source" href="checkbox.html">
                checkbox.js
              </a>
            
              
              <a class="source" href="checkboxGroup.html">
                checkboxGroup.js
              </a>
            
              
              <a class="source" href="decorator.html">
                decorator.js
              </a>
            
              
              <a class="source" href="dictionary.html">
                dictionary.js
              </a>
            
              
              <a class="source" href="functionMangler.html">
                functionMangler.js
              </a>
            
              
              <a class="source" href="popupManager.html">
                popupManager.js
              </a>
            
              
              <a class="source" href="prototype.html">
                prototype.js
              </a>
            
              
              <a class="source" href="tmplHelper.html">
                tmplHelper.js
              </a>
            
              
              <a class="source" href="tmplUtil.html">
                tmplUtil.js
              </a>
            
              
              <a class="source" href="url.html">
                url.js
              </a>
            
              
              <a class="source" href="util.html">
                util.js
              </a>
            
              
              <a class="source" href="bootstrapper.html">
                bootstrapper.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>datagrid.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*global define, tmpl, TimelineLite, TweenLite, window, i18n, $, console, RAMP */</span>
<span class="hljs-comment">/*jslint white: true */</span>

<span class="hljs-comment">/**
* Datagrid submodule.
*
* @module RAMP
* @submodule Datagrid
* @main Datagrid
*/</span>

<span class="hljs-comment">/**
* The Datagrid class represents the side bar table shown next to the map. The data grid displays all map objects in a text format and allows the user to see more
* details (same as clicking the map object) and navigate to the object. This class create the UI panel, events, and event-handles for the data grid container.
*
* ####Imports RAMP Modules:
* {{#crossLink "RAMP"}}{{/crossLink}}  
* {{#crossLink "GraphicExtension"}}{{/crossLink}}  
* {{#crossLink "GlobalStorage"}}{{/crossLink}}  
* {{#crossLink "DatagridClickHandler"}}{{/crossLink}}  
* {{#crossLink "Map"}}{{/crossLink}}  
* {{#crossLink "EventManager"}}{{/crossLink}}  
* {{#crossLink "Theme"}}{{/crossLink}}  
* {{#crossLink "Util"}}{{/crossLink}}  
* {{#crossLink "Array"}}{{/crossLink}}  
* {{#crossLink "Dictionary"}}{{/crossLink}}  
* {{#crossLink "PopupManager"}}{{/crossLink}}  
* {{#crossLink "TmplHelper"}}{{/crossLink}}  
* 
* ####Uses RAMP Templates:
* {{#crossLink "templates/datagrid_template.json"}}{{/crossLink}}
* {{#crossLink "templates/extended_datagrid_template.json"}}{{/crossLink}}
* 
* @class Datagrid
* @static
* @uses dojo/_base/declare
* @uses dojo/_base/lang
* @uses dojo/query
* @uses dojo/_base/array
* @uses dojo/dom-class
* @uses dojo/dom-attr
* @uses dojo/dom-construct
* @uses dojo/topic
* @uses dojo/on
* @uses esri/layers/FeatureLayer
* @uses esri/tasks/query
*/</span>

define([
<span class="hljs-comment">/* Dojo */</span>
    <span class="hljs-string">"dojo/_base/declare"</span>, <span class="hljs-string">"dojo/_base/lang"</span>, <span class="hljs-string">"dojo/query"</span>, <span class="hljs-string">"dojo/_base/array"</span>, <span class="hljs-string">"dojo/dom-class"</span>,
    <span class="hljs-string">"dojo/dom-attr"</span>, <span class="hljs-string">"dojo/dom-construct"</span>, <span class="hljs-string">"dojo/topic"</span>, <span class="hljs-string">"dojo/on"</span>, <span class="hljs-string">"dojo/Deferred"</span>,

<span class="hljs-comment">/* Text */</span>
     <span class="hljs-string">"dojo/text!./templates/datagrid_template.json"</span>,
     <span class="hljs-string">"dojo/text!./templates/extended_datagrid_template.json"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Esri</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-string">"esri/layers/FeatureLayer"</span>, <span class="hljs-string">"esri/tasks/query"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Ramp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-string">"ramp/ramp"</span>, <span class="hljs-string">"ramp/graphicExtension"</span>, <span class="hljs-string">"ramp/globalStorage"</span>, <span class="hljs-string">"ramp/datagridClickHandler"</span>, <span class="hljs-string">"ramp/map"</span>,
        <span class="hljs-string">"ramp/eventManager"</span>, <span class="hljs-string">"ramp/theme"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Util</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>         <span class="hljs-string">"utils/util"</span>, <span class="hljs-string">"utils/array"</span>, <span class="hljs-string">"utils/dictionary"</span>, <span class="hljs-string">"utils/popupManager"</span>, <span class="hljs-string">"utils/tmplHelper"</span>],

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(
</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Dojo</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        declare, lang, dojoQuery, dojoArray, domClass, domAttr,
        domConstruct, topic, dojoOn, Deferred,</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        data_grid_template,
        extended_datagrid_template,</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Esri</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        FeatureLayer, EsriQuery,</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Ramp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Ramp, GraphicExtension, GlobalStorage, DatagridClickHandler, RampMap, EventManager, Theme,</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Util</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        utilMisc, UtilArray, utilDict, popupManager, tmplHelper) {
        <span class="hljs-string">"use strict"</span>;

        <span class="hljs-keyword">var</span> GRID_MODE_SUMMARY = <span class="hljs-string">"summary"</span>,
            GRID_MODE_FULL = <span class="hljs-string">"full"</span>,

            <span class="hljs-comment">/**
            * Name of the attribute used to store the oid
            * in the details and zoomTo buttons
            *
            * @private
            * @property featureOidField
            */</span>
            featureOidField = <span class="hljs-string">"feature-oid"</span>,

            <span class="hljs-comment">/**
            * Name of the attribute used to store the layer id
            * in the details and zoomTo buttons
            *
            * @private
            * @property layerIdField
            */</span>
            layerIdField = <span class="hljs-string">"layer-id"</span>,

            data_grid_template_json = <span class="hljs-built_in">JSON</span>.parse(tmplHelper.stringifyTemplate(data_grid_template)),
            extended_datagrid_template_json = <span class="hljs-built_in">JSON</span>.parse(tmplHelper.stringifyTemplate(extended_datagrid_template)),</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>layerConfig,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            gridConfig,

            <span class="hljs-comment">/**
            * The jquery table
            *
            * @private
            * @property oTable
            */</span>
            oTable,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>The JQuery Object representing the grid</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            jqgrid,
            featureToPage = {},

            currentSortingMode = <span class="hljs-string">"asc"</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>A boolean used to keep track of whether or not the grid should apply an
extent filter when the datagrid gets selected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            extentFilterExpired = <span class="hljs-literal">true</span>,

            zoomToGraphic,

            lastExtent,</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>invisibleLayer toggle counter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            invisibleLayerToggleOn = [],

            <span class="hljs-comment">/**
            * Total number of features in all the visible layers on the map
            *
            * @private
            * @property totalRecords
            */</span>
            totalRecords = <span class="hljs-number">0</span>,

            ui = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-comment">/**
                * creates a datagrid row that has the following features:
                * highlight for a give graphic
                * un-highlight
                * scroll to for a give graphic
                *
                * @method createRowPrototype
                * @private
                * @param {String} cssClass the style that highlights the row.
                * @return {Object} an object containing features of a datagrid row
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createRowPrototype</span><span class="hljs-params">(cssClass)</span> </span>{
                    <span class="hljs-keyword">var</span> index = -<span class="hljs-number">1</span>,
                        graphic = <span class="hljs-literal">null</span>;

                    <span class="hljs-keyword">return</span> {
                        focusedButton: <span class="hljs-literal">null</span>,

                        isActive: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            <span class="hljs-keyword">return</span> graphic !== <span class="hljs-literal">null</span>;
                        },

                        isEqual: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layerId, oid)</span> </span>{
                            <span class="hljs-keyword">var</span> thisId = graphic.getLayer().id,
                                thisOid = GraphicExtension.getOid(graphic);

                            <span class="hljs-keyword">return</span> (thisId === layerId) &amp;&amp; (thisOid === oid);
                        },

                        <span class="hljs-comment">/**
                        * Navigate to the page the row is in and scroll to it. Returns true
                        * if the row exists in the datagrid, false otherwise.
                        *
                        * @method navigateToRow
                        * @return {Boolean} A value indicating is the navigation is successful
                        * @private
                        * @method navigateToRow
                        */</span>
                        navigateToRow: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Figure out which page the entry is in and navigate to that page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">var</span> page = <span class="hljs-built_in">Math</span>.floor(index / gridConfig.rowsPerPage);
                                <span class="hljs-keyword">if</span> (oTable.page() !== page) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>False tells draw not to navigate to the first page</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    jqgrid.DataTable().page(page).draw(<span class="hljs-literal">false</span>);
                                }

                                jqgridTableWrapper.scrollTo(<span class="hljs-keyword">this</span>.getNode(), <span class="hljs-number">300</span>, {
                                    axis: <span class="hljs-string">"y"</span>,
                                    offset: {
                                        left: <span class="hljs-number">0</span>,
                                        top: -<span class="hljs-keyword">this</span>.getNode().height() * <span class="hljs-number">1.5</span>
                                    }
                                });

                                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                            }
                            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                        },

                        setGraphic: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(newGraphic)</span> </span>{
                            graphic = newGraphic;

                            <span class="hljs-keyword">this</span>.refresh();
                        },

                        <span class="hljs-comment">/**
                        * Finds a row node corresponding to the given graphic object.
                        *
                        * @method refresh
                        * @private
                        * @return {{node: jObject, page: number}} A row node that displays graphic information. If none found, returns an object with empty jNode.
                        */</span>
                        refresh: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            <span class="hljs-keyword">if</span> (graphic) {
                                <span class="hljs-keyword">var</span> layerId = graphic.getLayer().id,
                                    id = GraphicExtension.getOid(graphic);
                                <span class="hljs-keyword">if</span> ((layerId <span class="hljs-keyword">in</span> featureToPage) &amp;&amp; (id <span class="hljs-keyword">in</span> featureToPage[layerId])) {
                                    index = featureToPage[layerId][id];
                                } <span class="hljs-keyword">else</span> {
                                    index = -<span class="hljs-number">1</span>;
                                }
                            } <span class="hljs-keyword">else</span> {
                                index = -<span class="hljs-number">1</span>;
                            }
                        },

                        <span class="hljs-comment">/**
                        * Finds a row node corresponding to the given graphic object.
                        *
                        * @method getNode
                        * @private
                        * @return {{node: jObject, page: number}} A row node that displays graphic information. If none found, returns an object with empty jNode.
                        */</span>
                        getNode: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            <span class="hljs-keyword">return</span> $(<span class="hljs-built_in">String</span>.format(<span class="hljs-string">"#jqgrid tbody tr:nth-child({0})"</span>, index % gridConfig.rowsPerPage + <span class="hljs-number">1</span>));
                        },

                        <span class="hljs-comment">/**
                        * Highlights the given graphic object using the specified cssClass.
                        *
                        * @method activate
                        * @private
                        */</span>
                        activate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            <span class="hljs-keyword">if</span> (graphic) {
                                <span class="hljs-keyword">this</span>.getNode().addClass(cssClass);

                                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.focusedButton) {
                                    <span class="hljs-keyword">this</span>.getNode().find(<span class="hljs-keyword">this</span>.focusedButton).focus();
                                    <span class="hljs-keyword">this</span>.focusedButton = <span class="hljs-literal">null</span>;
                                }
                            }
                        },

                        <span class="hljs-comment">/**
                        * Removes a specified cssClass from a given graphic object in the data grid
                        *
                        * @method deactivate
                        * @private
                        */</span>
                        deactivate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            <span class="hljs-keyword">if</span> (graphic) {
                                <span class="hljs-keyword">this</span>.getNode().removeClass(cssClass);
                                graphic = <span class="hljs-literal">null</span>;
                            }
                        }
                    };
                }

                <span class="hljs-keyword">var</span> highlightRow = createRowPrototype(<span class="hljs-string">"selected-row"</span>),
                    zoomlightRow = createRowPrototype(<span class="hljs-string">"highlighted-row"</span>),

                    extendedTabTitle,

                    sectionNode,
                    tabNode = $(<span class="hljs-string">"details[data-panel-name=datagrid]"</span>),

                    selectedDatasetId,

                    datagridStatusLine,
                    datagridGlobalToggles,
                    datagridNotice,
                    jqgridWrapper,
                    jqgridTableWrapper,
                    dataTablesScroll,
                    dataTablesScrollBody,
                    dataTablesScrollHead,
                    datasetSelector,
                    datasetSelectorSubmitButton,

                    datagridMode = GRID_MODE_SUMMARY, <span class="hljs-comment">// GRID_MODE_FULL</span>

                    _isReady = <span class="hljs-literal">false</span>; <span class="hljs-comment">// indicates if the ui has fully rendered</span>

                <span class="hljs-comment">/**
                * Generates a data grid row data with a checkbox to be used in template
                *
                * @method generateToggleButtonDataForTemplate
                * @private
                * @return {String} the generated row data object.
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generateToggleButtonDataForTemplate</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>TODO: if no more modification is needed, this can be omitted and merged in the higher level.
create object for template
TODO: JKW
Note, the following object is for passing to the template, properties
were guessed. Need to add more detail later on. Empty values were provided,
for example, there were value of “” assigned to the toggle button template, in the code
provided. A temporary property name “attribute” is used. Not sure if this will be
used by ECDMP, therefore, leave the empty value in the template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> toggleButtonData = {
                        buttonLabel: i18n.t(<span class="hljs-string">"datagrid.sort"</span>),
                        classAddition: <span class="hljs-string">"font-medium global-button"</span>,
                        someAttribute: <span class="hljs-string">""</span>
                    };

                    <span class="hljs-keyword">return</span> toggleButtonData;
                }

                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rowRenderer</span><span class="hljs-params">(data, type, row, meta)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>attribute = feature.attributes;
Remember, case sensitivity MATTERS in the attribute name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                    <span class="hljs-keyword">var</span> obj = row.last(),
                        datagridMode = ui.getDatagridMode(),
                        tmplData,
                        layerConfig = obj.feature.getLayer().ramp.config;

                    <span class="hljs-keyword">if</span> (datagridMode === GRID_MODE_SUMMARY) {
                        <span class="hljs-keyword">if</span> (!(datagridMode <span class="hljs-keyword">in</span> obj)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>bundle feature into the template data object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            tmplData = tmplHelper.dataBuilder(obj.feature, layerConfig);

                            <span class="hljs-keyword">var</span> sumTemplate = layerConfig.templates.summary;

                            tmpl.cache = {};

                            tmpl.templates = data_grid_template_json;

                            obj[datagridMode] = tmpl(sumTemplate, tmplData);
                        }

                        <span class="hljs-keyword">return</span> obj[datagridMode];
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">if</span> (!(datagridMode <span class="hljs-keyword">in</span> obj)) {
                            obj[datagridMode] = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>make array containing values for each column in the full grid
retrieve extendedGrid config object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">var</span> extendedGrid = layerConfig.datagrid.gridColumns;

                            tmpl.cache = {};
                            tmpl.templates = extended_datagrid_template_json;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>bundle feature into the template data object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            tmplData = tmplHelper.dataBuilder(obj.feature, layerConfig);

                            dojoArray.forEach(extendedGrid, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(col, i)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>add columnIdx property, and set initial value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                tmplData.columnIdx = i;
                                <span class="hljs-keyword">var</span> result = tmpl(col.columnTemplate, tmplData);</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Need to check if it’s a number, since the template converts
everything into strings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">if</span> (col.sortType === <span class="hljs-string">"numeric"</span>) {
                                    result = <span class="hljs-built_in">Number</span>(result);
                                }
                                obj[datagridMode].push(result);
                            });
                        }

                        <span class="hljs-keyword">return</span> obj[datagridMode][meta.col];
                    }
                }

                <span class="hljs-comment">/**
                * Creates a Data table based on the grid configuration specified in the application config object. See http://datatables.net/reference/option/ for addition information on config parameters.
                *
                * @method createDatatable
                * @private
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createDatatable</span><span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">var</span> forcedWidth,
                        tableOptions = {
                            info: <span class="hljs-literal">false</span>,
                            columnDefs: [],
                            autoWidth: <span class="hljs-literal">false</span>,
                            deferRender: <span class="hljs-literal">true</span>,
                            order: [], <span class="hljs-comment">//required to remove the "default sort" icon from the first column</span>
                            paging: <span class="hljs-literal">true</span>,
                            pagingType: <span class="hljs-string">"ramp"</span>, <span class="hljs-comment">//"full_numbers",</span>
                            scrollX: <span class="hljs-literal">true</span>,
                            destroy: <span class="hljs-literal">true</span>,
                            pageLength: gridConfig.rowsPerPage,
                            language: i18n.t(<span class="hljs-string">"datagrid.gridstrings"</span>, { returnObjectTrees: <span class="hljs-literal">true</span> }),
                            getTotalRecords: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                <span class="hljs-keyword">return</span> totalRecords;
                            }
                        };

                    <span class="hljs-keyword">if</span> (datagridMode === GRID_MODE_SUMMARY) {
                        tableOptions = lang.mixin(tableOptions,
                            {
                                columns: [{
                                    title: <span class="hljs-string">"Name"</span>,
                                    width: <span class="hljs-string">"300px"</span>,
                                    type: <span class="hljs-string">"string"</span>,
                                    className: <span class="hljs-string">""</span>,
                                    render: rowRenderer,
                                    orderable: <span class="hljs-literal">true</span>
                                }],
                                dom: <span class="hljs-string">'&lt;"jqgrid_table_wrapper summary-table"t&gt;&lt;"status-line"p&gt;'</span>,
                                searching: <span class="hljs-literal">true</span>
                            }
                        );
                    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>layout for variable column (extended grid)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        tableOptions = lang.mixin(tableOptions,
                            {
                                columns: ui.getSelectedDatasetId() === <span class="hljs-literal">null</span> ? [{ title: <span class="hljs-string">""</span> }] : dojoArray.map(Ramp.getLayerConfigWithId(ui.getSelectedDatasetId()).datagrid.gridColumns, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(column)</span> </span>{
                                    <span class="hljs-keyword">return</span> {
                                        title: column.title,
                                        width: column.width ? column.width : <span class="hljs-string">"100px"</span>,
                                        type: column.sortType,
                                        className: column.alignment ? <span class="hljs-string">""</span> : <span class="hljs-string">"center"</span>,
                                        render: rowRenderer,
                                        orderable: column.orderable
                                    };
                                }),
                                dom: <span class="hljs-string">'&lt;"jqgrid_table_wrapper full-table"t&gt;&lt;"datagrid-info-notice simple"&gt;&lt;"status-line"p&gt;'</span>,
                                scrollY: <span class="hljs-string">"500px"</span>, <span class="hljs-comment">// just a placeholder; it will be dynamically updated later</span>
                                searching: RAMP.config.extendedDatagridExtentFilterEnabled
                            }
                        );
                    }

                    jqgrid = sectionNode.find(<span class="hljs-string">"table"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>True if a page change just occurred
False otherwise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> pageChange = <span class="hljs-literal">false</span>;

                    oTable = jqgrid.DataTable(tableOptions)
                        .on(<span class="hljs-string">"page.dt"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            topic.publish(EventManager.GUI.SUBPANEL_DOCK, { origin: <span class="hljs-string">"datagrid,ex-datagrid"</span> });

                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"subPanleDock"</span>);

                            pageChange = <span class="hljs-literal">true</span>;
                        })
                        .on(<span class="hljs-string">"order.dt"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            topic.publish(EventManager.GUI.SUBPANEL_DOCK, { origin: <span class="hljs-string">"datagrid,ex-datagrid"</span> });

                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"subPanleDock"</span>);
                        })
                        .on(<span class="hljs-string">"draw.dt"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            cacheSortedData();</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Do not activateRows if we’re doing a page change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">if</span> (pageChange) {
                                pageChange = <span class="hljs-literal">false</span>;
                            } <span class="hljs-keyword">else</span> {
                                ui.activateRows();
                            }

                            ui.adjustPanelWidth();

                            topic.publish(EventManager.Datagrid.DRAW_COMPLETE);
                        });

                    jqgridWrapper = sectionNode.find(<span class="hljs-string">"#jqgrid_wrapper"</span>);
                    jqgridTableWrapper = sectionNode.find(<span class="hljs-string">".jqgrid_table_wrapper"</span>);
                    dataTablesScroll = sectionNode.find(<span class="hljs-string">".dataTables_scroll"</span>);
                    dataTablesScrollBody = dataTablesScroll.find(<span class="hljs-string">".dataTables_scrollBody"</span>);
                    dataTablesScrollHead = dataTablesScroll.find(<span class="hljs-string">".dataTables_scrollHead"</span>);

                    datagridNotice = sectionNode.find(<span class="hljs-string">'.datagrid-info-notice'</span>);

                    Theme.tooltipster(jqgridWrapper);</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>DO:Clean;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (datagridMode !== GRID_MODE_SUMMARY) {
                        jqgridWrapper.addClass(<span class="hljs-string">"fadedOut"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>explicitly set height of the scrollbody so the horizontal scrollbar is visible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        dataTablesScrollBody.height(jqgridTableWrapper.height() - dataTablesScrollHead.height());</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>explicitly force-set width of the jqgrid so it wouldn’t compress when a sub-panel is opened
also check if the width is no greater than that of the container, hide the horizontal scrollbar</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        forcedWidth = jqgrid.outerWidth();

                        ui.adjustPanelWidth();

                        <span class="hljs-comment">/*if (forcedWidth === jqgridWrapper.outerWidth()) {
                            dataTablesScrollBody.addClass("overflow-x-hidden");
                        } else {
                            dataTablesScrollBody.removeClass("overflow-x-hidden");
                        }*/</span>

                        jqgrid.forceStyle({ width: forcedWidth + <span class="hljs-string">"px"</span> });
                    }
                }
                <span class="hljs-comment">/**
                * Initialize tooltips for the data grid
                *
                * @method initTooltips
                * @private
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initTooltips</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>/ <summary>
/ initialize tooltips for the datagrid
/ </summary></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    popupManager.registerPopup(sectionNode, <span class="hljs-string">"hoverIntent"</span>,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.target.attr(<span class="hljs-string">"title"</span>)) {
                                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.target.isOverflowed()) {
                                    <span class="hljs-keyword">this</span>.target.tooltipster({ theme: <span class="hljs-string">'.tooltipster-dark'</span> }).tooltipster(<span class="hljs-string">"show"</span>);
                                } <span class="hljs-keyword">else</span> {
                                    <span class="hljs-keyword">this</span>.target.removeAttr(<span class="hljs-string">"title"</span>);
                                }
                            }
                        },
                        {
                            handleSelector: <span class="hljs-string">".point-name, .category-name, .title-span"</span>,
                            useAria: <span class="hljs-literal">false</span>,
                            timeout: <span class="hljs-number">500</span>
                        }
                    );
                }

                <span class="hljs-comment">/**
                * Adds event-handling for buttons inside the data grid's row elements (i.e 'Details', 'Zoom To' buttons)
                *
                * @method setButtonEvents
                * @private
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setButtonEvents</span><span class="hljs-params">()</span> </span>{
                    sectionNode.on(<span class="hljs-string">"click"</span>, <span class="hljs-string">"button.details"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">var</span> buttonNode = $(<span class="hljs-keyword">this</span>),
                            layerId = buttonNode.data(layerIdField),
                            oid = buttonNode.data(featureOidField);  <span class="hljs-comment">//TODO: replace with better selector</span>

                        highlightRow.focusedButton = <span class="hljs-string">"button.details"</span>;

                        <span class="hljs-keyword">if</span> (highlightRow.isActive() &amp;&amp; highlightRow.isEqual(layerId, oid)) {
                            DatagridClickHandler.onDetailDeselect(datagridMode);
                        } <span class="hljs-keyword">else</span> {
                            <span class="hljs-keyword">var</span> graphic = getGraphicFromButton(buttonNode);

                            DatagridClickHandler.onDetailSelect(buttonNode, graphic, datagridMode);
                        }
                    });</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Event handling for “Zoom To” button</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    sectionNode.on(<span class="hljs-string">"click"</span>, <span class="hljs-string">"button.zoomto"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(evt)</span> </span>{
                        <span class="hljs-keyword">var</span> zoomNode = $(<span class="hljs-keyword">this</span>);

                        zoomlightRow.focusedButton = <span class="hljs-string">"button.zoomto"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Zoom To</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">if</span> (zoomNode.text() === i18n.t(<span class="hljs-string">"datagrid.zoomTo"</span>)) {
                            handleGridEvent(evt, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                zoomToGraphic = getGraphicFromButton(zoomNode);</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>store the current extent, then zoom to point.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                lastExtent = RampMap.getMap().extent.clone();

                                DatagridClickHandler.onZoomTo(RampMap.getMap().extent.clone(), zoomToGraphic);</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Update “zoom back” text after the extent change, if we update it
before the extent change, it won’t work since the datagrid gets
repopulated after an extent change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                utilMisc.subscribeOnce(EventManager.Datagrid.EXTENT_FILTER_END, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Find the first node with the same oid, layerId</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    <span class="hljs-keyword">var</span> newNode = $(<span class="hljs-built_in">String</span>.format(<span class="hljs-string">"button.zoomto[data-{0}='{1}'][data-{2}='{3}']:eq(0)"</span>,
                                                    featureOidField, GraphicExtension.getOid(zoomToGraphic),
                                                    layerIdField, zoomToGraphic.getLayer().id));
                                    newNode.text(i18n.t(<span class="hljs-string">"datagrid.zoomBack"</span>));
                                });
                            });
                        } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// Zoom back</span>
                            DatagridClickHandler.onZoomBack(zoomToGraphic);
                            zoomNode.text(i18n.t(<span class="hljs-string">"datagrid.zoomTo"</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Reset focus back to “Zoom To” link after map extent change</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            utilMisc.subscribeOnce(EventManager.Datagrid.EXTENT_FILTER_END, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                <span class="hljs-keyword">var</span> newNode = $(<span class="hljs-built_in">String</span>.format(<span class="hljs-string">"button.zoomto[data-{0}='{1}'][data-{2}='{3}']:eq(0)"</span>,
                                        featureOidField, GraphicExtension.getOid(zoomToGraphic),
                                        layerIdField, zoomToGraphic.getLayer().id));
                                newNode.focus();
                            });
                        }
                    });

                    sectionNode.on(<span class="hljs-string">"click"</span>, <span class="hljs-string">"button.global-button"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">var</span> buttonNode = $(<span class="hljs-keyword">this</span>);

                        <span class="hljs-keyword">if</span> (currentSortingMode === <span class="hljs-string">"asc"</span>) {
                            buttonNode.addClass(<span class="hljs-string">"state-expanded"</span>);
                            currentSortingMode = <span class="hljs-string">"desc"</span>;
                        } <span class="hljs-keyword">else</span> {
                            buttonNode.removeClass(<span class="hljs-string">"state-expanded"</span>);
                            currentSortingMode = <span class="hljs-string">"asc"</span>;
                        }

                        jqgrid.DataTable().order([<span class="hljs-number">0</span>, currentSortingMode]).draw();
                    });</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Adds an event trigger for the expansion of the datagrid control</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    sectionNode.on(<span class="hljs-string">"click"</span>, <span class="hljs-string">"button.expand"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">var</span> d = <span class="hljs-keyword">new</span> Deferred();
                        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"grid expanded!"</span>);

                        datagridMode = datagridMode === GRID_MODE_SUMMARY ? GRID_MODE_FULL : GRID_MODE_SUMMARY;

                        d.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            initScrollListeners();
                        });

                        refreshPanel(d);

                        topic.publish(EventManager.GUI.DATAGRID_EXPAND);
                    });

                    sectionNode.on(<span class="hljs-string">"change"</span>, <span class="hljs-string">"#datasetSelector"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">var</span> controlNode = $(<span class="hljs-keyword">this</span>),
                            optionSelected = controlNode.find(<span class="hljs-string">"option:selected"</span>),
                            state = (optionSelected[<span class="hljs-number">0</span>].value === selectedDatasetId);

                        updateDatasetSelectorState(state, <span class="hljs-literal">true</span>);
                    });

                    sectionNode.on(<span class="hljs-string">"click"</span>, <span class="hljs-string">"#datasetSelectorSubmitButton"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">var</span> optionSelected = datasetSelector.find(<span class="hljs-string">"option:selected"</span>);

                        <span class="hljs-keyword">if</span> (optionSelected.length &gt; <span class="hljs-number">0</span>) {
                            selectedDatasetId = optionSelected[<span class="hljs-number">0</span>].value;
                        } <span class="hljs-keyword">else</span> {
                            selectedDatasetId = <span class="hljs-string">""</span>;
                        }

                        refreshTable();
                    });

                    popupManager.registerPopup(sectionNode, <span class="hljs-string">"hover, focus"</span>,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                            <span class="hljs-keyword">this</span>.target.removeClass(<span class="hljs-string">"wb-invisible"</span>);
                            d.resolve();
                        },
                        {
                            handleSelector: <span class="hljs-string">"tr"</span>,

                            targetSelector: <span class="hljs-string">".record-controls"</span>,

                            closeHandler: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                                <span class="hljs-keyword">this</span>.target.addClass(<span class="hljs-string">"wb-invisible"</span>);

                                d.resolve();
                            },

                            activeClass: <span class="hljs-string">"bg-very-light"</span>,
                            useAria: <span class="hljs-literal">false</span>
                        }
                    );

                    popupManager.registerPopup(sectionNode, <span class="hljs-string">"hover, focus"</span>,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                            d.resolve();
                        },
                        {
                            handleSelector: <span class="hljs-string">".full-table #jqgrid tbody tr"</span>,
                            activeClass: <span class="hljs-string">"bg-very-light"</span>,
                            useAria: <span class="hljs-literal">false</span>
                        }
                    );

                    popupManager.registerPopup(sectionNode, <span class="hljs-string">"dblclick"</span>,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                            <span class="hljs-keyword">var</span> <span class="hljs-comment">//oldHandles = jqgrid.find(".expand-cell"),</span>
                                extraPadding = (<span class="hljs-keyword">this</span>.handle.outerHeight() - <span class="hljs-keyword">this</span>.target.height()) / <span class="hljs-number">2</span>;

                            TweenLite.set(<span class="hljs-string">".expand-cell"</span>, { clearProps: <span class="hljs-string">"padding"</span>, className: <span class="hljs-string">"-=expand-cell"</span> });</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>TweenLite.set(“.expand-cell”, { className: “-=expand-cell” });</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            TweenLite.set(<span class="hljs-keyword">this</span>.handle, { padding: extraPadding });

                            <span class="hljs-built_in">window</span>.getSelection().removeAllRanges();

                            d.resolve();
                        },
                        {
                            handleSelector: <span class="hljs-string">"td"</span>,

                            targetSelector: <span class="hljs-string">".title-span"</span>,

                            closeHandler: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                                TweenLite.set(<span class="hljs-keyword">this</span>.handle, { clearProps: <span class="hljs-string">"padding"</span> });
                                TweenLite.set(<span class="hljs-keyword">this</span>.handle, { className: <span class="hljs-string">"-=expand-cell"</span> });

                                d.resolve();
                            },

                            activeClass: <span class="hljs-string">"expand-cell"</span>,
                            useAria: <span class="hljs-literal">false</span>
                        }
                    );</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>handle clicks on notices</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    popupManager.registerPopup(sectionNode, <span class="hljs-string">"click"</span>,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                            <span class="hljs-keyword">this</span>.target.toggle();

                            <span class="hljs-keyword">this</span>.handle
                                .find(<span class="hljs-string">".separator i"</span>)
                                .removeClass(<span class="hljs-string">"fa-angle-down"</span>)
                                .addClass(<span class="hljs-string">"fa-angle-up"</span>);

                            d.resolve();
                        },
                        {
                            closeHandler: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                                <span class="hljs-keyword">this</span>.target.toggle();

                                <span class="hljs-keyword">this</span>.handle
                                    .find(<span class="hljs-string">".separator i"</span>)
                                    .removeClass(<span class="hljs-string">"fa-angle-up"</span>)
                                    .addClass(<span class="hljs-string">"fa-angle-down"</span>);

                                d.resolve();
                            },

                            handleSelector: <span class="hljs-string">".info-notice-button"</span>,
                            containerSelector: <span class="hljs-string">".datagrid-info-notice"</span>,
                            targetSelector: <span class="hljs-string">".notice-details"</span>
                        }
                    );
                }

                <span class="hljs-comment">/**
                * Apply's or removes the scrollbar from the data grid based on the height of its container.
                *
                * @method initScrollListeners
                * @private
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initScrollListeners</span><span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">var</span> currentTopScroll,
                        currentBottomScroll;

                    <span class="hljs-keyword">if</span> (datagridMode === GRID_MODE_SUMMARY) {
                        jqgridTableWrapper.scroll(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            currentTopScroll = jqgridTableWrapper.scrollTop();
                            currentBottomScroll = dataTablesScroll.height() - jqgridTableWrapper.scrollTop() - jqgridTableWrapper.height();

                            <span class="hljs-keyword">if</span> (currentTopScroll === <span class="hljs-number">0</span>) {
                                datagridGlobalToggles.removeClass(<span class="hljs-string">"scroll"</span>);
                                datagridNotice.removeClass(<span class="hljs-string">"scroll"</span>);
                            } <span class="hljs-keyword">else</span> {
                                datagridGlobalToggles.addClass(<span class="hljs-string">"scroll"</span>);
                                datagridNotice.addClass(<span class="hljs-string">"scroll"</span>);
                            }

                            <span class="hljs-keyword">if</span> (currentBottomScroll === <span class="hljs-number">0</span>) {
                                datagridStatusLine.removeClass(<span class="hljs-string">"scroll"</span>);
                            } <span class="hljs-keyword">else</span> {
                                datagridStatusLine.addClass(<span class="hljs-string">"scroll"</span>);
                            }
                        });
                    } <span class="hljs-keyword">else</span> {
                        dataTablesScrollBody.scroll(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            currentTopScroll = dataTablesScrollBody.scrollTop();

                            <span class="hljs-keyword">if</span> (currentTopScroll === <span class="hljs-number">0</span>) {
                                dataTablesScrollHead.removeClass(<span class="hljs-string">"scroll"</span>);
                            } <span class="hljs-keyword">else</span> {
                                dataTablesScrollHead.addClass(<span class="hljs-string">"scroll"</span>);
                            }
                        });
                    }
                }

                <span class="hljs-comment">/**
                * Highlights the row according to the graphic stored in the event. Sets the hightlightRow variable to the graphic object inside the sent event
                *
                * @method highlightrowShow
                * @private
                * @param {Object} event A thrown event that contains a graphic object inside the grid
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">highlightrowShow</span><span class="hljs-params">(event)</span> </span>{
                    highlightrowHide();

                    highlightRow.setGraphic(event.graphic);

                    <span class="hljs-keyword">if</span> (event.scroll) {
                        ui.activateRows();</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>applyExtentFilter();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    }
                }

                <span class="hljs-comment">/**
                * Un-highlights the row that is currently highlighted
                *
                * @method highlightrowHide
                * @private
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">highlightrowHide</span><span class="hljs-params">()</span> </span>{
                    highlightRow.deactivate();

                    DatagridClickHandler.onZoomCancel();
                }

                <span class="hljs-comment">/**
                * Stores the graphic in the given event in the variable zoomlightRow
                *
                * @method zoomlightrowShow
                * @private
                * @param {Object} event A thrown event that contains a graphic object inside the grid
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">zoomlightrowShow</span><span class="hljs-params">(event)</span> </span>{
                    zoomlightRow.setGraphic(event.graphic);
                }

                <span class="hljs-comment">/**
                * De-activates the row stored in zoomlightRow
                *
                * @method zoomlightrowHide
                * @private
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">zoomlightrowHide</span><span class="hljs-params">()</span> </span>{
                    zoomlightRow.deactivate();
                }

                <span class="hljs-comment">/**
                * Registers event handlers for following events:
                *
                * datagrid/highlightrow-show
                * datagrid/zoomlightrow-show
                * datagrid/zoomlightrow-hide
                * @method initUIListeners
                * @private
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initUIListeners</span><span class="hljs-params">()</span> </span>{
                    topic.subscribe(EventManager.Datagrid.HIGHLIGHTROW_SHOW, highlightrowShow);

                    topic.subscribe(EventManager.Datagrid.HIGHLIGHTROW_HIDE, highlightrowHide);

                    topic.subscribe(EventManager.Datagrid.ZOOMLIGHTROW_SHOW, zoomlightrowShow);

                    topic.subscribe(EventManager.Datagrid.ZOOMLIGHTROW_HIDE, zoomlightrowHide);

                    topic.subscribe(EventManager.Datagrid.DRAW_COMPLETE, updateDatasetSelectorToLoaded);
                }
                <span class="hljs-comment">/**
                 * Updates the state of the dataset selector based on whether the dataset has been loaded and what dataset is currently selected.
                 *
                 * @method updateDatasetSelectorState
                 * @param {Boolean} state indicates if button is disabled or not; true - disabled;
                 * @param {Boolean} [loaded] indicates if the selected dataset is already loaded; it's assumed to be loading otherwise
                 */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateDatasetSelectorState</span><span class="hljs-params">(state, loaded)</span> </span>{
                    <span class="hljs-keyword">var</span> layer;
                    loaded = loaded || <span class="hljs-literal">false</span>;

                    datasetSelectorSubmitButton
                        .attr(<span class="hljs-string">"disabled"</span>, state)
                        .text(state ?
                            (loaded ?
                                i18n.t(<span class="hljs-string">"datagrid.ex.datasetSelectorButtonLoaded"</span>)
                                : i18n.t(<span class="hljs-string">"datagrid.ex.datasetSelectorButtonLoading"</span>))
                            : i18n.t(<span class="hljs-string">"datagrid.ex.datasetSelectorButtonLoad"</span>));

                    layer = dojoArray.filter(RAMP.config.layers.feature,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layer)</span> </span>{
                            <span class="hljs-keyword">return</span> layer.id === selectedDatasetId;
                        });

                    <span class="hljs-keyword">if</span> (extendedTabTitle &amp;&amp; layer.length &gt; <span class="hljs-number">0</span>) {
                        extendedTabTitle.text(<span class="hljs-string">": "</span> + layer[<span class="hljs-number">0</span>].displayName);
                    }
                }

                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateDatasetSelectorToLoaded</span><span class="hljs-params">()</span> </span>{
                    datasetSelectorSubmitButton
                        .text(i18n.t(<span class="hljs-string">"datagrid.ex.datasetSelectorButtonLoaded"</span>));
                }

                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refreshTable</span><span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">var</span> duration = <span class="hljs-number">0.2</span>,
                        tl = <span class="hljs-keyword">new</span> TimelineLite({ paused: <span class="hljs-literal">true</span> }),
                        stl = <span class="hljs-keyword">new</span> TimelineLite({ paused: <span class="hljs-literal">true</span> }),
                        newWrapper,
                        deffered = <span class="hljs-keyword">new</span> Deferred();

                    tmpl.cache = {};
                    tmpl.templates = data_grid_template_json;
                    newWrapper = tmpl(
                        <span class="hljs-string">"datagrid_manager_table_Template"</span>,
                        {
                            tableId: <span class="hljs-string">"jqgrid"</span>,
                            tableCss: <span class="hljs-string">"display table-condensed table-simplify"</span><span class="hljs-comment">// animated fadeIn"</span>
                        }
                    );

                    <span class="hljs-keyword">if</span> (highlightRow.isActive()) {
                        duration = <span class="hljs-number">0.6</span>;
                        DatagridClickHandler.onDetailDeselect(datagridMode);
                    }

                    tl.set(jqgridWrapper, { className: <span class="hljs-string">"+=animated fadeOut"</span> });

                    <span class="hljs-comment">/*jshint validthis: true */</span>
                    tl.call(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        tl.pause();

                        jqgridWrapper.replaceWith(newWrapper);
                        createDatatable();

                        updateDatasetSelectorState(<span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>continue with transition when apply filter finished</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        deffered.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>console.timeEnd(‘applyExtentFilter’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"I'm resuming"</span>);

                            stl.set(jqgridWrapper, { className: <span class="hljs-string">"-=fadedOut"</span> });
                            stl.set(jqgridWrapper, { className: <span class="hljs-string">"+=animated fadeIn"</span> });
                            stl.set(jqgridWrapper, { className: <span class="hljs-string">"-=animated fadeIn"</span> }, <span class="hljs-string">"+=1"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>stl.set(jqgridTableWrapper, { className: “-=animated fadeIn” }, “+=” + duration);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                            stl.play();</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>tl.set(jqgrid, { className: “-=animated fadeIn” }, “+=” + duration);
tl.resume();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        });</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>console.time(‘applyExtentFilter’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                        applyExtentFilter(deffered);
                    }, <span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>, duration + <span class="hljs-number">0.05</span>);

                    <span class="hljs-comment">/*tl.set(jqgridWrapper, { className: "-=fadeOut" });
                    tl.set(jqgridWrapper, { className: "+=fadeIn" });
                    tl.set(jqgridWrapper, { className: "-=animated fadeIn" }, "+=" + duration);*/</span>

                    tl.play();
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>recreates the datagrid panel with the new grid + stuff ( summary or extended )</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">refreshPanel</span><span class="hljs-params">(d)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>using template to generate global checkboxes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> globalCheckBoxesData = generateToggleButtonDataForTemplate(),
                        templateData = {
                            buttons: globalCheckBoxesData,
                            tableId: <span class="hljs-string">"jqgrid"</span>,
                            tableCss: <span class="hljs-string">"display table-condensed table-simplify"</span>
                        },
                        section,
                        templateKey,
                        duration = <span class="hljs-number">0.5</span>,
                        tl = <span class="hljs-keyword">new</span> TimelineLite({ paused: <span class="hljs-literal">true</span> }),
                        stl = <span class="hljs-keyword">new</span> TimelineLite({ paused: <span class="hljs-literal">true</span> }),
                        deffered = <span class="hljs-keyword">new</span> Deferred();

                    tmpl.cache = {};
                    tmpl.templates = data_grid_template_json;

                    <span class="hljs-keyword">if</span> (datagridMode === GRID_MODE_SUMMARY) {
                        templateKey = <span class="hljs-string">"datagrid_manager_Template"</span>;
                        templateData.buttons.toggleTitle = i18n.t(<span class="hljs-string">"datagrid.fullData"</span>);

                        <span class="hljs-keyword">if</span> (extendedTabTitle) {
                            extendedTabTitle.remove();
                        }
                    } <span class="hljs-keyword">else</span> {
                        templateKey = <span class="hljs-string">"datagrid_full_manager_Template"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>bugfix: 7047 need this to fix extended grid issue.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        selectedDatasetId = <span class="hljs-string">""</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>filter out static layers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">var</span> nonStaticFeatureLayers = dojoArray.filter(RAMP.config.layers.feature, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layerConfig)</span> </span>{
                            <span class="hljs-keyword">var</span> layer = RAMP.map.getLayer(layerConfig.id);
                            <span class="hljs-keyword">if</span> (layer) {
                                <span class="hljs-keyword">if</span> (layer.loaded) {
                                    <span class="hljs-keyword">return</span> layer.ramp.type !== GlobalStorage.layerType.Static &amp;&amp; layer.visible;
                                }
                            }
                        });

                        templateData.buttons = lang.mixin(templateData.buttons,
                            {
                                datasets: nonStaticFeatureLayers,
                                toggleTitle: i18n.t(<span class="hljs-string">"datagrid.ex.dataSummary"</span>),
                                txtDataset: i18n.t(<span class="hljs-string">"datagrid.ex.dataset"</span>)
                            }
                        );

                        extendedTabTitle = $(<span class="hljs-string">"#tabs1_2-lnk"</span>).append(<span class="hljs-string">"&lt;span&gt;"</span>).find(<span class="hljs-string">"span"</span>);
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>generate the content using rowData and given template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    section = tmpl(templateKey, templateData);

                    DatagridClickHandler.onDetailDeselect(datagridMode);

                    tl.set(sectionNode, { className: <span class="hljs-string">"+=animated fadeOut"</span> });
                    <span class="hljs-keyword">if</span> (jqgrid) {
                        tl.set(jqgrid, { clearProps: <span class="hljs-string">"width"</span> });
                    }

                    <span class="hljs-comment">/*jshint validthis: true */</span>
                    tl.call(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        tl.pause();

                        sectionNode.empty().append(section);
                        createDatatable();

                        datagridGlobalToggles = sectionNode.find(<span class="hljs-string">'#datagridGlobalToggles'</span>);

                        datagridStatusLine = sectionNode.find(<span class="hljs-string">'.status-line'</span>);
                        datasetSelector = $(<span class="hljs-string">"#datasetSelector"</span>);
                        datasetSelectorSubmitButton = $(<span class="hljs-string">"#datasetSelectorSubmitButton"</span>);
                        updateDatasetSelectorState(<span class="hljs-literal">true</span>);

                        d.resolve();

                        tl.resume();</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>continue with transition when apply filter finished</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        deffered.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>tl.call(function () { oTable.columns.adjust().draw(); console.log(“!!!”); }, null, this, “+=2”);</p>

            </div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>tl.resume();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                            stl.set(jqgridWrapper, { className: <span class="hljs-string">"-=fadedOut"</span> });
                            stl.set(jqgridWrapper, { className: <span class="hljs-string">"+=animated fadeIn"</span> });
                            stl.set(jqgridWrapper, { className: <span class="hljs-string">"-=animated fadeIn"</span> }, <span class="hljs-string">"+=1"</span>);

                            stl.play();
                        });

                        applyExtentFilter(deffered);
                    }, <span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>, duration + <span class="hljs-number">0.1</span>);

                    tl.set(sectionNode, { className: <span class="hljs-string">"-=fadeOut"</span> });
                    tl.set(sectionNode, { className: <span class="hljs-string">"+=fadeIn"</span> });
                    tl.set(sectionNode, { className: <span class="hljs-string">"-=animated fadeIn"</span> }, <span class="hljs-string">"+="</span> + duration);

                    tl.play();
                }

                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">activateRows</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>If there was previously a selected point,
navigate to the correct page and highlight it in the datagrid</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    highlightRow.refresh();
                    zoomlightRow.refresh();</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Scroll to the highlighted row first, if it fails,
scroll to the zoomed row</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (!highlightRow.navigateToRow()) {
                        zoomlightRow.navigateToRow();
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>set the focus on the first button in the datagrid
is not a really good idea to just move focus around
jqgrid.dataTable().find(“button:first”).focus();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                    zoomlightRow.activate();
                    highlightRow.activate();

                    capturePanel();
                }

                <span class="hljs-comment">/**
                * Checks if the datagrid currently visible, i.e., the data tab is selected on the side panel
                *
                * @method isVisible
                * @private
                * @return {Boolean} indicating if the datagrid is currently visible
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isVisible</span><span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">return</span> tabNode.attr(<span class="hljs-string">"aria-expanded"</span>) === <span class="hljs-string">"true"</span>;
                }

                <span class="hljs-comment">/**
                * Captures a subpanel that was opened and docked by the datagrid module previously.
                *
                * @method capturePanel
                * @param {Boolean} force if truthy - capture the panel even if the datagrid is not visible; use when switching to datagrid tab and the datagrid is not fully rendered yet by the browser
                * @private
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">capturePanel</span><span class="hljs-params">(force)</span> </span>{
                    <span class="hljs-keyword">var</span> origin = <span class="hljs-string">"datagrid"</span>,
                        target = highlightRow.getNode().find(<span class="hljs-string">".record-controls"</span>);

                    <span class="hljs-keyword">if</span> (datagridMode === GRID_MODE_FULL) {
                        origin = <span class="hljs-string">"ex-datagrid"</span>;
                        target = highlightRow.getNode().find(<span class="hljs-string">".button.details"</span>);
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>capture subpanel only if a row is active and the datagrid itself is visible
if the subpanel is captured while the datagrid is not visible, the subpanel will also disappear since it’s inserted in the datagrid structure</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (highlightRow.isActive() &amp;&amp; (isVisible() || force)) {
                        topic.publish(EventManager.GUI.SUBPANEL_CAPTURE, {
                            target: target,
                            consumeOrigin: origin,
                            origin: origin
                        });
                    }
                }

                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">adjustPanelWidth</span><span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">if</span> (datagridMode === GRID_MODE_SUMMARY) {
                        utilMisc.adjustWidthForSrollbar(jqgridTableWrapper, [datagridGlobalToggles, datagridStatusLine, datagridNotice]);
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">if</span> (jqgrid.outerWidth() === jqgridWrapper.outerWidth()) {
                            dataTablesScrollBody.addClass(<span class="hljs-string">"overflow-x-hidden"</span>);
                        } <span class="hljs-keyword">else</span> {
                            dataTablesScrollBody.removeClass(<span class="hljs-string">"overflow-x-hidden"</span>);
                        }
                    }
                }

                <span class="hljs-keyword">return</span> {
                    <span class="hljs-comment">/**
                    * The constructor method for the data grid. Adds the grid's panel to the UI, adds the data rows, and creates all event triggers
                    *
                    * @method init
                    * @constructor
                    *
                    */</span>
                    init: utilMisc.once(
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            <span class="hljs-keyword">var</span> d = <span class="hljs-keyword">new</span> Deferred();
                            d.then(
                                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                    _isReady = <span class="hljs-literal">true</span>;

                                    initTooltips();
                                    setButtonEvents();
                                    initScrollListeners();
                                    initUIListeners();
                                }
                            );

                            sectionNode = $(<span class="hljs-string">"#"</span> + RAMP.config.divNames.datagrid);
                            refreshPanel(d);
                        }
                    ),

                    getDatagridMode: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">return</span> datagridMode;
                    },

                    getSelectedDatasetId: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">if</span> (!selectedDatasetId) {
                            <span class="hljs-keyword">if</span> (datasetSelector.find(<span class="hljs-string">"option:selected"</span>).length &gt; <span class="hljs-number">0</span>) {
                                selectedDatasetId = datasetSelector.find(<span class="hljs-string">"option:selected"</span>)[<span class="hljs-number">0</span>].value;
                            } <span class="hljs-keyword">else</span> {
                                <span class="hljs-keyword">var</span> firstVisibleLayer = UtilArray.find(RAMP.config.layers.feature, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layerConfig)</span> </span>{
                                    <span class="hljs-keyword">var</span> layer = RAMP.map.getLayer(layerConfig.id);
                                    <span class="hljs-keyword">if</span> (layer) {
                                        <span class="hljs-keyword">return</span> layer.visible &amp;&amp; layer.ramp.type !== GlobalStorage.layerType.Static;
                                    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>layer failed to load.  it will not be visible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                                    }
                                });
                                selectedDatasetId = firstVisibleLayer === <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : firstVisibleLayer.id;
                            }
                        } <span class="hljs-keyword">else</span> {
                            datasetSelector.find(<span class="hljs-string">"option[value='"</span> + selectedDatasetId + <span class="hljs-string">"']"</span>).prop(<span class="hljs-string">'selected'</span>, <span class="hljs-literal">true</span>);
                        }

                        <span class="hljs-keyword">return</span> selectedDatasetId;
                    },

                    <span class="hljs-comment">/**
                    * Indicates that the Data grid is fully rendered
                    * @method isReady
                    * @return {Boolean} _isReady flag indicating the render status of the data grid
                    */</span>
                    isReady: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">return</span> _isReady;
                    },

                    <span class="hljs-comment">/**
                    * Adjusts the width of the datagrid panel to accommodate the scrollbar.
                    *
                    * @method adjustPanelWidth
                    */</span>
                    adjustPanelWidth: adjustPanelWidth,

                    activateRows: activateRows,

                    <span class="hljs-comment">/**
                    * publishes the subPanel_Capture event to the GUI class
                    * @method capturePanel
                    */</span>
                    capturePanel: capturePanel,

                    <span class="hljs-comment">/**
                    * Update the datagrid notice to show feedback to the user if any.
                    * Right now is used to display notifications about scale dependent layers that are off scale at the moment.
                    *
                    * @private
                    * @method updateNotice
                    */</span>
                    updateNotice: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">var</span> notice,
                            data = { layers: <span class="hljs-literal">null</span> },
                            invisibleLayers =
                                RampMap.getInvisibleLayers()
                                .filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(l)</span> </span>{
                                    <span class="hljs-keyword">return</span> l.ramp &amp;&amp; l.ramp.type === GlobalStorage.layerType.feature;
                                }),

                            selectedDatasetId,
                            index;

                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isReady()) {
                            tmpl.cache = {};
                            tmpl.templates = data_grid_template_json;

                            <span class="hljs-keyword">if</span> (datagridMode === GRID_MODE_FULL) {</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>check if the selected layer is off scale at the current extent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                selectedDatasetId = ui.getSelectedDatasetId();
                                index = UtilArray.indexOf(invisibleLayers, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(il)</span> </span>{
                                    <span class="hljs-keyword">return</span> il.id === selectedDatasetId;
                                });

                                <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) {
                                    notice = tmpl(<span class="hljs-string">"datagrid_full_info_notice"</span>, data);
                                }
                            } <span class="hljs-keyword">else</span> {
                                <span class="hljs-keyword">if</span> (invisibleLayers.length &gt; <span class="hljs-number">0</span>) {
                                    data.layers = invisibleLayers.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(il)</span> </span>{
                                        <span class="hljs-keyword">return</span> il.ramp.config;
                                    });</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>display notice only if invisibleLayer has eyeToggle on</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    <span class="hljs-keyword">if</span> (invisibleLayerToggleOn.length &gt; <span class="hljs-number">0</span>) {
                                        notice = tmpl(<span class="hljs-string">"datagrid_info_notice"</span>, data);
                                    }
                                }
                            }</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>if a notice was created, add it to the DOM</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">if</span> (notice) {
                                datagridNotice
                                        .empty()
                                        .append(notice);

                                sectionNode.addClass(<span class="hljs-string">"notice"</span>);
                            } <span class="hljs-keyword">else</span> {
                                datagridNotice.empty();
                                sectionNode.removeClass(<span class="hljs-string">"notice"</span>);
                            }
                        }
                    },

                    initInvisibleLayerToggleCount: utilMisc.once(
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            invisibleLayerToggleOn = RampMap.getInvisibleLayers()
                            .filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(l)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>make sure l.ramp is not undefined, and it’s a feature layer, and config.settings.visible is true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">return</span> l.ramp &amp;&amp; l.ramp.type === GlobalStorage.layerType.feature &amp;&amp; l.ramp.config.settings.visible;
                            })
                            .map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(lyr)</span> </span>{
                                <span class="hljs-keyword">return</span> lyr.ramp.config.id;
                            });
                        }
                    )
                };
            }());

        <span class="hljs-comment">/**
        * Caches the sorted data from datatables for feature click events to consume.  Builds featureToPage as a
        * mapping of (layerName,layerId) =&gt; page where layerName and layerId are strings and page is a zero based int.
        *
        * @method cacheSortedData
        * @private
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cacheSortedData</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> elements = oTable.rows().data();
            featureToPage = {};
            $.each(elements, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(idx, val)</span> </span>{
                <span class="hljs-keyword">var</span> layer = val.last().layerId,
                    fid = GraphicExtension.getOid(val.last().feature);

                <span class="hljs-keyword">if</span> (!(layer <span class="hljs-keyword">in</span> featureToPage)) {
                    featureToPage[layer] = {
                    };
                }
                featureToPage[layer][fid] = idx;
            });
        }

        <span class="hljs-comment">/**
        * A handler that handlers the Enter key press and Click mouse event of the data grid.
        * It is actually a binder that binds the key / mouse event to a handler specified.
        * This is wired up to grid cells in the bootstrapper to achieve click/keypress functions
        *
        * @method handleGridEvent
        * @private
        * @param {Event} e the event object
        * @param {Function} callback the callback function
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleGridEvent</span><span class="hljs-params">(e, callback)</span> </span>{
            <span class="hljs-keyword">if</span> ((e.type === <span class="hljs-string">"keypress"</span> &amp;&amp; e.keyCode === <span class="hljs-number">13</span>) || e.type === <span class="hljs-string">"click"</span>) {
                callback();</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Ramp.setHTML(oid); // just update info hit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            }
        }
        <span class="hljs-comment">/**
        * Gets all layer data in the current map extent that are visible, and put the data into the data grid.
        *
        * @method applyExtentFilter
        * @param {A Deferred object} d
        *
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">applyExtentFilter</span><span class="hljs-params">(d)</span> </span>{
            <span class="hljs-keyword">var</span> visibleFeatures = {},
                visibleGridLayers = RampMap.getVisibleFeatureLayers(),
                dataGridMode = ui.getDatagridMode(),
                q = <span class="hljs-keyword">new</span> EsriQuery();</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>console.time(‘applyExtentFilter:part 1’);
console.time(‘applyExtentFilter:part 1 - 1’);</p>

            </div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>filter out static layers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            visibleGridLayers = dojoArray.filter(visibleGridLayers, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layer)</span> </span>{
                <span class="hljs-keyword">return</span> layer.ramp.type !== GlobalStorage.layerType.Static;
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>console.log(‘HOGG - applying extent filter.  visible layers: ‘ + visibleGridLayers.length.toString());</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">if</span> (dataGridMode === GRID_MODE_FULL) {
                visibleGridLayers = dojoArray.filter(visibleGridLayers, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layer)</span> </span>{
                    <span class="hljs-keyword">return</span> layer.id === ui.getSelectedDatasetId();
                });

                <span class="hljs-keyword">if</span> (RAMP.config.extendedDatagridExtentFilterEnabled) {
                    q.geometry = RampMap.getMap().extent;
                } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Grab everything!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    q.geometry = RampMap.getMaxExtent();</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>q.where = “1 = 1”;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                }
            } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// Summary Mode</span>
                q.geometry = RampMap.getMap().extent;
            }

            q.outFields = [<span class="hljs-string">"*"</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>console.timeEnd(‘applyExtentFilter:part 1 - 1’);</p>

            </div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Update total records</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            totalRecords = <span class="hljs-number">0</span>;
            dojoArray.forEach(visibleGridLayers, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layer)</span> </span>{
                totalRecords += layer.graphics.length;
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>console.time(‘applyExtentFilter:part 1 - 2’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">var</span> deferredList = dojoArray.map(visibleGridLayers, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(gridLayer)</span> </span>{
                <span class="hljs-keyword">return</span> gridLayer.queryFeatures(q).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(features)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>console.timeEnd(‘applyExtentFilter:part 1 - 2’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                    <span class="hljs-keyword">if</span> (features.features.length &gt; <span class="hljs-number">0</span>) {
                        <span class="hljs-keyword">var</span> layer = features.features[<span class="hljs-number">0</span>].getLayer();
                        visibleFeatures[layer.id] = features.features;
                    }
                });
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Execute this only after all the deferred objects has resolved</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            utilMisc.afterAll(deferredList, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>console.timeEnd(‘applyExtentFilter:part 1’);</p>

            </div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>console.time(‘applyExtentFilter:part 2 - fetchRecords’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                fetchRecords(visibleFeatures);</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>console.timeEnd(‘applyExtentFilter:part 2 - fetchRecords’);
initialize invisible layer toggle count</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                ui.initInvisibleLayerToggleCount();

                ui.updateNotice();

                <span class="hljs-keyword">if</span> (d) {
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"I'm calling reserve!!!"</span>);
                    d.resolve();
                }
            });
        }

        <span class="hljs-comment">/**
        * Given a map feature, return a data object used to represent the feature in the datagrid.
        *
        * @method getDataObject
        * @private
        * @param {Object} feature the feature needs to be represented in the datagrid
        * return {Array} an array representing the data the given feature contains.
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDataObject</span><span class="hljs-params">(feature)</span> </span>{
            <span class="hljs-keyword">var</span> layerConfig = feature.getLayer().ramp.config,
                innerArray;</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>attribute = feature.attributes;</p>

            </div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Remember, case sensitivity MATTERS in the attribute name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">if</span> (ui.getDatagridMode() === GRID_MODE_SUMMARY) {
                innerArray = [feature.attributes[layerConfig.nameField]];
            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>make array containing values for each column in the full grid</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                innerArray = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>retrieve extendedGrid config object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> extendedGrid = layerConfig.datagrid.gridColumns;</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>process each column and add to row</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                dojoArray.forEach(extendedGrid, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(column)</span> </span>{
                    innerArray.push(feature.attributes[column.fieldName] || <span class="hljs-string">""</span>);
                });
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>TODO may want to move the generation of this custom object to a separate area, as this data will be useful in
    both the summary and full grid state.  Will need some thinking.</p>

            </div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Includes fields that are useful which are not derived from the config.featureSources
this should not draw, as there will be no column defined for it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            innerArray.push({
                layerId: layerConfig.id,
                layerName: layerConfig.displayName,
                feature: feature
            });

            <span class="hljs-keyword">return</span> innerArray;
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateRecordsCount</span><span class="hljs-params">(visibleRecords)</span> </span>{
            $(<span class="hljs-string">".pagination-record-number"</span>).text(<span class="hljs-built_in">String</span>.format(<span class="hljs-string">"{0} / {1}"</span>, visibleRecords, totalRecords));
        }

        <span class="hljs-comment">/**
        * Populate the datagrid with data in visibleFeatures
        *
        * @method fetchRecords
        * @param {Array} visibleFeatures a dictionary mapping
        * layer id to an array of feature objects
        * @private
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchRecords</span><span class="hljs-params">(visibleFeatures)</span> </span>{
            <span class="hljs-keyword">if</span> (jqgrid === <span class="hljs-literal">undefined</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>fetchRecords call made prior ty jqgrid creation
TODO: consider adding a log.warning(‘fetchRecords called prior to grid initialization’)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">return</span>;
            }
            jqgrid.DataTable().clear(); <span class="hljs-comment">// Do NOT redraw the datatable at this point</span>

            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Object</span>.keys(visibleFeatures).isEmpty()) {
                updateRecordsCount(<span class="hljs-number">0</span>);
                jqgrid.DataTable().draw();
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-keyword">var</span> data = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>for each feature layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            utilDict.forEachEntry(visibleFeatures, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, features)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>for each feature in a specific layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                data = data.concat(dojoArray.map(features, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(feature)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>return the appropriate data object for the feature (.map puts them in array form)</p>

            </div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>“cache” the data object so we don’t have to generate it again</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">return</span> feature[ui.getDatagridMode()] ? feature[ui.getDatagridMode()] : feature[ui.getDatagridMode()] = getDataObject(feature);
                }));
            });

            updateRecordsCount(data.length);

            oTable.one(<span class="hljs-string">"draw.dt"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                topic.publish(EventManager.Datagrid.EXTENT_FILTER_END);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>add the data to the grid</p>

            </div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>console.time(‘fetchRecords: fnAddData’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            jqgrid.dataTable().fnAddData(data);</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>console.timeEnd(‘fetchRecords: fnAddData’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"jqgrid.dataTable().fnAddData(data);"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>NOTE: fnAddData should be the last thing that happens in this function
if you want to add something after this point, use the fnDrawCallback
function in the jqgrid initialization</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        }

        <span class="hljs-comment">/**
        * Returns the graphic object of a feature layer which is contained in the given buttonNode.
        *
        * @method getGraphicFromButton
        * @private
        * @param {JObject} buttonNode   the node containing the feature layer
        * @return {Object}   the graphic object of the feature layer.
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getGraphicFromButton</span><span class="hljs-params">(buttonNode)</span> </span>{
            <span class="hljs-keyword">var</span> layerId = buttonNode.data(layerIdField),</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Need to parse the index into an integer since it
comes as a String</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                oid = <span class="hljs-built_in">parseInt</span>(buttonNode.data(featureOidField)),
                featureLayer = RampMap.getFeatureLayer(layerId),

                graphic = UtilArray.binaryFind(featureLayer.graphics,
                    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(a_graphic)</span> </span>{
                        <span class="hljs-keyword">return</span> GraphicExtension.getOid(a_graphic) - oid;
                    });

            <span class="hljs-keyword">return</span> graphic;
        }

        <span class="hljs-comment">/**
        * Binding event handling for events:
        * filterManager/layer-visibility-toggled
        * datagrid/applyExtentFilter
        *
        * @method initListeners
        * @private
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initListeners</span><span class="hljs-params">()</span> </span>{
            topic.subscribe(EventManager.FilterManager.LAYER_VISIBILITY_TOGGLED, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> </span>{
                extentFilterExpired = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>added by Jack to make sure layer visibility is added or removed from checkedLayerVisibility</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (event.id !== <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">var</span> idx = dojoArray.indexOf(invisibleLayerToggleOn, event.id);
                    <span class="hljs-keyword">if</span> (idx === -<span class="hljs-number">1</span> &amp;&amp; event.state) {</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>add</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        invisibleLayerToggleOn.push(event.id);
                    }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (idx !== -<span class="hljs-number">1</span> &amp;&amp; !event.state) {</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>remove</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        invisibleLayerToggleOn.splice(idx,<span class="hljs-number">1</span>);
                    }
                }
            });

            <span class="hljs-comment">/* UI EVENTS */</span>
            topic.subscribe(EventManager.GUI.TAB_SELECTED, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arg)</span> </span>{
                <span class="hljs-keyword">if</span> (arg.tabName === <span class="hljs-string">"datagrid"</span>) {
                    <span class="hljs-keyword">if</span> (extentFilterExpired) {
                        extentFilterExpired = <span class="hljs-literal">false</span>;
                        applyExtentFilter();
                    } <span class="hljs-keyword">else</span> {
                        ui.capturePanel(<span class="hljs-literal">true</span>);
                    }

                    ui.adjustPanelWidth();
                }
            });

            topic.subscribe(EventManager.GUI.TAB_DESELECTED, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arg)</span> </span>{
                <span class="hljs-keyword">if</span> (arg.tabName === <span class="hljs-string">"datagrid"</span>) {
                    topic.publish(EventManager.GUI.SUBPANEL_DOCK, {
                        origin: <span class="hljs-string">"datagrid"</span>
                    });
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"subPanleDock"</span>);
                }
            });

            topic.subscribe(EventManager.Datagrid.APPLY_EXTENT_FILTER, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">if</span> (ui.getDatagridMode() !== GRID_MODE_FULL) {
                    applyExtentFilter();
                }
            });

            topic.subscribe(EventManager.LayerLoader.LAYER_UPDATED, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(evt)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>layer has updated its data.  if it has grid-worthy data, refresh the grid</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (evt.layer.ramp.type === GlobalStorage.layerType.feature) {
                    <span class="hljs-keyword">if</span> (ui.getDatagridMode() !== GRID_MODE_FULL) {</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>console.log(‘HOGG - layer loaded event’);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        applyExtentFilter();
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>this is causing more trouble than it is worth.  if a user opens big grid before a layer is loaded, they wont be
expecting to look at it anyways.   If it finishes loading when the big grid is open, user will be unaware because
everything else is hidden.  A loaded layer will appear the next time the grid opens.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-comment">/*else {
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>in this case, a slow loading layer updated after the user has switched to the extended grid view.
add layer to selection combo box (as it would not have been added when the pane was generated)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        var layerConfig = Ramp.getLayerConfigWithId(evt.layer.id),
                            optElem = document.createElement("option"),  // "&lt;option value='" + layerConfig.id + "'&gt;" + layerConfig.displayName + "&lt;/option&gt;",
                            datasetSelector = $("#datasetSelector");

                        optElem.text = layerConfig.displayName;
                        optElem.value = layerConfig.id;
                        datasetSelector.add(optElem);
                    }*/
                }
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>update notice after zoom end event since some of the scale-dependent layers might end up off scale</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            topic.subscribe(EventManager.Map.ZOOM_END, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                ui.updateNotice();
            });

            topic.subscribe(EventManager.GUI.SUBPANEL_CHANGE, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(evt)</span> </span>{
                <span class="hljs-keyword">if</span> (evt.origin === <span class="hljs-string">"ex-datagrid"</span> &amp;&amp;
                    evt.isComplete) {
                    ui.adjustPanelWidth();
                }
            });
        }

        <span class="hljs-keyword">return</span> {
            <span class="hljs-comment">/**
            * Initialize the datagrid. must be called before any properties can be accessed.
            *
            * @method init
            */</span>
            init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Added to make sure the layer is not static</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> layerConfigs = dojoArray.filter(RAMP.config.layers.feature, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layerConfig)</span> </span>{
                    <span class="hljs-keyword">return</span> !layerConfig.isStatic;
                });

                <span class="hljs-keyword">if</span> (layerConfigs.length !== <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>layerConfig = config.featureLayers;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    gridConfig = layerConfigs[<span class="hljs-number">0</span>].datagrid;  <span class="hljs-comment">//this is just to configure the structure of the grid.  since all layers have same structure, just pick first one</span>

                    <span class="hljs-comment">/*
                    $.fn.dataTable.ext.search.push(
                        function (settings, data, dataIndex) {
                            return data[0].indexOf("Water Regions") &gt; -1;
                        }
                    );*/</span>

                    initListeners();

                    ui.init();
                }
            } <span class="hljs-comment">//InitDataGrid</span>
        };
    });</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
