<!DOCTYPE html>

<html>
<head>
  <title>filterManager.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="advancedToolbar.html">
                advancedToolbar.js
              </a>
            
              
              <a class="source" href="basemapSelector.html">
                basemapSelector.js
              </a>
            
              
              <a class="source" href="bookmarkLink.html">
                bookmarkLink.js
              </a>
            
              
              <a class="source" href="dataLoader.html">
                dataLoader.js
              </a>
            
              
              <a class="source" href="dataLoaderGui.html">
                dataLoaderGui.js
              </a>
            
              
              <a class="source" href="datagrid.html">
                datagrid.js
              </a>
            
              
              <a class="source" href="datagridClickHandler.html">
                datagridClickHandler.js
              </a>
            
              
              <a class="source" href="eventManager.html">
                eventManager.js
              </a>
            
              
              <a class="source" href="featureClickHandler.html">
                featureClickHandler.js
              </a>
            
              
              <a class="source" href="featureHighlighter.html">
                featureHighlighter.js
              </a>
            
              
              <a class="source" href="filterManager.html">
                filterManager.js
              </a>
            
              
              <a class="source" href="geoSearch.html">
                geoSearch.js
              </a>
            
              
              <a class="source" href="globalStorage.html">
                globalStorage.js
              </a>
            
              
              <a class="source" href="graphicExtension.html">
                graphicExtension.js
              </a>
            
              
              <a class="source" href="gui.html">
                gui.js
              </a>
            
              
              <a class="source" href="imageExport.html">
                imageExport.js
              </a>
            
              
              <a class="source" href="layerGroup.html">
                layerGroup.js
              </a>
            
              
              <a class="source" href="layerItem.html">
                layerItem.js
              </a>
            
              
              <a class="source" href="layerLoader.html">
                layerLoader.js
              </a>
            
              
              <a class="source" href="map.html">
                map.js
              </a>
            
              
              <a class="source" href="mapClickHandler.html">
                mapClickHandler.js
              </a>
            
              
              <a class="source" href="maptips.html">
                maptips.js
              </a>
            
              
              <a class="source" href="navigation.html">
                navigation.js
              </a>
            
              
              <a class="source" href="quickzoom.html">
                quickzoom.js
              </a>
            
              
              <a class="source" href="ramp.html">
                ramp.js
              </a>
            
              
              <a class="source" href="stepItem.html">
                stepItem.js
              </a>
            
              
              <a class="source" href="theme.html">
                theme.js
              </a>
            
              
              <a class="source" href="RAMP-starter.html">
                RAMP-starter.js
              </a>
            
              
              <a class="source" href="areaTool.html">
                areaTool.js
              </a>
            
              
              <a class="source" href="baseTool.html">
                baseTool.js
              </a>
            
              
              <a class="source" href="bufferTool.html">
                bufferTool.js
              </a>
            
              
              <a class="source" href="distanceTool.html">
                distanceTool.js
              </a>
            
              
              <a class="source" href="populationTool.html">
                populationTool.js
              </a>
            
              
              <a class="source" href="array.html">
                array.js
              </a>
            
              
              <a class="source" href="bricks.html">
                bricks.js
              </a>
            
              
              <a class="source" href="checkbox.html">
                checkbox.js
              </a>
            
              
              <a class="source" href="checkboxGroup.html">
                checkboxGroup.js
              </a>
            
              
              <a class="source" href="decorator.html">
                decorator.js
              </a>
            
              
              <a class="source" href="dictionary.html">
                dictionary.js
              </a>
            
              
              <a class="source" href="functionMangler.html">
                functionMangler.js
              </a>
            
              
              <a class="source" href="popupManager.html">
                popupManager.js
              </a>
            
              
              <a class="source" href="prototype.html">
                prototype.js
              </a>
            
              
              <a class="source" href="tmplHelper.html">
                tmplHelper.js
              </a>
            
              
              <a class="source" href="tmplUtil.html">
                tmplUtil.js
              </a>
            
              
              <a class="source" href="url.html">
                url.js
              </a>
            
              
              <a class="source" href="util.html">
                util.js
              </a>
            
              
              <a class="source" href="bootstrapper.html">
                bootstrapper.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>filterManager.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>ï»¿<span class="hljs-comment">/*global define, tmpl, i18n, console, $, RAMP */</span>

<span class="hljs-comment">/**
* FilterManager submodule
*
* @module RAMP
* @submodule FilterManager
* @main FilterManager
*/</span>

<span class="hljs-comment">/**
* FilterManager class. Represents the legend next to the map and the controls to toggle each map layer's visibility and boundary box.
* The FilterManager also includes a attribute filter that allows the user to hide map features based on a attribute values
*
* For a doc with diagrams on how this class works, please see
* http://ecollab.ncr.int.ec.gc.ca/projects/science-apps/priv/RAMP/RAMP%20AMD%20Filter%20Module.docx
*
* ####Imports RAMP Modules:
* {{#crossLink "RAMP"}}{{/crossLink}}  
* {{#crossLink "GlobalStorage"}}{{/crossLink}}  
* {{#crossLink "Map"}}{{/crossLink}}  
* {{#crossLink "EventManager"}}{{/crossLink}}  
* {{#crossLink "LayerItem"}}{{/crossLink}}  
* {{#crossLink "LayerGroup"}}{{/crossLink}}  
* {{#crossLink "Theme"}}{{/crossLink}}  
* {{#crossLink "TmplHelper"}}{{/crossLink}}  
* {{#crossLink "Util"}}{{/crossLink}}  
* {{#crossLink "Dictionary"}}{{/crossLink}}  
* {{#crossLink "PopupManager"}}{{/crossLink}}  
* {{#crossLink "Checkbox"}}{{/crossLink}}  
* {{#crossLink "CheckboxGroup"}}{{/crossLink}}  
* 
* ####Uses RAMP Templates:
* {{#crossLink "templates/filter_manager_template.json"}}{{/crossLink}}
* {{#crossLink "templates/filter_wms_meta_Template.json"}}{{/crossLink}}
* 
* @class FilterManager
* @static
* @uses dojo/_base/array
* @uses dojo/Deferred
* @uses dojo/topic
* @uses esri/tasks/query
*/</span>

define([
<span class="hljs-comment">/* Dojo */</span>
        <span class="hljs-string">"dojo/_base/lang"</span>, <span class="hljs-string">"dojo/_base/array"</span>, <span class="hljs-string">"dojo/Deferred"</span>, <span class="hljs-string">"dojo/topic"</span>,
<span class="hljs-comment">/* Text */</span>
        <span class="hljs-string">"dojo/text!./templates/filter_manager_template.json"</span>,
        <span class="hljs-string">"dojo/text!./templates/filter_wms_meta_Template.json"</span>,

<span class="hljs-comment">/* Esri */</span>
        <span class="hljs-string">"esri/tasks/query"</span>,

<span class="hljs-comment">/* Ramp */</span>
        <span class="hljs-string">"ramp/ramp"</span>, <span class="hljs-string">"ramp/globalStorage"</span>, <span class="hljs-string">"ramp/map"</span>, <span class="hljs-string">"ramp/eventManager"</span>, <span class="hljs-string">"ramp/theme"</span>, <span class="hljs-string">"ramp/layerGroup"</span>, <span class="hljs-string">"ramp/layerItem"</span>,

<span class="hljs-comment">/* Util */</span>
        <span class="hljs-string">"utils/tmplHelper"</span>, <span class="hljs-string">"utils/util"</span>, <span class="hljs-string">"utils/dictionary"</span>, <span class="hljs-string">"utils/popupManager"</span>, <span class="hljs-string">"utils/checkbox"</span>, <span class="hljs-string">"utils/checkboxGroup"</span>],

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(
    <span class="hljs-comment">/* Dojo */</span>
        lang, dojoArray, Deferred, topic,
    <span class="hljs-comment">/* Text */</span>
        filter_manager_template_json,
        filter_wms_meta_Template,

    <span class="hljs-comment">/* Esri */</span>
        EsriQuery,

    <span class="hljs-comment">/* Ramp */</span>
        Ramp, GlobalStorage, RampMap, EventManager, Theme, LayerGroup, LayerItem,

    <span class="hljs-comment">/* Util */</span>
        TmplHelper, UtilMisc, UtilDict, PopupManager, Checkbox, CheckboxGroup)</span> </span>{
<span class="hljs-pi">        "use strict"</span>;

        <span class="hljs-keyword">var</span> config,
            layerIdField = <span class="hljs-string">"layer-id"</span>,

            layerGroups = {},

            ui = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                <span class="hljs-keyword">var</span> sectionNode,
                    mainList,
                    layerList,

                    layerSettings,
                    layerToggles,
                    layerSort,
                    layerTooltips;

                layerSettings = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">var</span> transparencySliders;

                    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initTransparencySliders</span><span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>initializes all sliders in the layer list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        transparencySliders = layerList.find(<span class="hljs-string">".nstSlider._slider"</span>)
                            .removeClass(<span class="hljs-string">"_slider"</span>)
                            .nstSlider({
                                left_grip_selector: <span class="hljs-string">".leftGrip"</span>,
                                rounding: <span class="hljs-number">0.01</span>,
                                highlight: {
                                    grip_class: <span class="hljs-string">"gripHighlighted"</span>,
                                    panel_selector: <span class="hljs-string">".highlightPanel"</span>
                                },
                                value_changed_callback: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cause, leftValue)</span> </span>{ <span class="hljs-comment">//, rightValue, prevMin, prevMax) {</span>
                                    <span class="hljs-keyword">var</span> slider = $(<span class="hljs-keyword">this</span>),
                                        sliderId = slider.data(layerIdField),
                                        leftValueFormatted = <span class="hljs-built_in">Math</span>.round(leftValue * <span class="hljs-number">100</span>) + <span class="hljs-string">"%"</span>,
                                        newState;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>update the slider label and highlight range</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    slider
                                        .parent().find(<span class="hljs-string">'.leftLabel'</span>).text(leftValueFormatted).end().end()
                                        .nstSlider(<span class="hljs-string">'highlight_range'</span>, <span class="hljs-number">0</span>, leftValue);

                                    topic.publish(EventManager.FilterManager.LAYER_TRANSPARENCY_CHANGED, {
                                        layerId: sliderId,
                                        value: leftValue
                                    });</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Setting Opacity to 0.0, sets layer to invisible
Setting Opacity to &gt;0.0, sets layer to visible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    newState = leftValue === <span class="hljs-number">0</span> ? <span class="hljs-literal">false</span> : slider.hasClass(<span class="hljs-string">"disabled"</span>) ? <span class="hljs-literal">true</span> : newState;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>TODO: refactor; this is a bit unclear
fire event only if newState is false or true; do nothing if undefined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> newState !== <span class="hljs-string">'undefined'</span> &amp;&amp; cause &amp;&amp; cause !== <span class="hljs-string">"refresh"</span>) {
                                        topic.publish(EventManager.FilterManager.TOGGLE_LAYER_VISIBILITY, {
                                            state: newState,
                                            layerId: sliderId
                                        });
                                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>console.log(cause, leftValue, rightValue, prevMin, prevMax);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                }
                            });</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>.nstSlider(âset_step_histogramâ, [4, 6, 10, 107]);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    }

                    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initListeners</span><span class="hljs-params">()</span> </span>{
                        topic.subscribe(EventManager.FilterManager.LAYER_VISIBILITY_TOGGLED, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(evt)</span> </span>{
                            <span class="hljs-keyword">var</span> slider = layerList.find(<span class="hljs-string">".nstSlider"</span>).filter(<span class="hljs-string">"[data-layer-id='"</span> + evt.id + <span class="hljs-string">"']"</span>),
                                value;

                            <span class="hljs-keyword">if</span> (slider.length &gt; <span class="hljs-number">0</span>) {
                                slider.toggleClass(<span class="hljs-string">"disabled"</span>, !evt.state);
                                value = slider.nstSlider(<span class="hljs-string">"get_current_min_value"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Toggling layer to Visible when Opacity is 0.0, sets Opacity to 1.0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">if</span> (value === <span class="hljs-number">0</span> &amp;&amp; evt.state) {
                                    slider.nstSlider(<span class="hljs-string">"set_position"</span>, <span class="hljs-number">1</span>);
                                }
                            }
                        });
                    }

                    <span class="hljs-keyword">return</span> {
                        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            initTransparencySliders();

                            initListeners();
                        },

                        update: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            initTransparencySliders();
                        }
                    };
                }());

                layerToggles = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">var</span> globalToggleSection,
                        boxCheckboxGroup,
                        eyeCheckboxGroup;

                    <span class="hljs-comment">/**
                    * Sets UI status of a layer presentation (checkbox and eye) according to the user action: select / de-select a layer.
                    * publishes event "filterManager/box-visibility-toggled" every time a layer status changed.
                    * There should only be one eye and one global checkbox, but
                    * we say checkbox"es" because jquery returns a list and it's
                    * easier to write a function that takes a list of checkboxes
                    * than to write two functions, one to take a list and one to
                    * take an individual checkbox
                    * 
                    * @method createGroups
                    * @private
                    */</span>
                    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createGroups</span><span class="hljs-params">()</span> </span>{
                        boxCheckboxGroup = <span class="hljs-keyword">new</span> CheckboxGroup(
                            mainList.find(<span class="hljs-string">".checkbox-custom .box + input"</span>),
                            {
                                nodeIdAttr: layerIdField,

                                label: {
                                    check: i18n.t(<span class="hljs-string">'filterManager.hideBounds'</span>),
                                    uncheck: i18n.t(<span class="hljs-string">'filterManager.showBounds'</span>)
                                },

                                onChange: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                    Theme.tooltipster(<span class="hljs-keyword">this</span>.labelNode.parent(), <span class="hljs-literal">null</span>, <span class="hljs-string">"update"</span>);
                                },

                                master: {
                                    node: globalToggleSection.find(<span class="hljs-string">".checkbox-custom .box + input"</span>),

                                    nodeIdAttr: <span class="hljs-string">"id"</span>,

                                    label: {
                                        check: i18n.t(<span class="hljs-string">'filterManager.hideAllBounds'</span>),
                                        uncheck: i18n.t(<span class="hljs-string">'filterManager.showAllBounds'</span>)
                                    }
                                }
                            });

                        boxCheckboxGroup.on(CheckboxGroup.event.MEMBER_TOGGLE, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(evt)</span> </span>{
                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Filter Manager -&gt; Checkbox"</span>, evt.checkbox.id, <span class="hljs-string">"set by"</span>, evt.agency, <span class="hljs-string">"to"</span>, evt.checkbox.state);

                            topic.publish(EventManager.FilterManager.BOX_VISIBILITY_TOGGLED, {
                                id: evt.checkbox.id,
                                state: evt.checkbox.state
                            });
                        });

                        boxCheckboxGroup.on(CheckboxGroup.event.MASTER_TOGGLE, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(evt)</span> </span>{
                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Filter Manager -&gt; Master Checkbox"</span>, evt.checkbox.id, <span class="hljs-string">"set by"</span>, evt.agency, <span class="hljs-string">"to"</span>, evt.checkbox.state);
                        });

                        eyeCheckboxGroup = <span class="hljs-keyword">new</span> CheckboxGroup(
                            mainList.find(<span class="hljs-string">".checkbox-custom .eye + input"</span>),
                            {
                                nodeIdAttr: layerIdField,

                                label: {
                                    check: i18n.t(<span class="hljs-string">'filterManager.hideFeatures'</span>),
                                    uncheck: i18n.t(<span class="hljs-string">'filterManager.showFeatures'</span>)
                                },

                                onChange: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                    Theme.tooltipster(<span class="hljs-keyword">this</span>.labelNode.parent(), <span class="hljs-literal">null</span>, <span class="hljs-string">"update"</span>);
                                },

                                master: {
                                    node: globalToggleSection.find(<span class="hljs-string">".checkbox-custom .eye + input"</span>),

                                    nodeIdAttr: <span class="hljs-string">"id"</span>,

                                    label: {
                                        check: i18n.t(<span class="hljs-string">'filterManager.hideAllFeatures'</span>),
                                        uncheck: i18n.t(<span class="hljs-string">'filterManager.showAllFeatures'</span>)
                                    }
                                }
                            });

                        eyeCheckboxGroup.on(CheckboxGroup.event.MEMBER_TOGGLE, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(evt)</span> </span>{
                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Filter Manager -&gt; Checkbox"</span>, evt.checkbox.id, <span class="hljs-string">"set by"</span>, evt.agency, <span class="hljs-string">"to"</span>, evt.checkbox.state);

                            topic.publish(EventManager.FilterManager.LAYER_VISIBILITY_TOGGLED, {
                                id: evt.checkbox.id,
                                state: evt.checkbox.state
                            });
                        });

                        eyeCheckboxGroup.on(CheckboxGroup.event.MASTER_TOGGLE, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(evt)</span> </span>{
                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Filter Manager -&gt; Master Checkbox"</span>, evt.checkbox.id, <span class="hljs-string">"set by"</span>, evt.agency, <span class="hljs-string">"to"</span>, evt.checkbox.state);
                        });
                    }

                    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initListeners</span><span class="hljs-params">()</span> </span>{
                        topic.subscribe(EventManager.FilterManager.TOGGLE_BOX_VISIBILITY, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(evt)</span> </span>{
                            boxCheckboxGroup.setState(evt.state, evt.layerId);
                        });

                        topic.subscribe(EventManager.FilterManager.TOGGLE_LAYER_VISIBILITY, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(evt)</span> </span>{
                            eyeCheckboxGroup.setState(evt.state, evt.layerId);
                        });
                    }

                    <span class="hljs-keyword">return</span> {
                        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            globalToggleSection = sectionNode.find(<span class="hljs-string">"#filterGlobalToggles"</span>);
                            Theme.tooltipster(mainList);

                            createGroups();
                            initListeners();
                        },

                        update: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            Theme.tooltipster(mainList);

                            boxCheckboxGroup.addCheckbox(mainList.find(<span class="hljs-string">".checkbox-custom .box + input"</span>));
                            eyeCheckboxGroup.addCheckbox(mainList.find(<span class="hljs-string">".checkbox-custom .eye + input"</span>));
                        },

                        globalToggleSection: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            <span class="hljs-keyword">return</span> globalToggleSection;
                        }
                    };
                }());

                layerSort = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">var</span> sortableHandle,

                        layerGroupSeparator,
                        reorderLists,

                        onUpdate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event, ui)</span> </span>{
                            <span class="hljs-keyword">var</span> layerId = ui.item[<span class="hljs-number">0</span>].id,
                                idArray = layerList
                                    .map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(i, elm)</span> </span>{ <span class="hljs-keyword">return</span> $(elm).find(<span class="hljs-string">"&gt; li"</span>).toArray().reverse(); }) <span class="hljs-comment">// for each layer list, find its items and reverse their order</span>
                                    .map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(i, elm)</span> </span>{ <span class="hljs-keyword">return</span> elm.id; }), <span class="hljs-comment">// get ids</span>
                                cleanIdArray = idArray.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(i, elm)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>check if layer is in error state.  error layers should not be part of the count</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    <span class="hljs-keyword">return</span> (getLayerItem(elm).state !== LayerItem.state.ERROR);
                                }),
                                index = dojoArray.indexOf(cleanIdArray, layerId);

                            <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span>) {
                                <span class="hljs-keyword">return</span>;
                            }

                            topic.publish(EventManager.GUI.SUBPANEL_CLOSE, {
                                origin: <span class="hljs-string">"rampPopup,datagrid"</span>
                            });

                            topic.publish(EventManager.FilterManager.SELECTION_CHANGED, {
                                id: layerId,
                                index: index
                            });

                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Layer"</span>, layerId, <span class="hljs-string">"moved -&gt;"</span>, index);
                        },

                        onStop = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            layerList
                                .removeClass(<span class="hljs-string">"sort-active"</span>)
                                .removeClass(<span class="hljs-string">"sort-disabled"</span>);

                            layerGroupSeparator.removeClass(<span class="hljs-string">"active"</span>);

                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Layer Reordering complete."</span>);
                        },

                        onStart = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event, ui)</span> </span>{
                            layerList
                                .has(ui.item).addClass(<span class="hljs-string">"sort-active"</span>)
                                .end().filter(<span class="hljs-string">":not(.sort-active)"</span>).addClass(<span class="hljs-string">"sort-disabled"</span>);
                            ui.item.removeClass(<span class="hljs-string">"bg-very-light"</span>);

                            layerGroupSeparator.addClass(<span class="hljs-string">"active"</span>);

                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Layer Reordering starts."</span>);
                        };

                    <span class="hljs-keyword">return</span> {
                        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        },

                        <span class="hljs-comment">/**
                        * Sets all the events to handle layer reordering with both mouse and keyboard.
                        * @method setLayerReorderingEvents
                        * @private
                        */</span>
                        update: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                            layerGroupSeparator = layerList.parent().find(<span class="hljs-string">".layer-group-separator"</span>);
                            reorderLists = layerList.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(i, elm)</span> </span>{ <span class="hljs-keyword">return</span> $(elm).find(<span class="hljs-string">"&gt; li"</span>).length &gt; <span class="hljs-number">1</span>; });

                            <span class="hljs-keyword">if</span> (sortableHandle) {
                                sortableHandle.sortable(<span class="hljs-string">"destroy"</span>);
                            }

                            sortableHandle = reorderLists
                                .sortable({
                                    axis: <span class="hljs-string">"y"</span>,
                                    handle: <span class="hljs-string">".sort-handle"</span>,
                                    placeholder: <span class="hljs-string">"sortable-placeholder"</span>,
                                    update: onUpdate,
                                    stop: onStop,
                                    start: onStart
                                });

                            UtilMisc.keyboardSortable(reorderLists, {
                                linkLists: <span class="hljs-literal">true</span>,
                                onUpdate: onUpdate,
                                onStart: onStart,
                                onStop: onStop
                            });
                        }
                    };
                }());

                layerTooltips = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">return</span> {
                        <span class="hljs-comment">/**
                        * initialize a tooltip for each layer, using the layer name.
                        * @method initTooltips
                        * @private
                        */</span>
                        init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Theme.tooltipster(_filterGlobalToggles_to_remove);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            Theme.tooltipster(mainList);

                            PopupManager.registerPopup(mainList, <span class="hljs-string">"hoverIntent"</span>,
                                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.target.attr(<span class="hljs-string">"title"</span>)) {
                                        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.target.isOverflowed()) {
                                            <span class="hljs-keyword">this</span>.target.tooltipster({ theme: <span class="hljs-string">'.tooltipster-dark'</span> }).tooltipster(<span class="hljs-string">"show"</span>);
                                        } <span class="hljs-keyword">else</span> {
                                            <span class="hljs-keyword">this</span>.target.removeAttr(<span class="hljs-string">"title"</span>);
                                        }
                                    }
                                },
                                {
                                    handleSelector: <span class="hljs-string">".layer-name span, .layer-details span"</span>,
                                    useAria: <span class="hljs-literal">false</span>,
                                    timeout: <span class="hljs-number">500</span>
                                }
                            );
                        }
                    };
                }());

                <span class="hljs-comment">/**
                * Changes the width of the layers pane to accommodate for the scrollbar if it's needed.
                *
                * @method adjustPaneWidth
                * @private
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">adjustPaneWidth</span><span class="hljs-params">()</span> </span>{
                    UtilMisc.adjustWidthForSrollbar($(<span class="hljs-string">"#layerList"</span>), [layerToggles.globalToggleSection()]);
                }

                <span class="hljs-comment">/**
                * Sets event handlers for various controls that may be present in the layer items. All event handlers are set on the main list container and are independed of the individual layer items.
                *
                * @method setButtonEvents
                * @private
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setButtonEvents</span><span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">var</span> metadataPopup;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>highlight layer item on hover/focus with a light gray background</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    PopupManager.registerPopup(mainList, <span class="hljs-string">"hover, focus"</span>,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                            d.resolve();
                        },
                        {
                            handleSelector: <span class="hljs-string">"li.layerList1:not(.list-item-grabbed):not(.ui-sortable-helper)"</span>,
                            targetSelector: <span class="hljs-string">":tabbable"</span>,
                            activeClass: <span class="hljs-string">"bg-very-light"</span>,
                            useAria: <span class="hljs-literal">false</span>
                        }
                    );</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>open the settings panel when the settings control is clicked; visibility slider is refreshed;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    PopupManager.registerPopup(mainList, <span class="hljs-string">"click"</span>,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                            <span class="hljs-keyword">this</span>.target.slideToggle(<span class="hljs-string">"fast"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                adjustPaneWidth();
                                d.resolve();
                            });
                            <span class="hljs-keyword">this</span>.target.find(<span class="hljs-string">".nstSlider"</span>).nstSlider(<span class="hljs-string">"refresh"</span>);
                        },
                        {
                            handleSelector: <span class="hljs-string">".settings-button"</span>,
                            containerSelector: <span class="hljs-string">"li.layerList1"</span>,
                            targetSelector: <span class="hljs-string">".filter-row-settings"</span>,
                            activeClass: <span class="hljs-string">"button-pressed"</span>
                        }
                    );</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>open renderers sections when the renderer button (layer icon) is clicked;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    PopupManager.registerPopup(mainList, <span class="hljs-string">"click"</span>,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                            <span class="hljs-keyword">var</span> newTooltip = <span class="hljs-keyword">this</span>.isOpen() ? i18n.t(<span class="hljs-string">'filterManager.showLegend'</span>) : i18n.t(<span class="hljs-string">'filterManager.hideLegend'</span>),
                                that = <span class="hljs-keyword">this</span>;

                            <span class="hljs-keyword">this</span>.target.slideToggle(<span class="hljs-string">"fast"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                adjustPaneWidth();

                                that.handle
                                    .prop(<span class="hljs-string">"title"</span>, newTooltip)
                                    .find(<span class="hljs-string">"&gt; .wb-invisible"</span>)
                                    .text(newTooltip);

                                Theme.tooltipster(that.handle.parent(), <span class="hljs-literal">null</span>, <span class="hljs-string">"update"</span>);

                                d.resolve();
                            });
                        },
                        {
                            handleSelector: <span class="hljs-string">".renderer-button"</span>,
                            containerSelector: <span class="hljs-string">"li.layerList1"</span>,
                            targetSelector: <span class="hljs-string">".renderer-list"</span>,
                            activeClass: <span class="hljs-string">"button-pressed"</span>
                        }
                    );</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>display metadata when the metadata button is clicked;
TODO: move to a separate/different module?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    metadataPopup = PopupManager.registerPopup(mainList, <span class="hljs-string">"click"</span>,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>close the popup, this will update aria tags;
the metadata panel will be closed by metadataClickHandler if needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">if</span> (metadataPopup.isOpen(<span class="hljs-literal">null</span>, <span class="hljs-string">"any"</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>need to reject the open promise since we are actually closing the popup</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                d.reject();
                                metadataPopup.close();

                                metadataClickHandler(<span class="hljs-keyword">this</span>.target);
                            } <span class="hljs-keyword">else</span> {
                                metadataClickHandler(<span class="hljs-keyword">this</span>.target);

                                d.resolve();
                            }
                        },
                        {
                            closeHandler: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                                d.resolve();
                            },
                            handleSelector: <span class="hljs-string">".metadata-button"</span>,
                            openOnly: <span class="hljs-literal">true</span>,
                            activeClass: <span class="hljs-string">"button-pressed"</span>
                        }
                    );</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>reload layer when reload button is clicked;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    PopupManager.registerPopup(mainList, <span class="hljs-string">"click"</span>,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>call reload thing here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">var</span> id = $(<span class="hljs-keyword">this</span>.target).data(<span class="hljs-string">"layer-id"</span>);
                            topic.publish(EventManager.LayerLoader.RELOAD_LAYER, { layerId: id });
                            d.resolve();
                        },
                        {
                            handleSelector: <span class="hljs-string">".reload-button"</span>
                        }
                    );</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>remove layer when remove button is clicked;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    PopupManager.registerPopup(mainList, <span class="hljs-string">"click"</span>,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                            <span class="hljs-keyword">var</span> id = $(<span class="hljs-keyword">this</span>.target).data(<span class="hljs-string">"layer-id"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>call remove thing here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            topic.publish(EventManager.LayerLoader.REMOVE_LAYER, { layerId: id });
                            d.resolve();
                        },
                        {
                            handleSelector: <span class="hljs-string">".remove-button"</span>
                        }
                    );

                    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">metadataClickHandler</span><span class="hljs-params">(target)</span> </span>{
                        <span class="hljs-keyword">var</span> button = $(target),
                            node = button.parents(<span class="hljs-string">"legend"</span>);

                        <span class="hljs-keyword">if</span> (!node.hasClass(<span class="hljs-string">"selected-row"</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>var guid = $(this).data(âguidâ) || $(this).data(âguidâ, UtilMisc.guid()).data(âguidâ);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">var</span> id = button.data(<span class="hljs-string">"layer-id"</span>),
                                layerConfig = Ramp.getLayerConfigWithId(id),
                                metadataUrl;

                            topic.publish(EventManager.GUI.SUBPANEL_OPEN, {
                                panelName: i18n.t(<span class="hljs-string">'filterManager.metadata'</span>),
                                title: node.find(<span class="hljs-string">".layer-name span"</span>).text(), <span class="hljs-comment">// + " " + guid,</span>
                                content: <span class="hljs-literal">null</span>,
                                target: node.find(<span class="hljs-string">".layer-details"</span>),
                                origin: <span class="hljs-string">"filterManager"</span>,
                                guid: id,
                                doOnOpen: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                    node.addClass(<span class="hljs-string">"selected-row"</span>);
                                },
                                doOnHide: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>button.removeClass(âbutton-pressedâ);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                    <span class="hljs-keyword">if</span> (metadataPopup.isOpen(<span class="hljs-literal">null</span>, <span class="hljs-string">"any"</span>)) {
                                        metadataPopup.close();
                                    }
                                    node.removeClass(<span class="hljs-string">"selected-row"</span>);
                                }
                            });</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>only wms layers have this value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">if</span> (layerConfig.layerInfo) {
                                <span class="hljs-keyword">if</span> (layerConfig.legend) {
                                    <span class="hljs-keyword">var</span> wmsmeta;

                                    tmpl.cache = {};
                                    tmpl.templates = <span class="hljs-built_in">JSON</span>.parse(TmplHelper.stringifyTemplate(filter_wms_meta_Template));

                                    wmsmeta = tmpl(<span class="hljs-string">"wms_meta_main"</span>,
                                        {
                                            legendUrl: layerConfig.legend.imageUrl,
                                            getCapabilitiesUrl: layerConfig.url + <span class="hljs-string">"&amp;request=GetCapabilities"</span>
                                        }
                                    );

                                    topic.publish(EventManager.GUI.SUBPANEL_OPEN, {
                                        content: $(wmsmeta),
                                        origin: <span class="hljs-string">"filterManager"</span>,
                                        update: <span class="hljs-literal">true</span>,
                                        guid: id
                                    });
                                } <span class="hljs-keyword">else</span> {
                                    topic.publish(EventManager.GUI.SUBPANEL_OPEN, {
                                        content: <span class="hljs-string">"&lt;p&gt;"</span> + i18n.t(<span class="hljs-string">'filterManager.metadataNotFound'</span>) + <span class="hljs-string">"&lt;/p&gt;"</span>,
                                        origin: <span class="hljs-string">"filterManager"</span>,
                                        update: <span class="hljs-literal">true</span>,
                                        guid: id
                                    });
                                }
                            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>for feature layer
metadataUrl =String.format(â<a href="http://intranet.ecdmp-dev.cmc.ec.gc.ca/geonetwork/srv/eng/csw?service=CSW&amp;version=2.0.2&amp;request=GetRecordById&amp;outputSchema=csw:IsoRecord&amp;id={0}">http://intranet.ecdmp-dev.cmc.ec.gc.ca/geonetwork/srv/eng/csw?service=CSW&amp;version=2.0.2&amp;request=GetRecordById&amp;outputSchema=csw:IsoRecord&amp;id={0}</a>â, guid);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">var</span> metadataError = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                                    topic.publish(EventManager.GUI.SUBPANEL_OPEN, {
                                        content: <span class="hljs-string">"&lt;p&gt;"</span> + i18n.t(<span class="hljs-string">'filterManager.metadataNotFound'</span>) + <span class="hljs-string">"&lt;/p&gt;"</span>,
                                        origin: <span class="hljs-string">"filterManager"</span>,
                                        update: <span class="hljs-literal">true</span>,
                                        guid: id
                                    });
                                };

                                metadataUrl = layerConfig.metadataUrl;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>set it to null when layerConfig.catalogueUrl does not exist
instead of key with empty value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">var</span> params = <span class="hljs-literal">null</span>;
                                <span class="hljs-keyword">if</span> (layerConfig.catalogueUrl) {
                                    params = [{ key: <span class="hljs-string">"catalogue_url"</span>, value: layerConfig.catalogueUrl }];
                                }

                                <span class="hljs-keyword">if</span> (!metadataUrl) {
                                    metadataError();
                                } <span class="hljs-keyword">else</span> {
                                    UtilMisc.transformXML(metadataUrl, <span class="hljs-string">"assets/metadata/xstyle_default_"</span> + RAMP.locale + <span class="hljs-string">".xsl"</span>,
                                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(error, data)</span> </span>{
                                            <span class="hljs-keyword">if</span> (error) {
                                                metadataError();
                                            } <span class="hljs-keyword">else</span> {
                                                topic.publish(EventManager.GUI.SUBPANEL_OPEN, {
                                                    content: $(data),
                                                    origin: <span class="hljs-string">"filterManager"</span>,
                                                    update: <span class="hljs-literal">true</span>,
                                                    guid: id
                                                });
                                            }
                                        }, <span class="hljs-literal">null</span>, params);
                                }
                            }
                        } <span class="hljs-keyword">else</span> {
                            topic.publish(EventManager.GUI.SUBPANEL_CLOSE, { origin: <span class="hljs-string">"filterManager"</span> });
                        }
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>for scale-dependent layers - zoom to data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    PopupManager.registerPopup(mainList, <span class="hljs-string">"click"</span>,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(d)</span> </span>{
                            <span class="hljs-keyword">var</span> layerId = <span class="hljs-keyword">this</span>.target.data(<span class="hljs-string">"layer-id"</span>);

                            RampMap.zoomToLayerScale(layerId);

                            d.resolve();
                        },
                        {
                            handleSelector: <span class="hljs-string">".button-none.zoom"</span>,
                            activeClass: <span class="hljs-string">"button-pressed"</span>
                        }
                    );</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>adjust panel width on load</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    adjustPaneWidth();
                }

                <span class="hljs-comment">/**
                * Adjusts filter style according to the scroll action on the layers.
                * @method initScrollListeners
                * @private
                */</span>
                <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initScrollListeners</span><span class="hljs-params">()</span> </span>{
                    <span class="hljs-keyword">var</span> globalToggleSection = layerToggles.globalToggleSection();

                    layerList.scroll(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">var</span> currentScroll = layerList.scrollTop();
                        <span class="hljs-keyword">if</span> (currentScroll === <span class="hljs-number">0</span>) {
                            globalToggleSection.removeClass(<span class="hljs-string">"scroll"</span>);
                        } <span class="hljs-keyword">else</span> {
                            globalToggleSection.addClass(<span class="hljs-string">"scroll"</span>);
                        }
                    });
                }

                <span class="hljs-keyword">return</span> {
                    init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        <span class="hljs-keyword">var</span> section,
                            layerGroup,
                            that = <span class="hljs-keyword">this</span>;

                        sectionNode = $(<span class="hljs-string">"#"</span> + RAMP.config.divNames.filter);
                        section = tmpl(<span class="hljs-string">'filter_manager_template2'</span>, { config: RAMP.config });

                        sectionNode.empty().append(section);

                        mainList = sectionNode.find(<span class="hljs-string">"#layerList"</span>);
                        layerList = mainList.find(<span class="hljs-string">"&gt; li &gt; ul"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>fade out the loading animation
sectionNode.addClass(âanimated fadeOutâ);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-comment">/*window.setTimeout(
                            function () {*/</span>
                        <span class="hljs-comment">/*sectionNode
                            .empty().append(section)
                            .removeClass("fadeOut")
                            .addClass('animated fadeIn');*/</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>remove the animating css class
window.setTimeout(function () { sectionNode.removeClass(âanimated fadeInâ); }, 300);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                        GlobalStorage.layerSelectorGroups.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layerType)</span> </span>{
                            layerGroup = <span class="hljs-keyword">new</span> LayerGroup([], {
                                layerType: layerType
                            });

                            layerGroups[layerType] = layerGroup;
                            that.addLayerGroup(layerGroup.node);
                        });

                        layerToggles.init();
                        layerTooltips.init();
                        setButtonEvents();
                        initScrollListeners();
                        layerSettings.init();</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>ui initialization completes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-built_in">console</span>.log(EventManager.FilterManager.UI_COMPLETE);
                        topic.publish(EventManager.FilterManager.UI_COMPLETE);
                        <span class="hljs-comment">/*},
                        300
                    );*/</span>
                    },

                    <span class="hljs-comment">/**
                    * Updates certain UI aspects like layer settings panel (visibility sliders for now only), layer visibility and bounding box toggles, and layer sorting.
                    * @method ui.update
                    * @private
                    */</span>
                    update: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                        layerList = mainList.find(<span class="hljs-string">"&gt; li &gt; ul"</span>);

                        layerSettings.update();
                        layerToggles.update();
                        layerSort.update();
                    },

                    <span class="hljs-comment">/**
                    * Add the provided layer group node to the layer selector ui.
                    * @method ui.addLayerGroup
                    * @private
                    */</span>
                    addLayerGroup: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layerGroupNode)</span> </span>{
                        mainList.prepend(layerGroupNode);
                    }
                };
            }());

        <span class="hljs-comment">/**
        * Returns a LayerItem object with specified layerId.
        * @param {String} layerId a layer id
        * @method getLayerItem
        * @private
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLayerItem</span><span class="hljs-params">(layerId)</span> </span>{
            <span class="hljs-keyword">var</span> layerItem = <span class="hljs-literal">null</span>;

            UtilDict.forEachEntry(layerGroups, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, layerGroup)</span> </span>{
                <span class="hljs-keyword">if</span> (!layerItem) {
                    layerItem = layerGroup.getLayerItem(layerId);
                }
            });

            <span class="hljs-keyword">return</span> layerItem;
        }

        <span class="hljs-comment">/**
        * Set the state of the specified layer to the provided value.
        * @param {String} layerId a layer id
        * @param {String} layerState a state to set the specified layer to
        * @param {Object} [options] additional options to be passed to the layerItem upon setting state
        * @method setLayerState
        * @private
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setLayerState</span><span class="hljs-params">(layerId, layerState, options)</span> </span>{
            <span class="hljs-keyword">var</span> layerItem,
                isChanged = <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">if</span> (!(layerId <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>)) {
                layerId = [layerId];
            }

            layerId.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(lId)</span> </span>{
                layerItem = getLayerItem(lId);
                <span class="hljs-keyword">if</span> (layerItem &amp;&amp; layerItem.setState(layerState, options)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>if we went to loaded, call a modified version of below function that only updates that one layer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    setLayerOffScaleState(lId);
                    isChanged = <span class="hljs-literal">true</span>;
                }
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>update the toggle groups after changing state since toggles might disappear/be added</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (isChanged) {
                ui.update();
            }
        }

        <span class="hljs-comment">/**
        * Checks if any of the layers have data that is not visible and sets the appropriate layer state.
        * @method setLayerOffScaleStates
        * @private
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setLayerOffScaleStates</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">var</span> visibleLayers = RampMap.getVisibleLayers(),
                invisibleLayers = RampMap.getInvisibleLayers();

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filterLayerIds</span><span class="hljs-params">(layers)</span> </span>{
                layers = layers
                    .map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(l)</span> </span>{
                        <span class="hljs-keyword">if</span> (l.ramp) {
                            <span class="hljs-keyword">if</span> (l.ramp.config) {</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>we prefer the config id, as the ramp core can sometimes append things to the actual layer object id to help bind layers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">return</span> l.ramp.config.id;
                            } <span class="hljs-keyword">else</span> {
                                <span class="hljs-keyword">return</span> l.id;
                            }
                        }
                    })
                    .filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(l)</span> </span>{
                        <span class="hljs-keyword">return</span> (l);
                    });

                <span class="hljs-keyword">return</span> layers;
            }

            visibleLayers = filterLayerIds(visibleLayers);
            setLayerState(visibleLayers, LayerItem.state.DEFAULT, <span class="hljs-literal">true</span>);

            invisibleLayers = filterLayerIds(invisibleLayers);
            setLayerState(invisibleLayers, LayerItem.state.OFF_SCALE, <span class="hljs-literal">true</span>);
        }

        <span class="hljs-comment">/**
       * Checks if a specific layer has data that is not visible and sets the appropriate layer state.
       * @method setLayerOffScaleState
       * @param {String} layerId a layer id
       * @private
       */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setLayerOffScaleState</span><span class="hljs-params">(layerId)</span> </span>{
            <span class="hljs-keyword">var</span> visibleLayers = RampMap.getVisibleLayers(),
                invisibleLayers = RampMap.getInvisibleLayers();

            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filterLayerIds</span><span class="hljs-params">(layers)</span> </span>{
                layers = layers
                    .map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(l)</span> </span>{
                        <span class="hljs-keyword">if</span> (l.ramp) {
                            <span class="hljs-keyword">if</span> (l.ramp.config) {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>we prefer the config id, as the ramp core can sometimes append things to the actual layer object id to help bind layers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                <span class="hljs-keyword">return</span> l.ramp.config.id;
                            } <span class="hljs-keyword">else</span> {
                                <span class="hljs-keyword">return</span> l.id;
                            }
                        }
                    })
                    .filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(l)</span> </span>{
                        <span class="hljs-keyword">return</span> (l);
                    });

                <span class="hljs-keyword">return</span> layers;
            }

            visibleLayers = filterLayerIds(visibleLayers);
            invisibleLayers = filterLayerIds(invisibleLayers);
            <span class="hljs-keyword">if</span> (visibleLayers.contains(layerId)) {
                setLayerState(layerId, LayerItem.state.DEFAULT, <span class="hljs-literal">true</span>);
            }

            <span class="hljs-keyword">if</span> (invisibleLayers.contains(layerId)) {
                setLayerState(invisibleLayers, LayerItem.state.OFF_SCALE, <span class="hljs-literal">true</span>);
            }
        }

        <span class="hljs-comment">/**
        * Initiates a listener to handle tab deselected event
        *
        * @method initListeners
        * @private
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initListeners</span><span class="hljs-params">()</span> </span>{
            topic.subscribe(EventManager.GUI.TAB_DESELECTED, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arg)</span> </span>{
                <span class="hljs-keyword">if</span> (arg.tabName === <span class="hljs-string">"filterManager"</span>) {
                    topic.publish(EventManager.GUI.SUBPANEL_CLOSE, { origin: <span class="hljs-string">"filterManager"</span> });
                }
            });

            topic.subscribe(EventManager.Map.ZOOM_END, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
                setLayerOffScaleStates();
            });
        }

        <span class="hljs-keyword">return</span> {
            <span class="hljs-comment">/**
            * Reads the application configuration and creates the legend and filter management widget
            * @method init
            * @constructor
            */</span>
            init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Convenience config objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                config = RAMP.config;</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>reset and load global template
TODO: move the following out from generateGlobalCheckboxes() and merge filter_global_row_template_json into filter_row_template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                tmpl.cache = {};
                tmpl.templates = <span class="hljs-built_in">JSON</span>.parse(TmplHelper.stringifyTemplate(filter_manager_template_json));

                ui.init();

                initListeners();
                setLayerOffScaleStates();
            },

            <span class="hljs-comment">/**
            * Add a provided layer to the layer selector.
            * @param {String} layerType layer type - name of the layer group
            * @param {Object} layerRamp ramp object
            * @param {Object} [options] additional options for the layer item
            * @param {String} [options.state] the state to initialize in.  Default value is LOADING
            * @param {String} [options.notices] optional notices, for example error notices if the layer cannot be loaded from the get go
            * @method addLayer
            */</span>
            addLayer: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layerType, layerRamp, options)</span> </span>{
                <span class="hljs-keyword">var</span> layerGroup = layerGroups[layerType],
                    newLayer;

                options = options || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>TODO: figure out how to handle ordering of the groups - canât have wms group before feature layer group</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">if</span> (!layerGroup) {
                    layerGroup = <span class="hljs-keyword">new</span> LayerGroup([], {
                        layerType: layerType,
                        layerState: LayerItem.state.LOADING
                    });

                    layerGroups[layerType] = layerGroup;
                    ui.addLayerGroup(layerGroup.node);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>layer is user-added, add an extra notice to all states</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (layerRamp.user) {
                    options = lang.mixin(options,
                        {
                            stateMatrix: LayerItem.getStateMatrixTemplate()
                        }
                    );

                    LayerItem.addStateMatrixPart(options.stateMatrix, <span class="hljs-string">"notices"</span>, LayerItem.notices.USER, <span class="hljs-literal">true</span>);
                    LayerItem.removeStateMatrixPart(options.stateMatrix, <span class="hljs-string">"controls"</span>, LayerItem.controls.METADATA);
                }

                newLayer = layerGroup.addLayerItem(layerRamp.config, options);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>TODO: check scale in cleaner way</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                setLayerOffScaleStates();

                ui.update();
            },

            <span class="hljs-comment">/**
            * Remove a layer from the layer selector.
            * @param {String} layerType layer type - name of the layer group
            * @param {String} layerId layer id of layer to remove
            * @method removeLayer
            */</span>
            removeLayer: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layerType, layerId)</span> </span>{
                <span class="hljs-keyword">var</span> layerGroup = layerGroups[layerType];

                <span class="hljs-keyword">if</span> (!layerGroup) {</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>tried to remove a layer that doesnât exist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"tried to remove layer from nonexistant group: "</span> + layerType);
                } <span class="hljs-keyword">else</span> {
                    layerGroup.removeLayerItem(layerId);</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>TODO REQUIRED?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    ui.update();
                }
            },

            <span class="hljs-comment">/**
            * Returns the state of the layer with the specified layer id.
            * @param {String} layerId a layer id
            * @method getLayerState
            * @private
            */</span>
            getLayerState: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layerId)</span> </span>{
                <span class="hljs-keyword">var</span> layerItem = getLayerItem(layerId);

                <span class="hljs-keyword">if</span> (layerItem) {
                    <span class="hljs-keyword">return</span> layerItem.state;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
                }
            },

            <span class="hljs-comment">/**
            * Set the state of the specified layer to the provided value. Public hook to call internal setLayerState function.
            * @param {String} layerId a layer id
            * @param {String} layerState a state to set the specified layer to
            * @param {Object} [options] additional options to be passed to the layerItem upon setting state
            * @method setLayerState
            */</span>
            setLayerState: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(layerId, layerState, options)</span> </span>{
                setLayerState(layerId, layerState, options);
            },

            <span class="hljs-comment">/**
            * Queries all map points on a given feature layer and returns their attributes
            * @method _getFeatures
            * @param {Object} fl A feature layer to query
            * @return {Object} An array of attributes from the designated feature layer
            */</span>
            _getFeatures: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fl)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>do a query on ALL the map points.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> queryTask = <span class="hljs-keyword">new</span> EsriQuery();
                queryTask.returnGeometry = <span class="hljs-literal">false</span>; <span class="hljs-comment">//only return attributes</span>
                queryTask.maxAllowableOffset = <span class="hljs-number">1000</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>query.outFields = outFieldsList;  //note: this list is overridden by fields in featurelayer constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                queryTask.where = fl.objectIdField + <span class="hljs-string">"&gt;0"</span>;

                <span class="hljs-keyword">return</span> fl.queryFeatures(queryTask);
            },
            <span class="hljs-comment">/**
            * Grabs all distinct values of the given field from a featureLayer.
            * @method _getField
            * @param {Object} fl A feature layer to query
            * @param {String} field The field (or column) to query in the feature layer
            * @return {Object} deferred A deferred object which will resolve to an array of unique values
            */</span>
            _getField: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fl, field)</span> </span>{
                <span class="hljs-keyword">var</span> deferred = <span class="hljs-keyword">new</span> Deferred();

                <span class="hljs-keyword">this</span>._getFeatures(fl).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(featureSet)</span> </span>{
                    deferred.resolve(dojoArray.map(featureSet.features, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(feature)</span> </span>{
                        <span class="hljs-keyword">return</span> feature.attributes[field];
                    }));
                });

                <span class="hljs-keyword">return</span> deferred.promise;
            }
        };
    });</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
