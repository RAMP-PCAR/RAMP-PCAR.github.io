<!DOCTYPE html>

<html>
<head>
  <title>map.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="advancedToolbar.html">
                advancedToolbar.js
              </a>
            
              
              <a class="source" href="basemapSelector.html">
                basemapSelector.js
              </a>
            
              
              <a class="source" href="bookmarkLink.html">
                bookmarkLink.js
              </a>
            
              
              <a class="source" href="dataLoader.html">
                dataLoader.js
              </a>
            
              
              <a class="source" href="dataLoaderGui.html">
                dataLoaderGui.js
              </a>
            
              
              <a class="source" href="datagrid.html">
                datagrid.js
              </a>
            
              
              <a class="source" href="datagridClickHandler.html">
                datagridClickHandler.js
              </a>
            
              
              <a class="source" href="eventManager.html">
                eventManager.js
              </a>
            
              
              <a class="source" href="featureClickHandler.html">
                featureClickHandler.js
              </a>
            
              
              <a class="source" href="featureHighlighter.html">
                featureHighlighter.js
              </a>
            
              
              <a class="source" href="filterManager.html">
                filterManager.js
              </a>
            
              
              <a class="source" href="geoSearch.html">
                geoSearch.js
              </a>
            
              
              <a class="source" href="globalStorage.html">
                globalStorage.js
              </a>
            
              
              <a class="source" href="graphicExtension.html">
                graphicExtension.js
              </a>
            
              
              <a class="source" href="gui.html">
                gui.js
              </a>
            
              
              <a class="source" href="imageExport.html">
                imageExport.js
              </a>
            
              
              <a class="source" href="layerGroup.html">
                layerGroup.js
              </a>
            
              
              <a class="source" href="layerItem.html">
                layerItem.js
              </a>
            
              
              <a class="source" href="layerLoader.html">
                layerLoader.js
              </a>
            
              
              <a class="source" href="map.html">
                map.js
              </a>
            
              
              <a class="source" href="mapClickHandler.html">
                mapClickHandler.js
              </a>
            
              
              <a class="source" href="maptips.html">
                maptips.js
              </a>
            
              
              <a class="source" href="navigation.html">
                navigation.js
              </a>
            
              
              <a class="source" href="quickzoom.html">
                quickzoom.js
              </a>
            
              
              <a class="source" href="ramp.html">
                ramp.js
              </a>
            
              
              <a class="source" href="stepItem.html">
                stepItem.js
              </a>
            
              
              <a class="source" href="theme.html">
                theme.js
              </a>
            
              
              <a class="source" href="RAMP-starter.html">
                RAMP-starter.js
              </a>
            
              
              <a class="source" href="areaTool.html">
                areaTool.js
              </a>
            
              
              <a class="source" href="baseTool.html">
                baseTool.js
              </a>
            
              
              <a class="source" href="bufferTool.html">
                bufferTool.js
              </a>
            
              
              <a class="source" href="distanceTool.html">
                distanceTool.js
              </a>
            
              
              <a class="source" href="populationTool.html">
                populationTool.js
              </a>
            
              
              <a class="source" href="array.html">
                array.js
              </a>
            
              
              <a class="source" href="bricks.html">
                bricks.js
              </a>
            
              
              <a class="source" href="checkbox.html">
                checkbox.js
              </a>
            
              
              <a class="source" href="checkboxGroup.html">
                checkboxGroup.js
              </a>
            
              
              <a class="source" href="decorator.html">
                decorator.js
              </a>
            
              
              <a class="source" href="dictionary.html">
                dictionary.js
              </a>
            
              
              <a class="source" href="functionMangler.html">
                functionMangler.js
              </a>
            
              
              <a class="source" href="popupManager.html">
                popupManager.js
              </a>
            
              
              <a class="source" href="prototype.html">
                prototype.js
              </a>
            
              
              <a class="source" href="tmplHelper.html">
                tmplHelper.js
              </a>
            
              
              <a class="source" href="tmplUtil.html">
                tmplUtil.js
              </a>
            
              
              <a class="source" href="url.html">
                url.js
              </a>
            
              
              <a class="source" href="util.html">
                util.js
              </a>
            
              
              <a class="source" href="bootstrapper.html">
                bootstrapper.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>map.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>ï»¿<span class="hljs-comment">/*global define, esri, console, $, RAMP, proj4, window */</span>

<span class="hljs-comment">/**
*
* A RAMP Map module with ESRI and Dojo AMD Modules
* This module provides function to create an ESRI web map control. A global config object is
* required to initialize the map.
*
* @module RAMP
* @submodule Map
* @main Map
*/</span>

<span class="hljs-comment">/**
* Map class represents the ESRI map object. The map is generated based on the application configuration and templates.
*
* ####Imports RAMP Modules:
* {{#crossLink "GlobalStorage"}}{{/crossLink}}  
* {{#crossLink "RAMP"}}{{/crossLink}}  
* {{#crossLink "FeatureClickHandler"}}{{/crossLink}}  
* {{#crossLink "MapClickHandler"}}{{/crossLink}}  
* {{#crossLink "Navigation"}}{{/crossLink}}  
* {{#crossLink "EventManager"}}{{/crossLink}}  
* {{#crossLink "Util"}}{{/crossLink}}  
* {{#crossLink "Array"}}{{/crossLink}}  
* 
* @class Map
* @static
* @uses dojo/_base/declare
* @uses dojo/_base/array
* @uses dojo/dom
* @uses dojo/dom-construct
* @uses dojo/number
* @uses dojo/query
* @uses dojo/topic
* @uses dojo/on
* @uses esri/map
* @uses esri/layers/FeatureLayer
* @uses esri/layers/ArcGISTiledMapServiceLayer
* @uses esri/layers/ArcGISDynamicMapServiceLayer
* @uses esri/layers/WMSLayer
* @uses esri/SpatialReference
* @uses esri/dijit/Scalebar
* @uses esri/geometry/Extent
* @uses esri/tasks/GeometryService
* @uses esri/tasks/ProjectParameters
*/</span>

define([
<span class="hljs-comment">/* Dojo */</span>
<span class="hljs-string">"dojo/_base/declare"</span>, <span class="hljs-string">"dojo/_base/array"</span>, <span class="hljs-string">"dojo/dom"</span>,
        <span class="hljs-string">"dojo/dom-construct"</span>, <span class="hljs-string">"dojo/number"</span>, <span class="hljs-string">"dojo/query"</span>, <span class="hljs-string">"dojo/topic"</span>, <span class="hljs-string">"dojo/on"</span>,

<span class="hljs-comment">/* Esri */</span>
<span class="hljs-string">"esri/map"</span>, <span class="hljs-string">"esri/layers/FeatureLayer"</span>, <span class="hljs-string">"esri/layers/ArcGISTiledMapServiceLayer"</span>, <span class="hljs-string">"esri/layers/ArcGISDynamicMapServiceLayer"</span>,
<span class="hljs-string">"esri/SpatialReference"</span>, <span class="hljs-string">"esri/dijit/Scalebar"</span>, <span class="hljs-string">"esri/geometry/Extent"</span>, <span class="hljs-string">"esri/layers/WMSLayer"</span>, <span class="hljs-string">"esri/tasks/GeometryService"</span>, <span class="hljs-string">"esri/tasks/ProjectParameters"</span>,

<span class="hljs-comment">/* Ramp */</span>
<span class="hljs-string">"ramp/globalStorage"</span>, <span class="hljs-string">"ramp/ramp"</span>, <span class="hljs-string">"ramp/featureClickHandler"</span>, <span class="hljs-string">"ramp/mapClickHandler"</span>, <span class="hljs-string">"ramp/navigation"</span>, <span class="hljs-string">"ramp/eventManager"</span>,

<span class="hljs-comment">/* Util */</span>
<span class="hljs-string">"utils/util"</span>, <span class="hljs-string">"utils/array"</span>, <span class="hljs-string">"utils/dictionary"</span>],

    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">
    <span class="hljs-comment">/* Dojo */</span>
    declare, dojoArray, dom, domConstruct, number, query, topic, dojoOn,

    <span class="hljs-comment">/* Esri */</span>
    EsriMap, FeatureLayer, ArcGISTiledMapServiceLayer, ArcGISDynamicMapServiceLayer,
    SpatialReference, EsriScalebar, EsriExtent, WMSLayer, GeometryService, ProjectParameters,

    <span class="hljs-comment">/* Ramp */</span>
    GlobalStorage, Ramp, FeatureClickHandler, MapClickHandler, Navigation, EventManager,

    <span class="hljs-comment">/* Util */</span>
    UtilMisc, UtilArray, UtilDict</span>) </span>{
<span class="hljs-pi">        "use strict"</span>;

        <span class="hljs-comment">/**
        * An Array of {{#crossLink "Esri/layers/FeatureLayer"}}{{/crossLink}} objects.
        *
        * @private
        * @property featureLayers {Array}
        */</span>
        <span class="hljs-keyword">var</span> featureLayers,

            <span class="hljs-comment">/**
            * An Array of {{#crossLink "Esri/layer/WMSLayer"}}{{/crossLink}} objects.
            *
            * @private
            * @property wmsLayers {Array}
            */</span>
            wmsLayers = [],

            <span class="hljs-comment">/**
            * Maps the id of a graphic layer to the GraphicsLayer Object that represents its extent bounding box.
            * A dictionary of String, {{#crossLink "Esri/layers/GraphicsLayer"}}{{/crossLink}} pairs.
            *
            * @private
            * @property boundingBoxMapping {Object}
            */</span>
            boundingBoxMapping = {},

            <span class="hljs-comment">/**
            * The map not only contains feature layers, but also other layers such as the
            * basemap layer, highlight layer, bounding box layer, etc. This variable is
            * used to store the starting index of the feature layers in the map.
            *
            * @private
            * @property featureLayerStartIndex {Integer}
            */</span>
            featureLayerStartIndex,

            map,

            fullExtent,
            maxExtent,
            initExtent;

        <span class="hljs-comment">/**
        * Shows the loading image.
        *
        * @private
        * @method _showLoadingImg
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_showLoadingImg</span>(<span class="hljs-params"></span>) </span>{
            $(<span class="hljs-string">"#map-load-indicator"</span>).removeClass(<span class="hljs-string">"hidden"</span>);
        }

        <span class="hljs-comment">/**
        * Hides the loading image.
        *
        * @private
        * @method _hideLoadingImg
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_hideLoadingImg</span>(<span class="hljs-params"></span>) </span>{
            $(<span class="hljs-string">"#map-load-indicator"</span>).addClass(<span class="hljs-string">"hidden"</span>);
        }

        <span class="hljs-comment">/**
        * Update Map Scale when zoom level changes
        *
        * @private
        * @method _updateScale
        * @param {Object} event
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_updateScale</span>(<span class="hljs-params">event</span>) </span>{
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"hjkl"</span>);
            <span class="hljs-keyword">if</span> (event.levelChange) {
                <span class="hljs-keyword">var</span> currentScale = number.format(event.lod.scale),
                    scaleLabelText = <span class="hljs-string">"1 : "</span> + currentScale;

                domConstruct.empty(<span class="hljs-string">'scaleLabel'</span>);
                $(<span class="hljs-string">"#scaleLabel"</span>).text(scaleLabelText);
            }
        }

        <span class="hljs-comment">/**
        * Republishes map events to the outside using topic.publish
        *
        * @method _initRepublishers
        * @param {Object} map object
        * @private
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initRepublishers</span>(<span class="hljs-params">map</span>) </span>{
            <span class="hljs-keyword">var</span> prefix = <span class="hljs-string">"map"</span>;

            <span class="hljs-comment">/**
            * Republish map events using topic.publish
            *
            * @method republish
            * @param {String} name
            * @private
            */</span>
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">republish</span>(<span class="hljs-params">name</span>) </span>{
                map.on(name, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
                    topic.publish(prefix + <span class="hljs-string">"/"</span> + name, event);
                });
            }

            republish(<span class="hljs-string">"update-end"</span>);
            republish(<span class="hljs-string">"extent-change"</span>);
            republish(<span class="hljs-string">"zoom-start"</span>);
            republish(<span class="hljs-string">"zoom-end"</span>);
            republish(<span class="hljs-string">"pan-start"</span>);
            republish(<span class="hljs-string">"pan-end"</span>);
        }

        <span class="hljs-comment">/**
        * Subscribe to external events (published using topic.publish)
        * and react accordingly
        *
        * @method _initListeners
        * @param {Object} map map object
        * @private
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initListeners</span>(<span class="hljs-params">map</span>) </span>{
            <span class="hljs-comment">/* SUBSCRIBED EVENTS */</span>
            topic.subscribe(EventManager.Map.CENTER_AT, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
                map.centerAt(event.point);
            });

            topic.subscribe(EventManager.Map.CENTER_AND_ZOOM, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
                <span class="hljs-keyword">var</span> point = <span class="hljs-keyword">new</span> esri.geometry.Point(event.graphic.geometry.x, event.graphic.geometry.y, map.spatialReference),
                    d = map.centerAndZoom(point, event.level); <span class="hljs-comment">// Last parameter is the level</span>

                <span class="hljs-keyword">if</span> (event.callback) {
                    d.then(event.callback);
                }
            });

            topic.subscribe(EventManager.Map.SET_EXTENT, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
                event.extent.spatialReference = map.spatialReference;
                <span class="hljs-keyword">var</span> d = map.setExtent(event.extent);

                <span class="hljs-keyword">if</span> (event.callback) {
                    d.then(event.callback);
                }
            });

            <span class="hljs-comment">/* NAVIGATION EVENTS */</span>
            topic.subscribe(EventManager.Navigation.PAN, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>event.direction panUp, panDown, panLeft, panRight
this same as calling map.panUp(), map.panDown(), map.panLeft(), map.panRight()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                map[event.direction]();
            });

            topic.subscribe(EventManager.Navigation.ZOOM_STEP, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
                map.setLevel(map.getLevel() + event.level);
            });

            topic.subscribe(EventManager.Navigation.ZOOM, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
                map.setLevel(event.level);
            });

            topic.subscribe(EventManager.Navigation.FULL_EXTENT, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                map.setExtent(fullExtent);
            });

            <span class="hljs-comment">/* GUI EVENTS */</span>
            topic.subscribe(EventManager.GUI.LAYOUT_CHANGE, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                map.resize(<span class="hljs-literal">true</span>);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Unhighlight the point when the subpanel is collapsed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            topic.subscribe(EventManager.GUI.SUBPANEL_CHANGE, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">eventArg</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>unhighlight only if the panel closing is the details panel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (!eventArg.visible &amp;&amp;
                    eventArg.isComplete &amp;&amp;
                    (eventArg.origin === (<span class="hljs-string">"rampPopup"</span> || <span class="hljs-string">"datagrid"</span>))) {
                    topic.publish(EventManager.FeatureHighlighter.HIGHLIGHT_HIDE, {});
                }
            });

            <span class="hljs-comment">/* START BOUNDING BOX TOGGLE */</span>

            topic.subscribe(EventManager.FilterManager.LAYER_VISIBILITY_TOGGLED, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) </span>{
                <span class="hljs-keyword">var</span> setTo = evt.state,
                    layerId = evt.id,</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>either take url (would need mapping to layer on map),
map id in config, graphic layer id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    layer = map.getLayer(layerId);

                layer.setVisibility(setTo);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>loops through any static layers that are mapped to the feature layer being toggled</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">try</span> {
                    dojoArray.forEach(GlobalStorage.LayerMap[layerId], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">staticLayer</span>) </span>{
                        <span class="hljs-keyword">var</span> layer = map.getLayer(staticLayer);
                        layer.setVisibility(setTo);
                    });
                }
                <span class="hljs-keyword">catch</span> (err) {
                }
            });

            topic.subscribe(EventManager.FilterManager.LAYER_TRANSPARENCY_CHANGED, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) </span>{
                <span class="hljs-keyword">var</span> layer = map.getLayer(evt.layerId);

                <span class="hljs-keyword">if</span> (layer !== <span class="hljs-literal">undefined</span>) {
                    layer.setOpacity(evt.value);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>loops through any static layers that are mapped to the feature layer being toggled</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">try</span> {
                        dojoArray.forEach(GlobalStorage.LayerMap[evt.layerId], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">staticLayer</span>) </span>{
                            <span class="hljs-keyword">var</span> layer = map.getLayer(staticLayer);
                            layer.setOpacity(evt.value);
                        });
                    }
                    <span class="hljs-keyword">catch</span> (err) {
                    }
                }
            });

            topic.subscribe(EventManager.FilterManager.BOX_VISIBILITY_TOGGLED, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) </span>{
                setBoundingBoxVisibility(evt.id, evt.state);
            });
            <span class="hljs-comment">/* END BOUNDING BOX TOGGLE */</span>

            topic.subscribe(EventManager.FilterManager.SELECTION_CHANGED, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>this is handling the user trying to re-order the layers
graphical and feature layers must be handled separately from
all other layers as ESRI separates the two internally</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">var</span> newIndex = evt.index,
                    featureLayers;

                <span class="hljs-keyword">if</span> (map.layerIds.contains(evt.id)) {
                    featureLayers = dojoArray.map(map.graphicsLayerIds, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) </span>{
                        <span class="hljs-keyword">return</span> map.getLayer(x).type === <span class="hljs-string">'Feature Layer'</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
                    }).sum();
                    newIndex += <span class="hljs-number">1</span> - featureLayers; <span class="hljs-comment">// offset by 1 basemap not accounted for</span>
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'newIndex '</span> + newIndex);
                    <span class="hljs-built_in">console</span>.log(map.layerIds);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">if</span> (!featureLayerStartIndex) {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Find the index of the first feature layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        featureLayerStartIndex = UtilArray.indexOf(map.graphicsLayerIds, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">layerId</span>) </span>{
                            <span class="hljs-keyword">var</span> layer = map.getLayer(layerId);
                            <span class="hljs-keyword">return</span> layer.type &amp;&amp; layer.type === <span class="hljs-string">"Feature Layer"</span>;
                        });
                    }
                    newIndex += featureLayerStartIndex;
                }
                map.reorderLayer(map.getLayer(evt.id), newIndex);
                topic.publish(EventManager.Map.REORDER_END);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>TODO this will likely get removed or amended by aly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-comment">/* Add Layer subscription*/</span>
            topic.subscribe(EventManager.Map.ADD_LAYER, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">var</span> type = dom.byId(<span class="hljs-string">"addLayer-select-type"</span>).value,
                    URL = dom.byId(<span class="hljs-string">"addLayer-URL-input"</span>).value,
                    opacity = dom.byId(<span class="hljs-string">"addLayer-Opacity"</span>).value;

                <span class="hljs-built_in">console</span>.log(type + <span class="hljs-string">" | "</span> + URL + <span class="hljs-string">" | "</span> + opacity);
                addStaticLayer(type, URL, opacity);
            });

            topic.subscribe(EventManager.Map.ADD_LAYER_READY, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">temp_layer</span>) </span>{
                map.addLayer(temp_layer);
            });
        }
        <span class="hljs-comment">/**
        * Creates event handlers for the map control: click, mouse-over, load, extent change, and update events.
        *
        * @private
        * @method _initEventHandlers
        * @param {Object} map A ESRI map object
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_initEventHandlers</span>(<span class="hljs-params">map</span>) </span>{
            map.on(<span class="hljs-string">"extent-change"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
                _updateScale(event);

                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"map - &gt;&gt; extent-change"</span>, event);
                dojoOn.once(map, <span class="hljs-string">"update-end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"map - &gt;&gt; update-end - &gt;&gt; Apply extent Filter"</span>);
                    topic.publish(EventManager.Datagrid.APPLY_EXTENT_FILTER);
                });
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Deselect all highlighted points if the map is clicked</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            map.on(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) </span>{
                FeatureClickHandler.onFeatureDeselect(evt);
                topic.publish(EventManager.Map.CLICK, evt);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Show/Hide spinner for map loading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            map.on(<span class="hljs-string">"update-start"</span>, _showLoadingImg);
            map.on(<span class="hljs-string">"update-end"</span>, _hideLoadingImg);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>code that would wait until all layers were loaded.  not used anymore, but could be useful to keep around to steal later</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-comment">/*
            var handle = map.on("update-end", function () {
                var isAllLoaded = dojoArray.every(
                        map.graphicsLayerIds.concat(map.layerIds),
                        function (layerId) {
                            var layer = map.getLayer(layerId);
                            console.log(layer.loaded, layerId, layer);
                            return layer.loaded;
                        }
                    );

                console.log("map -&gt; is all layers loaded: ", isAllLoaded);

                if (isAllLoaded) {
                    handle.remove();
                    console.log("map -&gt;", EventManager.Map.ALL_LAYERS_LOADED);
                    topic.publish(EventManager.Map.ALL_LAYERS_LOADED);
                }
            });
            */</span>
        }

        <span class="hljs-comment">/**
        * Will project an extent to a desired spatial reference, using client side projection library.
        * Avoids the need for Esri Geometry Service
        *
        * @method localProjectExtent
        * @private
        * @param  {Esri/Extent} extent extent to be projected
        * @param {Esri/SpatialReference} sr {{#crossLink "Esri/SpatialReference"}}{{/crossLink}} to project to
        * @return {Esri/Extent} extent in the desired projection
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">localProjectExtent</span>(<span class="hljs-params">extent, sr</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>TODO can we handle WKT?
we can now</p>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>interpolates two points by splitting the line in half recursively</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">interpolate</span>(<span class="hljs-params">p0, p1, steps</span>) </span>{
                <span class="hljs-keyword">var</span> mid, i0, i1;

                <span class="hljs-keyword">if</span> (steps === <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span> [p0, p1]; }

                mid = [(p0[<span class="hljs-number">0</span>] + p1[<span class="hljs-number">0</span>]) / <span class="hljs-number">2</span>, (p0[<span class="hljs-number">1</span>] + p1[<span class="hljs-number">1</span>]) / <span class="hljs-number">2</span>];
                <span class="hljs-keyword">if</span> (steps === <span class="hljs-number">1</span>) {
                    <span class="hljs-keyword">return</span> [p0, mid, p1];
                }
                <span class="hljs-keyword">if</span> (steps &gt; <span class="hljs-number">1</span>) {
                    i0 = interpolate(p0, mid, steps - <span class="hljs-number">1</span>);
                    i1 = interpolate(mid, p1, steps - <span class="hljs-number">1</span>);
                    <span class="hljs-keyword">return</span> i0.concat(i1.slice(<span class="hljs-number">1</span>));
                }
            }

            <span class="hljs-keyword">var</span> points = [[extent.xmin, extent.ymin], [extent.xmax, extent.ymin], [extent.xmax, extent.ymax], [extent.xmin, extent.ymax], [extent.xmin, extent.ymin]],
                projConvert, transformed, projExtent, x0, y0, x1, y1, xvals, yvals, interpolatedPoly = [], srcProj;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>interpolate each edge by splitting it in half 3 times (since lines are not guaranteed to project to lines we need to consider
max / min points in the middle of line segments)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>].map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">i</span>) </span>{ <span class="hljs-keyword">return</span> interpolate(points[i], points[i + <span class="hljs-number">1</span>], <span class="hljs-number">3</span>).slice(<span class="hljs-number">1</span>); }).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">seg</span>) </span>{ interpolatedPoly = interpolatedPoly.concat(seg); });</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>reproject the extent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (extent.spatialReference.wkid) {
                srcProj = <span class="hljs-string">'EPSG:'</span> + extent.spatialReference.wkid;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (extent.spatialReference.wkt) {
                srcProj = extent.spatialReference.wkt;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'No WKT or WKID specified on extent.spatialReference'</span>);
            }
            projConvert = proj4(srcProj, <span class="hljs-string">'EPSG:'</span> + sr.wkid);
            transformed = interpolatedPoly.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) </span>{ <span class="hljs-keyword">return</span> projConvert.forward(x); });

            xvals = transformed.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) </span>{ <span class="hljs-keyword">return</span> x[<span class="hljs-number">0</span>]; });
            yvals = transformed.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x</span>) </span>{ <span class="hljs-keyword">return</span> x[<span class="hljs-number">1</span>]; });

            x0 = <span class="hljs-built_in">Math</span>.min.apply(<span class="hljs-literal">null</span>, xvals);
            x1 = <span class="hljs-built_in">Math</span>.max.apply(<span class="hljs-literal">null</span>, xvals);

            y0 = <span class="hljs-built_in">Math</span>.min.apply(<span class="hljs-literal">null</span>, yvals);
            y1 = <span class="hljs-built_in">Math</span>.max.apply(<span class="hljs-literal">null</span>, yvals);

            projExtent = <span class="hljs-keyword">new</span> EsriExtent(x0, y0, x1, y1, sr);
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'localProjectExtent complete: '</span> + <span class="hljs-built_in">JSON</span>.stringify(projExtent));

            <span class="hljs-keyword">return</span> projExtent;
        }

        <span class="hljs-comment">/**
        * project an extent to a new spatial reference, if required
        * when projection is finished, call another function and pass the result to it.
        *
        * @method projectExtent
        * @private
        * @param {Object} extent an extent object from the configuration
        * @param {Esri/SpatialReference} sr {{#crossLink "Esri/SpatialReference"}}{{/crossLink}} to project to
        * @param {Function} callWhenDone function to call when extent is projected.  expects geometry parameter
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">projectExtent</span>(<span class="hljs-params">extent, sr, callWhenDone</span>) </span>{
            <span class="hljs-keyword">var</span> realExtent;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>convert configuration extent to proper esri extent object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            realExtent = <span class="hljs-keyword">new</span> EsriExtent(extent);

            <span class="hljs-keyword">if</span> (UtilMisc.isSpatialRefEqual(realExtent.spatialReference, sr)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>the extent is already in the correct projection.
go to the next step</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                callWhenDone([realExtent]);
            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>need to re-project the extent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">var</span> projectedExtent = localProjectExtent(realExtent, sr);
                callWhenDone([projectedExtent]);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Geometry Service Version.  Makes a more accurate bounding box, but requires an arcserver</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-comment">/*
                var geomSrv, geomParams;
                geomSrv = new GeometryService(RAMP.config.geometryServiceUrl);
                geomParams = new ProjectParameters();
                geomParams.geometries = [realExtent];
                geomParams.outSR = sr;

                geomSrv.project(geomParams, function (projectedExtents) {
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>after service returns, continue to next step</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    callWhenDone(projectedExtents);
                });
                */
            }
        }

        /**
        * process the projected default extent, begin projection of full extent.
        * used as an asynchronous gate for the projection.
        *
        * @method projectFullExtent
        * @private
        * @param {Array} projectedDefaultExtent an array containing the default extent object in the map's projection
        */
        function projectFullExtent(projectedDefaultExtent) {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>store projected result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            RAMP.config.extents.defaultExtent = projectedDefaultExtent[<span class="hljs-number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>project the full extent.  when finished, process max extent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            projectExtent(RAMP.config.extents.fullExtent, projectedDefaultExtent[<span class="hljs-number">0</span>].spatialReference, projectMaxExtent);
        }

        <span class="hljs-comment">/**
        * process the projected full extent, begin projection of maximum extent.
        * used as an asynchronous gate for the projection.
        *
        * @method projectMaxExtent
        * @private
        * @param {Array} projectedFullExtent an array containing the full extent object in the map's projection
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">projectMaxExtent</span>(<span class="hljs-params">projectedFullExtent</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>store projected result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            RAMP.config.extents.fullExtent = projectedFullExtent[<span class="hljs-number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>project the max extent.  when finished, tell map to continue loading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            projectExtent(RAMP.config.extents.maximumExtent, projectedFullExtent[<span class="hljs-number">0</span>].spatialReference, finishExtentProjection);
        }

        <span class="hljs-comment">/**
        * process the projected maximum extent, then alert app to continue loading the map.
        * used as an asynchronous gate for the projection.
        *
        * @method finishExtentProjection
        * @private
        * @param {Array} projectedMaxExtent an array containing the maximum extent object in the map's projection
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">finishExtentProjection</span>(<span class="hljs-params">projectedMaxExtent</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>store projected result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            RAMP.config.extents.maximumExtent = projectedMaxExtent[<span class="hljs-number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>throw event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            topic.publish(EventManager.Map.EXTENTS_REPROJECTED);
        }

        <span class="hljs-comment">/**
        * Add a static, non-interactive Layer to the map
        * <span class="hljs-doctag"><span class="hljs-keyword">NOTE</span></span>: this function is currently not being used.
        *
        * @private
        * @method AddStaticLayer
        * @param {String} layer_type A value which controls how the layer is going to be added to the map
        * @param {String} layer_url A URL pointing to a valid map service endpoint
        * @param {Number} layer_op A value between 0.0 and 1.0 which determines the transparency of the layer
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addStaticLayer</span>(<span class="hljs-params">layer_type, layer_url, layer_op</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>TODO: consider removing this?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            layer_op = layer_op / <span class="hljs-number">100</span>; <span class="hljs-comment">// change percentage to decimal</span>
            <span class="hljs-keyword">var</span> tempLayer;
            <span class="hljs-keyword">switch</span> (layer_type) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"feature"</span>:
                    tempLayer = <span class="hljs-keyword">new</span> FeatureLayer(layer_url, {
                        opacity: layer_op,
                        mode: FeatureLayer.MODE_SNAPSHOT
                    });
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">"tile"</span>:
                    tempLayer = <span class="hljs-keyword">new</span> ArcGISTiledMapServiceLayer(layer_url, {
                        opacity: layer_op
                    });
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">"dynamic"</span>:
                    tempLayer = <span class="hljs-keyword">new</span> ArcGISDynamicMapServiceLayer(layer_url, {
                        opacity: layer_op
                    });
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">default</span>:

                    <span class="hljs-keyword">break</span>;
            }

            topic.publish(EventManager.Map.ADD_LAYER_READY, tempLayer);
            topic.publish(EventManager.GUI.ADD_LAYER_PANEL_CHANGE, {
                visible: <span class="hljs-literal">false</span>
            });
        }

        <span class="hljs-comment">/**
        * Sets the visibility of the bounding box that belongs to the layer with the given layerId.
        * Note: the layerId needs to be the ID of the featurelayer, not the ID of the actual bounding
        * box layer.
        *
        * @private
        * @method setBoundingBoxVisibility
        * @param {String} layerId the id of the layer whose bounding box visibility should be set
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setBoundingBoxVisibility</span>(<span class="hljs-params">layerId, visibility</span>) </span>{
            <span class="hljs-keyword">var</span> boxLayer = boundingBoxMapping[layerId];</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>if (boxLayer.graphics.isEmpty() &amp;&amp; visibility) {
   // get bounding box info from config object
   var boundingBoxExtent;
   var layerConfig = dojoArray.find(config.featureLayers, function (layerConfig) {
       return layerConfig.id === layerId;
   });</p>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>   boundingBoxExtent.xmin = layerConfig.boundingBox.extent.xmin;
   boundingBoxExtent.ymin = layerConfig.boundingBox.extent.ymin;
   boundingBoxExtent.xmax = layerConfig.boundingBox.extent.xmax;
   boundingBoxExtent.ymax = layerConfig.boundingBox.extent.ymax;</p>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>   var extentGraphic = new esri.Graphic({
       geometry: boundingBoxExtent,
       symbol: {
           color: [255, 0, 0, 64],
           outline: {
               color: [240, 128, 128, 255],
               width: 1,
               type: âesriSLSâ,
               style: âesriSLSSolidâ
           },
           type: âesriSFSâ,
           style: âesriSFSSolidâ
       }
   });
   boxLayer.add(extentGraphic);
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            boxLayer.setVisibility(visibility);
        }

        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolveLayerOpacity</span>(<span class="hljs-params">layerOpacity</span>) </span>{
            <span class="hljs-keyword">return</span> layerOpacity.default || <span class="hljs-number">1</span>;
        }

        <span class="hljs-comment">/**
        * Sets up loading event handlers and initializes the .ramp object of a layer
        * Circular reference errors prevent us from calling LayerLoader directly from this module
        *
        * @private
        * @method prepLayer
        * @param  {Object} layer layer to be prepped
        * @param  {Object} config config object for the layer
        * @param  {Boolean} userLayer optional.  indicates if layer was added by a user.  default value is false
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">prepLayer</span>(<span class="hljs-params">layer, config, userLayer</span>) </span>{
            layer.ramp = {
                config: config,
                user: <span class="hljs-keyword">typeof</span> userLayer === <span class="hljs-string">'boolean'</span> ? userLayer : <span class="hljs-literal">false</span>,
                load: {
                    state: <span class="hljs-string">"loading"</span>,
                    inLS: <span class="hljs-literal">false</span>,  <span class="hljs-comment">//layer has entry in layer selector</span>
                    inCount: <span class="hljs-literal">false</span>  <span class="hljs-comment">//layer is included in the layer counts</span>
                }
            };

            layer.on(<span class="hljs-string">'load'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>console.log(âPREP LOAD OK â + evt.layer.url);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                topic.publish(EventManager.LayerLoader.LAYER_LOADED, { layer: evt.layer });
            });

            layer.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>console.log(âPREP LOAD FAIL â + evt.target.url);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                evt.target.ramp.loadOk = <span class="hljs-literal">false</span>;
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'layer failed to load'</span>);
                <span class="hljs-built_in">console</span>.log(evt);
                topic.publish(EventManager.LayerLoader.LAYER_ERROR, {
                    layer: evt.target,
                    error: evt.error
                });
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>since the update-start event doesnât let you know who threw it (supposed to but doesnât), we need to tack the handler
function onto the actual layer object so we can use the âthisâ keyword to grab the sending layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            layer.ramp.load.onUpdateStart = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                topic.publish(EventManager.LayerLoader.LAYER_UPDATING, { layer: <span class="hljs-keyword">this</span> });
            };

            layer.on(<span class="hljs-string">'update-start'</span>, layer.ramp.load.onUpdateStart);</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>add update end handler for layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            layer.on(<span class="hljs-string">'update-end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) </span>{
                topic.publish(EventManager.LayerLoader.LAYER_UPDATED, { layer: evt.target });
            });
        }

        <span class="hljs-keyword">return</span> {
            <span class="hljs-comment">/**
            * For a specified layer, zooms to the closest level that has some visible data.
            * @param {String} layerId a layer id to zoom to.
            * @method zoomToLayerScale
            */</span>
            zoomToLayerScale: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">layerId</span>) </span>{
                <span class="hljs-keyword">var</span> layer = map.getLayer(layerId),
                    lods = map._params.lods,
                    currentLevel = map.getLevel(),
                    topLod,
                    bottomLod,
                    lod,
                    i;</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>gis lesson.
min scale means dont show the layer if zoomed out beyond the min scale
max scale means dont show the layer if zoomed in beyond the max scale
from a numerical perspective, min &gt; max (as the scale number represents 1/number )</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; lods.length; i += <span class="hljs-number">1</span>) {
                    lod = lods[i];</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>console.log(âlodâ, lod, lod.scale &gt; layer.minScale);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (!topLod &amp;&amp; lod.scale &lt;= layer.minScale) {
                        topLod = lod;
                    }

                    <span class="hljs-keyword">if</span> (!bottomLod &amp;&amp; lod.scale &lt;= layer.maxScale) {
                        bottomLod = lods[<span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, i - <span class="hljs-number">1</span>)];
                    }
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>assign defaults for open-ended ranges
we will never have the case where both values are 0, as in that case the layer is visible everywhere, and this
function will not be called (itâs only used when layer is out-of-scale range).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">if</span> (layer.minScale === <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>no ceiling.  top = bottom</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    topLod = bottomLod;
                }

                <span class="hljs-keyword">if</span> (layer.maxScale === <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>no floor.  bottom = top</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    bottomLod = topLod;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>console.log(topLod, bottomLod, map.getLevel(), map.getZoom(), Math.abs(topLod.level - currentLevel) &lt;= Math.abs(bottomLod.level - currentLevel));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(topLod.level - currentLevel) &lt;= <span class="hljs-built_in">Math</span>.abs(bottomLod.level - currentLevel)) {
                    map.setZoom(topLod.level);
                } <span class="hljs-keyword">else</span> {
                    map.setZoom(bottomLod.level);
                }
            },

            <span class="hljs-comment">/**
            * For a specified layer, determine if the layer's scale fit into map LOD range.
            * Return ture if in range
            * @param { number } maxScale maximum scale.
            * @param { number } minScale minimum scale
            * @method layerInLODRange
            * @type { boolean }
            */</span>
            layerInLODRange: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">maxScale, minScale</span>) </span>{
                <span class="hljs-keyword">var</span> lods = map._params.lods,                    
                    topLod = -<span class="hljs-number">1</span>,
                    bottomLod = -<span class="hljs-number">1</span>,
                    lod,
                    i,
                    inRange = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>gis lesson.
min scale means dont show the layer if zoomed out beyond the min scale
max scale means dont show the layer if zoomed in beyond the max scale
from a numerical perspective, min &gt; max (as the scale number represents 1/number )</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                
                <span class="hljs-keyword">if</span> (maxScale === <span class="hljs-number">0</span>) {
                    bottomLod = <span class="hljs-number">0</span>; 
                }

                <span class="hljs-keyword">if</span> (minScale === <span class="hljs-number">0</span>) {
                    topLod = <span class="hljs-number">0</span>;
                }

                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; lods.length; i += <span class="hljs-number">1</span>) {
                    lod = lods[i];

                    <span class="hljs-keyword">if</span> (topLod === -<span class="hljs-number">1</span> &amp;&amp; lod.scale &lt;= minScale) {
                        topLod = lod;
                    }

                    <span class="hljs-keyword">if</span> (bottomLod === -<span class="hljs-number">1</span> &amp;&amp; lod.scale &lt;= maxScale) {
                        bottomLod = lods[<span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, i - <span class="hljs-number">1</span>)];
                    } 
                }

                <span class="hljs-keyword">if</span> (maxScale === <span class="hljs-number">0</span> &amp;&amp; minScale === <span class="hljs-number">0</span>) {                    
                    inRange = <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (minScale === <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>check only maxScale (bottomLod)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    inRange = (bottomLod === -<span class="hljs-number">1</span>) ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>; 
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (maxScale === <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>check only minScale (topLod)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    inRange = (topLod === -<span class="hljs-number">1</span>) ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>; 
                } <span class="hljs-keyword">else</span> {
                    inRange = (topLod !== -<span class="hljs-number">1</span> &amp;&amp; bottomLod !== -<span class="hljs-number">1</span>);
                }

                <span class="hljs-keyword">return</span> inRange;
                
            },

            <span class="hljs-comment">/**
            * The maximum extent of the map control is allowed to go to
            * @property getMaxExtent
            * @type {Object}
            *
            */</span>
            getMaxExtent: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> maxExtent;
            },
            <span class="hljs-comment">/**
            * Return the map control object
            * @property getMap
            * @type {Object}
            *
            */</span>
            getMap: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (!map) {
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"trying to get map before it is available!"</span>);
                }
                <span class="hljs-keyword">return</span> map;
            },

            <span class="hljs-comment">/**
            * Returns a list of feature layers that are currently visible on the map.
            * @method getVisibleFeatureLayers
            * @return {Array} an array of {{#crossLink "Esri/layers/FeatureLayer"}}{{/crossLink}} objects
            *
            */</span>
            getVisibleFeatureLayers: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Return only the feature layers
TODO do we need to consider static layers here?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">return</span> dojoArray.filter(map.getLayersVisibleAtScale(), <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">layer</span>) </span>{
                    <span class="hljs-keyword">return</span> layer.type &amp;&amp; (layer.type === <span class="hljs-string">"Feature Layer"</span>) &amp;&amp; layer.visible;
                });
            },

            getVisibleLayers: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> map.getLayersVisibleAtScale();
            },

            getInvisibleLayers: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">var</span> visibleLayers,
                    allLayers,
                    invisibleLayers;

                visibleLayers = <span class="hljs-keyword">this</span>.getVisibleLayers();
                allLayers = map._layers;
                invisibleLayers = [];

                UtilDict.forEachEntry(allLayers, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, value</span>) </span>{
                    <span class="hljs-keyword">var</span> index = UtilArray.indexOf(visibleLayers, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">vl</span>) </span>{
                        <span class="hljs-keyword">return</span> key === vl.id;
                    });

                    <span class="hljs-keyword">if</span> (index === -<span class="hljs-number">1</span>) {
                        invisibleLayers.push(value);
                    }
                });

                <span class="hljs-keyword">return</span> invisibleLayers;
            },

            <span class="hljs-comment">/**
            * Returns the mapping of feature layer ids to assocciated bounding box layers.
            * @method getBoundingBoxMapping
            * @return {Object} A dictionary of String, {{#crossLink "Esri/layers/GraphicsLayer"}}{{/crossLink}} pairs.
            *
            */</span>
            getBoundingBoxMapping: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> boundingBoxMapping;
            },

            <span class="hljs-comment">/**
            * Return the feature layer corresponding to the given id.
            *
            * @method getFeatureLayer
            * @private
            * @param {String} featureId the id of the feature layer
            * @return {Esri/layers/FeatureLayer} feature layer
            */</span>
            getFeatureLayer: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">featureId</span>) </span>{
                <span class="hljs-keyword">return</span> map.getLayer(featureId);
            },

            <span class="hljs-comment">/**
            * Apply extent defaulting prior to URL overrides.
            *
            * @method applyExtentDefaulting
            * @private
            */</span>
            applyExtentDefaulting: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>if full extent is missing, set to default extent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (!(RAMP.config.extents.fullExtent)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>need to deserialize/reserialize to avoid pointing to actual defaultExtent, which may be changed later by the Bookmark Link module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    RAMP.config.extents.fullExtent = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify(RAMP.config.extents.defaultExtent));
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>if maximum extent is missing, set to full extent.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (!(RAMP.config.extents.maximumExtent)) {
                    RAMP.config.extents.maximumExtent = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify(RAMP.config.extents.fullExtent));
                }
            },

            <span class="hljs-comment">/**
            * initiate the projection of the config extents to basemap extents
            *
            * @method projectConfigExtents
            */</span>
            projectConfigExtents: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>extract default basemap projection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> mapSR = <span class="hljs-keyword">new</span> SpatialReference(RAMP.config.basemaps[RAMP.config.initialBasemapIndex].spatialReference);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>project the default extent.  when finished, process full extent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                projectExtent(RAMP.config.extents.defaultExtent, mapSR, projectFullExtent);
            },

            <span class="hljs-comment">/**
            * Given an ESRI Extent Object, returns a new ESRI Extent Object that
            * contains the extent adjusted according to this map's maximum extent
            *
            * <span class="hljs-doctag"><span class="hljs-keyword">NOTE</span></span>: this method is currently unused!
            *
            * @param {esri/geometry/Extent} e the extent Object
            * @param {esri/geometry/Extent} maxExtent the maximum extent
            * @return {esri/geometry/Extent} An adjusted extent, if the target extent is outside the boundary
            * @method checkBoundary
            */</span>
            checkBoundary: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e, maxExtent</span>) </span>{
                <span class="hljs-keyword">var</span> extent = e,
                width = extent.width(),
                height = extent.height(),
                centerX = extent.centerX(),
                centerY = extent.centerY(),
                flag, adjustedEx;

                adjustedEx = extent.clone();

                <span class="hljs-keyword">var</span> maxHeight = maxExtent.height();
                <span class="hljs-keyword">if</span> (height &gt; maxHeight) {
                    height = maxHeight;
                }

                <span class="hljs-keyword">if</span> (centerY &gt; maxExtent.ymax) {
                    adjustedEx.ymax = maxExtent.ymax;
                    adjustedEx.ymin = maxExtent.ymax - height;
                    flag = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>} else if (extent.ymin &lt; maxExtent.ymin) {</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (centerY &lt; maxExtent.ymin) {
                    adjustedEx.ymin = maxExtent.ymin;
                    adjustedEx.ymax = maxExtent.ymin + height;
                    flag = <span class="hljs-literal">true</span>;
                }

                <span class="hljs-keyword">var</span> maxWidth = maxExtent.width();
                <span class="hljs-keyword">if</span> (width &gt; maxWidth) {
                    width = maxWidth;
                }

                <span class="hljs-keyword">if</span> (centerX &gt; maxExtent.xmax) {
                    adjustedEx.xmax = maxExtent.xmax;
                    adjustedEx.xmin = maxExtent.xmax - width;
                    flag = <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (centerX &lt; maxExtent.xmin) {
                    adjustedEx.xmin = maxExtent.xmin;
                    adjustedEx.xmax = maxExtent.xmin + width;
                    flag = <span class="hljs-literal">true</span>;
                }

                <span class="hljs-keyword">if</span> (flag) {
                    <span class="hljs-keyword">return</span> adjustedEx;
                }
            },

            <span class="hljs-comment">/**
           * Create a new FeatureLayer object based on the config input
           *
           * @method makeFeatureLayer
           * @param {Object} layerConfig config object for the layer to create
           * @param {Boolean} userLayer optional specifies if layer was added by a user
           * @return {Esri/layers/FeatureLayer} feature layer object (unloaded)
           */</span>
            makeFeatureLayer: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">layerConfig, userLayer</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>TODO: source of possible errors; add error handling</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> fl = <span class="hljs-keyword">new</span> FeatureLayer(layerConfig.url, {
                    id: layerConfig.id,
                    mode: FeatureLayer.MODE_SNAPSHOT,
                    outFields: [layerConfig.layerAttributes],
                    visible: layerConfig.settings.visible,
                    opacity: resolveLayerOpacity(layerConfig.settings.opacity),
                    maxAllowableOffset: layerConfig.maxAllowableOffset
                });

                prepLayer(fl, layerConfig, userLayer);

                fl.ramp.type = GlobalStorage.layerType.feature;

                <span class="hljs-keyword">return</span> fl;
            },

            <span class="hljs-comment">/**
           * Return the feature layer corresponding to the given url.
           *
           * @method makeWmsLayer
           * @param {Object} layerConfig config object for the layer to create
           * @param {Boolean} userLayer optional specifies if layer was added by a user
           * @return {Esri/layers/WMSLayer} WMS layer
           */</span>

            makeWmsLayer: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">layerConfig, userLayer</span>) </span>{
                <span class="hljs-keyword">var</span> wmsl = <span class="hljs-keyword">new</span> WMSLayer(layerConfig.url, {
                    id: layerConfig.id,
                    format: layerConfig.format,
                    opacity: resolveLayerOpacity(layerConfig.settings.opacity),
                    visibleLayers: [layerConfig.layerName]</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>resourceInfo: {
   extent: new EsriExtent(layer.extent),
   layerInfos: [new WMSLayerInfo({name:layer.layerName,title:layer.displayName})]
}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                });

                prepLayer(wmsl, layerConfig, userLayer);

                wmsl.ramp.type = GlobalStorage.layerType.wms;

                wmsl.setVisibility(layerConfig.settings.visible);

                <span class="hljs-keyword">return</span> wmsl;
            },

            <span class="hljs-comment">/**
            * Return the static layer corresponding to the given url.
            *
            * @method makeStaticLayer
            * @private
            * @param {Object} layerConfig config object for the layer to create
            * @param {Boolean} userLayer optional specifies if layer was added by a user
            * @return {Object} layer object of the appropriate type
            */</span>

            makeStaticLayer: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">layerConfig, userLayer</span>) </span>{
                <span class="hljs-keyword">var</span> tempLayer,
                    layerType = layerConfig.layerType || <span class="hljs-string">"feature"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>determine layer type and process</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">switch</span> (layerType) {
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"feature"</span>:
                        tempLayer = <span class="hljs-keyword">new</span> FeatureLayer(layerConfig.url, {
                            opacity: resolveLayerOpacity(layerConfig.settings.opacity),
                            mode: FeatureLayer.MODE_SNAPSHOT,
                            visible: layerConfig.settings.visible,
                            id: layerConfig.id,
                            maxAllowableOffset: layerConfig.maxAllowableOffset
                        });

                        prepLayer(tempLayer, layerConfig, userLayer);

                        tempLayer.ramp.type = GlobalStorage.layerType.Static;

                        <span class="hljs-keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>We are currently not supporting other static layer types at the moment.
Future versions should re-implement these cases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-comment">/*
                    case "tile":
                        tempLayer = new ArcGISTiledMapServiceLayer(staticLayer.url, {
                            opacity: resolveLayerOpacity(staticLayer.settings.opacity),
                            id: staticLayer.id
                        });
                        console.log("tile layer added. " + staticLayer.id);
                        break;

                    case "dynamic":
                        tempLayer = new ArcGISDynamicMapServiceLayer(staticLayer.url, {
                            opacity: resolveLayerOpacity(staticLayer.settings.opacity),
                            id: staticLayer.id
                        });
                        console.log("dynamic layer added. " + staticLayer.id);
                        break;
                        */</span>

                    <span class="hljs-keyword">default</span>:
                        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"unknown static layer type encountered: "</span> + layerType);
                        <span class="hljs-keyword">break</span>;
                }
                <span class="hljs-keyword">return</span> tempLayer;
            },

            <span class="hljs-comment">/**
            * Adds custom ramp properties to layer.  Adds handlers to loading events.
            *
            * @method enhanceLayer
            * @param  {Object} layer layer to be prepped
            * @param  {Object} config config object for the layer
            * @param  {Boolean} userLayer optional.  indicates if layer was added by a user.  default value is false
            */</span>
            enhanceLayer: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">layer, config, userLayer</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>call the private function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                prepLayer(layer, config, userLayer);
            },

            <span class="hljs-comment">/**
            * Will project an extent to a desired spatial reference, using client side projection library.
            * Avoids the need for Esri Geometry Service
            *
            * @method localProjectExtent
            * @param  {Esri/Extent} extent extent to be projected
            * @param {Esri/SpatialReference} sr {{#crossLink "Esri/SpatialReference"}}{{/crossLink}} to project to
            * @return {Esri/Extent} extent in the desired projection
            */</span>
            localProjectExtent: localProjectExtent,

            <span class="hljs-comment">/*
            * Initialize map control with configuration objects provided in the bootstrapper.js file.
            *
            * Initialize extent
            * Generate and load initial base map
            * Generate map layer objects
            * Show scalebar
            * Publish events to outside for other modules to use
            * Subscribe events to update map control
            *
            * @method init
            * @param {Object} mapDiv the HTML div that will store the map control
            * @constructor
            *
            */</span>
            init: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>,

                schemaBasemap = RAMP.config.basemaps[RAMP.config.initialBasemapIndex],

                <span class="hljs-comment">/**
                * The URL of the first layer of the basemap that is on by default.
                *
                * @property url
                * @private
                * @type {String}
                */</span>
                url = schemaBasemap.layers[<span class="hljs-number">0</span>].url,

                <span class="hljs-comment">/**
                * The basemap layer
                *
                * @property baseLayer
                * @private
                * @type {Esri/layers/ArcGISTiledMapServiceLayer}
                */</span>
                baseLayer = <span class="hljs-keyword">new</span> ArcGISTiledMapServiceLayer(url, {
                    id: <span class="hljs-string">"basemapLayer"</span>
                }),

                loadListener = baseLayer.on(<span class="hljs-string">'update-end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>only load things once, pls!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    loadListener.remove();</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>basemap has loaded.  continue on with the map loading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    topic.publish(EventManager.Map.INITIAL_BASEMAP_LOADED);
                });

                baseLayer.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">evt</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>basemap has died.  long live the basemap.
TODO some proper error handling here.  error page?  message to user of catastrophic failure?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'initial basemap failed to load: '</span> + evt.error.message);
                    <span class="hljs-built_in">window</span>.location.href = RAMP.config.mapInitFailUrl;
                });

                <span class="hljs-comment">/**
                * The initial extent of the map
                *
                * @property InitExtent
                * @private
                * @type {esri/geometry/Extent}
                */</span>
                initExtent = <span class="hljs-keyword">new</span> EsriExtent(RAMP.config.extents.defaultExtent);

                <span class="hljs-comment">/**
                * Used for full extent in nav widget
                *
                * @property fullExtent
                * @private
                * @type {esri/geometry/Extent}
                */</span>
                fullExtent = <span class="hljs-keyword">new</span> EsriExtent(RAMP.config.extents.fullExtent);

                <span class="hljs-comment">/**
                * The maximum extent of the map
                *
                * @property maxExtent
                * @private
                * @type {esri/geometry/Extent}
                */</span>
                maxExtent = <span class="hljs-keyword">new</span> EsriExtent(RAMP.config.extents.maximumExtent);</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>generate WMS layers array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                wmsLayers = dojoArray.map(RAMP.config.layers.wms, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">layer</span>) </span>{
                    <span class="hljs-keyword">return</span> that.makeWmsLayer(layer);
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>generate feature layers array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                featureLayers = dojoArray.map(RAMP.config.layers.feature, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">layerConfig</span>) </span>{
                    <span class="hljs-keyword">var</span> fl;

                    <span class="hljs-keyword">if</span> (layerConfig.isStatic) {
                        fl = that.makeStaticLayer(layerConfig);
                    } <span class="hljs-keyword">else</span> {
                        fl = that.makeFeatureLayer(layerConfig);
                    }

                    <span class="hljs-keyword">return</span> fl;
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>determine the basmap wkid from config</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> tileSchema = schemaBasemap.tileSchema;</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>add custom level of details if lod exists in config.json</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (tileSchema) {
                    <span class="hljs-keyword">var</span> levelOfDetails = UtilArray.find(RAMP.config.LODs, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">configLOD</span>) </span>{
                        <span class="hljs-keyword">return</span> configLOD.tileSchema === tileSchema;
                    });</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>the map!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    map = <span class="hljs-keyword">new</span> EsriMap(RAMP.config.divNames.map, {
                        extent: initExtent,
                        logo: <span class="hljs-literal">false</span>,
                        minZoom: RAMP.config.zoomLevels.min,
                        maxZoom: RAMP.config.zoomLevels.max,
                        slider: <span class="hljs-literal">false</span>,
                        lods: levelOfDetails.lod
                    });
                } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>the map!</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    map = <span class="hljs-keyword">new</span> EsriMap(RAMP.config.divNames.map, {
                        extent: initExtent,
                        logo: <span class="hljs-literal">false</span>,
                        minZoom: RAMP.config.zoomLevels.min,
                        maxZoom: RAMP.config.zoomLevels.max,
                        slider: <span class="hljs-literal">false</span>
                    });
                }

                RAMP.map = map;
                MapClickHandler.init(map);

                <span class="hljs-comment">/*  START - Add static layers   */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>NOTE: this type of thing is not currenlty supported by the config schema.  Need to revisit and determine if we want to keep this code or not.
this only deals with static layers that are bound to a feature layer.  stand alone static layers are handled like normal feature layers</p>

            </div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>if this does get implemented, this code should be moved to the layerLoader.js onLayerLoaded function.  After a feature layer successfully loads,
we should then load any of itâs static layers.  Extra tricky because these static layers do not appear in the layer selector (their state is bound
to the feature layer.
may want to consider another layerType .BoundStatic</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">var</span> staticLayers = [],
                    perLayerStaticMaps = [],
                    staticLayerMap = [];

                dojoArray.forEach(RAMP.config.layers.feature, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">layer</span>) </span>{
                    perLayerStaticMaps = [];
                    dojoArray.forEach(layer.staticLayers, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">staticLayer, i</span>) </span>{
                        <span class="hljs-keyword">var</span> tempLayer = that.makeStaticLayer(staticLayer);

                        staticLayers.push(tempLayer);</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>creates an array of all static layers defined for the current, single feature layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        perLayerStaticMaps[i] = staticLayer.id;
                    });</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>adds the static layer id array as a value to an array indexed by feature layer id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    staticLayerMap[layer.id] = perLayerStaticMaps;
                });

                RAMP.staticLayerMap = staticLayerMap;

                <span class="hljs-comment">/*  End - Add static layers   */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>This was intended to be used to distinguish layers from each other when crawling; Looks like we are not using it. Commenting out for now. SZ</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                baseLayer.ramp = {
                    type: GlobalStorage.layerType.Basemap
                };</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>save layer objects to load after basemap.
static layers is currently empty always</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                RAMP.startupLayers = wmsLayers.concat(staticLayers, featureLayers);</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>add the basemap</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                map.addLayer(baseLayer);

                <span class="hljs-comment">/* Start - Show scalebar */</span>
                <span class="hljs-keyword">var</span> scalebar = <span class="hljs-keyword">new</span> EsriScalebar({
                    map: map,
                    attachTo: <span class="hljs-string">"bottom-left"</span>,
                    scalebarUnit: <span class="hljs-string">"metric"</span>
                });

                scalebar.show();

                <span class="hljs-comment">/* End - Show scalebar */</span>

                _initRepublishers(map);
                _initListeners(map);
                _initEventHandlers(map);
            }
        };
    });</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
