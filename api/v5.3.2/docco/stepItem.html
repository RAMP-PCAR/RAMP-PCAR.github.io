<!DOCTYPE html>

<html>
<head>
  <title>stepItem.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="advancedToolbar.html">
                advancedToolbar.js
              </a>
            
              
              <a class="source" href="basemapSelector.html">
                basemapSelector.js
              </a>
            
              
              <a class="source" href="bookmarkLink.html">
                bookmarkLink.js
              </a>
            
              
              <a class="source" href="dataLoader.html">
                dataLoader.js
              </a>
            
              
              <a class="source" href="dataLoaderGui.html">
                dataLoaderGui.js
              </a>
            
              
              <a class="source" href="datagrid.html">
                datagrid.js
              </a>
            
              
              <a class="source" href="datagridClickHandler.html">
                datagridClickHandler.js
              </a>
            
              
              <a class="source" href="eventManager.html">
                eventManager.js
              </a>
            
              
              <a class="source" href="featureClickHandler.html">
                featureClickHandler.js
              </a>
            
              
              <a class="source" href="featureHighlighter.html">
                featureHighlighter.js
              </a>
            
              
              <a class="source" href="filterManager.html">
                filterManager.js
              </a>
            
              
              <a class="source" href="geoSearch.html">
                geoSearch.js
              </a>
            
              
              <a class="source" href="globalStorage.html">
                globalStorage.js
              </a>
            
              
              <a class="source" href="graphicExtension.html">
                graphicExtension.js
              </a>
            
              
              <a class="source" href="gui.html">
                gui.js
              </a>
            
              
              <a class="source" href="imageExport.html">
                imageExport.js
              </a>
            
              
              <a class="source" href="layerGroup.html">
                layerGroup.js
              </a>
            
              
              <a class="source" href="layerItem.html">
                layerItem.js
              </a>
            
              
              <a class="source" href="layerLoader.html">
                layerLoader.js
              </a>
            
              
              <a class="source" href="map.html">
                map.js
              </a>
            
              
              <a class="source" href="mapClickHandler.html">
                mapClickHandler.js
              </a>
            
              
              <a class="source" href="maptips.html">
                maptips.js
              </a>
            
              
              <a class="source" href="navigation.html">
                navigation.js
              </a>
            
              
              <a class="source" href="quickzoom.html">
                quickzoom.js
              </a>
            
              
              <a class="source" href="ramp.html">
                ramp.js
              </a>
            
              
              <a class="source" href="stepItem.html">
                stepItem.js
              </a>
            
              
              <a class="source" href="theme.html">
                theme.js
              </a>
            
              
              <a class="source" href="RAMP-starter.html">
                RAMP-starter.js
              </a>
            
              
              <a class="source" href="areaTool.html">
                areaTool.js
              </a>
            
              
              <a class="source" href="baseTool.html">
                baseTool.js
              </a>
            
              
              <a class="source" href="bufferTool.html">
                bufferTool.js
              </a>
            
              
              <a class="source" href="distanceTool.html">
                distanceTool.js
              </a>
            
              
              <a class="source" href="populationTool.html">
                populationTool.js
              </a>
            
              
              <a class="source" href="array.html">
                array.js
              </a>
            
              
              <a class="source" href="bricks.html">
                bricks.js
              </a>
            
              
              <a class="source" href="checkbox.html">
                checkbox.js
              </a>
            
              
              <a class="source" href="checkboxGroup.html">
                checkboxGroup.js
              </a>
            
              
              <a class="source" href="decorator.html">
                decorator.js
              </a>
            
              
              <a class="source" href="dictionary.html">
                dictionary.js
              </a>
            
              
              <a class="source" href="functionMangler.html">
                functionMangler.js
              </a>
            
              
              <a class="source" href="popupManager.html">
                popupManager.js
              </a>
            
              
              <a class="source" href="prototype.html">
                prototype.js
              </a>
            
              
              <a class="source" href="tmplHelper.html">
                tmplHelper.js
              </a>
            
              
              <a class="source" href="tmplUtil.html">
                tmplUtil.js
              </a>
            
              
              <a class="source" href="url.html">
                url.js
              </a>
            
              
              <a class="source" href="util.html">
                util.js
              </a>
            
              
              <a class="source" href="bootstrapper.html">
                bootstrapper.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>stepItem.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>﻿<span class="hljs-comment">/* global define, $, TimelineLite */</span>

<span class="hljs-comment">/**
* @module RAMP
* @submodule FilterManager
* @main FilterManager
*/</span>

<span class="hljs-comment">/**
* Creates a step in the choice tree. A step item can contain several bricks in it and can take different states. Each step can advance and retreat by either displaying its selected child or hiding it.
* 
* ####Imports RAMP Modules:
* {{#crossLink "Util"}}{{/crossLink}}  
* {{#crossLink "TmplHelper"}}{{/crossLink}}  
* {{#crossLink "TmplUtil"}}{{/crossLink}}  
* {{#crossLink "Array"}}{{/crossLink}}  
* {{#crossLink "Dictionary"}}{{/crossLink}}  
* {{#crossLink "Bricks"}}{{/crossLink}}    
*  
* 
* ####Uses RAMP Templates:
* {{#crossLink "templates/layer_selector_template.json"}}{{/crossLink}}
* 
* @class StepItem
* @constructor
* @uses dojo/Evented
* @uses dojo/_base/declare
* @uses dojo/lang
* @uses dojo/Deferred
* 
* @param {Object} config a config definition of the step item
* @param {String} config.id step item it; can be anything
* @param {Number} config.level level of this step item
* @param {Array} config.content an array of Brick configuration objects
* @param {String} config.content.[].id content brick id
* @param {Brick} config.content.[].type type of the content brick
* @param {Object} config.content.[].config a brick config object that will be passed to Brick.new() init function
* @param {Array} config.content.[].on a set of callbacks set on the create Brick object
* @param {String} config.content.[].on.[].eventName a name of the Brick event the callback should react to
* @param {Function} config.content.[].on.[].callback a function to be executed when the specified event is fired
* 
* @return {StepItem} A built StepItem object.
*/</span>

define([
    <span class="hljs-string">"dojo/Evented"</span>, <span class="hljs-string">"dojo/_base/declare"</span>, <span class="hljs-string">"dojo/_base/lang"</span>, <span class="hljs-string">"dojo/Deferred"</span>,

    <span class="hljs-comment">/* Text */</span>
    <span class="hljs-string">"dojo/text!./templates/filter_manager_template.json"</span>,

    <span class="hljs-comment">/* Util */</span>
    <span class="hljs-string">"utils/util"</span>, <span class="hljs-string">"utils/tmplHelper"</span>, <span class="hljs-string">"utils/tmplUtil"</span>, <span class="hljs-string">"utils/array"</span>, <span class="hljs-string">"utils/dictionary"</span>, <span class="hljs-string">"utils/bricks"</span>
],
    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">
        Evented, declare, lang, Deferred,

        <span class="hljs-comment">/* Text */</span>
        filter_manager_template,

        <span class="hljs-comment">/* Util */</span>
        UtilMisc, TmplHelper, TmplUtil, UtilArray, UtilDict, Bricks
    </span>) </span>{
<span class="hljs-pi">        "use strict"</span>;

        <span class="hljs-keyword">var</span> StepItem,
            ALL_STATES_CLASS,

            templates = <span class="hljs-built_in">JSON</span>.parse(TmplHelper.stringifyTemplate(filter_manager_template));

        StepItem = declare([Evented], {
            constructor: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">config</span>) </span>{
                <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>declare individual properties inside the constructor: <a href="http://dojotoolkit.org/reference-guide/1.9/dojo/_base/declare.html#id6">http://dojotoolkit.org/reference-guide/1.9/dojo/_base/declare.html#id6</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                lang.mixin(<span class="hljs-keyword">this</span>,
                    {
                        <span class="hljs-comment">/**
                         * Layer id. Upon initialization, `id` can be overwritten by `config.id` value. 
                         *
                         * @property id
                         * @type String
                         * @default null
                         */</span>
                        id: <span class="hljs-literal">null</span>,

                        <span class="hljs-comment">/**
                         * Indicates the level of the step, or how far down the tree this step appears. 
                         * 
                         * @property level
                         * @type Number
                         * @default 0
                         * 
                         */</span>
                        level: <span class="hljs-number">0</span>,

                        <span class="hljs-comment">/**
                         * A node of the StepItem.
                         *
                         * @property node
                         * @type JObject
                         * @default null
                         */</span>
                        node: <span class="hljs-literal">null</span>,

                        <span class="hljs-comment">/**
                         * An array of Brick configs and other related properties.
                         * 
                         * @property content
                         * @type {Array}
                         * @default null
                         * @private
                         * @example
                         *     [{
                         *        id: "sourceType",
                         *        type: Bricks.ChoiceBrick,
                         *        config: {
                         *            header: i18n.t("addDataset.dataSource"),
                         *            instructions: i18n.t("addDataset.help.dataSource"),
                         *            choices: [
                         *                {
                         *                    key: "serviceTypeStep",
                         *                    value: i18n.t("addDataset.dataSourceService")
                         *                },
                         *                {
                         *                    key: "fileTypeStep",
                         *                    value: i18n.t("addDataset.dataSourceFile")
                         *                }
                         *            ]
                         *        },
                         *        on: [
                         *            {
                         *                eventName: Bricks.ChoiceBrick.event.CHANGE,
                         *                //expose: { as: "advance" },
                         *                callback: choiceTreeCallbacks.simpleAdvance
                         *            }
                         *        ]
                         *       }]
                         * 
                         */</span>
                        content: <span class="hljs-literal">null</span>,

                        <span class="hljs-comment">/**
                         * A collection of build Bricks that can accessed by their ids.
                         * 
                         * @property contentBricks
                         * @type {Object}
                         * @default {}
                         */</span>
                        contentBricks: {},

                        <span class="hljs-comment">/**
                         * Default template used for building step items.
                         * 
                         * @property template
                         * @type {String}
                         * @default "default_step_template"
                         */</span>
                        template: <span class="hljs-string">"default_step_template"</span>,

                        <span class="hljs-comment">/**
                         * Node of the content div.
                         * 
                         * @private
                         * @property _contentNode
                         * @default null
                         */</span>
                        _contentNode: <span class="hljs-literal">null</span>,
                        <span class="hljs-comment">/**
                         * Node of the options container.
                         * 
                         * @private
                         * @property _optionsContainerNode
                         * @default null
                         */</span>
                        _optionsContainerNode: <span class="hljs-literal">null</span>,
                        <span class="hljs-comment">/**
                         * Node of the options background node. It's used to change the state of the child steps - SUCCESS, ERROR, etc.
                         * 
                         * @private
                         * @property _optionsBackgroundNode
                         * @default null
                         */</span>
                        _optionsBackgroundNode: <span class="hljs-literal">null</span>,
                        <span class="hljs-comment">/**
                         * Node of the options div.
                         * 
                         * @private
                         * @property _optionsNode
                         * @default null
                         */</span>
                        _optionsNode: <span class="hljs-literal">null</span>,

                        <span class="hljs-comment">/**
                         * A collection of the child step items of this step item. Should not be accessed directly.
                         * 
                         * @private
                         * @property _childSteps
                         * @default {}
                         */</span>
                        _childSteps: {},

                        <span class="hljs-comment">/**
                         * A step item of the currently active child of this step item. If there is no active child, it means that a choice or action hasn't been made on this step yet or it's the last step in the branch.
                         * 
                         * @private
                         * @property _activeChildStep
                         * @default null
                         */</span>
                        _activeChildStep: <span class="hljs-literal">null</span>,

                        <span class="hljs-comment">/**
                         * A step item of the parent step item if any. Used only for animating background when opening/collapsing (error) notices.
                         * 
                         * @private
                         * @property _parent
                         * @default null
                         */</span>
                        _parent: <span class="hljs-literal">null</span>,

                        <span class="hljs-comment">/**
                         * An object containing some data. This is used like that: when the step is advanced, a data object is provided by external code; this object is then passed to whichever child is being advanced so it can be retrieved later without external code having to store it somewhere.
                         * 
                         * @private
                         * @property _stepData
                         * @default null
                         */</span>
                        _stepData: {},

                        <span class="hljs-comment">/**
                         * The current state of this step item.
                         * 
                         * @private
                         * @property _state
                         * @default StepItem.state.DEFAULT,
                         */</span>
                        _state: StepItem.state.DEFAULT,

                        <span class="hljs-comment">/**
                         * A timeline of this step item. Used for animation
                         * 
                         * @private
                         * @property _timeline
                         */</span>
                        _timeline: <span class="hljs-keyword">new</span> TimelineLite({ paused: <span class="hljs-literal">true</span> }),
                        <span class="hljs-comment">/**
                         * A default duration value for all single transitions of any elements of this step.
                         * 
                         * @private
                         * @property _transitionDuration
                         * @default 0.4
                         */</span>
                        _transitionDuration: <span class="hljs-number">0.4</span>
                    },
                    config
                );

                <span class="hljs-keyword">this</span>.node = $(TmplHelper.template.call(<span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>.template, config, templates));

                <span class="hljs-keyword">this</span>._contentNode = <span class="hljs-keyword">this</span>.node.find(<span class="hljs-string">"&gt; .step-content"</span>);
                <span class="hljs-keyword">this</span>._optionsContainerNode = <span class="hljs-keyword">this</span>.node.find(<span class="hljs-string">"&gt; .step-options-container"</span>);
                <span class="hljs-keyword">this</span>._optionsBackgroundNode = <span class="hljs-keyword">this</span>._optionsContainerNode.find(<span class="hljs-string">"&gt; .options-bg"</span>);
                <span class="hljs-keyword">this</span>._optionsNode = <span class="hljs-keyword">this</span>._optionsContainerNode.find(<span class="hljs-string">"&gt; .step-options"</span>);

                <span class="hljs-keyword">this</span>.content.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">contentItem</span>) </span>{
                    that._addContentBrick(contentItem);
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>console.debug(“—&gt;”, this._state);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            },

            <span class="hljs-comment">/**
             * Instantiates and adds a new brick to this step item.
             * 
             * @method _addContentBrick
             * @param {Object} contentItem a config object for a Brick
             * @param {Object} contentItem.id Brick id
             * @param {Object} contentItem.config actual Brick config
             * @private
             */</span>
            _addContentBrick: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">contentItem</span>) </span>{
                <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>,
                    contentBrick = contentItem.type.new(contentItem.id, contentItem.config);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>if it’s a multiBrick, add individual bricks from its content to the main content and wire them as separate bricks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (Bricks.MultiBrick === contentItem.type) {

                    contentBrick.content.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">contentItem</span>) </span>{
                        that._wireBrickUp(contentItem, contentBrick.contentBricks[contentItem.id]);
                    });

                } <span class="hljs-keyword">else</span> {
                    that._wireBrickUp(contentItem, contentBrick);
                }

                <span class="hljs-keyword">this</span>._contentNode.append(contentBrick.node);

                <span class="hljs-keyword">this</span>._doInternalCheck();
            },

            <span class="hljs-comment">/**
             * Wire up listeners on the given Brick.
             * 
             * @method _wireBrickUp
             * @param  {Object} contentItem  a config object for a Brick
             * @param  {Object} contentBrick an actual Brick instance
             * @private
             */</span>
            _wireBrickUp: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">contentItem, contentBrick</span>) </span>{
                <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
                <span class="hljs-keyword">this</span>.contentBricks[contentBrick.id] = contentBrick;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>set brick events if specified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (contentItem.on) {
                    contentItem.on.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">o</span>) </span>{
                        contentBrick.on(o.eventName, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>if there is a callback specified, call it in the context of the brick</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">if</span> (o.callback) {
                                o.callback.call(contentBrick, that, data);
                            }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>if event is exposed; emit it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">if</span> (o.expose) {
                                that._doInternalCheck();
                                that.emit(contentBrick.id + <span class="hljs-string">"/"</span> + o.eventName, data);

                                <span class="hljs-keyword">if</span> (o.expose.as) {
                                    that.emit(o.expose.as, {
                                        brick: contentBrick,
                                        brickData: data
                                    });
                                }
                            }
                        });
                    });
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>do a check of all the bricks in case some of them depend on validity of other bricks in this step</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                contentBrick.on(Bricks.Brick.event.CHANGE, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                    that._doInternalCheck();
                });
            },

            <span class="hljs-comment">/**
             * Checks Brick's requirements. Enables or disabled the target Brick based on validity of its requirements.
             * 
             * @method _internalCheckHelper
             * @param  {Array} required      an array of required rules
             * @param  {Brick} targetBrick   a Brick with requirements
             * @param  {Object} contentBricks a dictionary of bricks available in this step
             * @private
             */</span>
            _internalCheckHelper: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">required, targetBrick, contentBricks</span>) </span>{
                <span class="hljs-keyword">var</span> flag = <span class="hljs-literal">false</span>;

                <span class="hljs-keyword">switch</span> (required.type) {
                    <span class="hljs-keyword">case</span> <span class="hljs-string">"all"</span>:
                        flag = required.check.every(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ch</span>) </span>{
                            <span class="hljs-keyword">return</span> contentBricks[ch].isValid();
                        });
                        <span class="hljs-keyword">break</span>;

                    <span class="hljs-keyword">case</span> <span class="hljs-string">"any"</span>:
                        flag = required.check.some(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ch</span>) </span>{
                            <span class="hljs-keyword">return</span> contentBricks[ch].isValid();
                        });
                        <span class="hljs-keyword">break</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>disable or enable a brick based on sum validity of its dependencies</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                targetBrick.disable(!flag);
            },

            <span class="hljs-comment">/**
             * Checks this step item validity by checking validity of all its Bricks.
             * 
             * @method _doInternalCheck
             * @private
             */</span>
            _doInternalCheck: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;

                UtilDict.forEachEntry(<span class="hljs-keyword">this</span>.contentBricks, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, brick</span>) </span>{

                    <span class="hljs-keyword">if</span> (brick.required) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>if it’s a MultiBrick, check requirements for each of the Bricks in MultiBrick </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">if</span> (Bricks.MultiBrick.isPrototypeOf(brick)) {

                            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(brick.required)) {

                                brick.required.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req</span>) </span>{
                                    that._internalCheckHelper(req, brick.contentBricks[req.id], that.contentBricks);
                                });

                            } <span class="hljs-keyword">else</span> {
                                that._internalCheckHelper(brick.required, brick, that.contentBricks);
                            }

                        } <span class="hljs-keyword">else</span> {
                            that._internalCheckHelper(brick.required, brick, that.contentBricks);
                        }
                    }
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>if the step in the error state and one of the Bricks is changed, switched to the DEFAULT state and switch all the content Bricks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._state === StepItem.state.ERROR) {
                    <span class="hljs-keyword">this</span>._notifyStateChange(StepItem.state.DEFAULT);
                }
            },

            <span class="hljs-comment">/**
             * Creates timeline for retreat animation - when the part of the choice tree is collapsing, switching to another branch of the tree.
             * 
             * @method _makeCloseTimeline
             * @param  {Boolean} skipFirst  indicates whether the first child step should be included in the timeline
             * @param  {Boolean} resetState indicates if the child step state should be reset
             * @return {Object}            a constructed close timeline
             * @private
             */</span>
            _makeCloseTimeline: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">skipFirst, resetState</span>) </span>{
                <span class="hljs-keyword">var</span> closeTimeline = <span class="hljs-keyword">new</span> TimelineLite(),
                    closeStagger,
                    closeTimelines = [];

                <span class="hljs-keyword">this</span>._getCloseTimelines(closeTimelines, skipFirst, resetState);
                closeTimelines = closeTimelines.reverse();

                <span class="hljs-keyword">if</span> (closeTimelines.length &gt; <span class="hljs-number">0</span>) {
                    closeStagger = <span class="hljs-keyword">this</span>._transitionDuration / <span class="hljs-number">2</span> / closeTimelines.length;
                    closeTimeline.add(closeTimelines, <span class="hljs-string">"+=0"</span>, <span class="hljs-string">"start"</span>, closeStagger);
                }

                <span class="hljs-keyword">return</span> closeTimeline;
            },

            <span class="hljs-comment">/**
             * Generates a close timeline for this particular step item and adds it to the global close timeline. Calls the same on the target child.
             *
             * @method _getCloseTimelines
             * @param  {Object} tls   global close timeline
             * @param  {Boolean} skip  indicates whether to skip the first child step item
             * @param  {Boolean} reset indicates whether to reset the step item state to DEFAULT
             * @return {StepItem}       itself
             * @private
             * @chainable
             */</span>
            _getCloseTimelines: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tls, skip, reset</span>) </span>{
                <span class="hljs-keyword">var</span> tl = <span class="hljs-keyword">new</span> TimelineLite(),

                    that = <span class="hljs-keyword">this</span>;

                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._activeChildStep) {

                    <span class="hljs-keyword">if</span> (!skip) {
                        tl
                            .call(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>that.currentLevel()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                that._notifyCurrentStepChange();
                            })
                            .to(<span class="hljs-keyword">this</span>._optionsContainerNode, <span class="hljs-keyword">this</span>._transitionDuration,
                                { top: -<span class="hljs-keyword">this</span>._activeChildStep.getContentOuterHeight(), ease: <span class="hljs-string">"easeOutCirc"</span> },
                                <span class="hljs-number">0</span>)
                            .set(<span class="hljs-keyword">this</span>._activeChildStep, { className: <span class="hljs-string">"-=active-option"</span> })
                            .set(<span class="hljs-keyword">this</span>._optionsContainerNode, { display: <span class="hljs-string">"none"</span> })
                        ;

                        tls.push(tl);
                    }

                    <span class="hljs-keyword">if</span> (reset) {
                        <span class="hljs-keyword">this</span>._notifyStateChange(StepItem.state.DEFAULT);
                    }

                    <span class="hljs-keyword">this</span>._activeChildStep._getCloseTimelines(tls);
                }

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
            },

            <span class="hljs-comment">/**
             * Creates timeline for shift animation - when the selected option for a choice is changing - animating horizontally.
             * 
             * @method _makeShiftTimeline
             * @param  {String} targetChildStepId  specifies the target childId
             * @return {Object}            a constructed shift timeline
             * @private
             */</span>
            _makeShiftTimeline: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">targetChildStepId</span>) </span>{
                <span class="hljs-keyword">var</span> shiftTimeline = <span class="hljs-keyword">new</span> TimelineLite(),
                    targetChildStep = <span class="hljs-keyword">this</span>._childSteps[targetChildStepId],
                    allChildNodes = <span class="hljs-keyword">this</span>._getChildNodes(),
                    otherChildNodes = <span class="hljs-keyword">this</span>._getChildNodes([targetChildStepId]);

                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._activeChildStep) {

                    shiftTimeline
                        .set(allChildNodes, { display: <span class="hljs-string">"inline-block"</span> })

                        .to(<span class="hljs-keyword">this</span>._optionsBackgroundNode, <span class="hljs-keyword">this</span>._transitionDuration, {
                            height: targetChildStep.getContentOuterHeight(),
                            <span class="hljs-string">"line-height"</span>: targetChildStep.getContentOuterHeight(),
                            ease: <span class="hljs-string">"easeOutCirc"</span>
                        }, <span class="hljs-number">0</span>)

                        .fromTo(<span class="hljs-keyword">this</span>._optionsNode, <span class="hljs-keyword">this</span>._transitionDuration,
                            { left: -<span class="hljs-keyword">this</span>._activeChildStep.getContentPosition().left },
                            { left: -targetChildStep.getContentPosition().left, ease: <span class="hljs-string">"easeOutCirc"</span> }, <span class="hljs-number">0</span>)
                        .set(otherChildNodes, { className: <span class="hljs-string">"-=active-option"</span> }) <span class="hljs-comment">// when shifting, active-option is changing</span>
                        .set(targetChildStep.node, { className: <span class="hljs-string">"+=active-option"</span> })

                        .set(<span class="hljs-keyword">this</span>._optionsNode, { left: <span class="hljs-number">0</span> })
                        .set(otherChildNodes, { display: <span class="hljs-string">"none"</span> })
                        .call(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                            targetChildStep._notifyStateChange(targetChildStep._state);
                        }, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">this</span>._transitionDuration / <span class="hljs-number">3</span>)
                    ;
                }

                <span class="hljs-keyword">return</span> shiftTimeline;
            },

            <span class="hljs-comment">/**
             * Creates timeline for advance animation - when the part of the choice tree is unfolding, (after switching to another branch of the tree).
             * 
             * @method _makeOpenTimeline
             * @param  {String} targetChildStepId specifies the target child id
             * @param  {Boolean} skipFirst  indicates whether the first child step should be included in the timeline
             * @return {Object}            a constructed open timeline
             * @private
             */</span>
            _makeOpenTimeline: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">targetChildStepId, skipFirst</span>) </span>{
                <span class="hljs-keyword">var</span> openTimeline = <span class="hljs-keyword">new</span> TimelineLite(),
                    openStagger,
                    openTimelines = [];

                <span class="hljs-keyword">this</span>._getOpenTimelines(openTimelines, targetChildStepId, skipFirst);

                <span class="hljs-keyword">if</span> (openTimelines.length &gt; <span class="hljs-number">0</span>) {
                    openStagger = <span class="hljs-keyword">this</span>._transitionDuration / <span class="hljs-number">2</span> / openTimelines.length;
                    openTimeline.add(openTimelines, <span class="hljs-string">"+=0"</span>, <span class="hljs-string">"start"</span>, openStagger);
                }

                <span class="hljs-keyword">return</span> openTimeline;
            },

            <span class="hljs-comment">/**
             * Generates an open timeline for this particular step item and adds it to the global open timeline. Calls the same on the target child.
             *
             * @method _getOpenTimelines
             * @param  {Object} tls   global open timeline
             * @param  {String} targetChildStepId specifies the target child id
             * @param  {Boolean} skip  indicates whether to skip the first child step item
             * @return {StepItem}       itself
             * @private
             * @chainable
             */</span>
            _getOpenTimelines: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">tls, targetChildStepId, skip</span>) </span>{
                <span class="hljs-keyword">var</span> tl = <span class="hljs-keyword">new</span> TimelineLite(),
                    targetChildStep = targetChildStepId ? <span class="hljs-keyword">this</span>._childSteps[targetChildStepId] : <span class="hljs-keyword">this</span>._activeChildStep,
                    otherChildNodes = <span class="hljs-keyword">this</span>._getChildNodes([targetChildStepId]);

                <span class="hljs-keyword">if</span> (targetChildStep) {

                    <span class="hljs-keyword">if</span> (!skip) {

                        tl</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>set options container node to visible, otherwise you can’t get its size</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            .set(<span class="hljs-keyword">this</span>._optionsContainerNode, { display: <span class="hljs-string">"block"</span>, top: -<span class="hljs-number">9999</span> }, <span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>make sure options’ node is on the left</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            .set(<span class="hljs-keyword">this</span>._optionsNode, { left: <span class="hljs-number">0</span> }, <span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>hide children other than target</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            .set(otherChildNodes, { display: <span class="hljs-string">"none"</span> }, <span class="hljs-number">0</span>)
                            .set(targetChildStep.node, { className: <span class="hljs-string">"+=active-option"</span>, display: <span class="hljs-string">"inline-block"</span> }, <span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>make the target step current</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            .call(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                                targetChildStep._notifyCurrentStepChange();
                            })</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>animate step’s background</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            .to(<span class="hljs-keyword">this</span>._optionsBackgroundNode, <span class="hljs-number">0</span>, {
                                height: targetChildStep.getContentOuterHeight(),
                                <span class="hljs-string">"line-height"</span>: targetChildStep.getContentOuterHeight()
                            }, <span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>animate height and position of the options’ container node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            .to(<span class="hljs-keyword">this</span>._optionsContainerNode, <span class="hljs-number">0</span>, { height: targetChildStep.getContentOuterHeight(), ease: <span class="hljs-string">"easeOutCirc"</span> }, <span class="hljs-number">0</span>)
                            .fromTo(<span class="hljs-keyword">this</span>._optionsContainerNode, <span class="hljs-keyword">this</span>._transitionDuration,
                                { top: -<span class="hljs-keyword">this</span>._optionsContainerNode.height() },
                                { top: <span class="hljs-number">0</span>, ease: <span class="hljs-string">"easeOutCirc"</span> },
                                <span class="hljs-number">0</span>)
                            .set(<span class="hljs-keyword">this</span>._optionsContainerNode, { height: <span class="hljs-string">"auto"</span> })
                        ;

                        tls.push(tl);
                    }

                    <span class="hljs-keyword">this</span>._notifyStateChange(StepItem.state.SUCCESS);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>hide all notices when making a step successful</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">this</span>.displayBrickNotices();
                    targetChildStep._getOpenTimelines(tls);
                }

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
            },

            <span class="hljs-comment">/**
             * Returns an array of child step nodes except for steps whose ids are passed in `except` param.
             * 
             * @method _getChildNodes
             * @private
             * @param  {Array} except an array of child step ids to not include in the result
             * @return {Array}        an array of child step nodes
             */</span>
            _getChildNodes: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">except</span>) </span>{
                <span class="hljs-keyword">var</span> childNodes = [];

                UtilDict.forEachEntry(<span class="hljs-keyword">this</span>._childSteps,
                    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">childId, childItem</span>) </span>{
                        <span class="hljs-keyword">if</span> (!except || except.indexOf(childItem.id) === -<span class="hljs-number">1</span>) {
                            childNodes.push(childItem.node);
                        }
                    }
                );

                <span class="hljs-keyword">return</span> childNodes;
            },

            <span class="hljs-comment">/**
             * Emits a `CURRENT_STEP_CHANGE` event with a payload of id and level of the current step item.
             * This notifies the trunk of the tree and this step is now a current step. The trunk in turn notifies 
             * every other step that they are not current steps.
             *
             * @method _notifyCurrentStepChange
             * @private
             */</span>
            _notifyCurrentStepChange: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">this</span>._emit(StepItem.event.CURRENT_STEP_CHANGE, { id: <span class="hljs-keyword">this</span>.id, level: <span class="hljs-keyword">this</span>.level });
            },

            <span class="hljs-comment">/**
             * Emits a `STATE_CHANGE` event with a payload of id, level and state of the current step item.
             * Additionally sets state of all the content bricks to corresponding states.
             * 
             * @method _notifyStateChange
             * @private
             * @chainable
             * @param  {String} state state to set the step item to
             * @return {StepItem}       itself
             */</span>
            _notifyStateChange: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">state</span>) </span>{
                <span class="hljs-keyword">var</span> brickState;

                <span class="hljs-keyword">this</span>._state = state;

                <span class="hljs-keyword">switch</span> (state) {
                    <span class="hljs-keyword">case</span> StepItem.state.SUCCESS:
                        brickState = Bricks.Brick.state.SUCCESS;
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">case</span> StepItem.state.ERROR:
                        brickState = Bricks.Brick.state.ERROR;
                        <span class="hljs-keyword">break</span>;
                    <span class="hljs-keyword">default</span>:
                        brickState = Bricks.Brick.state.DEFAULT;
                        <span class="hljs-keyword">break</span>;
                }

                UtilDict.forEachEntry(<span class="hljs-keyword">this</span>.contentBricks, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, brick</span>) </span>{
                    brick.setState(brickState);
                });

                <span class="hljs-keyword">this</span>._emit(StepItem.event.STATE_CHANGE, { id: <span class="hljs-keyword">this</span>.id, level: <span class="hljs-keyword">this</span>.level, state: <span class="hljs-keyword">this</span>._state });

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
            },

            <span class="hljs-comment">/**
             * A helper function to emit a supplied event with payload.
             * 
             * @private
             * @chainable
             * @param  {String} event   event name
             * @param  {Object} [payload] payload object
             * @return {StepItem}         itself
             */</span>
            _emit: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event, payload</span>) </span>{
                <span class="hljs-keyword">this</span>.emit(event, payload);

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
            },

            <span class="hljs-comment">/**
             * Returns step data and data from all content bricks.
             * 
             * @return {Object} step data and brick data
             */</span>
            getData: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">var</span> data = {
                    stepData: <span class="hljs-keyword">this</span>._stepData,
                    bricksData: {}
                };

                UtilDict.forEachEntry(<span class="hljs-keyword">this</span>.contentBricks, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, brick</span>) </span>{
                    lang.mixin(data.bricksData, brick.getData(<span class="hljs-literal">true</span>));
                });

                <span class="hljs-keyword">return</span> data;
            },

            <span class="hljs-comment">/**
             * Adds a given step item object as a child for this step item.
             * 
             * @method addChild
             * @chainable
             * @param {StepItem} stepItem a stepItem object to be added as a child.
             * @return {StepItem} itself
             */</span>
            addChild: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">stepItem</span>) </span>{
                <span class="hljs-keyword">this</span>._optionsNode.append(stepItem.node);
                <span class="hljs-keyword">this</span>._childSteps[stepItem.id] = stepItem;
                stepItem._parent = <span class="hljs-keyword">this</span>;

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
            },

            <span class="hljs-comment">/**
             * Clears this step by resetting its state to `DEFAULT`, clearing all content bricks, and hide all brick notices.
             * 
             * @method 
             * @param  {Array} brickIds [description]
             * @return {StepItem}          itself
             * @chainable
             */</span>
            clearStep: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">brickIds</span>) </span>{
                <span class="hljs-keyword">var</span> bricks = []; <span class="hljs-comment">// bricks from whose notices should be hidden</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>clear this steps state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">this</span>._notifyStateChange(StepItem.state.DEFAULT);

                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(brickIds)) {
                    brickIds.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">brickId</span>) </span>{
                        <span class="hljs-keyword">this</span>.contentBricks[brickId].clear();

                        bricks.push(<span class="hljs-keyword">this</span>.contentBricks[brickId]);
                    });
                } <span class="hljs-keyword">else</span> {
                    UtilDict.forEachEntry(<span class="hljs-keyword">this</span>.contentBricks, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, brick</span>) </span>{
                        brick.clear();

                        bricks.push(brick);
                    });
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>hide all notices when clearing the step</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">this</span>.displayBrickNotices();

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
            },

            <span class="hljs-comment">/**
             * Sets the step specified by the `level` and `stepId` to a specified state.
             * 
             * @method setState
             * @param {Number} level  level of the step to set the state on
             * @param {String} stepId id of the step to set the state on
             * @param {String} state  name of the state to set
             */</span>
            setState: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">level, stepId, state</span>) </span>{
                <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>if this step is the first step in the tree and so is the current step, set state class on its main node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.level === <span class="hljs-number">1</span> &amp;&amp; level === <span class="hljs-number">1</span>) {
                    <span class="hljs-keyword">this</span>.node
                        .removeClass(ALL_STATES_CLASS)
                        .addClass(state);
                } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>if not, go over the children and if one corresponds to the current step, set state class on the options (children) container</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    UtilDict.forEachEntry(<span class="hljs-keyword">this</span>._childSteps,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">childId, childStep</span>) </span>{
                            <span class="hljs-keyword">if</span> (childId === stepId &amp;&amp; childStep.level === level) {
                                that._optionsContainerNode
                                    .removeClass(ALL_STATES_CLASS)
                                    .addClass(state);
                            }
                        }
                    );
                }
            },

            <span class="hljs-comment">/**
             * Makes the step specified by the `level` and `stepId` a current step by setting a proper CSS class.
             * 
             * @method currentStep
             * @param  {Number} level  step level
             * @param  {String} stepId step id
             */</span>
            currentStep: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">level, stepId</span>) </span>{
                <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>if this step is the first step in the tree and so is the current step, set class on the main node of this step </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.level === <span class="hljs-number">1</span> &amp;&amp; level === <span class="hljs-number">1</span>) {
                    <span class="hljs-keyword">this</span>.node.addClass(StepItem.currentStepClass);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">this</span>.node.removeClass(StepItem.currentStepClass);
                    <span class="hljs-keyword">this</span>._optionsContainerNode.removeClass(StepItem.currentStepClass);</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>if not, go over the children and if one corresponds to the current step, set class on the options (children) container</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    UtilDict.forEachEntry(<span class="hljs-keyword">this</span>._childSteps,
                        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">childId, childStep</span>) </span>{
                            <span class="hljs-keyword">if</span> (childId === stepId &amp;&amp; childStep.level === level) {
                                that._optionsContainerNode.addClass(StepItem.currentStepClass);
                            }
                        }
                    );
                }
            },

            <span class="hljs-comment">/**
             * Checks if the step is valid. It's considered valid if all its content bricks are valid.
             *
             * @method isValid
             * @return {Boolean} true if completed; false, otherwise
             */</span>
            isValid: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                UtilDict.forEachEntry(<span class="hljs-keyword">this</span>.contentBricks, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, brick</span>) </span>{
                    <span class="hljs-keyword">if</span> (!brick.isValid()) {
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                    }
                });

                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            },

            <span class="hljs-comment">/**
             * Checks if the step is completed. It's considered completed if its state is SUCCESS.
             *
             * @method isCompleted
             * @return {Boolean} true if completed; false, otherwise
             */</span>
            isCompleted: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._state === StepItem.state.SUCCESS;
            },

            <span class="hljs-comment">/**
             * Sets data to the content brick
             * 
             * @method setData
             * @param {Object} data a data object 
             * @param {Object} [data.bricksData] dictionary of data where keys are brick ids and values data to be passed to the corresponding bricks
             * @param {Object} [data.stepData] some data object to be saved in this step 
             * @return {StepItem} itself
             * @chainable
             */</span>
            setData: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
                <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;

                <span class="hljs-keyword">if</span> (data) {
                    <span class="hljs-keyword">if</span> (data.bricksData) {
                        UtilDict.forEachEntry(data.bricksData, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">brickId, brickData</span>) </span>{
                            that.contentBricks[brickId].setData(brickData);
                        });
                    }

                    <span class="hljs-keyword">if</span> (data.stepData) {
                        <span class="hljs-keyword">this</span>._stepData = data.stepData;
                    }
                }
            },

            <span class="hljs-comment">/**
             * Set Brick notices, mostly errors.
             * 
             * @method displayBrickNotices
             * @param  {Object} [data] a dictionary of objects containing Brick notices
             */</span>
            displayBrickNotices: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{
                <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>,
                    bricks = [],
                    promise;

                <span class="hljs-keyword">if</span> (data) {
                    UtilDict.forEachEntry(data, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">brickId, brickData</span>) </span>{
                        that.contentBricks[brickId].displayNotice(brickData);

                        bricks.push(that.contentBricks[brickId]);
                    });</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>toggle notice </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">this</span>._toggleBrickNotices(bricks, data);
                } <span class="hljs-keyword">else</span> {
                    UtilDict.forEachEntry(<span class="hljs-keyword">this</span>.contentBricks, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, brick</span>) </span>{
                        bricks.push(brick);
                    });</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>if no data provided, first hide all existing notices, then empty them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    promise = <span class="hljs-keyword">this</span>._toggleBrickNotices(bricks, data);

                    promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                        bricks.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">brick</span>) </span>{
                            brick.displayNotice();
                        });
                    });
                }
            },

            <span class="hljs-comment">/**
             * Toggles the visibility of notices for specified bricks.
             * 
             * @method _toggleBrickNotices
             * @private
             * @param  {Array} bricks an array of Brick items to toggle notices on
             * @param  {Boolean} show   a flag indicating whether to show or hide the notices
             * @return {Promise}        a promise that is resolved after animation is completed
             */</span>
            _toggleBrickNotices: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">bricks, show</span>) </span>{
                <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>,
                    notices,
                    contentHeight = <span class="hljs-keyword">this</span>.getContentOuterHeight(),
                    heightChange = <span class="hljs-number">0</span>,
                    tl = <span class="hljs-keyword">new</span> TimelineLite({ paused: <span class="hljs-literal">true</span> }),
                    def = <span class="hljs-keyword">new</span> Deferred();

                tl.eventCallback(<span class="hljs-string">"onComplete"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                    def.resolve();
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>filter out bricks that don’t have any notices</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                notices = bricks
                    .map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">brick</span>) </span>{ <span class="hljs-keyword">return</span> brick.noticeNode; })
                    .filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">notice</span>) </span>{ <span class="hljs-keyword">return</span> notice.length &gt; <span class="hljs-number">0</span>; })
                ;

                <span class="hljs-keyword">if</span> (show) {
                    tl.set(notices, { height: <span class="hljs-number">0</span>, visibility: <span class="hljs-string">"visible"</span>, position: <span class="hljs-string">"relative"</span> }, <span class="hljs-number">0</span>);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>add notice animation to the timeline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                notices.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">notice</span>) </span>{

                    heightChange += notice.height();

                    tl
                        .to(notice, that._transitionDuration / <span class="hljs-number">2</span>, { height: show ? notice.height() : <span class="hljs-number">0</span>, ease: <span class="hljs-string">"easeOutCirc"</span> }, <span class="hljs-number">0</span>)
                    ;

                });

                <span class="hljs-keyword">if</span> (!show) {
                    tl.set(notices, { clearProps: <span class="hljs-string">"all"</span> });
                }

                heightChange = show ? <span class="hljs-number">0</span> : -heightChange;</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>change the height of the parent’s option background container to accommodate for notice height </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._parent) {
                    tl.to(<span class="hljs-keyword">this</span>._parent._optionsBackgroundNode, <span class="hljs-keyword">this</span>._transitionDuration / <span class="hljs-number">2</span>, {
                        height: contentHeight + heightChange,
                        <span class="hljs-string">"line-height"</span>: contentHeight + heightChange,
                        ease: <span class="hljs-string">"easeOutCirc"</span>
                    }, <span class="hljs-number">0</span>);
                }

                tl.play();

                <span class="hljs-keyword">return</span> def.promise;
            },

            <span class="hljs-comment">/**
             * Retreats the current step item by collapsing its active children and resetting their states to default. After, active child step is set to null.
             * 
             * @method retreat
             * @return {StepItem} itself
             * @chainable
             */</span>
            retreat: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">var</span> closeTimeline,
                    that = <span class="hljs-keyword">this</span>;

                <span class="hljs-keyword">this</span>._timeline
                    .seek(<span class="hljs-string">"+=0"</span>, <span class="hljs-literal">false</span>)
                    .clear()
                ;

                closeTimeline = <span class="hljs-keyword">this</span>._makeCloseTimeline(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);

                <span class="hljs-keyword">this</span>._timeline
                    .add(closeTimeline)
                    .call(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                        that._activeChildStep = <span class="hljs-literal">null</span>;
                    })
                ;

                <span class="hljs-keyword">this</span>._timeline.play(<span class="hljs-number">0</span>);

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
            },

            <span class="hljs-comment">/**
             * Advances the current step to the step with the provided id. The target id has to be a child step.
             * Additionally, the tree expands down if the target child has an active child as well, and so on, until no active child is present.
             * 
             * @method advance
             * @param  {String} targetChildStepId id of the new target step of advance too
             * @param  {Object} [targetChildData]   data to be passed to the target step as it opens
             * @return {StepItem}                   itself
             */</span>
            advance: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">targetChildStepId, targetChildData</span>) </span>{
                <span class="hljs-keyword">var</span> closeTimeline,
                    shiftTimeline,
                    openTimeline,
                    targetChildStep = <span class="hljs-keyword">this</span>._childSteps[targetChildStepId],
                    skipFirst,

                    that = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>cannot advance if the target is not specified</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (!targetChildStep) {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>reset timeline to the start and clear all the other rubbish that might be running already</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">this</span>._timeline
                    .seek(<span class="hljs-string">"+=0"</span>, <span class="hljs-literal">false</span>)
                    .clear()
                ;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>if there is already an active child step, skip the first animation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                skipFirst = <span class="hljs-keyword">this</span>._activeChildStep ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;

                targetChildStep.setData(targetChildData);

                closeTimeline = <span class="hljs-keyword">this</span>._makeCloseTimeline(skipFirst);
                shiftTimeline = <span class="hljs-keyword">this</span>._makeShiftTimeline(targetChildStepId);
                openTimeline = <span class="hljs-keyword">this</span>._makeOpenTimeline(targetChildStepId, skipFirst);

                <span class="hljs-keyword">this</span>._timeline
                    .add(closeTimeline)
                    .add(shiftTimeline)
                    .add(openTimeline)
                    .call(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>only when animation completes, set the active child to the target child</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        that._activeChildStep = targetChildStep;
                    })
                ;

                <span class="hljs-keyword">this</span>._timeline.play(<span class="hljs-number">0</span>);

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
            },

            <span class="hljs-comment">/**
             * Get position of the content node.
             * 
             * @method getContentPosition
             * @return {Object} jQuery position object of the content node
             */</span>
            getContentPosition: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._contentNode.position();
            },

            <span class="hljs-comment">/**
             * Get outer height of the content node
             * 
             * @method getContentOuterHeight
             * @return {Number} outer height of the content node
             */</span>
            getContentOuterHeight: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._contentNode.outerHeight();
            }
        });

        lang.mixin(StepItem,
            {
                <span class="hljs-comment">/**
                 * Specifies the current step CSS class name.
                 * 
                 * @property currentStepClass
                 * @static
                 * @type {String}
                 */</span>
                currentStepClass: <span class="hljs-string">"current-step"</span>,

                <span class="hljs-comment">/**
                 * A collection of possible StepItem states and their names.
                 * 
                 * @propery state
                 * @static
                 * @type {Object}
                 * @example
                 *     state: {
                 *           SUCCESS: "step-state-success",
                 *           ERROR: "step-state-error",
                 *           DEFAULT: "step-state-default",
                 *           LOADING: "step-state-loading"
                 *       }
                 * 
                 */</span>
                state: {
                    SUCCESS: <span class="hljs-string">"step-state-success"</span>,
                    ERROR: <span class="hljs-string">"step-state-error"</span>,
                    DEFAULT: <span class="hljs-string">"step-state-default"</span>,
                    LOADING: <span class="hljs-string">"step-state-loading"</span>
                },

                <span class="hljs-comment">/**
                 * Event names published by the StepItem
                 *
                 * @property event
                 * @static
                 * @type Object
                 * @example
                 *      {
                 *          CURRENT_STEP_CHANGE: "stepItem/currentStepChange",
                 *          STATE_CHANGE: "stepItem/stateChange"
                 *      }
                 */</span>
                event: {
                    <span class="hljs-comment">/**
                    * Published whenever a StepItem becomes a current step. A current step has a distinct visual style.
                    *
                    * @event StepItem.event.CURRENT_STEP_CHANGE
                    * @param event {Object}
                    * @param event.level {Number} Level of the StepItem that became a current step
                    * @param event.id {String} Id of the StepItem that became a current step
                    */</span>
                    CURRENT_STEP_CHANGE: <span class="hljs-string">"stepItem/currentStepChange"</span>,

                    <span class="hljs-comment">/**
                    * Published whenever a StepItem changes its state. 
                    * 
                    * @event StepItem.event.CURRENT_STEP_CHANGE
                    * @param event {Object}
                    * @param event.level {Number} Level of the StepItem that became a current step
                    * @param event.id {String} Id of the StepItem that became a current step
                    * @param event.state {String} name of the state
                    */</span>
                    STATE_CHANGE: <span class="hljs-string">"stepItem/stateChange"</span>
                }
            }
        );</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>a string with all possible StepItem state CSS classes joined by “ “; used to clear any CSS state class from the node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ALL_STATES_CLASS =
            <span class="hljs-built_in">Object</span>
                .getOwnPropertyNames(StepItem.state)
                .map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) </span>{ <span class="hljs-keyword">return</span> StepItem.state[key]; })
                .join(<span class="hljs-string">" "</span>);

        <span class="hljs-keyword">return</span> StepItem;
    });</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
