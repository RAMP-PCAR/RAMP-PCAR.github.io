<!DOCTYPE html>

<html>
<head>
  <title>geoSearch.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="advancedToolbar.html">
                advancedToolbar.js
              </a>
            
              
              <a class="source" href="attributeLoader.html">
                attributeLoader.js
              </a>
            
              
              <a class="source" href="basemapSelector.html">
                basemapSelector.js
              </a>
            
              
              <a class="source" href="bookmarkLink.html">
                bookmarkLink.js
              </a>
            
              
              <a class="source" href="dataLoader.html">
                dataLoader.js
              </a>
            
              
              <a class="source" href="dataLoaderGui.html">
                dataLoaderGui.js
              </a>
            
              
              <a class="source" href="datagrid.html">
                datagrid.js
              </a>
            
              
              <a class="source" href="datagridClickHandler.html">
                datagridClickHandler.js
              </a>
            
              
              <a class="source" href="eventManager.html">
                eventManager.js
              </a>
            
              
              <a class="source" href="featureClickHandler.html">
                featureClickHandler.js
              </a>
            
              
              <a class="source" href="featureHighlighter.html">
                featureHighlighter.js
              </a>
            
              
              <a class="source" href="filterManager.html">
                filterManager.js
              </a>
            
              
              <a class="source" href="geoSearch.html">
                geoSearch.js
              </a>
            
              
              <a class="source" href="globalStorage.html">
                globalStorage.js
              </a>
            
              
              <a class="source" href="graphicExtension.html">
                graphicExtension.js
              </a>
            
              
              <a class="source" href="gui.html">
                gui.js
              </a>
            
              
              <a class="source" href="imageExport.html">
                imageExport.js
              </a>
            
              
              <a class="source" href="layerGroup.html">
                layerGroup.js
              </a>
            
              
              <a class="source" href="layerItem.html">
                layerItem.js
              </a>
            
              
              <a class="source" href="layerLoader.html">
                layerLoader.js
              </a>
            
              
              <a class="source" href="map.html">
                map.js
              </a>
            
              
              <a class="source" href="mapClickHandler.html">
                mapClickHandler.js
              </a>
            
              
              <a class="source" href="maptips.html">
                maptips.js
              </a>
            
              
              <a class="source" href="navigation.html">
                navigation.js
              </a>
            
              
              <a class="source" href="quickzoom.html">
                quickzoom.js
              </a>
            
              
              <a class="source" href="stepItem.html">
                stepItem.js
              </a>
            
              
              <a class="source" href="theme.html">
                theme.js
              </a>
            
              
              <a class="source" href="RAMP-starter.html">
                RAMP-starter.js
              </a>
            
              
              <a class="source" href="areaTool.html">
                areaTool.js
              </a>
            
              
              <a class="source" href="baseTool.html">
                baseTool.js
              </a>
            
              
              <a class="source" href="bufferTool.html">
                bufferTool.js
              </a>
            
              
              <a class="source" href="distanceTool.html">
                distanceTool.js
              </a>
            
              
              <a class="source" href="populationTool.html">
                populationTool.js
              </a>
            
              
              <a class="source" href="array.html">
                array.js
              </a>
            
              
              <a class="source" href="bricks.html">
                bricks.js
              </a>
            
              
              <a class="source" href="checkbox.html">
                checkbox.js
              </a>
            
              
              <a class="source" href="checkboxGroup.html">
                checkboxGroup.js
              </a>
            
              
              <a class="source" href="decorator.html">
                decorator.js
              </a>
            
              
              <a class="source" href="dictionary.html">
                dictionary.js
              </a>
            
              
              <a class="source" href="functionMangler.html">
                functionMangler.js
              </a>
            
              
              <a class="source" href="popupManager.html">
                popupManager.js
              </a>
            
              
              <a class="source" href="prototype.html">
                prototype.js
              </a>
            
              
              <a class="source" href="tmplHelper.html">
                tmplHelper.js
              </a>
            
              
              <a class="source" href="tmplUtil.html">
                tmplUtil.js
              </a>
            
              
              <a class="source" href="url.html">
                url.js
              </a>
            
              
              <a class="source" href="util.html">
                util.js
              </a>
            
              
              <a class="source" href="bootstrapper.html">
                bootstrapper.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>geoSearch.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>﻿<span class="hljs-comment">/* global define, console, RAMP, escape */</span>

<span class="hljs-comment">/**
*
*
* @module RAMP
* @submodule GeoSearch
*/</span>

<span class="hljs-comment">/**
* GeoSearch class.
*
* Handles the querying of the geolocation service
* This includes adding user filters, parsing user input, and packaging return values
* <span class="hljs-doctag"><span class="hljs-keyword">NOTE</span></span>: the geogratis services treat lat/long as length-2 arrays where longitude comes first
*       e.g. [-77.167641,44.1072025]
*       code in this module will keep to that convention
*
* @class LayerLoader
* @static
* @uses dojo/Deferred
* @uses dojo/request/script
*/</span>

define([
<span class="hljs-comment">/* Dojo */</span>
 <span class="hljs-string">'dojo/request/script'</span>, <span class="hljs-string">'dojo/Deferred'</span>

<span class="hljs-comment">/* ESRI */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>‘esri/tasks/GeometryService’, ‘esri/tasks/ProjectParameters’, ‘esri/geometry/Extent’,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>],

    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">
    <span class="hljs-comment">/* Dojo */</span>
    script, Deferred

        <span class="hljs-comment">/* ESRI */</span>
</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>GeometryService, ProjectParameters, EsriExtent,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>) {
        <span class="hljs-string">'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>types of special inputs by the user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> parseType = {
            none: <span class="hljs-string">'none'</span>,
            fsa: <span class="hljs-string">'fsa'</span>,
            lonlat: <span class="hljs-string">'lonlat'</span>,
            prov: <span class="hljs-string">'prov'</span>
        }, statusType = {
            list: <span class="hljs-string">'list'</span>,
            none: <span class="hljs-string">'none'</span>,
            hide: <span class="hljs-string">'hide'</span>
        }, provSearch = [],
            provList = [],
            conciseList = [];

        <span class="hljs-comment">/**
        * Will determine if a value is a valid province identifier (en/fr name or 2-letter abbr)
        *
        * @method isProvince
        * @private
        * @param {String} value value to test
        * @return {Boolean} tells if value is valid province identifier
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isProvince</span>(<span class="hljs-params">value</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>this function is slightly redundant, as getProvCode would achieve the same result.
the thinking is this is used to quickly do an initial test (usually the test will be false).
once it is known the value is a province, the heavier logic can be executed in getProvCode (if needed).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> lVal = value.toLowerCase();
            <span class="hljs-keyword">return</span> provSearch.indexOf(lVal) &gt; -<span class="hljs-number">1</span>;
        }

        <span class="hljs-comment">/**
        * Convert a provice name to province code
        *
        * @method getProvCode
        * @private
        * @param {String} prov province string
        * @return {String} province code. undefined if no match
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getProvCode</span>(<span class="hljs-params">prov</span>) </span>{
            <span class="hljs-keyword">var</span> lProv = prov.toLowerCase(),
                code;
            provList.every(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">elem</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>TODO is there a prettier way to do this IF?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (elem.abbr.toLowerCase() === lProv || elem.name.en.toLowerCase() === lProv || elem.name.fr.toLowerCase() === lProv) {
                    code = elem.code;
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            });

            <span class="hljs-keyword">return</span> code;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>worker function for sorting named lists</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nameSorter</span>(<span class="hljs-params">a, b</span>) </span>{
            <span class="hljs-keyword">if</span> (a.name &gt; b.name) {
                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
            }
        }

        <span class="hljs-comment">/**
        * Returns a list of provinces and codes for the UI dropdown combo
        *
        * @method getProvList
        * @private
        * @return {Array} a list of province names and codes
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getProvList</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>The return value structure can be modified to best suit the UI when it is implemmented</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">return</span> provList.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">elem</span>) </span>{
                <span class="hljs-keyword">return</span> {
                    name: elem.name[RAMP.locale],
                    code: elem.code
                };
            }).sort(nameSorter);
        }

        <span class="hljs-comment">/**
        * Returns a list of concise names and codes for the UI dropdown combo
        *
        * @method getConciseList
        * @private
        * @return {Array} a list of concise names and codes
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getConciseList</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>The return value structure can be modified to best suit the UI when it is implemmented</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">return</span> conciseList.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">elem</span>) </span>{
                <span class="hljs-keyword">return</span> {
                    name: elem.name[RAMP.locale],
                    code: elem.code
                };
            }).sort(nameSorter);
        }

        <span class="hljs-comment">/**
        * Will determine if a value is a valid number for a lat/long co-ordinate
        *
        * @method isLatLong
        * @private
        * @param {String} value value to test
        * @return {Boolean} tells if value is valid lat/long
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isLatLong</span>(<span class="hljs-params">value</span>) </span>{
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(value)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">var</span> numType = <span class="hljs-built_in">Number</span>(value);
                <span class="hljs-keyword">return</span> ((numType &gt;= -<span class="hljs-number">180</span>) &amp;&amp; (numType &lt;= <span class="hljs-number">180</span>));
            }
        }

        <span class="hljs-comment">/**
        * Will determine if a point is inside an extent
        *
        * @method isInExtent
        * @private
        * @param {Array} point co-ordinates in [lon, lat] format
        * @param {Array} extent co-ordinates in [lon_min, lat_min, lon_max, lat_max] format
        * @return {Boolean} tells if the point is inside the extent
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isInExtent</span>(<span class="hljs-params">point, extent</span>) </span>{
            <span class="hljs-keyword">return</span> (point[<span class="hljs-number">0</span>] &gt;= extent[<span class="hljs-number">0</span>]) &amp;&amp; (point[<span class="hljs-number">0</span>] &lt;= extent[<span class="hljs-number">2</span>]) &amp;&amp; (point[<span class="hljs-number">1</span>] &gt;= extent[<span class="hljs-number">1</span>]) &amp;&amp; (point[<span class="hljs-number">1</span>] &lt;= extent[<span class="hljs-number">3</span>]);
        }

        <span class="hljs-comment">/**
        * Will examine the user search string. Returns any special type and related data
        * Valid types are: none, fsa, lonlat, prov
        *
        * @method parseInput
        * @private
        * @param {String} input user search string
        * @return {Object} result of parse.  has .type (string) and .data (object) properties
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseInput</span>(<span class="hljs-params">input</span>) </span>{
            <span class="hljs-keyword">var</span> ret = {
                type: parseType.none,
                data: input
            },
                fsaReg = <span class="hljs-regexp">/[A-Za-z]\d[A-Za-z]/</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>check for FSA</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> ((input.length &gt; <span class="hljs-number">2</span>) &amp;&amp; (fsaReg.test(input.substring(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>)))) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>ensure there is a break after first 3 characters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (((input.length &gt; <span class="hljs-number">3</span>) &amp;&amp; (input.substring(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>) === <span class="hljs-string">' '</span>)) || (input.length === <span class="hljs-number">3</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>tis an FSA</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    ret.type = parseType.fsa;
                    ret.data = input.substring(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>);
                    <span class="hljs-keyword">return</span> ret;
                }
            }

            <span class="hljs-keyword">if</span> (input.indexOf(<span class="hljs-string">','</span>) &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">var</span> vals = input.split(<span class="hljs-string">','</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>check lat/long</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (vals.length === <span class="hljs-number">2</span>) {
                    <span class="hljs-keyword">if</span> (isLatLong(vals[<span class="hljs-number">0</span>]) &amp;&amp; isLatLong(vals[<span class="hljs-number">1</span>])) {
                        ret.type = parseType.lonlat;
                        ret.data = [<span class="hljs-built_in">Number</span>(vals[<span class="hljs-number">1</span>]), <span class="hljs-built_in">Number</span>(vals[<span class="hljs-number">0</span>])]; <span class="hljs-comment">//Reverse order to match internal structure of lonlat</span>
                        <span class="hljs-keyword">return</span> ret;
                    }
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>check for trailing province
TODO move this into language configs?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> provTest = vals[vals.length - <span class="hljs-number">1</span>].trim();</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>see if item after last comma is a province</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (isProvince(provTest)) {
                    ret.type = parseType.prov;
                    ret.data = {
                        prov: getProvCode(provTest),
                        searchVal: input.substring(<span class="hljs-number">0</span>, input.lastIndexOf(<span class="hljs-string">','</span>))
                    };
                }
            }

            <span class="hljs-keyword">return</span> ret;
        }

        <span class="hljs-comment">/**
        * Will search for an FSA
        * Promise delivers centroid lat long if FSA is found
        *
        * @method fsaSearch
        * @private
        * @param {String} fsa FSA code
        * @return {Object} promise of results
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fsaSearch</span>(<span class="hljs-params">fsa</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>results thing
lat long of the FSA centroid. nothing if invalid FSA</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">var</span> defResult = <span class="hljs-keyword">new</span> Deferred(),</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>launch the search for the fsa</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                defService = script.get(RAMP.config.geolocationUrl + RAMP.locale + <span class="hljs-string">'/locate'</span>, {
                    query: <span class="hljs-string">'q='</span> + fsa,
                    jsonp: <span class="hljs-string">'callback'</span>
                });

            defService.then(
            <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">serviceContent</span>) </span>{
                <span class="hljs-built_in">console</span>.log(serviceContent);
                <span class="hljs-keyword">var</span> res = { lonlat: <span class="hljs-literal">undefined</span> };</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>service returned.  check if we have a result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (serviceContent.length &gt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>find first item that is a postal code</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    serviceContent.every(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">elem</span>) </span>{
                        <span class="hljs-keyword">if</span> (elem.type === <span class="hljs-string">'ca.gc.nrcan.geoloc.data.model.PostalCode'</span>) {
                            res.lonlat = elem.geometry.coordinates;
                            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">//will cause the "every" loop to break</span>
                        }
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">//keep looping</span>
                    });
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>resolve the promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                defResult.resolve(res);
            },
            <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Geolocation search error : '</span> + error);
                defResult.reject(error);
            });

            <span class="hljs-keyword">return</span> defResult.promise;
        }

        <span class="hljs-comment">/**
        * Will execute a specific search against the geoname service
        *
        * @method executeSearch
        * @private
        * @param {Object} params values to use in the search
        * @return {Object} promise of results
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">executeSearch</span>(<span class="hljs-params">params</span>) </span>{
            <span class="hljs-comment">/*
            input param details
            any missing properties means don't apply it to the search

            .lonlat  array of two decimal degrees, lat and long.  if present, means do area search

            .radius  radius of area filter.  used with lonlat

            */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>results thing
lat long of the FSA centroid. nothing if invalid FSA</p>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>build up our query string
<a href="http://www.nrcan.gc.ca/earth-sciences/geography/place-names/tools-applications/9249">http://www.nrcan.gc.ca/earth-sciences/geography/place-names/tools-applications/9249</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">var</span> query = <span class="hljs-string">''</span>,
                defResult = <span class="hljs-keyword">new</span> Deferred(),
                listLimit = <span class="hljs-number">10</span>, <span class="hljs-comment">//<span class="hljs-doctag"><span class="hljs-keyword">TODO</span></span> should this be defined in the config?</span>
                defService;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>search around a point</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (params.lonlat) {
                query += <span class="hljs-string">'lat='</span> + params.lonlat[<span class="hljs-number">1</span>].toString() + <span class="hljs-string">'&amp;lon='</span> + params.lonlat[<span class="hljs-number">0</span>].toString() + <span class="hljs-string">'&amp;'</span>;

                <span class="hljs-keyword">if</span> (params.radius) {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>should be between 1 and 100, and integer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    query += <span class="hljs-string">'radius='</span> + params.radius.toString() + <span class="hljs-string">'&amp;'</span>;
                }
            }

            <span class="hljs-keyword">if</span> (params.q) {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>inject wildcards after terms</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                query += <span class="hljs-string">'q='</span> + <span class="hljs-built_in">escape</span>(params.q.trim().replace(<span class="hljs-string">'%20'</span>, <span class="hljs-string">' '</span>).replace(<span class="hljs-string">' '</span>, <span class="hljs-string">'* '</span>) + <span class="hljs-string">'*'</span>) + <span class="hljs-string">'&amp;'</span>;
            }

            <span class="hljs-keyword">if</span> (params.prov) {
                query += <span class="hljs-string">'province='</span> + params.prov + <span class="hljs-string">'&amp;'</span>;
            }

            <span class="hljs-keyword">if</span> (params.concise) {
                query += <span class="hljs-string">'concise='</span> + params.concise + <span class="hljs-string">'&amp;'</span>;
            }

            <span class="hljs-keyword">if</span> (params.showAll) {
                listLimit = <span class="hljs-number">1000</span>; <span class="hljs-comment">//boost to max allowed by service</span>
            }
            query += <span class="hljs-string">'num='</span> + listLimit + <span class="hljs-string">'&amp;'</span>;

            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Executing Query: '</span> + query);</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>launch the search</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            defService = script.get(RAMP.config.geonameUrl + RAMP.locale + <span class="hljs-string">'/geonames.json'</span>, {
                query: query,
                jsonp: <span class="hljs-string">'callback'</span>
            });

            defService.then(
            <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">searchResult</span>) </span>{
                <span class="hljs-built_in">console</span>.log(searchResult);</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>turn complex results into simplified results (can add values as needed).
pass simplified result back to promise
NOTE: when using JSONP, the search results come back in a parent array.  If not JSONP, there is no array &gt;:’(</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">var</span> returnList = searchResult[<span class="hljs-number">0</span>].items.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">elem</span>) </span>{
                    <span class="hljs-keyword">return</span> {
                        name: elem.name,
                        location: elem.location,
                        province: elem.province.code, <span class="hljs-comment">//convert to text here (en/fr)?</span>
                        lonlat: [elem.longitude, elem.latitude],
                        type: elem.concise.code  <span class="hljs-comment">//convert to text here (en/fr)?</span>
                    };
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>note the bbox parameter on the geonames service does not work well.
will do a manual extent filter here, if there is one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (params.extent) {
                    defResult.resolve(returnList.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">elem</span>) </span>{
                        <span class="hljs-keyword">return</span> isInExtent(elem.lonlat, params.extent);
                    }));
                } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>no extent filter.  pass back entire list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    defResult.resolve(returnList);
                }
            },
            <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Geoname search error : '</span> + error);
                defResult.reject(error);
            });

            <span class="hljs-keyword">return</span> defResult.promise;
        }

        <span class="hljs-comment">/**
        * Will trigger an basic name search, apply filters, and package the results
        *
        *
        * @method generalSearch
        * @private
        * @param {String} name string to search on
        * @param {Object} filters search filters, particarly lonlat and optional radius
        * @param {Object} defResult a Deferred supplied by the caller. areaSearch will resolve or reject it
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generalSearch</span>(<span class="hljs-params">name, filters, defResult</span>) </span>{
            filters.q = name;

            <span class="hljs-keyword">var</span> result = {},</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>do an search on the name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            defSearch = executeSearch(filters);

            defSearch.then(
                <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">searchResult</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>service returned.  package results</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                    <span class="hljs-keyword">if</span> (searchResult.length &gt; <span class="hljs-number">0</span>) {
                        result.status = statusType.list;
                        result.list = searchResult;
                        result.defItem = searchResult[<span class="hljs-number">0</span>].lonlat; <span class="hljs-comment">//default to first item in the list</span>
                    } <span class="hljs-keyword">else</span> {
                        result.status = statusType.none;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>resolve the promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    defResult.resolve(result);
                },
                <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
                    defResult.reject(error);
                });
        }

        <span class="hljs-comment">/**
        * Will trigger an area search and package the results
        *
        *
        * @method areaSearch
        * @private
        * @param {Object} filters search filters, particarly lonlat and optional radius
        * @param {Object} defResult a Deferred supplied by the caller. areaSearch will resolve or reject it
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">areaSearch</span>(<span class="hljs-params">filters, defResult</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>set the lonlat as default result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> result = {
                defItem: filters.lonlat
            },</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>do an area search on FSA centroid</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            defArea = executeSearch(filters);

            defArea.then(
                <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">searchResult</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>service returned.  package results</p>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>TODO debate if no results should be hide or none.  None would visually indicate nothing in FSA radius found, but might confuse user to think FSA was invalid</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    result.status = (searchResult.length &gt; <span class="hljs-number">0</span>) ? statusType.list : statusType.hide;
                    result.list = searchResult;</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>resolve the promise</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    defResult.resolve(result);
                },
                <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
                    defResult.reject(error);
                });
        }

        <span class="hljs-comment">/**
        * Will search on user input string.  Public endpoint for searches, will orchestrate the appropriate search calls.
        * Accepts the following filter properties
        *   - radius: size of search radius search in km.  default 10. only used with lat/long or FSA searches
        *   - prov: province code (numeric, e.g. 35, not 'ON')
        *   - concise: concise type code
        *   - showAll: show all results or clip to first 10.  default false
        *   - extent: extent of search area in lat/long [xmin, ymin, xmax, ymax].  caller will project from basemap to latlong.  reasoning: caller can project once then cache until extent changes
        *
        * Result object can have the following properties
        *   - status: status of the search. values are list, none, hide. list means results are present. none means no results. hide means nothing should be shown (e.g. 1 char search string, bad postal code)
        *   - defItem: a lonlat array of the default result to zoom to if a person hits enter. for FSA, it is FSA centroid; for lat/long, it is the lat/long point; otherwise it is the first result
        *   - list: array of search results
        *       - name: name of the result
        *       - location: general area where the result is situated
        *       - province: province code where the result is found (numeric, e.g. 35, not 'ON')
        *       - lonlat: co-ordinate where the result is located. array of [longitude, latitude]
        *       - type: concise type code for the result
        *
        * @method geoSearch
        * @private
        * @param {String} input search item user has entered
        * @param {Object} filters any filters provided from the UI
        * @return {Object} promise of results
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">geoSearch</span>(<span class="hljs-params">input, filters</span>) </span>{
            <span class="hljs-keyword">var</span> defResult = <span class="hljs-keyword">new</span> Deferred();</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>is search too short?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (input.length &lt; <span class="hljs-number">3</span>) {
                defResult.resolve({
                    status: statusType.hide
                });
            }

            <span class="hljs-keyword">var</span> parse = parseInput(input);

            <span class="hljs-keyword">switch</span> (parse.type) {
                <span class="hljs-keyword">case</span> parseType.none:</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>add all the valid filter things, plus wildcards</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                    generalSearch(parse.data, filters, defResult);

                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> parseType.fsa:</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>search for the FSA</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> fsaPromise = fsaSearch(parse.data);

                    fsaPromise.then(
                        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fsaResult</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>did we find an FSA?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">if</span> (fsaResult.lonlat) {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>get results around the FSA</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                areaSearch({
                                    lonlat: fsaResult.lonlat,
                                    radius: filters.radius
                                }, defResult);
                            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>fsa not found.  return none result</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                defResult.resolve({
                                    status: statusType.none
                                });
                            }
                        },
                        <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
                            defResult.reject(error);
                        }
                    );

                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> parseType.lonlat:</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>package parsed lat/long for search</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    areaSearch({
                        lonlat: parse.data,
                        radius: filters.radius
                    }, defResult);

                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> parseType.prov:</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>add the province filter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    filters.prov = parse.data.prov;
                    generalSearch(parse.data.searchVal, filters, defResult);

                    <span class="hljs-keyword">break</span>;
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>after getting result, apply local extent filter if required</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">return</span> defResult.promise;
        }

        <span class="hljs-comment">/**
        * Will initialize the module. Download provice keys &amp; info. Download concise types keys &amp; info.
        *
        * @method isLatLong
        * @private
        */</span>
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>TODO do we need to worry about ensuring these calls return before the caller continues?
    they should be really fast, and if service is down geosearch is broken anyways.
    Init is called after the config loads, so should be plenty of time before a user starts geosearching</p>

            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>get provinces english</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> provUrl = <span class="hljs-string">'/codes/province.json'</span>,
                conciseUrl = <span class="hljs-string">'/codes/concise.json'</span>,
                defEnProv = script.get(RAMP.config.geonameUrl + <span class="hljs-string">'en'</span> + provUrl, {
                    jsonp: <span class="hljs-string">'callback'</span>
                });

            defEnProv.then(
            <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>service returned.  turn result into a formatted array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                provList = result[<span class="hljs-number">0</span>].definitions.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">provEn</span>) </span>{
                    <span class="hljs-keyword">return</span> {
                        code: provEn.code,
                        abbr: provEn.term,
                        name: {
                            en: provEn.description,
                            fr: <span class="hljs-string">''</span>
                        }
                    };
                });</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>now load the french provinces</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> defFrProv = script.get(RAMP.config.geonameUrl + <span class="hljs-string">'fr'</span> + provUrl, {
                    jsonp: <span class="hljs-string">'callback'</span>
                });

                defFrProv.then(
                    <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>match up province IDs of the french data to the global province list.
update the french names when a match is made</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        result[<span class="hljs-number">0</span>].definitions.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">provFr</span>) </span>{
                            provList.every(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">elem</span>) </span>{
                                <span class="hljs-keyword">if</span> (elem.code === provFr.code) {
                                    elem.name.fr = provFr.description;
                                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">//will cause the 'every' loop to break</span>
                                }
                                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">//keep looping</span>
                            });
                        });</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>now that we have a full dataset of province info, make a quick-find array for determining if strings are provinces</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        provList.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">elem</span>) </span>{
                            provSearch.splice(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, elem.abbr.toLowerCase(), elem.name.en.toLowerCase(), elem.name.fr.toLowerCase());
                        });
                    },
                     <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
                         <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Fail to load french province codes : '</span> + error);
                     });
            },
            <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Fail to load english province codes : '</span> + error);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>get geonames concise codes list english</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> defEnCon = script.get(RAMP.config.geonameUrl + <span class="hljs-string">'en'</span> + conciseUrl, {
                jsonp: <span class="hljs-string">'callback'</span>
            });

            defEnCon.then(
             <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>service returned.  turn result into a formatted array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                 conciseList = result[<span class="hljs-number">0</span>].definitions.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">conEn</span>) </span>{
                     <span class="hljs-keyword">return</span> {
                         code: conEn.code,
                         name: {
                             en: conEn.term,
                             fr: <span class="hljs-string">''</span>
                         }
                     };
                 });</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>now load the french concise codes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                 <span class="hljs-keyword">var</span> defFrCon = script.get(RAMP.config.geonameUrl + <span class="hljs-string">'fr'</span> + conciseUrl, {
                     jsonp: <span class="hljs-string">'callback'</span>
                 });

                 defFrCon.then(
                     <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>match up concise IDs of the french data to the global concise list.
update the french names when a match is made</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                         result[<span class="hljs-number">0</span>].definitions.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">conFr</span>) </span>{
                             conciseList.every(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">elem</span>) </span>{
                                 <span class="hljs-keyword">if</span> (elem.code === conFr.code) {
                                     elem.name.fr = conFr.term;
                                     <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">//will cause the "every" loop to break</span>
                                 }
                                 <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">//keep looping</span>
                             });
                         });
                     },
                      <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
                          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Fail to load french concise codes : '</span> + error);
                      });
             },
             <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
                 <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Fail to load english concise codes : '</span> + error);
             });
        }

        <span class="hljs-keyword">return</span> {
            geoSearch: geoSearch,
            init: init,
            getProvList: getProvList,
            getConciseList: getConciseList
        };
    });</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
