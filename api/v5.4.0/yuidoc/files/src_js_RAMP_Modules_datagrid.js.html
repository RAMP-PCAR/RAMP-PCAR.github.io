<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/js/RAMP/Modules/datagrid.js - ramp-pcar</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../../../assets/images/bobcat_logo_sharp_smaller_s.png" title="ramp-pcar">undefined</h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 5.4.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AdvancedToolbar.html">AdvancedToolbar</a></li>
            
                <li><a href="../classes/AreaTool.html">AreaTool</a></li>
            
                <li><a href="../classes/Array.html">Array</a></li>
            
                <li><a href="../classes/AttributeLoader.html">AttributeLoader</a></li>
            
                <li><a href="../classes/BaseMapSelector.html">BaseMapSelector</a></li>
            
                <li><a href="../classes/BaseTool.html">BaseTool</a></li>
            
                <li><a href="../classes/BookmarkLink.html">BookmarkLink</a></li>
            
                <li><a href="../classes/Bootstrapper.html">Bootstrapper</a></li>
            
                <li><a href="../classes/Brick.html">Brick</a></li>
            
                <li><a href="../classes/Bricks.html">Bricks</a></li>
            
                <li><a href="../classes/BricksChoiceBrick.html">BricksChoiceBrick</a></li>
            
                <li><a href="../classes/BufferTool.html">BufferTool</a></li>
            
                <li><a href="../classes/ButtonBrick.html">ButtonBrick</a></li>
            
                <li><a href="../classes/Checkbox.html">Checkbox</a></li>
            
                <li><a href="../classes/CheckboxBrick.html">CheckboxBrick</a></li>
            
                <li><a href="../classes/CheckboxfsBrick.html">CheckboxfsBrick</a></li>
            
                <li><a href="../classes/CheckboxGroup.html">CheckboxGroup</a></li>
            
                <li><a href="../classes/ChoiceBrick.html">ChoiceBrick</a></li>
            
                <li><a href="../classes/ColorPickerBrick.html">ColorPickerBrick</a></li>
            
                <li><a href="../classes/Datagrid.html">Datagrid</a></li>
            
                <li><a href="../classes/DatagridClickHandler.html">DatagridClickHandler</a></li>
            
                <li><a href="../classes/DataLoader.html">DataLoader</a></li>
            
                <li><a href="../classes/DataLoaderGui.html">DataLoaderGui</a></li>
            
                <li><a href="../classes/Decorator.html">Decorator</a></li>
            
                <li><a href="../classes/Dictionary.html">Dictionary</a></li>
            
                <li><a href="../classes/DistanceTool.html">DistanceTool</a></li>
            
                <li><a href="../classes/DropDownBrick.html">DropDownBrick</a></li>
            
                <li><a href="../classes/EventManager.html">EventManager</a></li>
            
                <li><a href="../classes/FeatureClickHandler.html">FeatureClickHandler</a></li>
            
                <li><a href="../classes/FeatureHighlighter.html">FeatureHighlighter</a></li>
            
                <li><a href="../classes/FileInputBrick.html">FileInputBrick</a></li>
            
                <li><a href="../classes/FilterManager.html">FilterManager</a></li>
            
                <li><a href="../classes/FunctionMangler.html">FunctionMangler</a></li>
            
                <li><a href="../classes/GlobalStorage.html">GlobalStorage</a></li>
            
                <li><a href="../classes/GraphicExtension.html">GraphicExtension</a></li>
            
                <li><a href="../classes/GUI.html">GUI</a></li>
            
                <li><a href="../classes/ImageExport.html">ImageExport</a></li>
            
                <li><a href="../classes/LayerGroup.html">LayerGroup</a></li>
            
                <li><a href="../classes/LayerItem.html">LayerItem</a></li>
            
                <li><a href="../classes/LayerLoader.html">LayerLoader</a></li>
            
                <li><a href="../classes/LayoutController.html">LayoutController</a></li>
            
                <li><a href="../classes/Map.html">Map</a></li>
            
                <li><a href="../classes/MapClickHandler.html">MapClickHandler</a></li>
            
                <li><a href="../classes/Maptips.html">Maptips</a></li>
            
                <li><a href="../classes/MetadataHandler.html">MetadataHandler</a></li>
            
                <li><a href="../classes/MultiBrick.html">MultiBrick</a></li>
            
                <li><a href="../classes/Navigation.html">Navigation</a></li>
            
                <li><a href="../classes/OkCancelButtonBrick.html">OkCancelButtonBrick</a></li>
            
                <li><a href="../classes/PopulationTool.html">PopulationTool</a></li>
            
                <li><a href="../classes/Popup.html">Popup</a></li>
            
                <li><a href="../classes/PopupBase.html">PopupBase</a></li>
            
                <li><a href="../classes/PopupBaseSettings.html">PopupBaseSettings</a></li>
            
                <li><a href="../classes/PopupManager.html">PopupManager</a></li>
            
                <li><a href="../classes/Prototype.html">Prototype</a></li>
            
                <li><a href="../classes/QuickZoom.html">QuickZoom</a></li>
            
                <li><a href="../classes/RAMP.html">RAMP</a></li>
            
                <li><a href="../classes/RampMap.html">RampMap</a></li>
            
                <li><a href="../classes/RAMPStarter.html">RAMPStarter</a></li>
            
                <li><a href="../classes/SimpleInputBrick.html">SimpleInputBrick</a></li>
            
                <li><a href="../classes/StepItem.html">StepItem</a></li>
            
                <li><a href="../classes/SubPanel.html">SubPanel</a></li>
            
                <li><a href="../classes/SubPanelSettings.html">SubPanelSettings</a></li>
            
                <li><a href="../classes/Theme.html">Theme</a></li>
            
                <li><a href="../classes/TmplHelper.html">TmplHelper</a></li>
            
                <li><a href="../classes/TmplUtil.html">TmplUtil</a></li>
            
                <li><a href="../classes/ToggleBrick.html">ToggleBrick</a></li>
            
                <li><a href="../classes/Url.html">Url</a></li>
            
                <li><a href="../classes/Util.html">Util</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/AttributeLoader.html">AttributeLoader</a></li>
            
                <li><a href="../modules/BookmarkLink.html">BookmarkLink</a></li>
            
                <li><a href="../modules/Bricks.html">Bricks</a></li>
            
                <li><a href="../modules/Datagrid.html">Datagrid</a></li>
            
                <li><a href="../modules/DataLoader.html">DataLoader</a></li>
            
                <li><a href="../modules/FilterManager.html">FilterManager</a></li>
            
                <li><a href="../modules/GeoSearch.html">GeoSearch</a></li>
            
                <li><a href="../modules/GlobalStorage.html">GlobalStorage</a></li>
            
                <li><a href="../modules/Map.html">Map</a></li>
            
                <li><a href="../modules/Maptips.html">Maptips</a></li>
            
                <li><a href="../modules/Navigation.html">Navigation</a></li>
            
                <li><a href="../modules/QuickZoom.html">QuickZoom</a></li>
            
                <li><a href="../modules/RAMP.html">RAMP</a></li>
            
                <li><a href="../modules/Theme.html">Theme</a></li>
            
                <li><a href="../modules/Tools.html">Tools</a></li>
            
                <li><a href="../modules/UI.html">UI</a></li>
            
                <li><a href="../modules/Utils.html">Utils</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/js/RAMP/Modules/datagrid.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*global define, tmpl, TimelineLite, TweenLite, window, i18n, $, console, RAMP */
/*jslint white: true */

/**
* Datagrid submodule.
*
* @module RAMP
* @submodule Datagrid
* @main Datagrid
*/

/**
* The Datagrid class represents the side bar table shown next to the map. The data grid displays all map objects in a text format and allows the user to see more
* details (same as clicking the map object) and navigate to the object. This class create the UI panel, events, and event-handles for the data grid container.
*
* ####Imports RAMP Modules:
* {{#crossLink &quot;RAMP&quot;}}{{/crossLink}}
* {{#crossLink &quot;GraphicExtension&quot;}}{{/crossLink}}
* {{#crossLink &quot;GlobalStorage&quot;}}{{/crossLink}}
* {{#crossLink &quot;DatagridClickHandler&quot;}}{{/crossLink}}
* {{#crossLink &quot;Map&quot;}}{{/crossLink}}
* {{#crossLink &quot;EventManager&quot;}}{{/crossLink}}
* {{#crossLink &quot;Theme&quot;}}{{/crossLink}}
* {{#crossLink &quot;Util&quot;}}{{/crossLink}}
* {{#crossLink &quot;Array&quot;}}{{/crossLink}}
* {{#crossLink &quot;Dictionary&quot;}}{{/crossLink}}
* {{#crossLink &quot;PopupManager&quot;}}{{/crossLink}}
* {{#crossLink &quot;TmplHelper&quot;}}{{/crossLink}}
*
* ####Uses RAMP Templates:
* {{#crossLink &quot;templates/datagrid_template.json&quot;}}{{/crossLink}}
* {{#crossLink &quot;templates/extended_datagrid_template.json&quot;}}{{/crossLink}}
*
* @class Datagrid
* @static
* @uses dojo/_base/lang
* @uses dojo/dom-class
* @uses dojo/dom-attr
* @uses dojo/dom-construct
* @uses dojo/topic
* @uses dojo/on
* @uses esri/tasks/query
*/

define([
/* Dojo */
    &quot;dojo/_base/lang&quot;, &quot;dojo/topic&quot;, &quot;dojo/Deferred&quot;,

/* Text */
     &quot;dojo/text!./templates/datagrid_template.json&quot;,
     &quot;dojo/text!./templates/extended_datagrid_template.json&quot;,

// Esri
        &quot;esri/tasks/query&quot;,

// Ramp
        &quot;ramp/graphicExtension&quot;, &quot;ramp/globalStorage&quot;, &quot;ramp/datagridClickHandler&quot;, &quot;ramp/map&quot;,
        &quot;ramp/eventManager&quot;, &quot;ramp/theme&quot;, &quot;ramp/layerLoader&quot;,

// Util
         &quot;utils/util&quot;, &quot;utils/array&quot;, &quot;utils/dictionary&quot;, &quot;utils/popupManager&quot;, &quot;utils/tmplHelper&quot;],

    function (
    // Dojo
        lang, topic, Deferred,

    //Text
        data_grid_template,
        extended_datagrid_template,

    // Esri
        EsriQuery,

    // Ramp
        GraphicExtension, GlobalStorage, DatagridClickHandler, RampMap, EventManager, Theme, LayerLoader,

    // Util
        utilMisc, UtilArray, utilDict, popupManager, tmplHelper) {
        &quot;use strict&quot;;

        var GRID_MODE_SUMMARY = &quot;summary&quot;,
            GRID_MODE_FULL = &quot;full&quot;,

            /**
            * Name of the attribute used to store the oid
            * in the details and zoomTo buttons
            *
            * @private
            * @property featureOidField
            */
            featureOidField = &quot;feature-oid&quot;,

            /**
            * Name of the attribute used to store the layer id
            * in the details and zoomTo buttons
            *
            * @private
            * @property layerIdField
            */
            layerIdField = &quot;layer-id&quot;,

            data_grid_template_json = JSON.parse(tmplHelper.stringifyTemplate(data_grid_template)),
            extended_datagrid_template_json = JSON.parse(tmplHelper.stringifyTemplate(extended_datagrid_template)),
            currentRowsPerPage = 1, //keeps track of the rows-per-page of the active grid

            /**
            * The jquery table
            *
            * @private
            * @property oTable
            */
            oTable,

        // The JQuery Object representing the grid
            jqgrid,
            featureToIndex = {},

            currentSortingMode = &quot;asc&quot;,

        // A boolean used to keep track of whether or not the grid should apply an
        // extent filter when the datagrid gets selected
            extentFilterExpired = true,

            zoomToGraphic,

            lastExtent,

            // invisibleLayer toggle counter
            invisibleLayerToggleOn = [],

            /**
            * Total number of features in all the visible layers on the map
            *
            * @private
            * @property totalRecords
            */
            totalRecords = 0,

            ui = (function () {
                /**
                * creates a datagrid row that has the following features:
                * highlight for a given feature
                * un-highlight
                * scroll to for a given feature
                *
                * @method createRowPrototype
                * @private
                * @param {String} cssClass the style that highlights the row.
                * @return {Object} an object containing features of a datagrid row
                */
                function createRowPrototype(cssClass) {
                    var index = -1,
                        fData = null;

                    return {
                        focusedButton: null,

                        isActive: function () {
                            return fData !== null;
                        },

                        isEqual: function (layerId, oid) {
                            var thisId = fData.parent.layerId,
                                thisOid = GraphicExtension.getFDataOid(fData);

                            return (thisId === layerId) &amp;&amp; (thisOid === oid);
                        },

                        /**
                        * Navigate to the page the row is in and scroll to it. Returns true
                        * if the row exists in the datagrid, false otherwise.
                        *
                        * @method navigateToRow
                        * @return {Boolean} A value indicating is the navigation is successful
                        * @private
                        */
                        navigateToRow: function () {
                            if (index !== -1) {
                                // Figure out which page the entry is in and navigate to that page
                                var page = Math.floor(index / currentRowsPerPage);
                                if (oTable.page() !== page) {
                                    // False tells draw not to navigate to the first page
                                    jqgrid.DataTable().page(page).draw(false);
                                }

                                jqgridTableWrapper.scrollTo(this.getNode(), 300, {
                                    axis: &quot;y&quot;,
                                    offset: {
                                        left: 0,
                                        top: -this.getNode().height() * 1.5
                                    }
                                });

                                return true;
                            }
                            return false;
                        },

                        setFeatureData: function (newFData) {
                            fData = newFData;

                            this.refresh();
                        },

                        /**
                        * Refresh the page index of this row
                        *
                        * @method refresh
                        * @private
                        * @return {{node: jObject, page: number}} A row node that displays graphic information. If none found, returns an object with empty jNode.
                        */
                        refresh: function () {
                            if (fData) {
                                var layerId = fData.parent.layerId,
                                    id = GraphicExtension.getFDataOid(fData);
                                if ((layerId in featureToIndex) &amp;&amp; (id in featureToIndex[layerId])) {
                                    index = featureToIndex[layerId][id];
                                } else {
                                    index = -1;
                                }
                            } else {
                                index = -1;
                            }
                        },

                        /**
                        * Finds a row node corresponding to this object.
                        *
                        * @method getNode
                        * @private
                        * @return {{node: jObject, page: number}} A row node that displays graphic information. If none found, returns an object with empty jNode.
                        */
                        getNode: function () {
                            return $(String.format(&quot;#jqgrid tbody tr:nth-child({0})&quot;, index % currentRowsPerPage + 1));
                        },

                        /**
                        * Highlights this row using the specified cssClass.
                        *
                        * @method activate
                        * @private
                        */
                        activate: function () {
                            if (fData) {
                                this.getNode().addClass(cssClass);

                                if (this.focusedButton) {
                                    this.getNode().find(this.focusedButton).focus();
                                    this.focusedButton = null;
                                }
                            }
                        },

                        /**
                        * Removes a specified cssClass from this row in the data grid
                        *
                        * @method deactivate
                        * @private
                        */
                        deactivate: function () {
                            if (fData) {
                                this.getNode().removeClass(cssClass);
                                fData = null;
                            }
                        }
                    };
                }

                var highlightRow = createRowPrototype(&quot;selected-row&quot;),
                    zoomlightRow = createRowPrototype(&quot;highlighted-row&quot;),

                    extendedTabTitle,

                    sectionNode,
                    tabNode = $(&quot;details[data-panel-name=datagrid]&quot;),

                    selectedDatasetId,

                    datagridStatusLine,
                    datagridGlobalToggles,
                    datagridNotice,
                    jqgridWrapper,
                    jqgridTableWrapper,
                    dataTablesScroll,
                    dataTablesScrollBody,
                    dataTablesScrollHead,
                    datasetSelector,
                    datasetSelectorSubmitButton,

                    datagridMode = GRID_MODE_SUMMARY, // GRID_MODE_FULL

                    _isReady = false; // indicates if the ui has fully rendered

                /**
                * Generates the content for a grid cell.  Will use template engine the first time, cached value after that.
                * Function must conform to datatables renderer api
                * https://datatables.net/reference/option/columns.render
                *
                * @method rowRenderer
                * @private
                * @param {Object} data the data for this cell that was added to the grid. not used
                * @param {String} type the type of request. not used
                * @param {Array} row full data values for the current row
                * @param {Object} meta additional information about the cell
                * return {String} value to display in the given grid cell
                */
                function rowRenderer(data, type, row, meta) {
                    //Remember, case sensitivity MATTERS in the attribute name.
                    var rowMetadata = row.last(), //secret stash of info in invisible last column
                        datagridMode = ui.getDatagridMode(),
                        tmplData,
                        layerConfig;

                    if (!rowMetadata || !rowMetadata.fData) {
                        //weird case where grid tries to render on non-existant row
                        return &quot;&quot;;
                    }

                    layerConfig = GraphicExtension.getConfigForFData(rowMetadata.fData);

                    if (datagridMode === GRID_MODE_SUMMARY) {
                        if (!(datagridMode in rowMetadata)) {
                            //first time rendering this row.
                            //we will run the template engine, then store the result in the last column.

                            //bundle feature into the template data object
                            tmplData = tmplHelper.dataBuilder(rowMetadata.fData, layerConfig);

                            var sumTemplate = layerConfig.templates.summary;

                            tmpl.cache = {};

                            tmpl.templates = data_grid_template_json;

                            rowMetadata[datagridMode] = tmpl(sumTemplate, tmplData);
                        }

                        return rowMetadata[datagridMode];
                    } else {
                        if (!(datagridMode in rowMetadata)) {
                            //first time rendering this row.
                            //we will generate it (template engine), then store the result in the last column.

                            rowMetadata[datagridMode] = [];

                            //make array containing values for each column in the full grid
                            // retrieve extendedGrid config object
                            var extendedGrid = layerConfig.datagrid.gridColumns;

                            tmpl.cache = {};
                            tmpl.templates = extended_datagrid_template_json;

                            //bundle feature into the template data object
                            tmplData = tmplHelper.dataBuilder(rowMetadata.fData, layerConfig);

                            extendedGrid.forEach(function (col, i) {
                                // add columnIdx property, and set initial value
                                tmplData.columnIdx = i;
                                var result = tmpl(col.columnTemplate, tmplData);
                                // Need to check if it&#x27;s a number, since the template converts
                                // everything into strings
                                if (col.sortType === &quot;numeric&quot;) {
                                    result = Number(result);
                                }
                                rowMetadata[datagridMode].push(result);
                            });
                        }

                        return rowMetadata[datagridMode][meta.col];
                    }
                }

                /**
                * Creates a Data table based on the grid configuration specified in the application config object. See http://datatables.net/reference/option/ for addition information on config parameters.
                *
                * @method createDatatable
                * @private
                */
                function createDatatable() {
                    var forcedWidth,
                        focusConfig,
                        tableOptions = {
                            info: false,
                            columnDefs: [],
                            autoWidth: false,
                            deferRender: true,
                            order: [], //required to remove the &quot;default sort&quot; icon from the first column
                            paging: true,
                            pagingType: &quot;ramp&quot;, //&quot;full_numbers&quot;,
                            scrollX: true,
                            destroy: true,
                            language: i18n.t(&quot;datagrid.gridstrings&quot;, { returnObjectTrees: true }),
                            getTotalRecords: function () {
                                return totalRecords;
                            }
                        };

                    if (datagridMode === GRID_MODE_SUMMARY) {
                        currentRowsPerPage = RAMP.config.rowsPerPage;
                        tableOptions = lang.mixin(tableOptions,
                            {
                                columns: [{
                                    title: &quot;Name&quot;,
                                    width: &quot;300px&quot;,
                                    type: &quot;string&quot;,
                                    className: &quot;&quot;,
                                    render: rowRenderer,
                                    orderable: true
                                }],
                                dom: &#x27;&lt;&quot;jqgrid_table_wrapper summary-table&quot;t&gt;&lt;&quot;status-line&quot;p&gt;&#x27;,
                                searching: true,
                                pageLength: currentRowsPerPage
                            }
                        );
                    } else {
                        //layout for variable column (extended grid)
                        //grab config for active dataset and generate a table layout based on gridColumns
                        if (ui.getSelectedDatasetId() in RAMP.layerRegistry) {
                            focusConfig = RAMP.layerRegistry[ui.getSelectedDatasetId()].ramp.config;
                        }
                        if (focusConfig &amp;&amp; focusConfig.datagrid) {
                            currentRowsPerPage = focusConfig.datagrid.rowsPerPage;
                        }
                        tableOptions = lang.mixin(tableOptions,
                            {
                                columns: ui.getSelectedDatasetId() === null ? [{ title: &quot;&quot; }] : focusConfig.datagrid.gridColumns.map(function (column) {
                                    return {
                                        title: column.title,
                                        width: column.width ? column.width : &quot;100px&quot;,
                                        type: column.sortType,
                                        className: column.alignment ? &quot;&quot; : &quot;center&quot;,
                                        render: rowRenderer,
                                        orderable: column.orderable
                                    };
                                }),
                                dom: &#x27;&lt;&quot;jqgrid_table_wrapper full-table&quot;t&gt;&lt;&quot;datagrid-info-notice simple&quot;&gt;&lt;&quot;status-line&quot;p&gt;&#x27;,
                                scrollY: &quot;500px&quot;, // just a placeholder; it will be dynamically updated later
                                searching: RAMP.config.extendedDatagridExtentFilterEnabled,
                                pageLength: currentRowsPerPage
                            }
                        );
                    }

                    jqgrid = sectionNode.find(&quot;table&quot;);

                    // True if a page change just occurred
                    // False otherwise
                    var pageChange = false;

                    oTable = jqgrid.DataTable(tableOptions)
                        .on(&quot;page.dt&quot;, function () {
                            topic.publish(EventManager.GUI.SUBPANEL_DOCK, { origin: &quot;datagrid,ex-datagrid&quot; });

                            console.log(&quot;subPanleDock&quot;);

                            pageChange = true;
                        })
                        .on(&quot;order.dt&quot;, function () {
                            topic.publish(EventManager.GUI.SUBPANEL_DOCK, { origin: &quot;datagrid,ex-datagrid&quot; });

                            console.log(&quot;subPanleDock&quot;);
                        })
                        .on(&quot;draw.dt&quot;, function () {
                            indexSortedData();

                            // Do not activateRows if we&#x27;re doing a page change
                            if (pageChange) {
                                pageChange = false;
                            } else {
                                ui.activateRows();
                            }

                            ui.adjustPanelWidth();

                            topic.publish(EventManager.Datagrid.DRAW_COMPLETE);
                        });

                    jqgridWrapper = sectionNode.find(&quot;#jqgrid_wrapper&quot;);
                    jqgridTableWrapper = sectionNode.find(&quot;.jqgrid_table_wrapper&quot;);
                    dataTablesScroll = sectionNode.find(&quot;.dataTables_scroll&quot;);
                    dataTablesScrollBody = dataTablesScroll.find(&quot;.dataTables_scrollBody&quot;);
                    dataTablesScrollHead = dataTablesScroll.find(&quot;.dataTables_scrollHead&quot;);

                    datagridNotice = sectionNode.find(&#x27;.datagrid-info-notice&#x27;);

                    Theme.tooltipster(jqgridWrapper);

                    // DO:Clean;
                    if (datagridMode !== GRID_MODE_SUMMARY) {
                        jqgridWrapper.addClass(&quot;fadedOut&quot;);

                        // explicitly set height of the scrollbody so the horizontal scrollbar is visible
                        dataTablesScrollBody.height(jqgridTableWrapper.height() - dataTablesScrollHead.height());

                        // explicitly force-set width of the jqgrid so it wouldn&#x27;t compress when a sub-panel is opened
                        // also check if the width is no greater than that of the container, hide the horizontal scrollbar
                        forcedWidth = jqgrid.outerWidth();

                        ui.adjustPanelWidth();

                        /*if (forcedWidth === jqgridWrapper.outerWidth()) {
                            dataTablesScrollBody.addClass(&quot;overflow-x-hidden&quot;);
                        } else {
                            dataTablesScrollBody.removeClass(&quot;overflow-x-hidden&quot;);
                        }*/

                        jqgrid.forceStyle({ width: forcedWidth + &quot;px&quot; });
                    }
                }
                /**
                * Initialize tooltips for the data grid
                *
                * @method initTooltips
                * @private
                */
                function initTooltips() {
                    /// &lt;summary&gt;
                    /// initialize tooltips for the datagrid
                    /// &lt;/summary&gt;
                    popupManager.registerPopup(sectionNode, &quot;hoverIntent&quot;,
                        function () {
                            if (this.target.attr(&quot;title&quot;)) {
                                if (this.target.isOverflowed()) {
                                    this.target.tooltipster({ theme: &#x27;.tooltipster-dark&#x27; }).tooltipster(&quot;show&quot;);
                                } else {
                                    this.target.removeAttr(&quot;title&quot;);
                                }
                            }
                        },
                        {
                            handleSelector: &quot;.point-name, .category-name, .title-span&quot;,
                            useAria: false,
                            timeout: 500
                        }
                    );
                }

                /**
                * Adds event-handling for buttons inside the data grid&#x27;s row elements (i.e &#x27;Details&#x27;, &#x27;Zoom To&#x27; buttons)
                *
                * @method setButtonEvents
                * @private
                */
                function setButtonEvents() {
                    sectionNode.on(&quot;click&quot;, &quot;button.details&quot;, function () {
                        var buttonNode = $(this),
                            layerId = buttonNode.data(layerIdField),
                            oid = buttonNode.data(featureOidField);

                        highlightRow.focusedButton = &quot;button.details&quot;;

                        if (highlightRow.isActive() &amp;&amp; highlightRow.isEqual(layerId, oid)) {
                            DatagridClickHandler.onDetailDeselect(datagridMode);
                        } else {
                            var fData = getFDataFromButton(buttonNode),
                                graphic = getGraphicFromFData(fData);

                            DatagridClickHandler.onDetailSelect(buttonNode, fData, graphic, datagridMode);
                        }
                    });

                    // Event handling for &quot;Zoom To&quot; button
                    sectionNode.on(&quot;click&quot;, &quot;button.zoomto&quot;, function (evt) {
                        var zoomNode = $(this),
                            fData = getFDataFromButton(zoomNode);

                        zoomlightRow.focusedButton = &quot;button.zoomto&quot;;

                        // Zoom To
                        if (zoomNode.text() === i18n.t(&quot;datagrid.zoomTo&quot;)) {
                            handleGridEvent(evt, function () {
                                zoomToGraphic = getGraphicFromFData(fData);

                                //store the current extent, then zoom to point.
                                lastExtent = RampMap.getMap().extent.clone();

                                DatagridClickHandler.onZoomTo(RampMap.getMap().extent.clone(), fData, zoomToGraphic);

                                // Update &quot;zoom back&quot; text after the extent change, if we update it
                                // before the extent change, it won&#x27;t work since the datagrid gets
                                // repopulated after an extent change
                                utilMisc.subscribe(EventManager.Datagrid.EXTENT_FILTER_END, function () {
                                    // Find the first node with the same oid, layerId
                                    var newNode = $(String.format(&quot;button.zoomto[data-{0}=&#x27;{1}&#x27;][data-{2}=&#x27;{3}&#x27;]:eq(0)&quot;,
                                                    featureOidField, GraphicExtension.getFDataOid(fData),
                                                    layerIdField, fData.parent.layerId));
                                    // Change node&#x27;s text to Zoom Back
                                    newNode.text(i18n.t(&quot;datagrid.zoomBack&quot;));
                                });
                            });
                        } else { // Zoom back
                            DatagridClickHandler.onZoomBack();
                            // Reset focus back to &quot;Zoom To&quot; link after map extent change
                            utilMisc.subscribe(EventManager.Datagrid.EXTENT_FILTER_END, function () {
                                var newNode = $(String.format(&quot;button.zoomto[data-{0}=&#x27;{1}&#x27;][data-{2}=&#x27;{3}&#x27;]:eq(0)&quot;,
                                        featureOidField, GraphicExtension.getFDataOid(fData),
                                        layerIdField, fData.parent.layerId));
                                // Change node&#x27;s text back to Zoom To
                                newNode.text(i18n.t(&quot;datagrid.zoomTo&quot;));
                                newNode.focus();
                            });
                            zoomNode.text(i18n.t(&quot;datagrid.zoomTo&quot;));
                        }
                    });

                    sectionNode.on(&quot;click&quot;, &quot;button.global-button&quot;, function () {
                        var buttonNode = $(this);

                        if (currentSortingMode === &quot;asc&quot;) {
                            buttonNode.addClass(&quot;state-expanded&quot;);
                            currentSortingMode = &quot;desc&quot;;
                        } else {
                            buttonNode.removeClass(&quot;state-expanded&quot;);
                            currentSortingMode = &quot;asc&quot;;
                        }

                        jqgrid.DataTable().order([0, currentSortingMode]).draw();
                    });

                    //Adds an event trigger for the expansion of the datagrid control
                    sectionNode.on(&quot;click&quot;, &quot;button.expand&quot;, function () {
                        var d = new Deferred();
                        console.log(&quot;grid expanded!&quot;);

                        datagridMode = datagridMode === GRID_MODE_SUMMARY ? GRID_MODE_FULL : GRID_MODE_SUMMARY;

                        d.then(function () {
                            initScrollListeners();
                        });

                        refreshPanel(d);

                        topic.publish(EventManager.GUI.DATAGRID_EXPAND);
                    });

                    sectionNode.on(&quot;change&quot;, &quot;#datasetSelector&quot;, function () {
                        var controlNode = $(this),
                            optionSelected = controlNode.find(&quot;option:selected&quot;),
                            state = (optionSelected[0].value === selectedDatasetId);

                        updateDatasetSelectorState(state, true);
                    });

                    sectionNode.on(&quot;click&quot;, &quot;#datasetSelectorSubmitButton&quot;, function () {
                        var optionSelected = datasetSelector.find(&quot;option:selected&quot;);

                        if (optionSelected.length &gt; 0) {
                            selectedDatasetId = optionSelected[0].value;
                        } else {
                            selectedDatasetId = &quot;&quot;;
                        }

                        refreshTable();
                    });

                    popupManager.registerPopup(sectionNode, &quot;hover, focus&quot;,
                        function (d) {
                            this.target.removeClass(&quot;wb-invisible&quot;);
                            d.resolve();
                        },
                        {
                            handleSelector: &quot;tr&quot;,

                            targetSelector: &quot;.record-controls&quot;,

                            closeHandler: function (d) {
                                this.target.addClass(&quot;wb-invisible&quot;);

                                d.resolve();
                            },

                            activeClass: &quot;bg-very-light&quot;,
                            useAria: false
                        }
                    );

                    popupManager.registerPopup(sectionNode, &quot;hover, focus&quot;,
                        function (d) {
                            d.resolve();
                        },
                        {
                            handleSelector: &quot;.full-table #jqgrid tbody tr&quot;,
                            activeClass: &quot;bg-very-light&quot;,
                            useAria: false
                        }
                    );

                    popupManager.registerPopup(sectionNode, &quot;dblclick&quot;,
                        function (d) {
                            var //oldHandles = jqgrid.find(&quot;.expand-cell&quot;),
                                extraPadding = (this.handle.outerHeight() - this.target.height()) / 2;

                            TweenLite.set(&quot;.expand-cell&quot;, { clearProps: &quot;padding&quot;, className: &quot;-=expand-cell&quot; });
                            //TweenLite.set(&quot;.expand-cell&quot;, { className: &quot;-=expand-cell&quot; });
                            TweenLite.set(this.handle, { padding: extraPadding });

                            window.getSelection().removeAllRanges();

                            d.resolve();
                        },
                        {
                            handleSelector: &quot;td&quot;,

                            targetSelector: &quot;.title-span&quot;,

                            closeHandler: function (d) {
                                TweenLite.set(this.handle, { clearProps: &quot;padding&quot; });
                                TweenLite.set(this.handle, { className: &quot;-=expand-cell&quot; });

                                d.resolve();
                            },

                            activeClass: &quot;expand-cell&quot;,
                            useAria: false
                        }
                    );

                    // handle clicks on notices
                    popupManager.registerPopup(sectionNode, &quot;click&quot;,
                        function (d) {
                            this.target.toggle();

                            this.handle
                                .find(&quot;.separator i&quot;)
                                .removeClass(&quot;fa-angle-down&quot;)
                                .addClass(&quot;fa-angle-up&quot;);

                            d.resolve();
                        },
                        {
                            closeHandler: function (d) {
                                this.target.toggle();

                                this.handle
                                    .find(&quot;.separator i&quot;)
                                    .removeClass(&quot;fa-angle-up&quot;)
                                    .addClass(&quot;fa-angle-down&quot;);

                                d.resolve();
                            },

                            handleSelector: &quot;.info-notice-button&quot;,
                            containerSelector: &quot;.datagrid-info-notice&quot;,
                            targetSelector: &quot;.notice-details&quot;
                        }
                    );
                }

                /**
                * Apply&#x27;s or removes the scrollbar from the data grid based on the height of its container.
                *
                * @method initScrollListeners
                * @private
                */
                function initScrollListeners() {
                    var currentTopScroll,
                        currentBottomScroll;

                    if (datagridMode === GRID_MODE_SUMMARY) {
                        jqgridTableWrapper.scroll(function () {
                            currentTopScroll = jqgridTableWrapper.scrollTop();
                            currentBottomScroll = dataTablesScroll.height() - jqgridTableWrapper.scrollTop() - jqgridTableWrapper.height();

                            if (currentTopScroll === 0) {
                                datagridGlobalToggles.removeClass(&quot;scroll&quot;);
                                datagridNotice.removeClass(&quot;scroll&quot;);
                            } else {
                                datagridGlobalToggles.addClass(&quot;scroll&quot;);
                                datagridNotice.addClass(&quot;scroll&quot;);
                            }

                            if (currentBottomScroll === 0) {
                                datagridStatusLine.removeClass(&quot;scroll&quot;);
                            } else {
                                datagridStatusLine.addClass(&quot;scroll&quot;);
                            }
                        });
                    } else {
                        dataTablesScrollBody.scroll(function () {
                            currentTopScroll = dataTablesScrollBody.scrollTop();

                            if (currentTopScroll === 0) {
                                dataTablesScrollHead.removeClass(&quot;scroll&quot;);
                            } else {
                                dataTablesScrollHead.addClass(&quot;scroll&quot;);
                            }
                        });
                    }
                }

                /**
                * Highlights the row according to the graphic stored in the event. Sets the hightlightRow variable to the graphic object inside the sent event
                *
                * @method highlightrowShow
                * @private
                * @param {Object} event A thrown event that contains a graphic object inside the grid
                */
                function highlightrowShow(event) {
                    highlightrowHide();

                    highlightRow.setFeatureData(event.fData);

                    if (event.scroll) {
                        ui.activateRows();
                        //applyExtentFilter();
                    }
                }

                /**
                * Un-highlights the row that is currently highlighted
                *
                * @method highlightrowHide
                * @private
                */
                function highlightrowHide() {
                    highlightRow.deactivate();

                    DatagridClickHandler.onZoomCancel();
                }

                /**
                * Stores the graphic in the given event in the variable zoomlightRow
                *
                * @method zoomlightrowShow
                * @private
                * @param {Object} event A thrown event that contains a graphic object inside the grid
                */
                function zoomlightrowShow(event) {
                    zoomlightRow.setFeatureData(event.fData);
                }

                /**
                * De-activates the row stored in zoomlightRow
                *
                * @method zoomlightrowHide
                * @private
                */
                function zoomlightrowHide() {
                    zoomlightRow.deactivate();
                }

                /**
                * Registers event handlers for following events:
                *
                * datagrid/highlightrow-show
                * datagrid/zoomlightrow-show
                * datagrid/zoomlightrow-hide
                * @method initUIListeners
                * @private
                */
                function initUIListeners() {
                    topic.subscribe(EventManager.Datagrid.HIGHLIGHTROW_SHOW, highlightrowShow);

                    topic.subscribe(EventManager.Datagrid.HIGHLIGHTROW_HIDE, highlightrowHide);

                    topic.subscribe(EventManager.Datagrid.ZOOMLIGHTROW_SHOW, zoomlightrowShow);

                    topic.subscribe(EventManager.Datagrid.ZOOMLIGHTROW_HIDE, zoomlightrowHide);

                    topic.subscribe(EventManager.Datagrid.DRAW_COMPLETE, updateDatasetSelectorToLoaded);
                }
                /**
                 * Updates the state of the dataset selector based on whether the dataset has been loaded and what dataset is currently selected.
                 *
                 * @method updateDatasetSelectorState
                 * @param {Boolean} state indicates if button is disabled or not; true - disabled;
                 * @param {Boolean} [loaded] indicates if the selected dataset is already loaded; it&#x27;s assumed to be loading otherwise
                 */
                function updateDatasetSelectorState(state, loaded) {
                    var layer;
                    loaded = loaded || false;

                    datasetSelectorSubmitButton
                        .attr(&quot;disabled&quot;, state)
                        .text(state ?
                            (loaded ?
                                i18n.t(&quot;datagrid.ex.datasetSelectorButtonLoaded&quot;)
                                : i18n.t(&quot;datagrid.ex.datasetSelectorButtonLoading&quot;))
                            : i18n.t(&quot;datagrid.ex.datasetSelectorButtonLoad&quot;));

                    layer = RAMP.config.layers.feature.filter(function (layer) {
                        return layer.id === selectedDatasetId;
                    });

                    if (extendedTabTitle &amp;&amp; layer.length &gt; 0) {
                        extendedTabTitle.text(&quot;: &quot; + layer[0].displayName);
                    }
                }

                function updateDatasetSelectorToLoaded() {
                    datasetSelectorSubmitButton
                        .text(i18n.t(&quot;datagrid.ex.datasetSelectorButtonLoaded&quot;));
                }

                function refreshTable() {
                    var duration = 0.2,
                        tl = new TimelineLite({ paused: true }),
                        stl = new TimelineLite({ paused: true }),
                        newWrapper,
                        deffered = new Deferred();

                    tmpl.cache = {};
                    tmpl.templates = data_grid_template_json;
                    newWrapper = tmpl(
                        &quot;datagrid_manager_table_Template&quot;,
                        {
                            tableId: &quot;jqgrid&quot;,
                            tableCss: &quot;display table-condensed table-simplify&quot;// animated fadeIn&quot;
                        }
                    );

                    if (highlightRow.isActive()) {
                        duration = 0.6;
                        DatagridClickHandler.onDetailDeselect(datagridMode);
                    }

                    tl.set(jqgridWrapper, { className: &quot;+=animated fadeOut&quot; });

                    /*jshint validthis: true */
                    tl.call(function () {
                        tl.pause();

                        jqgridWrapper.replaceWith(newWrapper);
                        createDatatable();

                        updateDatasetSelectorState(true);

                        // continue with transition when apply filter finished
                        deffered.then(function () {
                            //console.timeEnd(&#x27;applyExtentFilter&#x27;);

                            console.log(&quot;I&#x27;m resuming&quot;);

                            stl.set(jqgridWrapper, { className: &quot;-=fadedOut&quot; });
                            stl.set(jqgridWrapper, { className: &quot;+=animated fadeIn&quot; });
                            stl.set(jqgridWrapper, { className: &quot;-=animated fadeIn&quot; }, &quot;+=1&quot;);
                            //stl.set(jqgridTableWrapper, { className: &quot;-=animated fadeIn&quot; }, &quot;+=&quot; + duration);

                            stl.play();

                            //tl.set(jqgrid, { className: &quot;-=animated fadeIn&quot; }, &quot;+=&quot; + duration);
                            //tl.resume();
                        });

                        //console.time(&#x27;applyExtentFilter&#x27;);

                        applyExtentFilter(deffered);
                    }, null, this, duration + 0.05);

                    /*tl.set(jqgridWrapper, { className: &quot;-=fadeOut&quot; });
                    tl.set(jqgridWrapper, { className: &quot;+=fadeIn&quot; });
                    tl.set(jqgridWrapper, { className: &quot;-=animated fadeIn&quot; }, &quot;+=&quot; + duration);*/

                    tl.play();
                }

                //recreates the datagrid panel with the new grid + stuff ( summary or extended )
                function refreshPanel(d) {
                    // using template to generate global checkboxes
                    var globalCheckBoxesData = {
                        buttonLabel: i18n.t(&quot;datagrid.sort&quot;),
                        classAddition: &quot;font-medium global-button&quot;
                    },
                        templateData = {
                            buttons: globalCheckBoxesData,
                            tableId: &quot;jqgrid&quot;,
                            tableCss: &quot;display table-condensed table-simplify&quot;
                        },
                        section,
                        templateKey,
                        duration = 0.5,
                        tl = new TimelineLite({ paused: true }),
                        stl = new TimelineLite({ paused: true }),
                        deffered = new Deferred();

                    tmpl.cache = {};
                    tmpl.templates = data_grid_template_json;

                    if (datagridMode === GRID_MODE_SUMMARY) {
                        templateKey = &quot;datagrid_manager_Template&quot;;
                        templateData.buttons.toggleTitle = i18n.t(&quot;datagrid.fullData&quot;);

                        if (extendedTabTitle) {
                            extendedTabTitle.remove();
                        }
                    } else {
                        templateKey = &quot;datagrid_full_manager_Template&quot;;
                        // bugfix: 7047 need this to fix extended grid issue.
                        selectedDatasetId = &quot;&quot;;

                        // filter out static layers
                        var nonStaticFeatureLayers = RAMP.config.layers.feature.filter(function (layerConfig) {
                            var layer = RAMP.map.getLayer(layerConfig.id);
                            if (layer) {
                                if (layer.loaded) {
                                    return layer.ramp.type !== GlobalStorage.layerType.Static &amp;&amp; layer.visible;
                                }
                            }
                        });

                        templateData.buttons = lang.mixin(templateData.buttons,
                            {
                                datasets: nonStaticFeatureLayers,
                                toggleTitle: i18n.t(&quot;datagrid.ex.dataSummary&quot;),
                                txtDataset: i18n.t(&quot;datagrid.ex.dataset&quot;)
                            }
                        );

                        extendedTabTitle = $(&quot;#tabs1_2-lnk&quot;).append(&quot;&lt;span&gt;&quot;).find(&quot;span&quot;);
                    }

                    // generate the content using rowData and given template
                    section = tmpl(templateKey, templateData);

                    DatagridClickHandler.onDetailDeselect(datagridMode);
                    DatagridClickHandler.onZoomCancel();

                    tl.set(sectionNode, { className: &quot;+=animated fadeOut&quot; });
                    if (jqgrid) {
                        tl.set(jqgrid, { clearProps: &quot;width&quot; });
                    }

                    /*jshint validthis: true */
                    tl.call(function () {
                        tl.pause();

                        sectionNode.empty().append(section);
                        createDatatable();

                        datagridGlobalToggles = sectionNode.find(&#x27;#datagridGlobalToggles&#x27;);

                        datagridStatusLine = sectionNode.find(&#x27;.status-line&#x27;);
                        datasetSelector = $(&quot;#datasetSelector&quot;);
                        datasetSelectorSubmitButton = $(&quot;#datasetSelectorSubmitButton&quot;);
                        updateDatasetSelectorState(true);

                        d.resolve();

                        tl.resume();

                        // continue with transition when apply filter finished
                        deffered.then(function () {
                            //tl.call(function () { oTable.columns.adjust().draw(); console.log(&quot;!!!&quot;); }, null, this, &quot;+=2&quot;);

                            //tl.resume();

                            stl.set(jqgridWrapper, { className: &quot;-=fadedOut&quot; });
                            stl.set(jqgridWrapper, { className: &quot;+=animated fadeIn&quot; });
                            stl.set(jqgridWrapper, { className: &quot;-=animated fadeIn&quot; }, &quot;+=1&quot;);

                            stl.play();
                        });

                        applyExtentFilter(deffered);
                    }, null, this, duration + 0.1);

                    tl.set(sectionNode, { className: &quot;-=fadeOut&quot; });
                    tl.set(sectionNode, { className: &quot;+=fadeIn&quot; });
                    tl.set(sectionNode, { className: &quot;-=animated fadeIn&quot; }, &quot;+=&quot; + duration);

                    tl.play();
                }

                function activateRows() {
                    // If there was previously a selected point,
                    // navigate to the correct page and highlight it in the datagrid
                    highlightRow.refresh();
                    zoomlightRow.refresh();

                    // Scroll to the highlighted row first, if it fails,
                    // scroll to the zoomed row
                    if (!highlightRow.navigateToRow()) {
                        zoomlightRow.navigateToRow();
                    }

                    // set the focus on the first button in the datagrid
                    // is not a really good idea to just move focus around
                    //jqgrid.dataTable().find(&quot;button:first&quot;).focus();

                    zoomlightRow.activate();
                    highlightRow.activate();

                    capturePanel();
                }

                /**
                * Checks if the datagrid currently visible, i.e., the data tab is selected on the side panel
                *
                * @method isVisible
                * @private
                * @return {Boolean} indicating if the datagrid is currently visible
                */
                function isVisible() {
                    return tabNode.attr(&quot;aria-expanded&quot;) === &quot;true&quot;;
                }

                /**
                * Captures a subpanel that was opened and docked by the datagrid module previously.
                *
                * @method capturePanel
                * @param {Boolean} force if truthy - capture the panel even if the datagrid is not visible; use when switching to datagrid tab and the datagrid is not fully rendered yet by the browser
                * @private
                */
                function capturePanel(force) {
                    var origin = &quot;datagrid&quot;,
                        target = highlightRow.getNode().find(&quot;.record-controls&quot;);

                    if (datagridMode === GRID_MODE_FULL) {
                        origin = &quot;ex-datagrid&quot;;
                        target = highlightRow.getNode().find(&quot;.button.details&quot;);
                    }

                    // capture subpanel only if a row is active and the datagrid itself is visible
                    // if the subpanel is captured while the datagrid is not visible, the subpanel will also disappear since it&#x27;s inserted in the datagrid structure
                    if (highlightRow.isActive() &amp;&amp; (isVisible() || force)) {
                        topic.publish(EventManager.GUI.SUBPANEL_CAPTURE, {
                            target: target,
                            consumeOrigin: origin,
                            origin: origin
                        });
                    }
                }

                function adjustPanelWidth() {
                    if (datagridMode === GRID_MODE_SUMMARY) {
                        utilMisc.adjustWidthForSrollbar(jqgridTableWrapper, [datagridGlobalToggles, datagridStatusLine, datagridNotice]);
                    } else {
                        if (jqgrid.outerWidth() === jqgridWrapper.outerWidth()) {
                            dataTablesScrollBody.addClass(&quot;overflow-x-hidden&quot;);
                        } else {
                            dataTablesScrollBody.removeClass(&quot;overflow-x-hidden&quot;);
                        }
                    }
                }

                return {
                    /**
                    * The constructor method for the data grid. Adds the grid&#x27;s panel to the UI, adds the data rows, and creates all event triggers
                    *
                    * @method init
                    * @constructor
                    *
                    */
                    init: utilMisc.once(
                        function () {
                            var d = new Deferred();
                            d.then(
                                function () {
                                    _isReady = true;

                                    initTooltips();
                                    setButtonEvents();
                                    initScrollListeners();
                                    initUIListeners();
                                }
                            );

                            sectionNode = $(&quot;#&quot; + RAMP.config.divNames.datagrid);
                            refreshPanel(d);
                        }
                    ),

                    getDatagridMode: function () {
                        return datagridMode;
                    },

                    getSelectedDatasetId: function () {
                        if (!selectedDatasetId) {
                            if (datasetSelector.find(&quot;option:selected&quot;).length &gt; 0) {
                                selectedDatasetId = datasetSelector.find(&quot;option:selected&quot;)[0].value;
                            } else {
                                var firstVisibleLayer = UtilArray.find(RAMP.config.layers.feature, function (layerConfig) {
                                    var layer = RAMP.map.getLayer(layerConfig.id);
                                    if (layer) {
                                        return layer.visible &amp;&amp; (layer.ramp.type !== GlobalStorage.layerType.Static) &amp;&amp; (layer.ramp.load.state !== &#x27;error&#x27;);
                                    } else {
                                        //layer failed to load.  it will not be visible
                                        return false;
                                    }
                                });
                                selectedDatasetId = firstVisibleLayer === null ? null : firstVisibleLayer.id;
                            }
                        } else {
                            datasetSelector.find(&quot;option[value=&#x27;&quot; + selectedDatasetId + &quot;&#x27;]&quot;).prop(&#x27;selected&#x27;, true);
                        }

                        return selectedDatasetId;
                    },

                    /**
                    * Indicates that the Data grid is fully rendered
                    * @method isReady
                    * @return {Boolean} _isReady flag indicating the render status of the data grid
                    */
                    isReady: function () {
                        return _isReady;
                    },

                    /**
                    * Adjusts the width of the datagrid panel to accommodate the scrollbar.
                    *
                    * @method adjustPanelWidth
                    */
                    adjustPanelWidth: adjustPanelWidth,

                    activateRows: activateRows,

                    /**
                    * publishes the subPanel_Capture event to the GUI class
                    * @method capturePanel
                    */
                    capturePanel: capturePanel,

                    /**
                    * Update the datagrid notice to show feedback to the user if any.
                    * Right now is used to display notifications about scale dependent layers that are off scale at the moment.
                    *
                    * @private
                    * @method updateNotice
                    */
                    updateNotice: function () {
                        var notice,
                            data = { layers: null },
                            invisibleLayers =
                                RampMap.getInvisibleLayers()
                                .filter(function (l) {
                                    return l.ramp &amp;&amp; l.ramp.type === GlobalStorage.layerType.feature;
                                });

                        if (this.isReady()) {
                            tmpl.cache = {};
                            tmpl.templates = data_grid_template_json;

                            //We now download attributes separate from the map layer, so no need to show the warning in full grid
                            //as well, the warning covers the grid column labels
                            /*
                            if (datagridMode === GRID_MODE_FULL) {
                                // check if the selected layer is off scale at the current extent
                                selectedDatasetId = ui.getSelectedDatasetId();
                                index = UtilArray.indexOf(invisibleLayers, function (il) {
                                    return il.id === selectedDatasetId;
                                });

                                if (index !== -1) {
                                    notice = tmpl(&quot;datagrid_full_info_notice&quot;, data);
                                }
                            } else { */
                            if ((datagridMode !== GRID_MODE_FULL) &amp;&amp; (invisibleLayers.length &gt; 0)) {
                                data.layers = invisibleLayers.map(function (il) {
                                    return il.ramp.config;
                                });

                                // display notice only if invisibleLayer has eyeToggle on
                                if (invisibleLayerToggleOn.length &gt; 0) {
                                    notice = tmpl(&quot;datagrid_info_notice&quot;, data);
                                }
                            }

                            // if a notice was created, add it to the DOM
                            if (notice) {
                                datagridNotice
                                        .empty()
                                        .append(notice);

                                sectionNode.addClass(&quot;notice&quot;);
                            } else {
                                datagridNotice.empty();
                                sectionNode.removeClass(&quot;notice&quot;);
                            }
                        }
                    },

                    initInvisibleLayerToggleCount: utilMisc.once(
                        function () {
                            invisibleLayerToggleOn = RampMap.getInvisibleLayers()
                            .filter(function (l) {
                                // make sure l.ramp is not undefined, and it&#x27;s a feature layer, and config.settings.visible is true
                                return l.ramp &amp;&amp; l.ramp.type === GlobalStorage.layerType.feature &amp;&amp; l.ramp.config.settings.visible;
                            })
                            .map(function (lyr) {
                                return lyr.ramp.config.id;
                            });
                        }
                    )
                };
            }());

        /**
        * Caches the sorted data from datatables for feature click events to consume.  Builds featureToIndex as a
        * mapping of (layerId,featureId) =&gt; row index in the table.
        *
        * @method indexSortedData
        * @private
        */
        function indexSortedData() {
            var elements = oTable.rows().data();
            featureToIndex = {};
            $.each(elements, function (idx, val) {
                if (val.last()) {
                    var layer = val.last().layerId,
                        fid = GraphicExtension.getFDataOid(val.last().fData);

                    if (!(layer in featureToIndex)) {
                        featureToIndex[layer] = {};
                    }
                    featureToIndex[layer][fid] = idx;
                }
            });
        }

        /**
        * Handles the Enter key press and Click mouse event of the data grid.
        * It is actually a binder that binds the key / mouse event to a handler specified.
        * This is wired up to grid cells in the bootstrapper to achieve click/keypress functions
        *
        * @method handleGridEvent
        * @private
        * @param {Event} e the event object
        * @param {Function} callback the callback function
        */
        function handleGridEvent(e, callback) {
            if ((e.type === &quot;keypress&quot; &amp;&amp; e.keyCode === 13) || e.type === &quot;click&quot;) {
                callback();
                //Ramp.setHTML(oid); // just update info hit
            }
        }

        /**
        * Rounds up all visible features in the current map extent, then triggers the process to add those
        * features to the datagrid
        *
        * @method applyExtentFilter
        * @param {Deferred} d a deferred to resolve after the grid has been populated
        *
        */
        function applyExtentFilter(d) {
            var visibleFeatures = {},
                visibleGridLayers = RampMap.getVisibleFeatureLayers(),
                dataGridMode = ui.getDatagridMode(),
                q = new EsriQuery(),
                bigGridNoFilter = false;

            //console.time(&#x27;applyExtentFilter:part 1&#x27;);
            //console.time(&#x27;applyExtentFilter:part 1 - 1&#x27;);

            // filter out static layers
            visibleGridLayers = visibleGridLayers.filter(function (layer) {
                return layer.ramp.type !== GlobalStorage.layerType.Static;
            });

            //figure out what extent to use
            if (dataGridMode === GRID_MODE_FULL) {
                if (RAMP.config.extendedDatagridExtentFilterEnabled) {
                    q.geometry = RampMap.getMap().extent;
                    //in this case, we only consider the layer if it is visible
                    visibleGridLayers = visibleGridLayers.filter(function (layer) {
                        return layer.id === ui.getSelectedDatasetId();
                    });
                } else {
                    // Grab everything!  even if it&#x27;s not visible on the map
                    bigGridNoFilter = true;
                    visibleGridLayers = [RAMP.layerRegistry[ui.getSelectedDatasetId()]];
                }
            } else { // Summary Mode
                q.geometry = RampMap.getMap().extent;
            }

            //this will result in just objectid fields, as that is all we have in feature layers
            q.outFields = [&quot;*&quot;];

            //console.timeEnd(&#x27;applyExtentFilter:part 1 - 1&#x27;);

            // Update total records
            totalRecords = 0;
            visibleGridLayers.forEach(function (layer) {
                if (RAMP.data[layer.id]) {
                    totalRecords += RAMP.data[layer.id].features.length;
                }
            });

            //console.time(&#x27;applyExtentFilter:part 1 - 2&#x27;);

            var deferredList;

            if (bigGridNoFilter) {
                deferredList = []; //nothing to wait for.  empty array will satisfy afterAll()
                //we only have one layer, and will want all the data. flag as raw, and pass in the layer id
                visibleFeatures[visibleGridLayers[0].id] = {
                    type: &#x27;raw&#x27;,
                    layerId: visibleGridLayers[0].id
                };
            } else {
                //apply spatial query to the layers, collect deferred results in the array.
                deferredList = visibleGridLayers.map(function (gridLayer) {
                    return gridLayer.queryFeatures(q).then(function (features) {
                        //console.timeEnd(&#x27;applyExtentFilter:part 1 - 2&#x27;);

                        if (features.features.length &gt; 0) {
                            var layer = features.features[0].getLayer();
                            visibleFeatures[layer.id] = {
                                type: &#x27;features&#x27;,
                                features: features.features
                            };
                        }
                    });
                });
            }

            // Execute this only after all the deferred objects has resolved
            utilMisc.afterAll(deferredList, function () {
                //console.timeEnd(&#x27;applyExtentFilter:part 1&#x27;);

                //console.time(&#x27;applyExtentFilter:part 2 - fetchRecords&#x27;);

                fetchRecords(visibleFeatures);

                //console.timeEnd(&#x27;applyExtentFilter:part 2 - fetchRecords&#x27;);
                // initialize invisible layer toggle count
                ui.initInvisibleLayerToggleCount();

                ui.updateNotice();

                if (d) {
                    // console.log(&quot;I&#x27;m calling reserve!!!&quot;);
                    d.resolve();
                }
            });
        }

        /**
        * Given a feature data object, return a data object used to represent the feature in the datagrid.
        * The data object is an ordered array of raw values
        *
        * @method getDataObject
        * @private
        * @param {Object} fData data the feature needs to be represented in the datagrid
        * return {Array} an array representing the data the given feature contains.
        */
        function getDataObject(fData) {
            var layerConfig = GraphicExtension.getConfigForFData(fData),
                innerArray;

            //Remember, case sensitivity MATTERS in the attribute name.

            if (ui.getDatagridMode() === GRID_MODE_SUMMARY) {
                innerArray = [GraphicExtension.getFDataTitle(fData)];
            } else {
                //make array containing values for each column in the full grid
                innerArray = [];

                // retrieve extendedGrid config object
                var extendedGrid = layerConfig.datagrid.gridColumns;

                // process each column and add to row
                extendedGrid.forEach(function (column) {
                    innerArray.push(fData.attributes[column.fieldName] || &quot;&quot;);
                });
            }

            // Includes fields that are useful which are not derived from the config.featureSources
            // this should not draw, as there will be no column defined for it
            innerArray.push({
                layerId: layerConfig.id,
                layerName: layerConfig.displayName,
                fData: fData
            });

            return innerArray;
        }

        function updateRecordsCount(visibleRecords) {
            $(&quot;.pagination-record-number&quot;).text(String.format(&quot;{0} / {1}&quot;, visibleRecords, totalRecords));
        }

        /**
        * Populate the datagrid with data belonging to features contained in visibleFeatures
        *
        * @method fetchRecords
        * @param {Array} visibleFeatures a dictionary mapping layer id to an array of on-map feature objects
        * @private
        */
        function fetchRecords(visibleFeatures) {
            if (jqgrid === undefined) {
                // fetchRecords call made prior ty jqgrid creation
                console.warn(&#x27;fetchRecords called prior to grid initialization&#x27;);
                return;
            }
            jqgrid.DataTable().clear(); // Do NOT redraw the datatable at this point

            if (Object.keys(visibleFeatures).isEmpty()) {
                updateRecordsCount(0);
                jqgrid.DataTable().draw();
                return;
            }

            var data = [], newData, dgMode = ui.getDatagridMode();

            //for each feature layer
            utilDict.forEachEntry(visibleFeatures, function (key, layerBundle) {
                //ensure attribute data has been downloaded
                if (RAMP.data[key]) {
                    switch (layerBundle.type) {
                        case &#x27;features&#x27;:

                            //for each feature in a specific layer
                            newData = layerBundle.features.map(function (feature) {
                                //get the feature data for this feature
                                var fData = GraphicExtension.getFDataForGraphic(feature);

                                //return the appropriate data object for the feature (.map puts them in array form)
                                // &quot;cache&quot; the data object so we don&#x27;t have to generate it again
                                return fData[dgMode] ? fData[dgMode] : fData[dgMode] = getDataObject(fData);
                            });

                            data = data.concat(newData);

                            break;

                        case &#x27;raw&#x27;:
                            //just iterate over all the feature data in the data store.  this will grab data that is not visible on the map
                            newData = RAMP.data[layerBundle.layerId].features.map(function (fData) {
                                //return the appropriate data object for the feature (.map puts them in array form)
                                // &quot;cache&quot; the data object so we don&#x27;t have to generate it again
                                return fData[dgMode] ? fData[dgMode] : fData[dgMode] = getDataObject(fData);
                            });

                            data = data.concat(newData);

                            break;
                    }
                }
            });

            updateRecordsCount(data.length);

            oTable.one(&quot;draw.dt&quot;, function () {
                topic.publish(EventManager.Datagrid.EXTENT_FILTER_END);
            });

            //add the data to the grid

            //console.time(&#x27;fetchRecords: fnAddData&#x27;);

            jqgrid.dataTable().fnAddData(data);

            //console.timeEnd(&#x27;fetchRecords: fnAddData&#x27;);

            //console.log(&quot;jqgrid.dataTable().fnAddData(data);&quot;);

            // NOTE: fnAddData should be the last thing that happens in this function
            // if you want to add something after this point, use the fnDrawCallback
            // function in the jqgrid initialization
        }

        /**
        * Returns the graphic object of a feature layer for the corresponding feature data object.
        *
        * @method getGraphicFromFData
        * @private
        * @param {Object} fData a feature data object
        * @return {Object}   the graphic object of the feature layer.
        */
        function getGraphicFromFData(fData) {
            //TODO move this into graphicExtension?  check for RampMap import circular reference.

            var oid = GraphicExtension.getFDataOid(fData),
                graphic;

            graphic = GraphicExtension.findGraphic(oid, fData.parent.layerId);
            return graphic;
        }

        /**
        * Returns the feature data object which is encoded in the given buttonNode.
        *
        * @method getFDataFromButton
        * @private
        * @param {JObject} buttonNode   the node containing the button
        * @return {Object}   the feature data object
        */
        function getFDataFromButton(buttonNode) {
            var layerId = buttonNode.data(layerIdField),
                oid = buttonNode.data(featureOidField),
                layerData = RAMP.data[layerId];

            //since button.data returns in string format, we don&#x27;t need to convert the oid to a string for the index
            return layerData.features[layerData.index[oid]];
        }

        /**
        * Binding event handling for events:
        * filterManager/layer-visibility-toggled
        * datagrid/applyExtentFilter
        *
        * @method initListeners
        * @private
        */
        function initListeners() {
            topic.subscribe(EventManager.FilterManager.LAYER_VISIBILITY_TOGGLED, function (event) {
                extentFilterExpired = true;

                // added by Jack to make sure layer visibility is added or removed from checkedLayerVisibility
                if (event.id !== null) {
                    var idx = invisibleLayerToggleOn.indexOf(event.id);
                    if (idx === -1 &amp;&amp; event.state) {
                        // add
                        invisibleLayerToggleOn.push(event.id);
                    } else if (idx !== -1 &amp;&amp; !event.state) {
                        // remove
                        invisibleLayerToggleOn.splice(idx, 1);
                    }
                }
            });

            /* UI EVENTS */
            topic.subscribe(EventManager.GUI.TAB_SELECTED, function (arg) {
                if (arg.tabName === &quot;datagrid&quot;) {
                    if (extentFilterExpired) {
                        extentFilterExpired = false;
                        applyExtentFilter();
                    } else {
                        ui.capturePanel(true);
                    }

                    ui.adjustPanelWidth();
                }
            });

            topic.subscribe(EventManager.GUI.TAB_DESELECTED, function (arg) {
                if (arg.tabName === &quot;datagrid&quot;) {
                    topic.publish(EventManager.GUI.SUBPANEL_DOCK, {
                        origin: &quot;datagrid&quot;
                    });
                    console.log(&quot;subPanleDock&quot;);
                }
            });

            topic.subscribe(EventManager.Datagrid.APPLY_EXTENT_FILTER, function () {
                if (ui.getDatagridMode() !== GRID_MODE_FULL) {
                    applyExtentFilter();
                }
            });

            topic.subscribe(EventManager.LayerLoader.LAYER_UPDATED, function (evt) {
                //layer has updated its data.  if it has grid-worthy data, refresh the grid
                if (evt.layer.ramp.type === GlobalStorage.layerType.feature) {
                    if (ui.getDatagridMode() !== GRID_MODE_FULL) {
                        //console.log(&#x27;HOGG - layer loaded event&#x27;);
                        applyExtentFilter();
                    }
                    //this is causing more trouble than it is worth.  if a user opens big grid before a layer is loaded, they wont be
                    //expecting to look at it anyways.   If it finishes loading when the big grid is open, user will be unaware because
                    //everything else is hidden.  A loaded layer will appear the next time the grid opens.
                    /*else {
                        //in this case, a slow loading layer updated after the user has switched to the extended grid view.
                        //add layer to selection combo box (as it would not have been added when the pane was generated)
                        var layerConfig = Ramp.getLayerConfigWithId(evt.layer.id),
                            optElem = document.createElement(&quot;option&quot;),  // &quot;&lt;option value=&#x27;&quot; + layerConfig.id + &quot;&#x27;&gt;&quot; + layerConfig.displayName + &quot;&lt;/option&gt;&quot;,
                            datasetSelector = $(&quot;#datasetSelector&quot;);

                        optElem.text = layerConfig.displayName;
                        optElem.value = layerConfig.id;
                        datasetSelector.add(optElem);
                    }*/
                }
            });

            topic.subscribe(EventManager.LayerLoader.REMOVE_LAYER, function () {
                //layer has been removed, notify the ui incase the layer was scale dependent
                ui.updateNotice();
            });

            // update notice after zoom end event since some of the scale-dependent layers might end up off scale
            topic.subscribe(EventManager.Map.ZOOM_END, function () {
                ui.updateNotice();
            });

            topic.subscribe(EventManager.GUI.SUBPANEL_CHANGE, function (evt) {
                if (evt.origin === &quot;ex-datagrid&quot; &amp;&amp;
                    evt.isComplete) {
                    ui.adjustPanelWidth();
                }
            });
        }

        return {
            /**
            * Initialize the datagrid. must be called before any properties can be accessed.
            *
            * @method init
            */
            init: function () {
                initListeners();

                ui.init();
            } //InitDataGrid
        };
    });
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
